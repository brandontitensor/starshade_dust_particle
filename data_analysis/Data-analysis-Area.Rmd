---
title: "Area_based_analysis"
author: "Brandon Titensor"
date: "2025-01-08"
output: 
   html_document:
    toc: true
    toc_float: true
    theme: cosmo
---

```{r setup, include=FALSE}
# 
#   html_document:
#     toc: true
#     toc_float: true
#     theme: cosmo

# Load required libraries
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(knitr)
library(rstatix)
library(ggpubr)
library(gridExtra)
library(data.table)
library(cowplot)
library(ggplot2)
library(dplyr)
library(grid)
library(fs)
library(png)
library(kableExtra)
library(broom)

# Create unified theme for consistent plot appearance across the analysis
custom_theme <- theme_minimal() +
  theme(
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    legend.position = "bottom",
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray95")
  )

# Define consistent color palette for different trials
trial_colors <- c(
  "8" = "#0072B2",  # Navy Blue
  "9" = "#D55E00",  # Orange
  "10" = "#009E73",  # Green
  "11" = "#56B4E9",  # Sky Blue
  "12" = "#CC79A7", # Purple
  "13" = "#F0E442", #Yellow
  "14" = "#661100" #Dark Brown
)

# Define consistent line types for different data categories
line_types <- c(
  "Observed" = "solid",
  "Modeled" = "dashed",
  "Calibration" = "dotted"
)


```

## 1. Data Loading and Preprocessing

### 1.1 Edge Data

<!-- This section loads particle data from the edges of samples to analyze particulate contamination -->

```{r load_edge_data}
# Function to load and process a single sample of edge data
# This reads both particle details and summary information from CSV files
load_sample_data <- function(sample_number) {
  sample_str <- sprintf("%02d", sample_number)
  
  # Use file.path() which handles spaces better
  base_dir <- "/Users/brandontitensor/Desktop/College/Research/Dust_Contamination/Upload_data/Edges/Edge Measurements"
  folder_name <- paste0("Bef_", sample_str, " minus Aft_", sample_str)
  
  particles_file <- paste0("Particles Bef_", sample_str, " minus Aft_", sample_str, ".csv")
  summary_file <- paste0("Summary Bef_", sample_str, " minus Aft_", sample_str, ".csv")
  
  particles_path <- file.path(base_dir, folder_name, particles_file)
  summary_path <- file.path(base_dir, folder_name, summary_file)
  
  # Check if files exist
  if (!file.exists(particles_path)) {
    stop(paste("Particles file not found:", particles_path))
  }
  if (!file.exists(summary_path)) {
    stop(paste("Summary file not found:", summary_path))
  }
  
  # Load and preprocess particle data
  particles_data <- read.csv(particles_path)
  particles_data$Sample <- sample_number
  
  # Load and preprocess summary data
  summary_data <- read.csv(summary_path)
  names(summary_data) <- make.names(names(summary_data))
  summary_data$Count <- as.numeric(gsub("[^0-9.]", "", summary_data$Count))
  summary_data$width <- as.numeric(gsub("[^0-9.]", "", summary_data$finished_width))
  summary_data <- summary_data %>% drop_na()
  summary_data$Sample <- sample_number
  
  # Convert width from pixels to microns (calibration factor is 50/240)
  summary_data$width <- summary_data$finished_width * (50/240)
  
  list(particles = particles_data, summary = summary_data)
}

# Load data for samples 51-60 (Trials 9-12, 5 samples each)
edge_data <- map(c(1:30), load_sample_data)

# Combine all particle data into one dataset
edge_particles_data <- bind_rows(map(edge_data, "particles"))

# Combine all summary data into one dataset
edge_summary_data <- bind_rows(map(edge_data, "summary"))

# Assign trials to samples (5 samples per trial)
edge_particles_data$Trial <- ceiling((edge_particles_data$Sample - 5) / 5) + 9
edge_summary_data$Trial <- ceiling((edge_summary_data$Sample - 5) / 5) + 9

# Calculate total width for each trial to normalize data
total_width_by_trial <- edge_summary_data %>%
  group_by(Trial) %>%
  summarise(Total_Width = sum(width))

# Calculate the normalization factor based on the maximum width
max_width <- max(total_width_by_trial$Total_Width)
normalization_factors <- max_width / total_width_by_trial$Total_Width
```

### 1.2 Surface Data

<!-- This section loads data from the surfaces of samples before and after contamination -->

```{r load_surface_data}
# Function to load and process surface data
# This handles both before and after contamination measurements
load_data <- function(condition) {
  # Function to load and process particle data for a single sample
  load_particle_data <- function(trial_number, sample_number, cond) {
    tryCatch({
      particle_path <- sprintf("/Users/brandontitensor/Desktop/College/Research/Dust_Contamination/Upload_data/Surfaces/%sTr%dSa%dSurf/Particles_%sTr%dSa%dSurf.csv", 
                             cond, trial_number, sample_number, cond, trial_number, sample_number)
      
      particle_data <- read_csv(particle_path)
      particle_data <- particle_data[, 2:(ncol(particle_data)-2)]
      particle_data$Sample <- sample_number
      particle_data$Trial <- trial_number
      
      return(particle_data)
    }, error = function(e) {
      message(sprintf("Error loading particle data for %s Trial %d, Sample %d: %s", 
                     cond, trial_number, sample_number, e$message))
      return(NULL)
    })
  }

  # Load and process summary data with error handling
  load_summary_data <- function(trial_number, sample_number, cond) {
    tryCatch({
      summary_path <- sprintf("/Users/brandontitensor/Desktop/College/Research/Dust_Contamination/Upload_data/Surfaces/%sTr%dSa%dSurf/Summary_%sTr%dSa%dSurf.csv", 
                            cond, trial_number, sample_number, cond, trial_number, sample_number)
      
      summary_data <- read_csv(summary_path) %>% 
                             select(-c(7:16),-18)
      names(summary_data) <- make.names(names(summary_data))
      summary_data <- summary_data %>% 
        drop_na() %>%
        mutate(
          Sample = sample_number,
          Trial = trial_number,
          Slice_Number = as.integer(substr(Slice, nchar(Slice)-6, nchar(Slice)-4))
        )
      
      return(summary_data)
    }, error = function(e) {
      message(sprintf("Error loading summary data for %s Trial %d, Sample %d: %s", 
                     cond, trial_number, sample_number, e$message))
      return(NULL)
    })
  }

  # Load data for trials 8-12 (5 samples per trial)
  surface_particle_data <- map2(rep(9:14, each = 5), rep(1:5, times = 6), 
                              ~load_particle_data(.x, .y, condition))
  surface_summary_data <- map2(rep(9:14, each = 5), rep(1:5, times = 6), 
                             ~load_summary_data(.x, .y, condition))

  # Combine all data
  surface_particle_data <- bind_rows(surface_particle_data)
  surface_summary_data <- bind_rows(surface_summary_data)

  # Add cleaning method information based on trial number
  add_cleaning_method <- function(data) {
    data %>%
      mutate(Cleaning_Method = case_when(
        Trial %in% c(2, 3) ~ "IPA rinse",
        Trial %in% c(4, 5) ~ "Drag and wipe",
        Trial %in% c(6, 7) ~ "First contact",
        Trial %in% c(8, 9, 10, 11, 12,13,14) ~ "First contact & Drag and wipe",
        TRUE ~ NA_character_
      ))
  }

  surface_particle_data <- add_cleaning_method(surface_particle_data)
  surface_summary_data <- add_cleaning_method(surface_summary_data)

  # Calculate imaged areas to normalize counts (600 x 450 microns per image)
  image_size <- 600 * 450 # microns^2
  trial_areas <- surface_summary_data %>%
    group_by(Trial, Cleaning_Method) %>%
    summarise(
      Total_Images = n(),
      Total_Area = Total_Images * image_size * 1e-12, # Convert to m^2
      .groups = "drop"
    )

  list(particle_data = surface_particle_data, 
       summary_data = surface_summary_data, 
       trial_areas = trial_areas)
}

# Load before and after surface data for comparison
surface_before_data <- load_data("Bef")
surface_after_data <- load_data("Aft")
```

### 1.3 Calibration Wafer Data

<!-- This section loads data from calibration wafers which serve as reference standards -->

```{r load_calibration_data}
# Function to load and process calibration wafer data
load_calibration_data <- function(sample_number) {
  # Format sample number with leading zeros
  sample_str <- sprintf("%02d", sample_number)
  
  # Construct file paths
  particles_path <- sprintf("/Users/brandontitensor/Desktop/College/Research/Dust_Contamination/Upload_data/Calibration/Edge Measurements/Bef_%s minus Aft_%s/Particles Bef_%s minus Aft_%s.csv", sample_str, sample_str, sample_str, sample_str)
  summary_path <- sprintf("/Users/brandontitensor/Desktop/College/Research/Dust_Contamination/Upload_data/Calibration/Edge Measurements/Bef_%s minus Aft_%s/Summary Bef_%s minus Aft_%s.csv", sample_str, sample_str, sample_str, sample_str)
  
  # Load particle data
  particles_data <- read.csv(particles_path)
  particles_data$Sample <- sample_number
  
  # Load summary data and clean up formatting
  summary_data <- read.csv(summary_path)
  names(summary_data) <- make.names(names(summary_data))
  summary_data$Count <- as.numeric(gsub("[^0-9.]", "", summary_data$Count))
  summary_data$width <- as.numeric(gsub("[^0-9.]", "", summary_data$finished_width))
  summary_data$Sample <- sample_number
  summary_data <- summary_data %>% drop_na()
   # Convert width from pixels to microns (calibration factor is 50/240)
  summary_data$width <- summary_data$finished_width * (50/240)
  
  list(particles = particles_data, summary = summary_data)
}

# Load data for calibration samples (11-30)
calibration_data <- map(c(16:45), load_calibration_data)

# Combine all particle data
calibration_particles_data <- bind_rows(map(calibration_data, "particles"))

# Combine all summary data
calibration_summary_data <- bind_rows(map(calibration_data, "summary"))

# Assign trials to samples
calibration_particles_data$Trial <- ceiling((calibration_particles_data$Sample  - 15) / 5) + 8
calibration_summary_data$Trial <- ceiling((calibration_summary_data$Sample) / 5) + 5

# Calculate total width and normalization factors
total_width_by_trial <- calibration_summary_data %>%
  group_by(Trial) %>%
  summarise(Total_Width = sum(edge_width))

# Use same max_width as edge data for consistent normalization
calibration_max_width <- max_width
calibration_normalization_factors <- calibration_max_width / total_width_by_trial$Total_Width

# Free memory by removing the raw data
rm(calibration_data)
```

### 1.4 Calibration Surface Data

<!-- This section loads surface data from calibration wafers for complete comparison -->

```{r load_cal_surface_data}
# Function to load and process surface data from calibration wafers
# This is similar to the regular surface data function but with different file paths
load_data <- function(condition) {
  # Function to load and process particle data for a single sample
  load_particle_data <- function(trial_number, sample_number, cond) {
    tryCatch({
      particle_path <- sprintf("/Users/brandontitensor/Desktop/College/Research/Dust_Contamination/Upload_data/Cal_Surfaces/%sTr%dSa%dCwSurf/Particles_%sTr%dSa%dCwSurf.csv", 
                             cond, trial_number, sample_number, cond, trial_number, sample_number)
      
      particle_data <- read_csv(particle_path) 
      particle_data <- particle_data[, 2:(ncol(particle_data)-2)]
      particle_data$Sample <- sample_number
      particle_data$Trial <- trial_number
      
      return(particle_data)
    }, error = function(e) {
      message(sprintf("Error loading particle data for %s Trial %d, Sample %d: %s", 
                     cond, trial_number, sample_number, e$message))
      return(NULL)
    })
  }

  # Load and process summary data
  load_summary_data <- function(trial_number, sample_number, cond) {
    tryCatch({
      summary_path <- sprintf("/Users/brandontitensor/Desktop/College/Research/Dust_Contamination/Upload_data/Cal_Surfaces/%sTr%dSa%dCwSurf/Summary_%sTr%dSa%dCwSurf.csv", 
                            cond, trial_number, sample_number, cond, trial_number, sample_number)
      
      summary_data <- read_csv(summary_path) %>% 
                             select(-c(7:16),-18)
      names(summary_data) <- make.names(names(summary_data))
      summary_data <- summary_data %>% 
        drop_na() %>%
        mutate(
          Sample = sample_number,
          Trial = trial_number,
          Slice_Number = as.integer(substr(Slice, nchar(Slice)-6, nchar(Slice)-4))
        )
      
      return(summary_data)
    }, error = function(e) {
      message(sprintf("Error loading summary data for %s Trial %d, Sample %d: %s", 
                     cond, trial_number, sample_number, e$message))
      return(NULL)
    })
  }

  # Load data for trial 12 (5 samples)
  surface_particle_data <- map2(rep(12:14, each = 5), rep(1:5, times = 3), 
                              ~load_particle_data(.x, .y, condition))
  surface_summary_data <- map2(rep(12:14, each = 5), rep(1:5, times = 3), 
                             ~load_summary_data(.x, .y, condition))

  # Combine all data
  surface_particle_data <- bind_rows(surface_particle_data)
  surface_summary_data <- bind_rows(surface_summary_data)

  # Add cleaning method information
  add_cleaning_method <- function(data) {
    data %>%
      mutate(Cleaning_Method = case_when(
        Trial %in% c(2, 3) ~ "IPA rinse",
        Trial %in% c(4, 5) ~ "Drag and wipe",
        Trial %in% c(6, 7) ~ "First contact",
        Trial %in% c(8, 9, 10, 11, 12,13,14) ~ "First contact & Drag and wipe",
        TRUE ~ NA_character_
      ))
  }

  surface_particle_data <- add_cleaning_method(surface_particle_data)
  surface_summary_data <- add_cleaning_method(surface_summary_data)

  # Calculate imaged areas
  image_size <- 600 * 450 # microns^2
  trial_areas <- surface_summary_data %>%
    group_by(Trial, Cleaning_Method) %>%
    summarise(
      Total_Images = n(),
      Total_Area = Total_Images * image_size * 1e-12, # Convert to m^2
      .groups = "drop"
    )

  list(particle_data = surface_particle_data, 
       summary_data = surface_summary_data, 
       trial_areas = trial_areas)
}

# Load before and after calibration surface data
Cwsurface_before_data <- load_data("Bef")
Cwsurface_after_data <- load_data("Aft")
```

### 1.5 Witness Surface Data

<!-- This section loads surface data from Witness sample for complete comparison -->

```{r load_wit_surface_data}
# Function to load and process surface data from calibration wafers
# This is similar to the regular surface data function but with different file paths
load_data <- function(condition) {
  # Function to load and process particle data for a single sample
  load_particle_data <- function(trial_number, cond) {
    tryCatch({
      particle_path <- sprintf("/Users/brandontitensor/Desktop/College/Research/Dust_Contamination/Upload_data/Witness/Witness_%s_%d/Particles_Witness_%s_%d.csv", 
                             cond, trial_number, cond, trial_number)
      
      particle_data <- read_csv(particle_path)
      particle_data <- particle_data[, 2:(ncol(particle_data)-2)]
      particle_data$Trial <- trial_number
      
      return(particle_data)
    }, error = function(e) {
      message(sprintf("Error loading particle data for %s Trial %d", 
                     cond, trial_number, e$message))
      return(NULL)
    })
  }

  # Load and process summary data
  load_summary_data <- function(trial_number, cond) {
    tryCatch({
      summary_path <- sprintf("/Users/brandontitensor/Desktop/College/Research/Dust_Contamination/Upload_data/Witness/Witness_%s_%d/Summary_Witness_%s_%d.csv", 
                            cond, trial_number, cond, trial_number)
      
      summary_data <- read_csv(summary_path) %>% 
                             select(-c(7:16),-18)
      names(summary_data) <- make.names(names(summary_data))
      summary_data <- summary_data %>% 
        drop_na() %>%
        mutate(
          Trial = trial_number,
          Slice_Number = as.integer(substr(Slice, nchar(Slice)-6, nchar(Slice)-4))
        )
      
      return(summary_data)
    }, error = function(e) {
      message(sprintf("Error loading summary data for %s Trial %d", 
                     cond, trial_number, e$message))
      return(NULL)
    })
  }

  # Load data for trial 12 (5 samples)
  surface_particle_data <- map2(rep(9:14, each = 1), rep(1, times = 6), 
                              ~load_particle_data(.x, condition))
  surface_summary_data <- map2(rep(9:14, each = 1), rep(1, times = 6), 
                             ~load_summary_data(.x, condition))

  # Combine all data
  surface_particle_data <- bind_rows(surface_particle_data)
  surface_summary_data <- bind_rows(surface_summary_data)

  # Add cleaning method information
  add_cleaning_method <- function(data) {
    data %>%
      mutate(Cleaning_Method = case_when(
        Trial %in% c(2, 3) ~ "IPA rinse",
        Trial %in% c(4, 5) ~ "Drag and wipe",
        Trial %in% c(6, 7) ~ "First contact",
        Trial %in% c(8, 9, 10, 11, 12,13,14) ~ "First contact & Drag and wipe",
        TRUE ~ NA_character_
      ))
  }

  surface_particle_data <- add_cleaning_method(surface_particle_data)
  surface_summary_data <- add_cleaning_method(surface_summary_data)

  # Calculate imaged areas
  image_size <- 600 * 450 # microns^2
  trial_areas <- surface_summary_data %>%
    group_by(Trial, Cleaning_Method) %>%
    summarise(
      Total_Images = n(),
      Total_Area = Total_Images * image_size * 1e-12, # Convert to m^2
      .groups = "drop"
    )

  list(particle_data = surface_particle_data, 
       summary_data = surface_summary_data, 
       trial_areas = trial_areas)
}

# Load before and after calibration surface data
Witsurface_before_data <- load_data("bef")
Witsurface_after_data <- load_data("aft")
```

## 2. Surface Area Distribution Analysis

<!-- This section analyzes the particle size distribution on the sample surfaces -->

```{r surface_area_distribution_analysis}
# Filter surface particles by minimum area (1 )
surface_before_particles <- surface_before_data$particle_data %>%
 filter(Area > 1, Area < 6000) 
surface_after_particles <- surface_after_data$particle_data %>%
 filter(Area > 1, Area < 6000) 
combined_surface_data <- bind_rows(surface_before_particles,surface_after_particles)

# Create logarithmically spaced area thresholds from minimum to maximum particle size
min_area <- 1  # Starting from 1 as per previous filter
max_area <- max(combined_surface_data$Area)
log_min <- log10(min_area)
log_max <- log10(max_area)

# Create 250 evenly spaced points on log scale for binning particles
area_thresholds <- 10^(seq(log_min, log_max, length.out = 100))

# Define IEST standard parameters (Industry standard for contamination control)
# and calculate sample areas for normalization
slope <- -0.926  # Standard IEST slope
image_size <- 600 * 450 
new_sample_areas <- surface_before_data$summary_data %>%
  group_by(Sample, Trial, Cleaning_Method) %>%
  summarise(
    Total_Images = n(),
    Total_Area = 0.1 / (n() * image_size * 1e-12),  # Convert to m^2
    .groups = "drop"
  )


# Function to get area-based counts - counts particles that exceed each threshold
# and applies normalization factor to standardize to 0.1 m²
get_area_counts <- function(data, area_thresholds, normalization_factor) {
  # Initialize counts vector
  counts <- numeric(length(area_thresholds))
  areas <- numeric(length(area_thresholds))
  counts_nn <- numeric(length(area_thresholds))
  areas_nn <- numeric(length(area_thresholds))
    
  # For bins except the last one
  for(i in 1:(length(area_thresholds) - 1)) {
    bin_particles <- data$Area >= area_thresholds[i] & data$Area < area_thresholds[i + 1]
    counts_nn[i] <- sum(bin_particles)
    counts[i] <- sum(bin_particles) * normalization_factor
    areas_nn[i] <- sum(data$Area[bin_particles])
    areas[i] <- sum(data$Area[bin_particles]) * normalization_factor
  }
  
  # For the last bin
    last_bin <- data$Area >= area_thresholds[length(area_thresholds)]
  counts[length(area_thresholds)] <- sum(last_bin) * normalization_factor
  counts_nn[length(area_thresholds)] <- sum(last_bin)
  areas[length(area_thresholds)] <- sum(data$Area[last_bin]) * normalization_factor
  areas_nn[length(area_thresholds)] <- sum(data$Area[last_bin])

  
  # Return results in the same format as expected by the original code
  tibble(
    Area = area_thresholds,
    Count = counts,
    Scatter_Area = areas,
    Count_nn = counts_nn,
    Scatter_Area_nn = areas_nn
  )
}



# Calculate area-based counts for before and after data
# Normalizes each sample to 0.1 m² for standardized comparison
surface_before_counts <- surface_before_particles %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <-new_sample_areas$Total_Area[new_sample_areas$Sample == .y$Sample &  new_sample_areas$Trial == .y$Trial]
    get_area_counts(.x,area_thresholds, norm_factor)
  })

surface_after_counts <- surface_after_data$particle_data %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <- new_sample_areas$Total_Area[new_sample_areas$Sample == .y$Sample &  new_sample_areas$Trial == .y$Trial]
  get_area_counts(.x, area_thresholds, norm_factor)
  })

# Calculate differences (after - before) to get contamination effect
# and find positive differences (actual contamination)
surface_diff <- surface_after_counts %>%
  full_join(surface_before_counts, 
            by = c("Trial", "Sample", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Scatter_Diff = Scatter_Area_After - Scatter_Area_Before,
         Positive_Count_Diff = pmax(Count_Diff, 0),
         Positive_Scatter_Diff = pmax(Scatter_Diff, 0))

# Calculate cumulative counts (running sum of particles larger than threshold)
cumulative_surface <- surface_diff %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Positive_Count_Diff),
         Cumulative_Scatter = cumsum(Positive_Scatter_Diff)) %>%
  ungroup()

binned_surface <- surface_diff %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  ungroup()

# Calculate average counts by trial to reduce noise from individual samples
average_surface_cumulative <- cumulative_surface %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Extract trial 12 data for later comparison
surface_9 <- average_surface_cumulative %>% 
  filter( Trial == 9)

surface_10 <- average_surface_cumulative %>% 
  filter( Trial == 10)

surface_11 <- average_surface_cumulative %>% 
  filter( Trial == 11)

surface_12 <- average_surface_cumulative %>% 
  filter( Trial == 12)

surface_13 <- average_surface_cumulative %>% 
  filter( Trial == 13)

surface_14 <- average_surface_cumulative %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
surface_average <- bind_rows(surface_9, surface_10, surface_11, surface_12) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

surface_average_air <- bind_rows(surface_13, surface_14) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Calculate average counts by trial to reduce noise from individual samples
average_surface_binned <- binned_surface %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Positive_Count_Diff, na.rm = TRUE),
    Average_Scatter = mean(Positive_Scatter_Diff, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))



# Extract trials binned data for later comparison
surface_9_binned <- average_surface_binned %>% 
  filter( Trial == 9)

surface_10_binned <- average_surface_binned %>% 
  filter( Trial == 10)

surface_11_binned <- average_surface_binned %>% 
  filter( Trial == 11)

surface_12_binned <- average_surface_binned %>% 
  filter( Trial == 12)

surface_13_binned <- average_surface_binned %>% 
  filter( Trial == 13)

surface_14_binned <- average_surface_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
surface_average_binned <- bind_rows(surface_9_binned, surface_10_binned, surface_11_binned, surface_12_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    .groups = "drop"
  )%>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

surface_average_air_binned <- bind_rows(surface_13_binned, surface_14_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    .groups = "drop"
  )%>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))


## Standard Error Additions

# Cumulative
cumulative_surface_with_logs <- cumulative_surface %>%
  mutate(
     log_area = log10(Area),
    # Create a unique identifier for each Trial-Sample combination
    Sample_Trial = paste("Trial", Trial, "Sample", Sample, sep = "_"),
    # Calculate log_count, handling zeros to avoid -Inf
    log_count = ifelse(Cumulative_Count > 0, log10(Cumulative_Count), NA),
    # Calculate log_scatter, handling zeros to avoid -Inf
    log_scatter = ifelse(Cumulative_Scatter > 0, log10(Cumulative_Scatter), NA)
  ) %>%
  # Remove the original grouping columns as they are now in Sample_Trial
  select(Area,log_area, Sample_Trial, Cumulative_Count, log_count, Cumulative_Scatter, log_scatter) 

surface_cumcount_summary <- cumulative_surface_with_logs %>%
  # Select only the columns needed for the count summary
  select(Area,log_area, Sample_Trial, Cumulative_Count) %>%
  # Pivot the data to a wide format
  pivot_wider(names_from = Sample_Trial, values_from = Cumulative_Count) %>%
  # Arrange by Area for consistency
  arrange(Area) %>%
  # Group by row to calculate the standard deviation across columns
  rowwise() %>%
  # Create columns for SD, sample size (n), and standard error
  mutate(
    # Standard deviations
    SD_log_count_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_count_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_count_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_count_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_count_9_12 = ifelse(n_log_count_9_12 > 1, SD_log_count_9_12 / sqrt(n_log_count_9_12), NA),
    SE_log_count_13_14 = ifelse(n_log_count_13_14 > 1, SD_log_count_13_14 / sqrt(n_log_count_13_14), NA)) %>%
  # Ungroup to return to a standard tibble
  ungroup()

# Create the summary data frame for log_scatter
surface_cumscatter_summary <- cumulative_surface_with_logs %>%
  # Select only the columns needed for the scatter summary
  select(Area,log_area, Sample_Trial, Cumulative_Scatter) %>%
  # Pivot the data to a wide format
  pivot_wider(names_from = Sample_Trial, values_from = Cumulative_Scatter) %>%
  # Arrange by Area for consistency
  arrange(Area) %>%
  # Group by row to calculate the standard deviation across columns
  rowwise() %>%
  # Create columns for SD, sample size (n), and standard error
  mutate(
    # Standard deviations
    SD_log_scatter_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_scatter_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_scatter_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_scatter_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_scatter_9_12 = ifelse(n_log_scatter_9_12 > 1, SD_log_scatter_9_12 / sqrt(n_log_scatter_9_12), NA),
    SE_log_scatter_13_14 = ifelse(n_log_scatter_13_14 > 1, SD_log_scatter_13_14 / sqrt(n_log_scatter_13_14), NA)
  ) %>%
  # Ungroup to return to a standard tibble
  ungroup()

#Binned

binned_surface_with_logs <- binned_surface %>%
  mutate(
    log_area = log10(Area),
    Sample_Trial = paste("Trial", Trial, "Sample", Sample, sep = "_"),
    log_count_bin = ifelse(Positive_Count_Diff > 0, log10(Positive_Count_Diff), NA),
    log_scatter_bin = ifelse(Positive_Scatter_Diff > 0, log10(Positive_Scatter_Diff), NA)
  ) %>%
  select(Area,log_area, Trial, Sample_Trial,Positive_Count_Diff, log_count_bin,Positive_Scatter_Diff, log_scatter_bin)

# Create the summary data frame for binned log_count
surface_bincount_summary <- binned_surface_with_logs %>%
  select(Area,log_area, Sample_Trial, Positive_Count_Diff) %>%
  pivot_wider(names_from = Sample_Trial, values_from = Positive_Count_Diff) %>%
  arrange(Area) %>%
  rowwise() %>%
  mutate(
    # Standard deviations
    SD_log_count_bin_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_count_bin_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_count_bin_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_count_bin_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_count_bin_9_12 = ifelse(n_log_count_bin_9_12 > 1, SD_log_count_bin_9_12 / sqrt(n_log_count_bin_9_12), NA),
    SE_log_count_bin_13_14 = ifelse(n_log_count_bin_13_14 > 1, SD_log_count_bin_13_14 / sqrt(n_log_count_bin_13_14), NA)) %>%
  ungroup()

# Create the summary data frame for binned log_scatter
surface_binscatter_summary <- binned_surface_with_logs %>%
  select(Area, log_area,Sample_Trial, Positive_Scatter_Diff) %>%
  pivot_wider(names_from = Sample_Trial, values_from = Positive_Scatter_Diff) %>%
  arrange(Area) %>%
  rowwise() %>%
  mutate(
    # Standard deviations
    SD_log_scatter_bin_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_scatter_bin_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_scatter_bin_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_scatter_bin_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_scatter_bin_9_12 = ifelse(n_log_scatter_bin_9_12 > 1, SD_log_scatter_bin_9_12 / sqrt(n_log_scatter_bin_9_12), NA),
    SE_log_scatter_bin_13_14 = ifelse(n_log_scatter_bin_13_14 > 1, SD_log_scatter_bin_13_14 / sqrt(n_log_scatter_bin_13_14), NA)
  ) %>%
  ungroup()

```

## 3. Edge Area Distribution Analysis

<!-- This section analyzes particle distributions on the edges of samples -->

```{r edge_area_distribution_analysis}

edge_particles_data <- edge_particles_data %>%
 filter(Area > 1, Area < 6000) 

# Calculate normalization factors for edge measurements
new_edge_factors<- edge_summary_data %>%
  group_by(Sample, Trial) %>%
  summarise(
    Total_Width = 0.316227766 / (sum(width)* 1e-6),  # Convert microns to meters
    .groups = "drop"
  )

# Calculate area-based counts for edge data using the same function as surface data
edge_counts <- edge_particles_data %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <-  new_edge_factors$Total_Width[new_edge_factors$Sample == .y$Sample & new_edge_factors$Trial == .y$Trial]
    get_area_counts(.x, area_thresholds, norm_factor)
  })

# Calculate cumulative counts (particles larger than each threshold)
cumulative_edge <- edge_counts %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Count),
         Cumulative_Scatter = cumsum(Scatter_Area),
         Cumulative_Count_nn = cumsum(Count_nn),
         Cumulative_Scatter_nn = cumsum(Scatter_Area_nn)) %>%
  ungroup()

# Calculate cumulative counts (particles larger than each threshold)
binned_edge <- edge_counts %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  ungroup()

# Calculate average counts by trial to reduce sample variation
average_edge_cumulative <- cumulative_edge %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter, na.rm = TRUE),
    Average_Count_nn = mean(Cumulative_Count_nn, na.rm = TRUE),
    Average_Scatter_nn = mean(Cumulative_Scatter_nn, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)),
         log_count_nn = ifelse(Average_Count_nn == 0, -3, log10(Average_Count_nn)),
         log_scatter_nn = ifelse(Average_Scatter_nn == 0, -3, log10(Average_Scatter_nn))) %>% 
  arrange(Trial, desc(Area)) 

edge_9 <- average_edge_cumulative %>% 
  filter( Trial == 9)

edge_10 <- average_edge_cumulative %>% 
  filter( Trial == 10)

edge_11 <- average_edge_cumulative %>% 
  filter( Trial == 11)

edge_12 <- average_edge_cumulative %>% 
  filter( Trial == 12)

edge_13 <- average_edge_cumulative %>% 
  filter( Trial == 13)

edge_14 <- average_edge_cumulative %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
edge_average <- bind_rows(edge_9, edge_10, edge_11, edge_12) %>%
  group_by(Area, log_area) %>%
  summarize(
       Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

edge_average_air <- bind_rows(edge_13, edge_14) %>%
  group_by(Area, log_area) %>%
  summarize(
       Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )%>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Calculate average counts by trial to reduce noise from individual samples
average_edge_binned <- binned_edge %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Count_nn = mean(Count_nn, na.rm = TRUE),
    Average_Scatter = mean(Scatter_Area, na.rm = TRUE),
    Average_Scatter_nn = mean(Scatter_Area_nn, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_count_bin_nn = ifelse(Average_Count_nn == 0, -3, log10(Average_Count_nn)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)),
         log_scatter_bin_nn = ifelse(Average_Scatter_nn == 0, -3, log10(Average_Scatter_nn)))


edge_9_binned <- average_edge_binned %>% 
  filter( Trial == 9)

edge_10_binned <- average_edge_binned %>% 
  filter( Trial == 10)

edge_11_binned <- average_edge_binned %>% 
  filter( Trial == 11)

edge_12_binned <- average_edge_binned %>% 
  filter( Trial == 12)

edge_13_binned <- average_edge_binned %>% 
  filter( Trial == 13)

edge_14_binned <- average_edge_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
edge_average_binned <- bind_rows(edge_9_binned, edge_10_binned, edge_11_binned, edge_12_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
      Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

edge_average_air_binned <- bind_rows(edge_13_binned, edge_14_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
      Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Standard Error Additions

# Cumulative
cumulative_edge_with_logs <- cumulative_edge %>%
  mutate(
    log_area = log10(Area),
    # Create a unique identifier for each Trial-Sample combination
    Sample_Trial = paste("Trial", Trial, "Sample", Sample, sep = "_"),
    # Calculate log_count, handling zeros to avoid -Inf
    log_count = ifelse(Cumulative_Count > 0, log10(Cumulative_Count), NA),
    # Calculate log_scatter, handling zeros to avoid -Inf
    log_scatter = ifelse(Cumulative_Scatter > 0, log10(Cumulative_Scatter), NA)
  ) %>%
  # Remove the original grouping columns as they are now in Sample_Trial
  select(Area,log_area, Sample_Trial,Cumulative_Count, log_count,Cumulative_Scatter, log_scatter)

edge_cumcount_summary <- cumulative_edge_with_logs %>%
  # Select only the columns needed for the count summary
  select(Area, log_area,Sample_Trial, Cumulative_Count) %>%
  # Pivot the data to a wide format
  pivot_wider(names_from = Sample_Trial, values_from = Cumulative_Count) %>%
  # Arrange by Area for consistency
  arrange(Area) %>%
  # Group by row to calculate the standard deviation across columns
  rowwise() %>%
  # Create columns for SD, sample size (n), and standard error
  mutate(
    # Standard deviations
    SD_log_count_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_count_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_count_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_count_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_count_9_12 = ifelse(n_log_count_9_12 > 1, SD_log_count_9_12 / sqrt(n_log_count_9_12), NA),
    SE_log_count_13_14 = ifelse(n_log_count_13_14 > 1, SD_log_count_13_14 / sqrt(n_log_count_13_14), NA)) %>%
  # Ungroup to return to a standard tibble
  ungroup()

# Create the summary data frame for log_scatter
edge_cumscatter_summary <- cumulative_edge_with_logs %>%
  # Select only the columns needed for the scatter summary
  select(Area, log_area,Sample_Trial, Cumulative_Scatter) %>%
  # Pivot the data to a wide format
  pivot_wider(names_from = Sample_Trial, values_from = Cumulative_Scatter) %>%
  # Arrange by Area for consistency
  arrange(Area) %>%
  # Group by row to calculate the standard deviation across columns
  rowwise() %>%
  # Create columns for SD, sample size (n), and standard error
  mutate(
    # Standard deviations
    SD_log_scatter_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_scatter_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_scatter_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_scatter_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_scatter_9_12 = ifelse(n_log_scatter_9_12 > 1, SD_log_scatter_9_12 / sqrt(n_log_scatter_9_12), NA),
    SE_log_scatter_13_14 = ifelse(n_log_scatter_13_14 > 1, SD_log_scatter_13_14 / sqrt(n_log_scatter_13_14), NA)
  ) %>%
  # Ungroup to return to a standard tibble
  ungroup()

#Binned

binned_edge_with_logs <- binned_edge %>%
  mutate(
    log_area = log10(Area),
    Sample_Trial = paste("Trial", Trial, "Sample", Sample, sep = "_"),
    log_count_bin = ifelse(Count > 0, log10(Count), NA),
    log_scatter_bin = ifelse(Scatter_Area > 0, log10(Scatter_Area), NA)
  ) %>%
  select(Area, log_area,Trial, Sample_Trial,Count, log_count_bin,Scatter_Area, log_scatter_bin)

# Create the summary data frame for binned log_count
edge_bincount_summary <- binned_edge_with_logs %>%
  select(Area, log_area,Sample_Trial, Count) %>%
  pivot_wider(names_from = Sample_Trial, values_from = Count) %>%
  arrange(Area) %>%
  rowwise() %>%
  mutate(
    # Standard deviations
    SD_log_count_bin_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_count_bin_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_count_bin_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_count_bin_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_count_bin_9_12 = ifelse(n_log_count_bin_9_12 > 1, SD_log_count_bin_9_12 / sqrt(n_log_count_bin_9_12), NA),
    SE_log_count_bin_13_14 = ifelse(n_log_count_bin_13_14 > 1, SD_log_count_bin_13_14 / sqrt(n_log_count_bin_13_14), NA)) %>%
  ungroup()

# Create the summary data frame for binned log_scatter
edge_binscatter_summary <- binned_edge_with_logs %>%
  select(Area, log_area,Sample_Trial, Scatter_Area) %>%
  pivot_wider(names_from = Sample_Trial, values_from = Scatter_Area) %>%
  arrange(Area) %>%
  rowwise() %>%
  mutate(
    # Standard deviations
    SD_log_scatter_bin_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_scatter_bin_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_scatter_bin_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_scatter_bin_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_scatter_bin_9_12 = ifelse(n_log_scatter_bin_9_12 > 1, SD_log_scatter_bin_9_12 / sqrt(n_log_scatter_bin_9_12), NA),
    SE_log_scatter_bin_13_14 = ifelse(n_log_scatter_bin_13_14 > 1, SD_log_scatter_bin_13_14 / sqrt(n_log_scatter_bin_13_14), NA)
  ) %>%
  ungroup()

```

## 4. Calibration Wafer Analysis - Edge

<!-- This section analyzes particle distributions on calibration wafer edges for comparison with sample edges -->

```{r calibration_wafer_analysis_edge}

calibration_particles_data <- calibration_particles_data %>%
 filter(Area > 1, Area < 6000) 

# Calculate normalization factors for edge measurements
new_calibration_factors<- calibration_summary_data %>%
  group_by(Sample, Trial) %>%
  summarise(
    Total_Width = 0.316227766 / (sum(width)* 1e-6),  # Convert microns to meters
    .groups = "drop"
  )

# Filter qualified particles and associate them with the correct image
cw_particles_data_edge <- calibration_particles_data %>%
  filter(IsQualified == 1) %>%
  group_by(Sample, Trial) %>%
  mutate(
    ParticleIndex = row_number(),
    # Find which image a particle belongs to based on cumulative counts
    Image = findInterval(ParticleIndex, calibration_summary_data$CumulativeCount[calibration_summary_data$Sample == first(Sample) & calibration_summary_data$Trial == first(Trial)]) + 1
  ) %>%
  ungroup()


# Calculate area-based counts for edge data using the same function as surface data
cw_edge_counts <- cw_particles_data_edge %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <- new_calibration_factors$Total_Width[new_calibration_factors$Sample == .y$Sample & new_calibration_factors$Trial == .y$Trial]
    get_area_counts(.x, area_thresholds, norm_factor)
  })

# Calculate cumulative counts (particles larger than each threshold)
cw_cumulative_edge <- cw_edge_counts %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Count),
         Cumulative_Scatter = cumsum(Scatter_Area)) %>%
  ungroup()

# Calculate cumulative counts (particles larger than each threshold)
cw_binned_edge <- cw_edge_counts %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  ungroup()

# Calculate average counts by trial to reduce sample variation
cw_average_edge_cumulative <- cw_cumulative_edge %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter))) %>% 
  arrange(Trial, desc(Area)) 

cw_edge_9 <- cw_average_edge_cumulative %>% 
  filter( Trial == 9)

cw_edge_10 <- cw_average_edge_cumulative %>% 
  filter( Trial == 10)

cw_edge_11 <- cw_average_edge_cumulative %>% 
  filter( Trial == 11)

cw_edge_12 <- cw_average_edge_cumulative %>% 
  filter( Trial == 12)

cw_edge_13 <- cw_average_edge_cumulative %>% 
  filter( Trial == 13)

cw_edge_14 <- cw_average_edge_cumulative %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
cw_edge_average <- bind_rows(cw_edge_9, cw_edge_10, cw_edge_11, cw_edge_12) %>%
  group_by(Area, log_area) %>%
  summarize(
       Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

cw_edge_average_air <- bind_rows(cw_edge_13, cw_edge_14) %>%
  group_by(Area, log_area) %>%
  summarize(
       Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )%>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Calculate average counts by trial to reduce noise from individual samples
cw_average_edge_binned <- cw_binned_edge %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter_Area, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))


cw_edge_9_binned <- cw_average_edge_binned %>% 
  filter( Trial == 9)

cw_edge_10_binned <- cw_average_edge_binned %>% 
  filter( Trial == 10)

cw_edge_11_binned <- cw_average_edge_binned %>% 
  filter( Trial == 11)

cw_edge_12_binned <- cw_average_edge_binned %>% 
  filter( Trial == 12)

cw_edge_13_binned <- cw_average_edge_binned %>% 
  filter( Trial == 13)

cw_edge_14_binned <- cw_average_edge_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
cw_edge_average_binned <- bind_rows(cw_edge_9_binned, cw_edge_10_binned, cw_edge_11_binned, cw_edge_12_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
      Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )%>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

cw_edge_average_air_binned <- bind_rows(cw_edge_13_binned, cw_edge_14_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
      Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )%>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Standard Error Additions

# Cumulative
cumulative_cwedge_with_logs <- cw_cumulative_edge %>%
  mutate(
    log_area = log10(Area),
    # Create a unique identifier for each Trial-Sample combination
    Sample_Trial = paste("Trial", Trial, "Sample", Sample, sep = "_"),
    # Calculate log_count, handling zeros to avoid -Inf
    log_count = ifelse(Cumulative_Count > 0, log10(Cumulative_Count), NA),
    # Calculate log_scatter, handling zeros to avoid -Inf
    log_scatter = ifelse(Cumulative_Scatter > 0, log10(Cumulative_Scatter), NA)
  ) %>%
  # Remove the original grouping columns as they are now in Sample_Trial
  select(Area,log_area, Sample_Trial,Cumulative_Count, log_count,Cumulative_Scatter, log_scatter)

cwedge_cumcount_summary <- cumulative_cwedge_with_logs %>%
  # Select only the columns needed for the count summary
  select(Area,log_area, Sample_Trial, Cumulative_Count) %>%
  # Pivot the data to a wide format
  pivot_wider(names_from = Sample_Trial, values_from = Cumulative_Count) %>%
  # Arrange by Area for consistency
  arrange(Area) %>%
  # Group by row to calculate the standard deviation across columns
  rowwise() %>%
  # Create columns for SD, sample size (n), and standard error
  mutate(
    # Standard deviations
    SD_log_count_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_count_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_count_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_count_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_count_9_12 = ifelse(n_log_count_9_12 > 1, SD_log_count_9_12 / sqrt(n_log_count_9_12), NA),
    SE_log_count_13_14 = ifelse(n_log_count_13_14 > 1, SD_log_count_13_14 / sqrt(n_log_count_13_14), NA)) %>%
  # Ungroup to return to a standard tibble
  ungroup()

# Create the summary data frame for log_scatter
cwedge_cumscatter_summary <- cumulative_cwedge_with_logs %>%
  # Select only the columns needed for the scatter summary
  select(Area, log_area,Sample_Trial, Cumulative_Scatter) %>%
  # Pivot the data to a wide format
  pivot_wider(names_from = Sample_Trial, values_from = Cumulative_Scatter) %>%
  # Arrange by Area for consistency
  arrange(Area) %>%
  # Group by row to calculate the standard deviation across columns
  rowwise() %>%
  # Create columns for SD, sample size (n), and standard error
  mutate(
    # Standard deviations
    SD_log_scatter_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_scatter_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_scatter_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_scatter_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_scatter_9_12 = ifelse(n_log_scatter_9_12 > 1, SD_log_scatter_9_12 / sqrt(n_log_scatter_9_12), NA),
    SE_log_scatter_13_14 = ifelse(n_log_scatter_13_14 > 1, SD_log_scatter_13_14 / sqrt(n_log_scatter_13_14), NA)
  ) %>%
  # Ungroup to return to a standard tibble
  ungroup()

#Binned

binned_cwedge_with_logs <- cw_binned_edge %>%
  mutate(
    log_area = log10(Area),
    Sample_Trial = paste("Trial", Trial, "Sample", Sample, sep = "_"),
    log_count_bin = ifelse(Count > 0, log10(Count), NA),
    log_scatter_bin = ifelse(Scatter_Area > 0, log10(Scatter_Area), NA)
  ) %>%
  select(Area,log_area, Trial, Sample_Trial,Count, log_count_bin,Scatter_Area, log_scatter_bin)

# Create the summary data frame for binned log_count
cwedge_bincount_summary <- binned_cwedge_with_logs %>%
  select(Area,log_area, Sample_Trial, Count) %>%
  pivot_wider(names_from = Sample_Trial, values_from = Count) %>%
  arrange(Area) %>%
  rowwise() %>%
  mutate(
    # Standard deviations
    SD_log_count_bin_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_count_bin_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_count_bin_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_count_bin_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_count_bin_9_12 = ifelse(n_log_count_bin_9_12 > 1, SD_log_count_bin_9_12 / sqrt(n_log_count_bin_9_12), NA),
    SE_log_count_bin_13_14 = ifelse(n_log_count_bin_13_14 > 1, SD_log_count_bin_13_14 / sqrt(n_log_count_bin_13_14), NA)) %>%
  ungroup()

# Create the summary data frame for binned log_scatter
cwedge_binscatter_summary <- binned_cwedge_with_logs %>%
  select(Area,log_area, Sample_Trial, Scatter_Area) %>%
  pivot_wider(names_from = Sample_Trial, values_from = Scatter_Area) %>%
  arrange(Area) %>%
  rowwise() %>%
  mutate(
    # Standard deviations
    SD_log_scatter_bin_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_scatter_bin_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_scatter_bin_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_scatter_bin_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_scatter_bin_9_12 = ifelse(n_log_scatter_bin_9_12 > 1, SD_log_scatter_bin_9_12 / sqrt(n_log_scatter_bin_9_12), NA),
    SE_log_scatter_bin_13_14 = ifelse(n_log_scatter_bin_13_14 > 1, SD_log_scatter_bin_13_14 / sqrt(n_log_scatter_bin_13_14), NA)
  ) %>%
  ungroup()

```

## 5. Calibration Surface Analysis

<!-- This section analyzes particle distributions on calibration wafer surfaces -->

```{r cal_surface_area_distribution_analysis}
# Filter surface particles by minimum area (1 )
Cwsurface_before_data$particle_data <- Cwsurface_before_data$particle_data %>%
 filter(Area > 1, Area < 6000) 

Cwsurface_after_data$particle_data <- Cwsurface_after_data$particle_data %>%
 filter(Area > 1, Area < 6000) 


cw_new_sample_areas <- Cwsurface_before_data$summary_data %>%
  group_by(Sample, Trial, Cleaning_Method) %>%
  summarise(
    Total_Images = n(),
    Total_Area = 0.1 / (n() * image_size * 1e-12),  # Convert to m^2
    .groups = "drop"
  )

# Calculate area-based counts for before and after data
# Normalizes each sample to 0.1 m² for standardized comparison
cw_surface_before_counts <- Cwsurface_before_data$particle_data %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <-  cw_new_sample_areas$Total_Area[cw_new_sample_areas$Sample == .y$Sample &  cw_new_sample_areas$Trial == .y$Trial]
    get_area_counts(.x,area_thresholds, norm_factor)
  })

cw_surface_after_counts <- Cwsurface_after_data$particle_data %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <-   cw_new_sample_areas$Total_Area[cw_new_sample_areas$Sample == .y$Sample &  cw_new_sample_areas$Trial == .y$Trial]
  get_area_counts(.x, area_thresholds, norm_factor)
  })

# Calculate differences (after - before) to get contamination effect
# and find positive differences (actual contamination)
cw_surface_diff <- cw_surface_after_counts %>%
  full_join(cw_surface_before_counts, 
            by = c("Trial", "Sample", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Scatter_Diff = Scatter_Area_After - Scatter_Area_Before,
         Positive_Count_Diff = pmax(Count_Diff, 0),
         Positive_Scatter_Diff = pmax(Scatter_Diff, 0))

# Calculate cumulative counts (running sum of particles larger than threshold)
cw_cumulative_surface <- cw_surface_diff %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Positive_Count_Diff),
         Cumulative_Scatter = cumsum(Positive_Scatter_Diff)) %>%
  ungroup()

cw_binned_surface <- cw_surface_diff %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  ungroup()

# Calculate average counts by trial to reduce noise from individual samples
cw_average_surface_cumulative <- cw_cumulative_surface %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Extract trial 12 data for later comparison
cw_surface_9 <- cw_average_surface_cumulative %>% 
  filter( Trial == 9)

cw_surface_10 <- cw_average_surface_cumulative %>% 
  filter( Trial == 10)

cw_surface_11 <- cw_average_surface_cumulative %>% 
  filter( Trial == 11)

cw_surface_12 <- cw_average_surface_cumulative %>% 
  filter( Trial == 12)

cw_surface_13 <- cw_average_surface_cumulative %>% 
  filter( Trial == 13)

cw_surface_14 <- cw_average_surface_cumulative %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
cw_surface_average <- bind_rows(cw_surface_9, cw_surface_10, cw_surface_11, cw_surface_12) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )%>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

cw_surface_average_air <- bind_rows(cw_surface_13, cw_surface_14) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )%>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Calculate average counts by trial to reduce noise from individual samples
cw_average_surface_binned <- cw_binned_surface %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Positive_Count_Diff, na.rm = TRUE),
    Average_Scatter = mean(Positive_Scatter_Diff, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Extract trials binned data for later comparison
cw_surface_9_binned <- cw_average_surface_binned %>% 
  filter( Trial == 9)

cw_surface_10_binned <- cw_average_surface_binned %>% 
  filter( Trial == 10)

cw_surface_11_binned <- cw_average_surface_binned %>% 
  filter( Trial == 11)

cw_surface_12_binned <- cw_average_surface_binned %>% 
  filter( Trial == 12)

cw_surface_13_binned <- cw_average_surface_binned %>% 
  filter( Trial == 13)

cw_surface_14_binned <- cw_average_surface_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
cw_surface_average_binned <- bind_rows(cw_surface_9_binned, cw_surface_10_binned, cw_surface_11_binned, cw_surface_12_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )%>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

cw_surface_average_air_binned <- bind_rows(cw_surface_13_binned, cw_surface_14_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )%>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Standard Error Additions

# Cumulative
cumulative_cwsurf_with_logs <- cw_cumulative_surface %>%
  mutate(
    log_area = log10(Area),
    # Create a unique identifier for each Trial-Sample combination
    Sample_Trial = paste("Trial", Trial, "Sample", Sample, sep = "_"),
    # Calculate log_count, handling zeros to avoid -Inf
    log_count = ifelse(Cumulative_Count > 0, log10(Cumulative_Count), NA),
    # Calculate log_scatter, handling zeros to avoid -Inf
    log_scatter = ifelse(Cumulative_Scatter > 0, log10(Cumulative_Scatter), NA)
  ) %>%
  # Remove the original grouping columns as they are now in Sample_Trial
  select(Area, log_area,Sample_Trial, log_count, log_scatter)

cwsurf_cumcount_summary <- cumulative_cwsurf_with_logs %>%
  # Select only the columns needed for the count summary
  select(Area,log_area, Sample_Trial, log_count) %>%
  # Pivot the data to a wide format
  pivot_wider(names_from = Sample_Trial, values_from = log_count) %>%
  # Arrange by Area for consistency
  arrange(Area) %>%
  # Group by row to calculate the standard deviation across columns
  rowwise() %>%
  # Create columns for SD, sample size (n), and standard error
  mutate(
    # Standard deviations
    SD_log_count_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_count_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_count_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_count_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_count_9_12 = ifelse(n_log_count_9_12 > 1, SD_log_count_9_12 / sqrt(n_log_count_9_12), NA),
    SE_log_count_13_14 = ifelse(n_log_count_13_14 > 1, SD_log_count_13_14 / sqrt(n_log_count_13_14), NA)
  ) %>%
  # Ungroup to return to a standard tibble
  ungroup()

# Create the summary data frame for log_scatter
cwsurf_cumscatter_summary <- cumulative_cwsurf_with_logs %>%
  # Select only the columns needed for the scatter summary
  select(Area,log_area, Sample_Trial, log_scatter) %>%
  # Pivot the data to a wide format
  pivot_wider(names_from = Sample_Trial, values_from = log_scatter) %>%
  # Arrange by Area for consistency
  arrange(Area) %>%
  # Group by row to calculate the standard deviation across columns
  rowwise() %>%
  # Create columns for SD, sample size (n), and standard error
  mutate(
    # Standard deviations
    SD_log_scatter_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_scatter_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_scatter_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_scatter_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_scatter_9_12 = ifelse(n_log_scatter_9_12 > 1, SD_log_scatter_9_12 / sqrt(n_log_scatter_9_12), NA),
    SE_log_scatter_13_14 = ifelse(n_log_scatter_13_14 > 1, SD_log_scatter_13_14 / sqrt(n_log_scatter_13_14), NA)
  ) %>%
  # Ungroup to return to a standard tibble
  ungroup()

#Binned

binned_cwsurf_with_logs <- cw_binned_surface %>%
  mutate(
    log_area = log10(Area),
    Sample_Trial = paste("Trial", Trial, "Sample", Sample, sep = "_"),
    log_count_bin = ifelse(Positive_Count_Diff > 0, log10(Positive_Count_Diff), NA),
    log_scatter_bin = ifelse(Positive_Scatter_Diff > 0, log10(Positive_Scatter_Diff), NA)
  ) %>%
  select(Area,log_area, Trial, Sample_Trial, log_count_bin, log_scatter_bin)

# Create the summary data frame for binned log_count
cwsurf_bincount_summary <- binned_cwsurf_with_logs %>%
  select(Area,log_area, Sample_Trial, log_count_bin) %>%
  pivot_wider(names_from = Sample_Trial, values_from = log_count_bin) %>%
  arrange(Area) %>%
  rowwise() %>%
  mutate(
    # Standard deviations
    SD_log_count_bin_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_count_bin_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_count_bin_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_count_bin_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_count_bin_9_12 = ifelse(n_log_count_bin_9_12 > 1, SD_log_count_bin_9_12 / sqrt(n_log_count_bin_9_12), NA),
    SE_log_count_bin_13_14 = ifelse(n_log_count_bin_13_14 > 1, SD_log_count_bin_13_14 / sqrt(n_log_count_bin_13_14), NA)
  ) %>%
  ungroup()

# Create the summary data frame for binned log_scatter
cwsurf_binscatter_summary <- binned_cwsurf_with_logs %>%
  select(Area, log_area,Sample_Trial, log_scatter_bin) %>%
  pivot_wider(names_from = Sample_Trial, values_from = log_scatter_bin) %>%
  arrange(Area) %>%
  rowwise() %>%
  mutate(
    # Standard deviations
    SD_log_scatter_bin_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_scatter_bin_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_scatter_bin_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_scatter_bin_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_scatter_bin_9_12 = ifelse(n_log_scatter_bin_9_12 > 1, SD_log_scatter_bin_9_12 / sqrt(n_log_scatter_bin_9_12), NA),
    SE_log_scatter_bin_13_14 = ifelse(n_log_scatter_bin_13_14 > 1, SD_log_scatter_bin_13_14 / sqrt(n_log_scatter_bin_13_14), NA)
  ) %>%
  ungroup()

```

## 6. Witness Surface Analysis

<!-- This section analyzes particle distributions on calibration wafer surfaces -->

```{r wit_surface_area_distribution_analysis}
# Filter surface particles by minimum area (1 )
wit_surface_before_particles <- Witsurface_before_data$particle_data %>%
 filter(Area > 1, Area < 6000) 

wit_surface_after_particles <- Witsurface_after_data$particle_data %>%
 filter(Area > 1, Area < 6000) 

wit_combined_surface_data <- bind_rows(wit_surface_before_particles,wit_surface_after_particles)

wit_new_sample_areas <- Witsurface_before_data$summary_data %>%
  group_by(Trial, Cleaning_Method) %>%
  summarise(
    Total_Images = n(),
    Total_Area = 0.1 / (n() * image_size * 1e-12),  # Convert to m^2
    .groups = "drop"
  )

# Calculate area-based counts for before and after data
# Normalizes each sample to 0.1 m² for standardized comparison
# Get all unique trials from your factors table and convert to character
all_trials <- unique(wit_new_sample_areas$Trial)

# Create results for all trials, handling empty data
wit_surface_before_counts <- tibble(Trial = all_trials) %>%
  group_by(Trial) %>%
  group_modify(~ {
    current_trial <- .y$Trial
    
    # Get the subset of data for this trial
    trial_data <- wit_surface_before_particles %>% filter(Trial == current_trial)
    
    # Get normalization factor for this trial
    norm_factor <-  wit_new_sample_areas$Total_Area[wit_new_sample_areas$Trial == current_trial]
    
    # If no data for this trial, create zero counts for all area thresholds
    if (nrow(trial_data) == 0) {
      tibble(
        Area = area_thresholds,
        Count = 0,
        Scatter_Area = 0
      )
    } else {
      # Process normally if data exists
      get_area_counts(trial_data, area_thresholds, norm_factor)
    }
  })

wit_surface_after_counts <- Witsurface_after_data$particle_data %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <-  wit_new_sample_areas$Total_Area[wit_new_sample_areas$Trial == .y$Trial]
  get_area_counts(.x, area_thresholds, norm_factor)
  })

# Calculate differences (after - before) to get contamination effect
# and find positive differences (actual contamination)
wit_surface_diff <- wit_surface_after_counts %>%
  full_join(wit_surface_before_counts, 
            by = c("Trial", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Scatter_Diff = Scatter_Area_After - Scatter_Area_Before,
         Positive_Count_Diff = pmax(Count_Diff, 0),
         Positive_Scatter_Diff = pmax(Scatter_Diff, 0))

# Calculate cumulative counts (running sum of particles larger than threshold)
wit_cumulative_surface <- wit_surface_diff %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Positive_Count_Diff),
         Cumulative_Scatter = cumsum(Positive_Scatter_Diff)) %>%
  ungroup()

wit_binned_surface <- wit_surface_diff %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%
  ungroup()

# Calculate average counts by trial to reduce noise from individual samples
wit_average_surface_cumulative <- wit_cumulative_surface %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Extract trial 12 data for later comparison
wit_surface_9 <- wit_average_surface_cumulative %>% 
  filter( Trial == 9)

wit_surface_10 <- wit_average_surface_cumulative %>% 
  filter( Trial == 10)

wit_surface_11 <- wit_average_surface_cumulative %>% 
  filter( Trial == 11)

wit_surface_12 <- wit_average_surface_cumulative %>% 
  filter( Trial == 12)

wit_surface_13 <- wit_average_surface_cumulative %>% 
  filter( Trial == 13)

wit_surface_14 <- wit_average_surface_cumulative %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
wit_surface_average <- bind_rows(wit_surface_9, wit_surface_10, wit_surface_11, wit_surface_12) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

wit_surface_average_air <- bind_rows(wit_surface_13, wit_surface_14) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Calculate average counts by trial to reduce noise from individual samples
wit_average_surface_binned <- wit_binned_surface %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Positive_Count_Diff, na.rm = TRUE),
    Average_Scatter = mean(Positive_Scatter_Diff, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Extract trials binned data for later comparison
wit_surface_9_binned <- wit_average_surface_binned %>% 
  filter( Trial == 9)

wit_surface_10_binned <- wit_average_surface_binned %>% 
  filter( Trial == 10)

wit_surface_11_binned <- wit_average_surface_binned %>% 
  filter( Trial == 11)

wit_surface_12_binned <- wit_average_surface_binned %>% 
  filter( Trial == 12)

wit_surface_13_binned <- wit_average_surface_binned %>% 
  filter( Trial == 13)

wit_surface_14_binned <- wit_average_surface_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
wit_surface_average_binned <- bind_rows(wit_surface_9_binned, wit_surface_10_binned, wit_surface_11_binned, wit_surface_12_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

wit_surface_average_air_binned <- bind_rows(wit_surface_13_binned, wit_surface_14_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Standard Error Additions

# Cumulative
cumulative_witsurf_with_logs <- wit_cumulative_surface %>%
  mutate(
    log_area = log10(Area),
    # Create a unique identifier for each Trial-Sample combination
    Sample_Trial = paste("Trial", Trial, sep = "_"),
    # Calculate log_count, handling zeros to avoid -Inf
    log_count = ifelse(Cumulative_Count > 0, log10(Cumulative_Count), NA),
    # Calculate log_scatter, handling zeros to avoid -Inf
    log_scatter = ifelse(Cumulative_Scatter > 0, log10(Cumulative_Scatter), NA)
  ) %>%
  # Remove the original grouping columns as they are now in Sample_Trial
  select(Area,log_area, Sample_Trial, log_count, log_scatter)

witsurf_cumcount_summary <- cumulative_witsurf_with_logs %>%
  # Select only the columns needed for the count summary
  select(Area,log_area, Sample_Trial, log_count) %>%
  # Pivot the data to a wide format
  pivot_wider(names_from = Sample_Trial, values_from = log_count) %>%
  # Arrange by Area for consistency
  arrange(Area) %>%
  # Group by row to calculate the standard deviation across columns
  rowwise() %>%
  # Create columns for SD, sample size (n), and standard error
  mutate(
    # Standard deviations
    SD_log_count_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)")), na.rm = TRUE),
    SD_log_count_13_14 = sd(c_across(matches("^Trial_(13|14)")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_count_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)")))),
    n_log_count_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_count_9_12 = ifelse(n_log_count_9_12 > 1, SD_log_count_9_12 / sqrt(n_log_count_9_12), NA),
    SE_log_count_13_14 = ifelse(n_log_count_13_14 > 1, SD_log_count_13_14 / sqrt(n_log_count_13_14), NA)
  ) %>%
  # Ungroup to return to a standard tibble
  ungroup()

# Create the summary data frame for log_scatter
witsurf_cumscatter_summary <- cumulative_witsurf_with_logs %>%
  # Select only the columns needed for the scatter summary
  select(Area, log_area,Sample_Trial, log_scatter) %>%
  # Pivot the data to a wide format
  pivot_wider(names_from = Sample_Trial, values_from = log_scatter) %>%
  # Arrange by Area for consistency
  arrange(Area) %>%
  # Group by row to calculate the standard deviation across columns
  rowwise() %>%
  # Create columns for SD, sample size (n), and standard error
  mutate(
    # Standard deviations
    SD_log_scatter_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)")), na.rm = TRUE),
    SD_log_scatter_13_14 = sd(c_across(matches("^Trial_(13|14)")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_scatter_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)")))),
    n_log_scatter_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_scatter_9_12 = ifelse(n_log_scatter_9_12 > 1, SD_log_scatter_9_12 / sqrt(n_log_scatter_9_12), NA),
    SE_log_scatter_13_14 = ifelse(n_log_scatter_13_14 > 1, SD_log_scatter_13_14 / sqrt(n_log_scatter_13_14), NA)
  ) %>%
  # Ungroup to return to a standard tibble
  ungroup()

#Binned

binned_witsurf_with_logs <- wit_binned_surface %>%
  mutate(
    log_area = log10(Area),
    Sample_Trial = paste("Trial", Trial, sep = "_"),
    log_count_bin = ifelse(Positive_Count_Diff > 0, log10(Positive_Count_Diff), NA),
    log_scatter_bin = ifelse(Positive_Scatter_Diff > 0, log10(Positive_Scatter_Diff), NA)
  ) %>%
  select(Area,log_area, Trial, Sample_Trial, log_count_bin, log_scatter_bin)

# Create the summary data frame for binned log_count
witsurf_bincount_summary <- binned_witsurf_with_logs %>%
  select(Area,log_area, Sample_Trial, log_count_bin) %>%
  pivot_wider(names_from = Sample_Trial, values_from = log_count_bin) %>%
  arrange(Area) %>%
  rowwise() %>%
  mutate(
    # Standard deviations
    SD_log_count_bin_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)")), na.rm = TRUE),
    SD_log_count_bin_13_14 = sd(c_across(matches("^Trial_(13|14)")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_count_bin_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)")))),
    n_log_count_bin_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_count_bin_9_12 = ifelse(n_log_count_bin_9_12 > 1, SD_log_count_bin_9_12 / sqrt(n_log_count_bin_9_12), NA),
    SE_log_count_bin_13_14 = ifelse(n_log_count_bin_13_14 > 1, SD_log_count_bin_13_14 / sqrt(n_log_count_bin_13_14), NA)
  ) %>%
  ungroup()

# Create the summary data frame for binned log_scatter
witsurf_binscatter_summary <- binned_witsurf_with_logs %>%
  select(Area, log_area,Sample_Trial, log_scatter_bin) %>%
  pivot_wider(names_from = Sample_Trial, values_from = log_scatter_bin) %>%
  arrange(Area) %>%
  rowwise() %>%
  mutate(
    # Standard deviations
    SD_log_scatter_bin_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)")), na.rm = TRUE),
    SD_log_scatter_bin_13_14 = sd(c_across(matches("^Trial_(13|14)")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_scatter_bin_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)")))),
    n_log_scatter_bin_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_scatter_bin_9_12 = ifelse(n_log_scatter_bin_9_12 > 1, SD_log_scatter_bin_9_12 / sqrt(n_log_scatter_bin_9_12), NA),
    SE_log_scatter_bin_13_14 = ifelse(n_log_scatter_bin_13_14 > 1, SD_log_scatter_bin_13_14 / sqrt(n_log_scatter_bin_13_14), NA)
  ) %>%
  ungroup()

```

## 6. Edge Model Analysis

<!-- This section creates a model to predict edge contamination from surface contamination data -->

```{r edge_model_analysis}


# Calculate model parameters using area summation for after contamination
model_surface_after <- surface_after_data$particle_data %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <- (new_sample_areas$Total_Area[new_sample_areas$Sample == .y$Sample & new_sample_areas$Trial == .y$Trial])
    areas <- get_area_counts(.x, area_thresholds, norm_factor)
  }) 

# Calculate model parameters for before contamination
model_surface_before <- surface_before_data$particle_data %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <- new_sample_areas$Total_Area[new_sample_areas$Sample == .y$Sample & new_sample_areas$Trial == .y$Trial]
    areas <- get_area_counts(.x, area_thresholds, norm_factor)
  }) 

# Calculate differences to isolate contamination effect
model_surface_diff <- model_surface_after %>%
  full_join(model_surface_before, 
            by = c("Trial", "Sample", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Area_Diff = Scatter_Area_After - Scatter_Area_Before,
         Positive_Diff_Count = pmax(Count_Diff, 0),
         Positive_Diff_Area = pmax(Area_Diff, 0))

# Calculate model parameters using area-based approach
# This implements the surface-to-edge contamination model
model_edge_data <- model_surface_diff %>%
  group_by(Trial, Sample, Area) %>%
  mutate(
    # Calculate F = sum of particle areas / box area
    F = (Positive_Diff_Area * 1e-12) / (.1),
    
    # Calculate D (diameter) from Area
    D = (2 * sqrt(Area/pi))* 1e-6,
    
    # Calculate nl (number per unit length) = 4F/πD
    nl = (4 * F) / (pi * D),
    
    # Calculate total particles on edge
    Nedge = nl * 0.316227766,
    
    Scatter = Nedge * Area
  ) %>%
  ungroup()

# Calculate cumulative counts for modeled edge particles
model_cumulative_counts <- model_edge_data %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Nedge)) %>%
  mutate(Cumulative_Scatter = cumsum(Scatter)) %>% 
  ungroup()

# Calculate average modeled counts by trial
model_average_edge_cumulative <- model_cumulative_counts %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count = log10(Average_Count),
         log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = log10(Average_Scatter),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))


model_edge_9 <- model_average_edge_cumulative %>% 
  filter( Trial == 9)

model_edge_10 <- model_average_edge_cumulative %>% 
  filter( Trial == 10)

model_edge_11 <- model_average_edge_cumulative %>% 
  filter( Trial == 11)

model_edge_12 <- model_average_edge_cumulative %>% 
  filter( Trial == 12)

model_edge_13 <- model_average_edge_cumulative %>% 
  filter( Trial == 13)

model_edge_14 <- model_average_edge_cumulative %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
model_edge_average <- bind_rows(model_edge_9, model_edge_10, model_edge_11, model_edge_12) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

model_edge_average_air <- bind_rows(model_edge_13, model_edge_14) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

      
# Convert to binned data for size distribution analysis
model_average_edge_binned <- model_edge_data %>%
  group_by(Trial,Area) %>%
  arrange(desc(Area)) %>%  # Ensure data is sorted by descending area
 summarize(
    Average_Count = mean(Nedge, na.rm = TRUE),
    Average_Scatter = mean(Scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

model_edge_9_binned <- model_average_edge_binned %>% 
  filter( Trial == 9)

model_edge_10_binned <- model_average_edge_binned %>% 
  filter( Trial == 10)

model_edge_11_binned <- model_average_edge_binned %>% 
  filter( Trial == 11)

model_edge_12_binned <- model_average_edge_binned %>% 
  filter( Trial == 12)

model_edge_13_binned <- model_average_edge_binned %>% 
  filter( Trial == 13)

model_edge_14_binned <- model_average_edge_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
model_edge_average_binned <- bind_rows(model_edge_9_binned, model_edge_10_binned, model_edge_11_binned, model_edge_12_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Calculate the average of trials 9 through 12
model_edge_average_air_binned <- bind_rows(model_edge_13_binned, model_edge_14_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Standard Error Additions

# Cumulative
cumulative_modedge_with_logs <- model_cumulative_counts %>%
  mutate(
    log_area = log10(Area),
    # Create a unique identifier for each Trial-Sample combination
    Sample_Trial = paste("Trial", Trial, "Sample", Sample, sep = "_"),
    # Calculate log_count, handling zeros to avoid -Inf
    log_count = ifelse(Cumulative_Count > 0, log10(Cumulative_Count), NA),
    # Calculate log_scatter, handling zeros to avoid -Inf
    log_scatter = ifelse(Cumulative_Scatter > 0, log10(Cumulative_Scatter), NA)
  ) %>%
  # Remove the original grouping columns as they are now in Sample_Trial
  select(Area,log_area, Sample_Trial,Cumulative_Count, log_count,Cumulative_Scatter, log_scatter)

modedge_cumcount_summary <- cumulative_modedge_with_logs %>%
  # Select only the columns needed for the count summary
  select(Area,log_area, Sample_Trial, Cumulative_Count) %>%
  # Pivot the data to a wide format
  pivot_wider(names_from = Sample_Trial, values_from = Cumulative_Count) %>%
  # Arrange by Area for consistency
  arrange(Area) %>%
  # Group by row to calculate the standard deviation across columns
  rowwise() %>%
  # Create columns for SD, sample size (n), and standard error
  mutate(
    # Standard deviations
    SD_log_count_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_count_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_count_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_count_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_count_9_12 = ifelse(n_log_count_9_12 > 1, SD_log_count_9_12 / sqrt(n_log_count_9_12), NA),
    SE_log_count_13_14 = ifelse(n_log_count_13_14 > 1, SD_log_count_13_14 / sqrt(n_log_count_13_14), NA)) %>%
  # Ungroup to return to a standard tibble
  ungroup()

# Create the summary data frame for log_scatter
modedge_cumscatter_summary <- cumulative_modedge_with_logs %>%
  # Select only the columns needed for the scatter summary
  select(Area, log_area,Sample_Trial, Cumulative_Scatter) %>%
  # Pivot the data to a wide format
  pivot_wider(names_from = Sample_Trial, values_from = Cumulative_Scatter) %>%
  # Arrange by Area for consistency
  arrange(Area) %>%
  # Group by row to calculate the standard deviation across columns
  rowwise() %>%
  # Create columns for SD, sample size (n), and standard error
  mutate(
    # Standard deviations
    SD_log_scatter_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_scatter_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_scatter_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_scatter_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_scatter_9_12 = ifelse(n_log_scatter_9_12 > 1, SD_log_scatter_9_12 / sqrt(n_log_scatter_9_12), NA),
    SE_log_scatter_13_14 = ifelse(n_log_scatter_13_14 > 1, SD_log_scatter_13_14 / sqrt(n_log_scatter_13_14), NA)
  ) %>%
  # Ungroup to return to a standard tibble
  ungroup()

#Binned

binned_modedge_with_logs <- model_edge_data %>%
  mutate(
    log_area = log10(Area),
    Sample_Trial = paste("Trial", Trial, "Sample", Sample, sep = "_"),
    log_count_bin = ifelse(Nedge > 0, log10(Nedge), NA),
    log_scatter_bin = ifelse(Scatter > 0, log10(Scatter), NA)
  ) %>%
  select(Area,log_area, Trial, Sample_Trial, Nedge, log_count_bin,Scatter, log_scatter_bin)

# Create the summary data frame for binned log_count
modedge_bincount_summary <- binned_modedge_with_logs %>%
  select(Area,log_area, Sample_Trial, Nedge) %>%
  pivot_wider(names_from = Sample_Trial, values_from = Nedge) %>%
  arrange(Area) %>%
  rowwise() %>%
  mutate(
    # Standard deviations
    SD_log_count_bin_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_count_bin_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_count_bin_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_count_bin_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_count_bin_9_12 = ifelse(n_log_count_bin_9_12 > 1, SD_log_count_bin_9_12 / sqrt(n_log_count_bin_9_12), NA),
    SE_log_count_bin_13_14 = ifelse(n_log_count_bin_13_14 > 1, SD_log_count_bin_13_14 / sqrt(n_log_count_bin_13_14), NA)) %>%
  ungroup()

# Create the summary data frame for binned log_scatter
modedge_binscatter_summary <- binned_modedge_with_logs %>%
  select(Area,log_area, Sample_Trial, Scatter) %>%
  pivot_wider(names_from = Sample_Trial, values_from = Scatter) %>%
  arrange(Area) %>%
  rowwise() %>%
  mutate(
    # Standard deviations
    SD_log_scatter_bin_9_12 = sd(c_across(matches("^Trial_(9|10|11|12)_")), na.rm = TRUE),
    SD_log_scatter_bin_13_14 = sd(c_across(matches("^Trial_(13|14)_")), na.rm = TRUE),
    
    # Sample sizes (count of non-NA values)
    n_log_scatter_bin_9_12 = sum(!is.na(c_across(matches("^Trial_(9|10|11|12)_")))),
    n_log_scatter_bin_13_14 = sum(!is.na(c_across(matches("^Trial_(13|14)_")))),
    
    # Standard errors (SE = SD / sqrt(n))
    SE_log_scatter_bin_9_12 = ifelse(n_log_scatter_bin_9_12 > 1, SD_log_scatter_bin_9_12 / sqrt(n_log_scatter_bin_9_12), NA),
    SE_log_scatter_bin_13_14 = ifelse(n_log_scatter_bin_13_14 > 1, SD_log_scatter_bin_13_14 / sqrt(n_log_scatter_bin_13_14), NA)
  ) %>%
  ungroup()


```

## 7. Straight Line Model (SLSM)

```{r Straight_Line_Model}
## 9. Edge Contamination Line Intersection Analysis
# This section simulates drawing a line across surfaces and analyzes how particles intersect with it
get_overhang_area_counts <- function(data, area_thresholds, normalization_factor) {
  # Check if data is empty
  if (nrow(data) == 0 || !"overhang_area" %in% names(data)) {
    # Return empty results with correct structure
    return(tibble(
      Area = area_thresholds,
      Count = rep(0, length(area_thresholds)),
      Scatter_Area = rep(0, length(area_thresholds))
    ))
  }
  
  # Check if overhang_area column has any non-NA values
  if (all(is.na(data$overhang_area)) || length(data$overhang_area) == 0) {
    return(tibble(
      Area = area_thresholds,
      Count = rep(0, length(area_thresholds)),
      Scatter_Area = rep(0, length(area_thresholds))
    ))
  }
  
  # Initialize counts vector
  counts <- numeric(length(area_thresholds))
  areas <- numeric(length(area_thresholds))
    
  # For bins except the last one
  for(i in 1:(length(area_thresholds) - 1)) {
    bin_particles <- data$overhang_area >= area_thresholds[i] & 
                     data$overhang_area < area_thresholds[i + 1] &
                     !is.na(data$overhang_area)
    counts[i] <- sum(bin_particles, na.rm = TRUE) * normalization_factor
    areas[i] <- sum(data$overhang_area[bin_particles], na.rm = TRUE) * normalization_factor
  }
  
  # For the last bin
  if (length(area_thresholds) > 0) {
    last_bin <- data$overhang_area >= area_thresholds[length(area_thresholds)] &
                !is.na(data$overhang_area)
    counts[length(area_thresholds)] <- sum(last_bin, na.rm = TRUE) * normalization_factor
    areas[length(area_thresholds)] <- sum(data$overhang_area[last_bin], na.rm = TRUE) * normalization_factor
  }
  
  # Return results in the same format as expected by the original code
  tibble(
    Area = area_thresholds,
    Count = counts,
    Scatter_Area = areas
  )
}



# Filter Trial 12 data from both surfaces, BEFORE contamination
starshade_surface_before9 <- surface_before_particles %>%
  filter(Trial == 9) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_before9 <- Cwsurface_before_data$particle_data %>%
  filter(Trial == 9, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
starshade_surface_after9 <- surface_after_particles %>%
  filter(Trial == 9) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_after9 <- Cwsurface_after_data$particle_data %>%
  filter(Trial == 9, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

starshade_surface_before10 <- surface_before_particles %>%
  filter(Trial == 10) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_before10 <- Cwsurface_before_data$particle_data %>%
  filter(Trial == 10, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
starshade_surface_after10 <- surface_after_particles %>%
  filter(Trial == 10) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_after10 <- Cwsurface_after_data$particle_data %>%
  filter(Trial == 10, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

starshade_surface_before11 <- surface_before_particles %>%
  filter(Trial == 11) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_before11 <- Cwsurface_before_data$particle_data %>%
  filter(Trial == 11, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
starshade_surface_after11 <- surface_after_particles %>%
  filter(Trial == 11) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_after11 <- Cwsurface_after_data$particle_data %>%
  filter(Trial == 11, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

starshade_surface_before12 <- surface_before_particles %>%
  filter(Trial == 12) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_before12 <- Cwsurface_before_data$particle_data %>%
  filter(Trial == 12, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
starshade_surface_after12 <- surface_after_particles %>%
  filter(Trial == 12) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_after12 <- Cwsurface_after_data$particle_data %>%
  filter(Trial == 12, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

starshade_surface_before13 <- surface_before_particles %>%
  filter(Trial == 13) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_before13 <- Cwsurface_before_data$particle_data %>%
  filter(Trial == 13, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
starshade_surface_after13 <- surface_after_particles %>%
  filter(Trial == 13) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_after13 <- Cwsurface_after_data$particle_data %>%
  filter(Trial == 13, Area > 1) %>%
  select(Area, BX, BY, Width, Height)


starshade_surface_before14 <- surface_before_particles %>%
  filter(Trial == 14) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_before14 <- Cwsurface_before_data$particle_data %>%
  filter(Trial == 14, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
starshade_surface_after14 <- surface_after_particles %>%
  filter(Trial == 14) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_after14 <- Cwsurface_after_data$particle_data %>%
  filter(Trial == 14, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_before9 <- Witsurface_before_data$particle_data %>%
  filter(Trial == 9) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_before10 <- Witsurface_before_data$particle_data %>%
  filter(Trial == 10, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_before11 <- Witsurface_before_data$particle_data %>%
  filter(Trial == 11) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_before12 <- Witsurface_before_data$particle_data %>%
  filter(Trial == 12, Area > 1) %>%
  select(Area, BX, BY, Width, Height)
witness_surface_before13 <- Witsurface_before_data$particle_data %>%
  filter(Trial == 13, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_before14 <- Witsurface_before_data$particle_data %>%
  filter(Trial == 14, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
witness_surface_after9 <- Witsurface_after_data$particle_data %>%
  filter(Trial == 9) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_after10 <- Witsurface_after_data$particle_data %>%
  filter(Trial == 10, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_after11 <- Witsurface_after_data$particle_data %>%
  filter(Trial == 11) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_after12 <- Witsurface_after_data$particle_data %>%
  filter(Trial == 12, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_after13 <- Witsurface_after_data$particle_data %>%
  filter(Trial == 13, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_after14 <- Witsurface_after_data$particle_data %>%
  filter(Trial == 14, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Calculate image dimensions for positioning
image_width <- 600  
image_height <- 450 

# Function to check if a particle intersects with a horizontal line and calculate overhang area
# This simulates how a particle would interact with an edge
particle_intersects_line <- function(particle, line_y) {
  # Calculate the top and bottom boundaries of the particle
  particle_top <- particle$BY + particle$Height
  particle_bottom <- particle$BY 
  
  # Check if the line passes through the particle
  if (line_y <= particle_top && line_y >= particle_bottom) {
    # Calculate proportion of area that would overhang
    # Distance from line to top of particle divided by total height
    proportion_above_line <- (particle_top - line_y) / particle$Height
    
    # Calculate the area that would overhang the edge (below the line)
    overhang_area <- particle$Area * (proportion_above_line)
    
    # Return intersection details
    return(list(
      intersects = TRUE,
      area = as.numeric(particle$Area),
      overhang_proportion = as.numeric(proportion_above_line),
      overhang_area = as.numeric(overhang_area),
      diameter = 2 * sqrt(particle$Area / pi),  # Equivalent circular diameter
      distance_from_line = min(line_y - particle_top, particle_bottom - line_y),  # How close to edge of particle
      relative_position = (line_y - particle_top) / particle$Height  # Relative position (0 = top, 1 = bottom)
    ))
  } else {
    return(list(intersects = FALSE))
  }
}

# Function to analyze intersections for a single line
# Modified analyze_line_intersections function to handle empty datasets
analyze_line_intersections <- function(particles_data, line_positions = NULL) {
  # Check if dataset is empty
  if (nrow(particles_data) == 0) {
    cat("Warning: Empty dataset provided to analyze_line_intersections\n")
    
    # Return empty results structure
    if (is.null(line_positions)) {
      line_positions <- image_height / 2
    }
    
    empty_results <- list()
    for (i in 1:length(line_positions)) {
      empty_results[[i]] <- list(
        line_position = line_positions[i],
        num_intersections = 0,
        intersecting_particles = list(),
        total_area = 0,
        overhang_area = 0,
        size_data = tibble(area = numeric(0), diameter = numeric(0), overhang_prop = numeric(0))
      )
    }
    return(empty_results)
  }
  
  # If no specific positions provided, use middle of image
  if (is.null(line_positions)) {
    line_positions <- image_height / 2
  }
  
  # Initialize results storage
  all_results <- list()
  
  # For each line position
  for (i in 1:length(line_positions)) {
    line_y <- line_positions[i]
    
    # Process each particle to check for intersection
    intersections <- map(1:nrow(particles_data), function(j) {
      particle_intersects_line(particles_data[j,], line_y)
    })
    
    # Filter to only intersecting particles
    intersecting_particles <- intersections[sapply(intersections, function(x) x$intersects)]
    
    # Calculate statistics for this line
    if (length(intersecting_particles) > 0) {
      all_results[[i]] <- list(
        line_position = line_y,
        num_intersections = length(intersecting_particles),
        intersecting_particles = intersecting_particles,
        total_area = sum(sapply(intersecting_particles, function(x) x$area)),
        overhang_area = sum(sapply(intersecting_particles, function(x) x$overhang_area)),
        size_data = tibble(
          area = sapply(intersecting_particles, function(x) x$area),
          diameter = sapply(intersecting_particles, function(x) x$diameter),
          overhang_prop = sapply(intersecting_particles, function(x) x$overhang_proportion)
        )
      )
    } else {
      all_results[[i]] <- list(
        line_position = line_y,
        num_intersections = 0,
        intersecting_particles = list(),
        total_area = 0,
        overhang_area = 0,
        size_data = tibble(area = numeric(0), diameter = numeric(0), overhang_prop = numeric(0))
      )
    }
  }
  
  return(all_results)
}

# Function to check dataset sizes before analysis
check_dataset_sizes <- function() {
  datasets <- list(
    "witness_surface_before9" = witness_surface_before9,
    "witness_surface_before10" = witness_surface_before10,
    "witness_surface_before11" = witness_surface_before11,
    "witness_surface_before12" = witness_surface_before12,
    "witness_surface_before13" = witness_surface_before13,
    "witness_surface_before14" = witness_surface_before14,
    "witness_surface_after9" = witness_surface_after9,
    "witness_surface_after10" = witness_surface_after10,
    "witness_surface_after11" = witness_surface_after11,
    "witness_surface_after12" = witness_surface_after12,
    "witness_surface_after13" = witness_surface_after13,
    "witness_surface_after14" = witness_surface_after14
  )
  
  for (name in names(datasets)) {
    cat(sprintf("%s: %d observations\n", name, nrow(datasets[[name]])))
  }
}

# Run the check
check_dataset_sizes()
# Use the middle of the image for the edge simulation line
central_line_y <- image_height / 2

# Analyze both surfaces with the same single line - BEFORE contamination
starshade_before_results9 <- analyze_line_intersections(starshade_surface_before9, c(central_line_y))
witness_before_results9 <- analyze_line_intersections(witness_surface_before9, c(central_line_y))

# Analyze both surfaces with the same single line - AFTER contamination
starshade_after_results9 <- analyze_line_intersections(starshade_surface_after9, c(central_line_y))
witness_after_results9 <- analyze_line_intersections(witness_surface_after9, c(central_line_y))

# Analyze both surfaces with the same single line - BEFORE contamination
starshade_before_results10 <- analyze_line_intersections(starshade_surface_before10, c(central_line_y))
witness_before_results10 <- analyze_line_intersections(witness_surface_before10, c(central_line_y))

# Analyze both surfaces with the same single line - AFTER contamination
starshade_after_results10 <- analyze_line_intersections(starshade_surface_after10, c(central_line_y))
witness_after_results10 <- analyze_line_intersections(witness_surface_after10, c(central_line_y))

# Analyze both surfaces with the same single line - BEFORE contamination
starshade_before_results11 <- analyze_line_intersections(starshade_surface_before11, c(central_line_y))
witness_before_results11 <- analyze_line_intersections(witness_surface_before11, c(central_line_y))

# Analyze both surfaces with the same single line - AFTER contamination
starshade_after_results11 <- analyze_line_intersections(starshade_surface_after11, c(central_line_y))
witness_after_results11 <- analyze_line_intersections(witness_surface_after11, c(central_line_y))

# Analyze both surfaces with the same single line - BEFORE contamination
starshade_before_results12 <- analyze_line_intersections(starshade_surface_before12, c(central_line_y))
calibration_before_results12 <- analyze_line_intersections(calibration_surface_before12, c(central_line_y))
witness_before_results12 <- analyze_line_intersections(witness_surface_before12, c(central_line_y))

# Analyze both surfaces with the same single line - AFTER contamination
starshade_after_results12 <- analyze_line_intersections(starshade_surface_after12, c(central_line_y))
calibration_after_results12 <- analyze_line_intersections(calibration_surface_after12, c(central_line_y))
witness_after_results12 <- analyze_line_intersections(witness_surface_after12, c(central_line_y))

starshade_before_results13 <- analyze_line_intersections(starshade_surface_before13, c(central_line_y))
calibration_before_results13 <- analyze_line_intersections(calibration_surface_before13, c(central_line_y))
witness_before_results13 <- analyze_line_intersections(witness_surface_before13, c(central_line_y))

# Analyze both surfaces with the same single line - AFTER contamination
starshade_after_results13 <- analyze_line_intersections(starshade_surface_after13, c(central_line_y))
calibration_after_results13 <- analyze_line_intersections(calibration_surface_after13, c(central_line_y))
witness_after_results13 <- analyze_line_intersections(witness_surface_after13, c(central_line_y))


starshade_before_results14 <- analyze_line_intersections(starshade_surface_before14, c(central_line_y))
calibration_before_results14 <- analyze_line_intersections(calibration_surface_before14, c(central_line_y))
witness_before_results14 <- analyze_line_intersections(witness_surface_before14, c(central_line_y))

# Analyze both surfaces with the same single line - AFTER contamination
starshade_after_results14 <- analyze_line_intersections(starshade_surface_after14, c(central_line_y))
calibration_after_results14 <- analyze_line_intersections(calibration_surface_after14, c(central_line_y))
witness_after_results14 <- analyze_line_intersections(witness_surface_after14, c(central_line_y))

#Extract the results for the particles that intersect the line
starshade_sim_after9 <- if(length(starshade_after_results9[[1]]$intersecting_particles) > 0) {
  map_df(starshade_after_results9[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "9")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_before9 <- if(length(starshade_before_results9[[1]]$intersecting_particles) > 0) {
  map_df(starshade_before_results9[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "9")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}
starshade_sim_after10 <- if(length(starshade_after_results10[[1]]$intersecting_particles) > 0) {
  map_df(starshade_after_results10[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "10")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_before10 <- if(length(starshade_before_results10[[1]]$intersecting_particles) > 0) {
  map_df(starshade_before_results10[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "10")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_after11 <- if(length(starshade_after_results11[[1]]$intersecting_particles) > 0) {
  map_df(starshade_after_results11[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "11")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_before11 <- if(length(starshade_before_results11[[1]]$intersecting_particles) > 0) {
  map_df(starshade_before_results11[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "11")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_after12 <- if(length(starshade_after_results12[[1]]$intersecting_particles) > 0) {
  map_df(starshade_after_results12[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "12")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_before12 <- if(length(starshade_before_results12[[1]]$intersecting_particles) > 0) {
  map_df(starshade_before_results12[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "12")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}



calibration_sim_after12 <- if(length(calibration_after_results12[[1]]$intersecting_particles) > 0) {
  map_df(calibration_after_results12[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "12")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

calibration_sim_before12 <- if(length(calibration_before_results12[[1]]$intersecting_particles) > 0) {
  map_df(calibration_before_results12[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "12")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}



starshade_sim_after13 <- if(length(starshade_after_results13[[1]]$intersecting_particles) > 0) {
  map_df(starshade_after_results13[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "13")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_before13 <- if(length(starshade_before_results13[[1]]$intersecting_particles) > 0) {
  map_df(starshade_before_results13[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "13")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}



calibration_sim_after13 <- if(length(calibration_after_results13[[1]]$intersecting_particles) > 0) {
  map_df(calibration_after_results13[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "13")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

calibration_sim_before13 <- if(length(calibration_before_results13[[1]]$intersecting_particles) > 0) {
  map_df(calibration_before_results13[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "13")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}




starshade_sim_after14 <- if(length(starshade_after_results14[[1]]$intersecting_particles) > 0) {
  map_df(starshade_after_results14[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "14")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_before14 <- if(length(starshade_before_results14[[1]]$intersecting_particles) > 0) {
  map_df(starshade_before_results14[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "14")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}



calibration_sim_after14 <- if(length(calibration_after_results14[[1]]$intersecting_particles) > 0) {
  map_df(calibration_after_results14[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "14")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

calibration_sim_before14 <- if(length(calibration_before_results14[[1]]$intersecting_particles) > 0) {
  map_df(calibration_before_results14[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "14")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_after9 <- if(length(witness_after_results9[[1]]$intersecting_particles) > 0) {
  map_df(witness_after_results9[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "after",
           Trial = "9")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_before9 <- if(length(witness_before_results9[[1]]$intersecting_particles) > 0) {
  map_df(witness_before_results9[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "before",
           Trial = "9")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_after10 <- if(length(witness_after_results10[[1]]$intersecting_particles) > 0) {
  map_df(witness_after_results10[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "after",
           Trial = "10")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_before10 <- if(length(witness_before_results10[[1]]$intersecting_particles) > 0) {
  map_df(witness_before_results10[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "before",
           Trial = "10")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_after11 <- if(length(witness_after_results11[[1]]$intersecting_particles) > 0) {
  map_df(witness_after_results11[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "after",
           Trial = "11")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_before11 <- if(length(witness_before_results11[[1]]$intersecting_particles) > 0) {
  map_df(witness_before_results11[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "before",
           Trial = "11")
} else {
  data.frame(
    intersect = character(0),
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_after12 <- if(length(witness_after_results12[[1]]$intersecting_particles) > 0) {
  map_df(witness_after_results12[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "after",
           Trial = "12")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_before12 <- if(length(witness_before_results12[[1]]$intersecting_particles) > 0) {
  map_df(witness_before_results12[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "before",
           Trial = "12")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}


witness_sim_after13 <- if(length(witness_after_results13[[1]]$intersecting_particles) > 0) {
  map_df(witness_after_results13[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "after",
           Trial = "13")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_before13 <- if(length(witness_before_results13[[1]]$intersecting_particles) > 0) {
  map_df(witness_before_results13[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "before",
           Trial = "13")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}



witness_sim_after14 <- if(length(witness_after_results14[[1]]$intersecting_particles) > 0) {
  map_df(witness_after_results14[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "after",
           Trial = "14")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_before14 <- if(length(witness_before_results14[[1]]$intersecting_particles) > 0) {
  map_df(witness_before_results14[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "before",
           Trial = "14")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

# Datasets to work from

s_bmodel_edge_before <- rbind(starshade_sim_before9, starshade_sim_before10, starshade_sim_before11, starshade_sim_before12, starshade_sim_before13, starshade_sim_before14)

s_bmodel_edge_after <- rbind(starshade_sim_after9, starshade_sim_after10, starshade_sim_after11, starshade_sim_after12, starshade_sim_after13, starshade_sim_after14)

w_bmodel_edge_before <- rbind(witness_sim_before9, witness_sim_before10, witness_sim_before11, witness_sim_before12, witness_sim_before13, witness_sim_before14)

w_bmodel_edge_after <- rbind(witness_sim_after9, witness_sim_after10, witness_sim_after11, witness_sim_after12, witness_sim_after13, witness_sim_after14)

c_bmodel_edge_before <- rbind(calibration_sim_before12,calibration_sim_before13,calibration_sim_before14)

c_bmodel_edge_after <- rbind(calibration_sim_after12,calibration_sim_after13,calibration_sim_after14)


# Calculate normalization factors for edge measurements
new_SSLSM_edge_factors<- surface_before_data$summary_data %>%
  group_by(Trial) %>%
  summarise(
    Total_Width = 0.316227766 / (n() * 600 * 1e-6),  # Convert microns to meters
    .groups = "drop"
  )

# Calculate area-based counts for edge data using the same function as surface data
SSLSM_edge_counts_before <- s_bmodel_edge_before %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <- new_SSLSM_edge_factors$Total_Width[new_SSLSM_edge_factors$Trial == .y$Trial]
  get_overhang_area_counts(.x, area_thresholds, norm_factor)
  })

SSLSM_edge_counts_after <- s_bmodel_edge_after %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <- new_SSLSM_edge_factors$Total_Width[new_SSLSM_edge_factors$Trial == .y$Trial]
  get_overhang_area_counts(.x, area_thresholds, norm_factor)
  })

SSLSM_surface_count_diff <- SSLSM_edge_counts_after %>%
  full_join(SSLSM_edge_counts_before, 
            by = c("Trial", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Positive_Diff = pmax(Count_Diff, 0),
         Scatter_Diff = Scatter_Area_After - Scatter_Area_Before,
         Positive_Scatter = pmax(Scatter_Diff, 0)
         )

# Calculate cumulative counts (particles larger than each threshold)
SSLSM_cumulative_edge_counts <- SSLSM_surface_count_diff %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Positive_Diff),
         Cumulative_Scatter = rev(cumsum(rev(Positive_Scatter)))) %>%
  ungroup() %>%
  mutate(log_area = log10(Area),
         log_count = ifelse(Cumulative_Count == 0, -3, log10(Cumulative_Count)),
         log_scatter = ifelse(Cumulative_Scatter == 0, -3, log10(Cumulative_Scatter))) %>% 
  arrange(Trial, desc(Area)) 


SSLSM_edge_9 <- SSLSM_cumulative_edge_counts %>% 
  filter( Trial == 9)

SSLSM_edge_10 <- SSLSM_cumulative_edge_counts %>% 
  filter( Trial == 10)

SSLSM_edge_11 <- SSLSM_cumulative_edge_counts %>% 
  filter( Trial == 11)

SSLSM_edge_12 <- SSLSM_cumulative_edge_counts %>% 
  filter( Trial == 12)

SSLSM_edge_13 <- SSLSM_cumulative_edge_counts %>% 
  filter( Trial == 13)

SSLSM_edge_14 <- SSLSM_cumulative_edge_counts %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
SSLSM_edge_average <- bind_rows(SSLSM_edge_9, SSLSM_edge_10, SSLSM_edge_11, SSLSM_edge_12) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

SSLSM_edge_average_air <- bind_rows(SSLSM_edge_13, SSLSM_edge_14) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Calculate binned counts from cumulative data
SSLSM_edge_binned <- SSLSM_cumulative_edge_counts %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%  # Ensure data is sorted by descending area
  mutate(
    Count = c(Cumulative_Count[1], diff(Cumulative_Count)),  # First value is the total, then differences
    Scatter = c(Cumulative_Scatter[length(Cumulative_Scatter)], -diff(Cumulative_Scatter))
  ) %>%
  ungroup() %>% 
  mutate(log_count_bin = ifelse(Count == 0, -3, log10(Count)),
         log_scatter_bin = ifelse(Scatter == 0, -3, log10(Scatter))
         )

SSLSM_edge_9_binned <- SSLSM_edge_binned %>% 
  filter( Trial == 9)

SSLSM_edge_10_binned <- SSLSM_edge_binned %>% 
  filter( Trial == 10)

SSLSM_edge_11_binned <- SSLSM_edge_binned %>% 
  filter( Trial == 11)

SSLSM_edge_12_binned <- SSLSM_edge_binned %>% 
  filter( Trial == 12)

SSLSM_edge_13_binned <- SSLSM_edge_binned %>% 
  filter( Trial == 13)

SSLSM_edge_14_binned <- SSLSM_edge_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
SSLSM_edge_average_binned <- bind_rows(SSLSM_edge_9_binned, SSLSM_edge_10_binned, SSLSM_edge_11_binned, SSLSM_edge_12_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

SSLSM_edge_average_air_binned <- bind_rows(SSLSM_edge_13_binned, SSLSM_edge_14_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

#Calibration Wafer Now

# Calculate normalization factors for edge measurements
new_CSLSM_edge_factors<- Cwsurface_before_data$summary_data %>%
  group_by(Trial) %>%
  summarise(
    Total_Width = n() * 600 * 1e-6,  # Convert microns to meters
    .groups = "drop"
  )

# Calculate area-based counts for edge data using the same function as surface data
CSLSM_edge_counts_before <- c_bmodel_edge_before %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <-  0.316227766 / new_CSLSM_edge_factors$Total_Width[new_CSLSM_edge_factors$Trial == .y$Trial]
  get_overhang_area_counts(.x, area_thresholds, norm_factor)
  })

CSLSM_edge_counts_after <- c_bmodel_edge_after %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <-  0.316227766 / new_CSLSM_edge_factors$Total_Width[new_CSLSM_edge_factors$Trial == .y$Trial]
  get_overhang_area_counts(.x, area_thresholds, norm_factor)
  })

CSLSM_surface_count_diff <- CSLSM_edge_counts_after %>%
  full_join(CSLSM_edge_counts_before, 
            by = c("Trial", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Positive_Diff = pmax(Count_Diff, 0),
         Scatter_Diff = Scatter_Area_After - Scatter_Area_Before,
         Positive_Scatter = pmax(Scatter_Diff, 0)
         )

# Calculate cumulative counts (particles larger than each threshold)
CSLSM_cumulative_edge_counts <- CSLSM_surface_count_diff %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Positive_Diff),
         Cumulative_Scatter = rev(cumsum(rev(Positive_Scatter)))) %>%
  ungroup() %>%
  mutate(log_area = log10(Area),
         log_count = ifelse(Cumulative_Count == 0, -3, log10(Cumulative_Count)),
         log_scatter = ifelse(Cumulative_Scatter == 0, -3, log10(Cumulative_Scatter))) %>% 
  arrange(Trial, desc(Area)) 


CSLSM_edge_9 <- CSLSM_cumulative_edge_counts %>% 
  filter( Trial == 9)

CSLSM_edge_10 <- CSLSM_cumulative_edge_counts %>% 
  filter( Trial == 10)

CSLSM_edge_11 <- CSLSM_cumulative_edge_counts %>% 
  filter( Trial == 11)

CSLSM_edge_12 <- CSLSM_cumulative_edge_counts %>% 
  filter( Trial == 12)

CSLSM_edge_13 <- CSLSM_cumulative_edge_counts %>% 
  filter( Trial == 13)

CSLSM_edge_14 <- CSLSM_cumulative_edge_counts %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
CSLSM_edge_average <- bind_rows(CSLSM_edge_9, CSLSM_edge_10, CSLSM_edge_11, CSLSM_edge_12) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

CSLSM_edge_average_air <- bind_rows(CSLSM_edge_13, CSLSM_edge_14) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Calculate binned counts from cumulative data
CSLSM_edge_binned <- CSLSM_cumulative_edge_counts %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%  # Ensure data is sorted by descending area
  mutate(
    Count = c(Cumulative_Count[1], diff(Cumulative_Count)),  # First value is the total, then differences
    Scatter = c(Cumulative_Scatter[length(Cumulative_Scatter)], -diff(Cumulative_Scatter))
  ) %>%
  ungroup() %>% 
  mutate(log_count_bin = ifelse(Count == 0, -3, log10(Count)),
         log_scatter_bin = ifelse(Scatter == 0, -3, log10(Scatter))
         )

CSLSM_edge_9_binned <- CSLSM_edge_binned %>% 
  filter( Trial == 9)

CSLSM_edge_10_binned <- CSLSM_edge_binned %>% 
  filter( Trial == 10)

CSLSM_edge_11_binned <- CSLSM_edge_binned %>% 
  filter( Trial == 11)

CSLSM_edge_12_binned <- CSLSM_edge_binned %>% 
  filter( Trial == 12)

CSLSM_edge_13_binned <- CSLSM_edge_binned %>% 
  filter( Trial == 13)

CSLSM_edge_14_binned <- CSLSM_edge_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
CSLSM_edge_average_binned <- bind_rows(CSLSM_edge_9_binned, CSLSM_edge_10_binned, CSLSM_edge_11_binned, CSLSM_edge_12_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

CSLSM_edge_average_air_binned <- bind_rows(CSLSM_edge_13_binned, CSLSM_edge_14_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))


## Witness Sample


# Calculate normalization factors for edge measurements
new_WSLSM_edge_factors<- Witsurface_before_data$summary_data %>%
  group_by(Trial) %>%
  summarise(
    Total_Width = n() * 600 * 1e-6,  # Convert microns to meters
    .groups = "drop"
  )

# Calculate area-based counts for edge data using the same function as surface data
# Get all unique trials from your factors table
all_trials <- as.character(unique(new_WSLSM_edge_factors$Trial))

# Create results for all trials, handling empty data
WSLSM_edge_counts_before <- tibble(Trial = all_trials) %>%
  group_by(Trial) %>%
  group_modify(~ {
    # Get the subset of data for this trial
    trial_data <- w_bmodel_edge_before %>% filter(Trial == .y$Trial)
    
    # Get normalization factor for this trial
    norm_factor <- 0.316227766 / new_WSLSM_edge_factors$Total_Width[new_WSLSM_edge_factors$Trial == .y$Trial]
    
    # If no data for this trial, create zero counts for all area thresholds
    if (nrow(trial_data) == 0) {
      tibble(
        Area = area_thresholds,
        Count = 0,
        Scatter_Area = 0
      )
    } else {
      # Process normally if data exists
      get_overhang_area_counts(trial_data, area_thresholds, norm_factor)
    }
  })

WSLSM_edge_counts_after <- w_bmodel_edge_after %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <- 0.316227766 / new_WSLSM_edge_factors$Total_Width[new_WSLSM_edge_factors$Trial == .y$Trial]
  get_overhang_area_counts(.x, area_thresholds, norm_factor)
  })

WSLSM_surface_count_diff <- WSLSM_edge_counts_after %>%
  full_join(WSLSM_edge_counts_before, 
            by = c("Trial", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Positive_Diff = pmax(Count_Diff, 0),
         Scatter_Diff = Scatter_Area_After - Scatter_Area_Before,
         Positive_Scatter = pmax(Scatter_Diff, 0)
         )

# Calculate cumulative counts (particles larger than each threshold)
WSLSM_cumulative_edge_counts <- WSLSM_surface_count_diff %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Positive_Diff),
         Cumulative_Scatter = rev(cumsum(rev(Positive_Scatter)))) %>%
  ungroup() %>%
  mutate(log_area = log10(Area),
         log_count = ifelse(Cumulative_Count == 0, -3, log10(Cumulative_Count)),
         log_scatter = ifelse(Cumulative_Scatter == 0, -3, log10(Cumulative_Scatter))) %>% 
  arrange(Trial, desc(Area)) 


WSLSM_edge_9 <- WSLSM_cumulative_edge_counts %>% 
  filter( Trial == 9)

WSLSM_edge_10 <- WSLSM_cumulative_edge_counts %>% 
  filter( Trial == 10)

WSLSM_edge_11 <- WSLSM_cumulative_edge_counts %>% 
  filter( Trial == 11)

WSLSM_edge_12 <- WSLSM_cumulative_edge_counts %>% 
  filter( Trial == 12)

WSLSM_edge_13 <- WSLSM_cumulative_edge_counts %>% 
  filter( Trial == 13)

WSLSM_edge_14 <- WSLSM_cumulative_edge_counts %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
WSLSM_edge_average <- bind_rows(WSLSM_edge_9, WSLSM_edge_10, WSLSM_edge_11, WSLSM_edge_12) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

WSLSM_edge_average_air <- bind_rows(WSLSM_edge_13, WSLSM_edge_14) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

# Calculate binned counts from cumulative data
WSLSM_edge_binned <- WSLSM_cumulative_edge_counts %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%  # Ensure data is sorted by descending area
  mutate(
    Count = c(Cumulative_Count[1], diff(Cumulative_Count)),  # First value is the total, then differences
    Scatter = c(Cumulative_Scatter[length(Cumulative_Scatter)], -diff(Cumulative_Scatter))
  ) %>%
  ungroup() %>% 
  mutate(log_count_bin = ifelse(Count == 0, -3, log10(Count)),
         log_scatter_bin = ifelse(Scatter == 0, -3, log10(Scatter))
         )

WSLSM_edge_9_binned <- WSLSM_edge_binned %>% 
  filter( Trial == 9)

WSLSM_edge_10_binned <- WSLSM_edge_binned %>% 
  filter( Trial == 10)

WSLSM_edge_11_binned <- WSLSM_edge_binned %>% 
  filter( Trial == 11)

WSLSM_edge_12_binned <- WSLSM_edge_binned %>% 
  filter( Trial == 12)

WSLSM_edge_13_binned <- WSLSM_edge_binned %>% 
  filter( Trial == 13)

WSLSM_edge_14_binned <- WSLSM_edge_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
WSLSM_edge_average_binned <- bind_rows(WSLSM_edge_9_binned, WSLSM_edge_10_binned, WSLSM_edge_11_binned, WSLSM_edge_12_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))

WSLSM_edge_average_air_binned <- bind_rows(WSLSM_edge_13_binned, WSLSM_edge_14_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )  %>% 
  mutate(log_count_bin = ifelse(Average_Count == 0, -3, log10(Average_Count)),
         log_scatter_bin = ifelse(Average_Scatter == 0, -3, log10(Average_Scatter)))
```

##7.5 

```{r}
# ========================================================================
# BRIGHTNESS ANALYSIS SECTION
# ========================================================================
# This section analyzes image brightness patterns across all surface and edge data types:
# Surfaces: Starshade, Calibration, Witness
# Edges: Starshade, Calibration

## Load required libraries for brightness analysis
if (!require(reshape2)) install.packages("reshape2")
library(reshape2)

# ========================================================================
# BRIGHTNESS ANALYSIS FUNCTIONS
# ========================================================================

#' Analyze surface brightness data for all surface types
analyze_all_surface_brightness <- function() {
  
  cat("=== SURFACE BRIGHTNESS ANALYSIS ===\n")
  
  # List of surface data objects to analyze
  surface_datasets <- list(
    "Starshade Surface Before" = if(exists("surface_before_data") && !is.null(surface_before_data$summary_data)) surface_before_data$summary_data else NULL,
    "Starshade Surface After" = if(exists("surface_after_data") && !is.null(surface_after_data$summary_data)) surface_after_data$summary_data else NULL,
    "Calibration Surface Before" = if(exists("Cwsurface_before_data") && !is.null(Cwsurface_before_data$summary_data)) Cwsurface_before_data$summary_data else NULL,
    "Calibration Surface After" = if(exists("Cwsurface_after_data") && !is.null(Cwsurface_after_data$summary_data)) Cwsurface_after_data$summary_data else NULL,
    "Witness Surface Before" = if(exists("Witsurface_before_data") && !is.null(Witsurface_before_data$summary_data)) Witsurface_before_data$summary_data else NULL,
    "Witness Surface After" = if(exists("Witsurface_after_data") && !is.null(Witsurface_after_data$summary_data)) Witsurface_after_data$summary_data else NULL
  )
  
  # Remove NULL datasets and report which are available
  available_datasets <- names(surface_datasets)[!sapply(surface_datasets, is.null)]
  surface_datasets <- surface_datasets[!sapply(surface_datasets, is.null)]
  
  cat("Available surface datasets:", paste(available_datasets, collapse = ", "), "\n")
  
  if(length(surface_datasets) == 0) {
    cat("WARNING: No surface summary datasets found.\n")
    cat("Expected datasets: surface_before_data$summary_data, surface_after_data$summary_data, \n")
    cat("                  Cwsurface_before_data$summary_data, Cwsurface_after_data$summary_data, \n")
    cat("                  Witsurface_before_data$summary_data, Witsurface_after_data$summary_data\n")
    return(NULL)
  }
  
  # Process each surface dataset
  surface_brightness_results <- list()
  
  for(dataset_name in names(surface_datasets)) {
    data <- surface_datasets[[dataset_name]]
    
    cat("Processing", dataset_name, "- Total images:", nrow(data), "\n")
    
    # Extract surface type and timing
    surface_type <- case_when(
      grepl("Starshade", dataset_name) ~ "Starshade",
      grepl("Calibration", dataset_name) ~ "Calibration",
      grepl("Witness", dataset_name) ~ "Witness",
      TRUE ~ "Unknown"
    )
    
    timing <- case_when(
      grepl("Before", dataset_name) ~ "Before",
      grepl("After", dataset_name) ~ "After",
      TRUE ~ "Unknown"
    )
    
    # Clean and process brightness data
    processed_data <- data %>%
      mutate(
        # Handle missing brightness values
        Post_Transform_Median_Brightness = ifelse(is.na(Post_Transform_Median_Brightness) | 
                                                 Post_Transform_Median_Brightness == 0, 
                                                 Original_Median_Brightness, 
                                                 Post_Transform_Median_Brightness),
        # Calculate brightness metrics
        Brightness_Change = Post_Transform_Median_Brightness - Original_Median_Brightness,
        Brightness_Change_Percent = ifelse(Original_Median_Brightness != 0,
                                          (Brightness_Change / Original_Median_Brightness) * 100,
                                          0),
        # Add identifiers
        Surface_Type = surface_type,
        Timing = timing,
        Dataset = dataset_name,
        Transform_Applied = ifelse(Transformation_Applied == "Yes", "Transformed", "Not Transformed"),
        # Extract trial numbers from image names
        Trial = str_extract(Slice, "\\d+$")
      )
    
    surface_brightness_results[[dataset_name]] <- processed_data
  }
  
  # Combine all surface data
  combined_surface_data <- bind_rows(surface_brightness_results)
  
  cat("Total surface images analyzed:", nrow(combined_surface_data), "\n")
  cat("Images with transformation applied:", 
      sum(combined_surface_data$Transform_Applied == "Transformed", na.rm = TRUE), "\n")
  
  # Summary by surface type and timing
  surface_counts <- combined_surface_data %>%
    group_by(Surface_Type, Timing) %>%
    summarise(
      Total_Images = n(),
      Transformed_Images = sum(Transform_Applied == "Transformed", na.rm = TRUE),
      .groups = "drop"
    )
  print(surface_counts)
  cat("\n")
  
  return(combined_surface_data)
}

#' Analyze edge brightness data for edge types
analyze_all_edge_brightness <- function() {
  
  cat("=== EDGE BRIGHTNESS ANALYSIS ===\n")
  
  # List of edge data objects to analyze
  edge_datasets <- list(
    "Starshade Edge" = if(exists("edge_summary_data")) edge_summary_data else NULL,
    "Calibration Edge" = if(exists("calibration_summary_data")) calibration_summary_data else NULL
  )
  
  # Remove NULL datasets and report which are available
  available_datasets <- names(edge_datasets)[!sapply(edge_datasets, is.null)]
  edge_datasets <- edge_datasets[!sapply(edge_datasets, is.null)]
  
  cat("Available edge datasets:", paste(available_datasets, collapse = ", "), "\n")
  
  if(length(edge_datasets) == 0) {
    cat("WARNING: No edge summary datasets found.\n")
    cat("Expected datasets: edge_summary_data, calibration_summary_data\n")
    return(NULL)
  }
  
  # Process each edge dataset
  edge_brightness_results <- list()
  
  for(dataset_name in names(edge_datasets)) {
    data <- edge_datasets[[dataset_name]]
    
    cat("Processing", dataset_name, "- Total samples:", nrow(data), "\n")
    
    # Extract edge type
    edge_type <- case_when(
      grepl("Starshade", dataset_name) ~ "Starshade",
      grepl("Calibration", dataset_name) ~ "Calibration",
      TRUE ~ "Unknown"
    )
    
    # Process edge brightness data
    processed_data <- data %>%
      mutate(
        Edge_Type = edge_type,
        Dataset = dataset_name,
        Sample_ID = row_number()
      )
    
    # Try to extract trial numbers from various possible columns
    trial_column <- NULL
    if("Result of C1-Fused" %in% names(data)) {
      trial_column <- "Result of C1-Fused"
    } else if("image_name" %in% names(data)) {
      trial_column <- "image_name"
    } else if("Slice" %in% names(data)) {
      trial_column <- "Slice"
    } else {
      # Use first column that contains image/file names
      text_cols <- sapply(data, function(x) is.character(x) && any(grepl("\\d", x)))
      if(any(text_cols)) {
        trial_column <- names(data)[which(text_cols)[1]]
      }
    }
    
    if(!is.null(trial_column)) {
      processed_data <- processed_data %>%
        mutate(Trial = str_extract(.data[[trial_column]], "\\d+$"))
      cat("Extracting trial numbers from column:", trial_column, "\n")
    } else {
      processed_data <- processed_data %>%
        mutate(Trial = as.character(Sample_ID))
      cat("WARNING: Could not find appropriate column for trial extraction. Using Sample_ID.\n")
    }
    
    # Check which brightness columns are available
    brightness_cols <- names(data)[grepl("Median", names(data))]
    cat("Available brightness columns:", paste(brightness_cols, collapse = ", "), "\n")
    
    if(length(brightness_cols) == 0) {
      cat("WARNING: No brightness columns found in", dataset_name, ". Skipping this dataset.\n")
      return(NULL)
    }
    
    # Select brightness measurements (use available columns)
    standard_brightness_cols <- c(
      "Bef_Pre_Upper_Median", "Bef_Pre_Lower_Median", "Bef_Pre_Entire_Median",
      "Bef_Post_Upper_Median", "Bef_Post_Lower_Median", "Bef_Post_Entire_Median",
      "Aft_Pre_Upper_Median", "Aft_Pre_Lower_Median", "Aft_Pre_Entire_Median",
      "Aft_Post_Upper_Median", "Aft_Post_Lower_Median", "Aft_Post_Entire_Median"
    )
    
    # Use only columns that actually exist
    available_brightness_cols <- intersect(standard_brightness_cols, names(processed_data))
    
    if(length(available_brightness_cols) == 0) {
      cat("WARNING: No standard brightness columns found in", dataset_name, ". Available columns:\n")
      print(names(data))
      cat("Skipping this dataset.\n")
      return(NULL)
    }
    
    cat("Using brightness columns:", paste(available_brightness_cols, collapse = ", "), "\n")
    
    processed_data <- processed_data %>%
      select(Sample_ID, Trial, Edge_Type, Dataset, all_of(available_brightness_cols)) %>%
      # Reshape to long format
      pivot_longer(cols = all_of(available_brightness_cols), 
                   names_to = "Measurement_Type", 
                   values_to = "Brightness") %>%
      # Parse measurement components
      separate(Measurement_Type, into = c("Contamination", "Processing", "Region"), sep = "_") %>%
      mutate(
        Contamination = case_when(
          Contamination == "Bef" ~ "Before Contamination",
          Contamination == "Aft" ~ "After Contamination",
          TRUE ~ Contamination
        ),
        Processing = case_when(
          Processing == "Pre" ~ "Before Processing", 
          Processing == "Post" ~ "After Processing",
          TRUE ~ Processing
        ),
        Region = case_when(
          Region == "Upper" ~ "Upper",
          Region == "Lower" ~ "Lower", 
          Region == "Entire" ~ "Entire",
          TRUE ~ Region
        )
      )
    
    edge_brightness_results[[dataset_name]] <- processed_data
  }
  
  # Combine all edge data
  combined_edge_data <- bind_rows(edge_brightness_results)
  
  cat("Total edge measurements analyzed:", nrow(combined_edge_data), "\n")
  
  # Summary by edge type
  edge_counts <- combined_edge_data %>%
    group_by(Edge_Type) %>%
    summarise(
      Total_Samples = n_distinct(Sample_ID),
      Total_Measurements = n(),
      .groups = "drop"
    )
  print(edge_counts)
  cat("\n")
  
  return(combined_edge_data)
}

# ========================================================================
# BRIGHTNESS VISUALIZATION FUNCTIONS
# ========================================================================

#' Create surface brightness plots
create_surface_brightness_plots <- function(surface_data) {
  
  if(is.null(surface_data) || nrow(surface_data) == 0) {
    cat("No surface data available for plotting.\n")
    return(NULL)
  }
  
  # Surface brightness distribution by type (histogram remains the same)
  p1 <- ggplot(surface_data) +
    geom_histogram(aes(x = Original_Median_Brightness, fill = "Original"), 
                   alpha = 0.7, bins = 70, position = "identity") +
    geom_histogram(aes(x = Post_Transform_Median_Brightness, fill = "Post-Transform"), 
                   alpha = 0.7, bins = 70, position = "identity") +
    facet_wrap(~ Surface_Type + Timing, scales = "free_y", ncol = 3) +
    labs(title = "Surface Image Brightness Distribution by Surface Type and Timing",
         subtitle = "Original vs Post-Transform Brightness",
         x = "Median Brightness Value", y = "Number of Images",
         fill = "Measurement") +
    theme_minimal() +
    theme(plot.title = element_text(size = 14, face = "bold")) +
    scale_fill_manual(values = c("Original" = "steelblue", "Post-Transform" = "coral"))
  
  # Brightness change by transformation status - HISTOGRAM DISTRIBUTION
  p2 <- ggplot(surface_data, aes(x = Brightness_Change_Percent)) +
    geom_histogram(aes(fill = Surface_Type), bins = 70, alpha = 0.7, position = "identity") +
    facet_wrap(~ Timing, scales = "free_y") +
    xlim(-50, 50) +  # Limit x-axis for better readability
    labs(title = "Distribution of Surface Brightness Changes",
         subtitle = "Count of images by brightness change percentage",
         x = "Brightness Change (%)", y = "Count of Images",
         fill = "Surface Type") +
    theme_minimal() +
    theme(plot.title = element_text(size = 14, face = "bold")) +
    scale_fill_manual(values = c("Starshade" = "steelblue", "Calibration" = "coral", "Witness" = "darkgreen")) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "red", alpha = 0.7)
  
  # Before vs after transformation scatter (keep as scatter)
  p3 <- ggplot(surface_data, aes(x = Original_Median_Brightness, y = Post_Transform_Median_Brightness)) +
    geom_point(aes(color = Surface_Type), size = 1.5, alpha = 0.6) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray") +
    facet_wrap(~ Timing, scales = "free") +
    labs(title = "Surface Brightness: Before vs After Processing by Timing",
         subtitle = "Diagonal line represents no change",
         x = "Original Brightness", y = "Post-Transform Brightness",
         color = "Surface Type") +
    theme_minimal() +
    theme(plot.title = element_text(size = 14, face = "bold")) +
    scale_color_manual(values = c("Starshade" = "steelblue", "Calibration" = "coral", "Witness" = "darkgreen"))
  
  # Brightness variability comparison - HISTOGRAM DISTRIBUTION
  brightness_long <- surface_data %>%
    select(Surface_Type, Timing, Original_Median_Brightness, Post_Transform_Median_Brightness) %>%
    pivot_longer(cols = c(Original_Median_Brightness, Post_Transform_Median_Brightness),
                 names_to = "Measurement_Stage", values_to = "Brightness") %>%
    mutate(Measurement_Stage = ifelse(Measurement_Stage == "Original_Median_Brightness", 
                                     "Original", "Post-Transform"))
  
  p4 <- ggplot(brightness_long, aes(x = Brightness)) +
    geom_histogram(aes(fill = Surface_Type), bins = 70, alpha = 0.7, position = "identity") +
    facet_grid(Measurement_Stage ~ Timing, scales = "free") +
    coord_cartesian(xlim = c(0, quantile(brightness_long$Brightness, 0.99, na.rm = TRUE))) +  # Limit to 99th percentile
    labs(title = "Distribution of Surface Brightness Values by Processing Stage",
         subtitle = "Count of images by brightness value",
         x = "Brightness Value", y = "Count of Images",
         fill = "Surface Type") +
    theme_minimal() +
    theme(plot.title = element_text(size = 14, face = "bold")) +
    scale_fill_manual(values = c("Starshade" = "steelblue", "Calibration" = "coral", "Witness" = "darkgreen"))
  
  # Processing effect distribution for surfaces - NEW PLOT
  surface_processing_effect <- surface_data %>%
    mutate(Processing_Effect = Post_Transform_Median_Brightness - Original_Median_Brightness)
  
  p5 <- ggplot(surface_processing_effect, aes(x = Processing_Effect)) +
    geom_histogram(aes(fill = Surface_Type), bins = 70, alpha = 0.7, position = "identity") +
    geom_vline(xintercept = 0, linetype = "dashed", color = "red", alpha = 0.7, size = 1) +
    facet_wrap(~ Timing, scales = "free_y") +
    xlim(-100, 100) +  # Limit x-axis for better readability
    labs(title = "Distribution of Surface Brightness Changes Due to Processing",
         subtitle = "Count of images by brightness change (negative = darker after processing/normalization)",
         x = "Brightness Change (Post-Transform - Original)", y = "Count of Images",
         fill = "Surface Type") +
    theme_minimal() +
    theme(plot.title = element_text(size = 14, face = "bold")) +
    scale_fill_manual(values = c("Starshade" = "steelblue", "Calibration" = "coral", "Witness" = "darkgreen"))
  
  # Timing effect distribution for surfaces - NEW PLOT
  # Check if we have both Before and After timing data
  timing_check <- surface_data %>%
    group_by(Timing) %>%
    summarise(count = n(), .groups = "drop")
  
  if("Before" %in% timing_check$Timing && "After" %in% timing_check$Timing) {
    
    # First, let's see what we're working with
    cat("Attempting timing effect analysis...\n")
    
    timing_wide <- surface_data %>%
      select(Surface_Type, Timing, Original_Median_Brightness, Post_Transform_Median_Brightness, Trial) %>%
      # Ensure we have matching trials for before/after comparison
      group_by(Surface_Type, Trial) %>%
      filter(n() == 2) %>%  # Only keep trials that have both Before and After
      ungroup() %>%
      pivot_wider(names_from = Timing, 
                  values_from = c(Original_Median_Brightness, Post_Transform_Median_Brightness),
                  values_fn = mean)  # In case of duplicates, take mean
    
    # Check what columns were actually created
    cat("Columns created after pivot_wider:", paste(names(timing_wide), collapse = ", "), "\n")
    
    # Check if the expected columns exist
    expected_cols <- c("Original_Median_Brightness_Before", "Original_Median_Brightness_After",
                      "Post_Transform_Median_Brightness_Before", "Post_Transform_Median_Brightness_After")
    
    existing_cols <- intersect(expected_cols, names(timing_wide))
    cat("Expected columns found:", paste(existing_cols, collapse = ", "), "\n")
    
    if(length(existing_cols) >= 2) {
      # Only proceed if we have at least some of the expected columns
      surface_timing_effect <- timing_wide %>%
        # Create timing effects only for columns that exist
        {
          result <- .
          if("Original_Median_Brightness_Before" %in% names(.) && "Original_Median_Brightness_After" %in% names(.)) {
            result <- result %>%
              mutate(Original_Timing_Effect = as.numeric(`Original_Median_Brightness_After`) - as.numeric(`Original_Median_Brightness_Before`))
          }
          if("Post_Transform_Median_Brightness_Before" %in% names(.) && "Post_Transform_Median_Brightness_After" %in% names(.)) {
            result <- result %>%
              mutate(PostTransform_Timing_Effect = as.numeric(`Post_Transform_Median_Brightness_After`) - as.numeric(`Post_Transform_Median_Brightness_Before`))
          }
          result
        } %>%
        # Select only the timing effect columns that were created
        select(Surface_Type, Trial, ends_with("_Timing_Effect")) %>%
        pivot_longer(cols = ends_with("_Timing_Effect"),
                     names_to = "Processing_Stage", values_to = "Timing_Effect") %>%
        mutate(Processing_Stage = case_when(
          Processing_Stage == "Original_Timing_Effect" ~ "Original",
          Processing_Stage == "PostTransform_Timing_Effect" ~ "Post-Transform",
          TRUE ~ Processing_Stage
        )) %>%
        filter(!is.na(Timing_Effect) & is.finite(Timing_Effect))
      
      if(nrow(surface_timing_effect) > 0) {
        p6 <- ggplot(surface_timing_effect, aes(x = Timing_Effect)) +
          geom_histogram(aes(fill = Surface_Type), bins = 50, alpha = 0.7, position = "identity") +
          geom_vline(xintercept = 0, linetype = "dashed", color = "red", alpha = 0.7, size = 1) +
          facet_wrap(~ Processing_Stage, scales = "free") +
          xlim(-50, 50) +  # Limit x-axis for better readability
          labs(title = "Distribution of Surface Brightness Changes Due to Timing",
               subtitle = "Count of images by brightness change (After - Before contamination)",
               x = "Brightness Change (After - Before Contamination)", y = "Count of Images",
               fill = "Surface Type") +
          theme_minimal() +
          theme(plot.title = element_text(size = 14, face = "bold")) +
          scale_fill_manual(values = c("Starshade" = "steelblue", "Calibration" = "coral", "Witness" = "darkgreen"))
        
        cat("Timing effect plot created with", nrow(surface_timing_effect), "paired observations.\n")
      } else {
        p6 <- NULL
        cat("No valid timing effect data after processing.\n")
      }
    } else {
      p6 <- NULL
      cat("Could not find expected columns for timing effect analysis.\n")
      cat("Available columns:", paste(names(timing_wide), collapse = ", "), "\n")
    }
  } else {
    p6 <- NULL
    cat("Both Before and After timing data required for timing effect analysis.\n")
    cat("Available timing groups:", paste(timing_check$Timing, collapse = ", "), "\n")
  }
  
  # Complete condition comparison for surfaces - NEW PLOT
  surface_comparison_data <- surface_data %>%
    select(Surface_Type, Timing, Original_Median_Brightness, Post_Transform_Median_Brightness) %>%
    pivot_longer(cols = c(Original_Median_Brightness, Post_Transform_Median_Brightness),
                 names_to = "Processing_Stage", values_to = "Brightness") %>%
    mutate(Processing_Stage = ifelse(Processing_Stage == "Original_Median_Brightness", "Original", "Post-Transform"))
  
  p7 <- ggplot(surface_comparison_data, aes(x = Brightness)) +
    geom_histogram(aes(fill = Surface_Type), bins = 50, alpha = 0.7, position = "identity") +
    facet_grid(Timing ~ Processing_Stage, scales = "free") +
    coord_cartesian(xlim = c(0, quantile(surface_comparison_data$Brightness, 0.99, na.rm = TRUE))) +  # Limit to 99th percentile
    labs(title = "Distribution of Surface Brightness Across All Conditions",
         subtitle = "Count of images by brightness value across timing and processing conditions",
         x = "Brightness Value", y = "Count of Images",
         fill = "Surface Type") +
    theme_minimal() +
    theme(plot.title = element_text(size = 14, face = "bold"),
          strip.text = element_text(size = 8)) +
    scale_fill_manual(values = c("Starshade" = "steelblue", "Calibration" = "coral", "Witness" = "darkgreen"))
  
  return(list(distribution = p1, change_by_transform = p2, before_vs_after = p3, 
              variability = p4, processing_effect = p5, timing_effect = p6, comparison = p7))
}

#' Create edge brightness plots
create_edge_brightness_plots <- function(edge_data) {
  
  if(is.null(edge_data) || nrow(edge_data) == 0) {
    cat("No edge data available for plotting.\n")
    return(NULL)
  }
  
  # Edge brightness by contamination and processing - HISTOGRAM DISTRIBUTION
  p1 <- ggplot(edge_data, aes(x = Brightness)) +
    geom_histogram(aes(fill = Edge_Type), bins = 30, alpha = 0.7, position = "identity") +
    facet_grid(Contamination + Processing ~ Region, scales = "free") +
    labs(title = "Distribution of Edge Brightness Values by Edge Type",
         subtitle = "Count of measurements by brightness value across all conditions",
         x = "Brightness Value", y = "Count of Measurements",
         fill = "Edge Type") +
    theme_minimal() +
    theme(plot.title = element_text(size = 14, face = "bold"),
          strip.text = element_text(size = 8)) +
    scale_fill_manual(values = c("Starshade" = "steelblue", "Calibration" = "coral"))
  
  # Contamination effect by edge type - HISTOGRAM DISTRIBUTION
  edge_contamination_effect <- edge_data %>%
    pivot_wider(names_from = Contamination, values_from = Brightness) %>%
    mutate(Contamination_Effect = `After Contamination` - `Before Contamination`)
  
  p2 <- ggplot(edge_contamination_effect, aes(x = Contamination_Effect)) +
    geom_histogram(aes(fill = Edge_Type), bins = 30, alpha = 0.7, position = "identity") +
    geom_vline(xintercept = 0, linetype = "dashed", color = "red", alpha = 0.7, size = 1) +
    facet_grid(Processing ~ Region, scales = "free") +
    labs(title = "Distribution of Edge Brightness Changes Due to Contamination",
         subtitle = "Count of measurements by brightness change (positive = brighter after contamination)",
         x = "Brightness Change (After - Before Contamination)", y = "Count of Measurements",
         fill = "Edge Type") +
    theme_minimal() +
    theme(plot.title = element_text(size = 14, face = "bold")) +
    scale_fill_manual(values = c("Starshade" = "steelblue", "Calibration" = "coral"))
  
  # Processing effect by edge type - HISTOGRAM DISTRIBUTION
  edge_processing_effect <- edge_data %>%
    pivot_wider(names_from = Processing, values_from = Brightness) %>%
    mutate(Processing_Effect = `After Processing` - `Before Processing`)
  
  p3 <- ggplot(edge_processing_effect, aes(x = Processing_Effect)) +
    geom_histogram(aes(fill = Edge_Type), bins = 30, alpha = 0.7, position = "identity") +
    geom_vline(xintercept = 0, linetype = "dashed", color = "red", alpha = 0.7, size = 1) +
    facet_grid(Contamination ~ Region, scales = "free") +
    labs(title = "Distribution of Edge Brightness Changes Due to Processing",
         subtitle = "Count of measurements by brightness change (negative = darker after processing/normalization)",
         x = "Brightness Change (After - Before Processing)", y = "Count of Measurements",
         fill = "Edge Type") +
    theme_minimal() +
    theme(plot.title = element_text(size = 14, face = "bold")) +
    scale_fill_manual(values = c("Starshade" = "steelblue", "Calibration" = "coral"))
  
  # Edge type comparison across all conditions - HISTOGRAM DISTRIBUTION
  edge_comparison_data <- edge_data %>%
    unite("Condition", Contamination, Processing, sep = " - ") %>%
    mutate(
      Condition_Short = case_when(
        Condition == "Before Contamination - Before Processing" ~ "Bef Cont - Bef Proc",
        Condition == "Before Contamination - After Processing" ~ "Bef Cont - Aft Proc",
        Condition == "After Contamination - Before Processing" ~ "Aft Cont - Bef Proc",
        Condition == "After Contamination - After Processing" ~ "Aft Cont - Aft Proc"
      )
    )
  
  p4 <- ggplot(edge_comparison_data, aes(x = Brightness)) +
    geom_histogram(aes(fill = Edge_Type), bins = 25, alpha = 0.7, position = "identity") +
    facet_grid(Condition_Short ~ Region, scales = "free") +
    labs(title = "Distribution of Edge Brightness: Starshade vs Calibration",
         subtitle = "Count of measurements by brightness value across all processing conditions",
         x = "Brightness Value", y = "Count of Measurements",
         fill = "Edge Type") +
    theme_minimal() +
    theme(plot.title = element_text(size = 14, face = "bold"),
          strip.text = element_text(size = 8)) +
    scale_fill_manual(values = c("Starshade" = "steelblue", "Calibration" = "coral"))
  
  return(list(brightness_by_status = p1, contamination_effect = p2, 
              processing_effect = p3, edge_comparison = p4))
}

# ========================================================================
# MAIN BRIGHTNESS ANALYSIS EXECUTION
# ========================================================================

cat("=== BRIGHTNESS ANALYSIS INITIALIZATION ===\n")
cat("Analyzing image brightness patterns across surface and edge types...\n")
cat("Target analyses: Starshade Surface, Calibration Surface, Witness Surface, Starshade Edge, Calibration Edge\n\n")

# Analyze surface brightness data
all_surface_brightness_data <- analyze_all_surface_brightness()

# Analyze edge brightness data  
all_edge_brightness_data <- analyze_all_edge_brightness()

# Create visualizations
if(!is.null(all_surface_brightness_data)) {
  cat("Creating surface brightness visualizations...\n")
  surface_brightness_plots <- create_surface_brightness_plots(all_surface_brightness_data)
  
  if(!is.null(surface_brightness_plots)) {
    print(surface_brightness_plots$distribution)
    print(surface_brightness_plots$change_by_transform)
    print(surface_brightness_plots$before_vs_after)
    print(surface_brightness_plots$variability)
    print(surface_brightness_plots$processing_effect)
    if(!is.null(surface_brightness_plots$timing_effect)) {
      print(surface_brightness_plots$timing_effect)
    }
    print(surface_brightness_plots$comparison)
  }
}

if(!is.null(all_edge_brightness_data)) {
  cat("Creating edge brightness visualizations...\n")
  edge_brightness_plots <- create_edge_brightness_plots(all_edge_brightness_data)
  
  if(!is.null(edge_brightness_plots)) {
    print(edge_brightness_plots$brightness_by_status)
    print(edge_brightness_plots$contamination_effect)
    print(edge_brightness_plots$processing_effect)
    print(edge_brightness_plots$edge_comparison)
  }
}

# ========================================================================
# BRIGHTNESS STATISTICS AND SUMMARIES
# ========================================================================

if(!is.null(all_surface_brightness_data)) {
  
  cat("\n=== SURFACE BRIGHTNESS SUMMARY STATISTICS ===\n")
  
  surface_brightness_summary <- all_surface_brightness_data %>%
    group_by(Surface_Type, Timing) %>%
    summarise(
      Count = n(),
      Original_Mean = round(mean(Original_Median_Brightness, na.rm = TRUE), 1),
      Original_SD = round(sd(Original_Median_Brightness, na.rm = TRUE), 1),
      PostTransform_Mean = round(mean(Post_Transform_Median_Brightness, na.rm = TRUE), 1),
      PostTransform_SD = round(sd(Post_Transform_Median_Brightness, na.rm = TRUE), 1),
      Avg_Change_Percent = round(mean(Brightness_Change_Percent, na.rm = TRUE), 1),
      .groups = "drop"
    )
  
  print(surface_brightness_summary)
  
  # Calculate normalization effectiveness by surface type
  cat("\n=== SURFACE BRIGHTNESS NORMALIZATION EFFECTIVENESS ===\n")
  
  normalization_effectiveness <- all_surface_brightness_data %>%
    group_by(Surface_Type, Timing) %>%
    summarise(
      Original_CV = sd(Original_Median_Brightness, na.rm = TRUE) / 
                    mean(Original_Median_Brightness, na.rm = TRUE),
      PostTransform_CV = sd(Post_Transform_Median_Brightness, na.rm = TRUE) / 
                         mean(Post_Transform_Median_Brightness, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      CV_Improvement_Percent = round((Original_CV - PostTransform_CV) / Original_CV * 100, 1),
      Original_CV = round(Original_CV, 3),
      PostTransform_CV = round(PostTransform_CV, 3)
    )
  
  print(normalization_effectiveness)
}

if(!is.null(all_edge_brightness_data)) {
  
  cat("\n=== EDGE BRIGHTNESS SUMMARY STATISTICS ===\n")
  
  edge_brightness_summary <- all_edge_brightness_data %>%
    group_by(Edge_Type, Contamination, Processing, Region) %>%
    summarise(
      Count = n(),
      Mean_Brightness = round(mean(Brightness, na.rm = TRUE), 1),
      SD_Brightness = round(sd(Brightness, na.rm = TRUE), 1),
      CV = round(sd(Brightness, na.rm = TRUE) / mean(Brightness, na.rm = TRUE), 3),
      .groups = "drop"
    ) %>%
    arrange(Edge_Type, Region, Contamination, Processing)
  
  print(edge_brightness_summary)
  
  # Analyze contamination and processing effects by edge type
  cat("\n=== EDGE BRIGHTNESS CHANGE EFFECTS BY EDGE TYPE ===\n")
  
  # Contamination effects
  contamination_effects <- all_edge_brightness_data %>%
    group_by(Edge_Type, Trial, Processing, Region) %>%
    summarise(
      Before_Contamination = mean(Brightness[Contamination == "Before Contamination"], na.rm = TRUE),
      After_Contamination = mean(Brightness[Contamination == "After Contamination"], na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(Contamination_Effect = After_Contamination - Before_Contamination) %>%
    group_by(Edge_Type, Processing, Region) %>%
    summarise(
      Mean_Contamination_Effect = round(mean(Contamination_Effect, na.rm = TRUE), 1),
      SD_Contamination_Effect = round(sd(Contamination_Effect, na.rm = TRUE), 1),
      .groups = "drop"
    )
  
  cat("Average brightness change due to contamination:\n")
  print(contamination_effects)
  
  # Processing effects
  processing_effects <- all_edge_brightness_data %>%
    group_by(Edge_Type, Trial, Contamination, Region) %>%
    summarise(
      Before_Processing = mean(Brightness[Processing == "Before Processing"], na.rm = TRUE),
      After_Processing = mean(Brightness[Processing == "After Processing"], na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(Processing_Effect = After_Processing - Before_Processing) %>%
    group_by(Edge_Type, Contamination, Region) %>%
    summarise(
      Mean_Processing_Effect = round(mean(Processing_Effect, na.rm = TRUE), 1),
      SD_Processing_Effect = round(sd(Processing_Effect, na.rm = TRUE), 1),
      .groups = "drop"
    )
  
  cat("\nAverage brightness change due to processing:\n")
  print(processing_effects)
  
  # Direct comparison between Starshade and Calibration edges
  cat("\n=== STARSHADE vs CALIBRATION EDGE COMPARISON ===\n")
  
  edge_comparison <- all_edge_brightness_data %>%
    group_by(Edge_Type, Contamination, Processing, Region) %>%
    summarise(Mean_Brightness = mean(Brightness, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = Edge_Type, values_from = Mean_Brightness) %>%
    mutate(
      Difference = round(Starshade - Calibration, 1),
      Percent_Difference = round((Starshade - Calibration) / Calibration * 100, 1)
    )
  
  print(edge_comparison)
}

# ========================================================================
# STORE RESULTS FOR INTEGRATION
# ========================================================================

# Store all brightness analysis results for use in other sections
brightness_analysis_results <- list(
  surface_data = all_surface_brightness_data,
  edge_data = all_edge_brightness_data,
  surface_summary = if(exists("surface_brightness_summary")) surface_brightness_summary else NULL,
  edge_summary = if(exists("edge_brightness_summary")) edge_brightness_summary else NULL,
  normalization_effectiveness = if(exists("normalization_effectiveness")) normalization_effectiveness else NULL,
  contamination_effects = if(exists("contamination_effects")) contamination_effects else NULL,
  processing_effects = if(exists("processing_effects")) processing_effects else NULL,
  edge_comparison = if(exists("edge_comparison")) edge_comparison else NULL,
  surface_plots = if(exists("surface_brightness_plots")) surface_brightness_plots else NULL,
  edge_plots = if(exists("edge_brightness_plots")) edge_brightness_plots else NULL
)

cat("\n=== BRIGHTNESS ANALYSIS COMPLETE ===\n")
cat("Results stored in 'brightness_analysis_results' list for integration with main analysis.\n")
if(!is.null(all_surface_brightness_data)) {
  surface_types <- paste(unique(paste(all_surface_brightness_data$Surface_Type, all_surface_brightness_data$Timing)), collapse = ", ")
  cat("Surface types analyzed:", surface_types, "\n")
}
if(!is.null(all_edge_brightness_data)) {
  edge_types <- paste(unique(all_edge_brightness_data$Edge_Type), collapse = ", ")
  cat("Edge types analyzed:", edge_types, "\n")
}
cat("\nAvailable result components:\n")
cat("- surface_data: Combined surface brightness data (Starshade, Calibration, Witness × Before/After)\n")
cat("- edge_data: Combined edge brightness data (Starshade, Calibration)\n") 
cat("- surface_summary: Summary statistics for all surface types and timing\n")
cat("- edge_summary: Summary statistics for all edge types\n")
cat("- normalization_effectiveness: CV improvement metrics by surface type and timing\n")
cat("- contamination_effects: Brightness changes due to contamination by edge type\n")
cat("- processing_effects: Brightness changes due to processing by edge type\n")
cat("- edge_comparison: Direct Starshade vs Calibration edge comparison\n")
cat("- surface_plots: Surface visualization plots (distribution, change_by_transform, before_vs_after, variability, processing_effect, timing_effect, comparison)\n")
cat("- edge_plots: Edge visualization plots (brightness_by_status, contamination_effect, processing_effect, edge_comparison)\n\n")
```



## 8. Error Stats

```{r}
# Function to calculate error statistics for any dataset with grouped counts
# This handles both normalized and raw data
calculate_error_stats <- function(data, group_vars = c("Trial", "Area"), 
                                  count_var = "Cumulative_Count", 
                                  norm_factor = NULL) {
  
  # Process the data with proper grouping
  result <- data %>%
    group_by(across(all_of(group_vars))) %>%
    summarize(
      Average_Count = mean(!!sym(count_var), na.rm = TRUE),
      StdDev = sd(!!sym(count_var), na.rm = TRUE),
      n = n(),
      # If n=1 (e.g., for model data), use Poisson statistics instead
      StdError = ifelse(n > 1, StdDev / sqrt(n - 1), sqrt(Average_Count)),
      # Apply normalization if provided
      .groups = "drop"
    )
  
  # Apply normalization if provided
  if (!is.null(norm_factor)) {
    result <- result %>%
      mutate(
        # Scale the error by the same normalization factor
        StdError = StdError * norm_factor
      )
  }
  
  # Calculate log statistics with proper error handling
  result <- result %>%
    mutate(
      # For log scale, calculate upper and lower bounds
      Upper_raw = Average_Count + StdError,
      Lower_raw = pmax(Average_Count - StdError, 1), # Prevent negative values
      # Transform to log scale
      log_area = log10(Area),
      log_count = log10(Average_Count),
      log_count = ifelse(log_count < 0, 0, log_count),
      Upper = log10(Upper_raw),
      Lower = log10(Lower_raw)
    )
  
  return(result)
}

# Calculate error statistics for each dataset type
# 1. Surface data - cumulative
surface_error_stats <- calculate_error_stats(
  cumulative_surface,
  group_vars = c("Trial", "Area"),
  count_var = "Cumulative_Count"
)

# 2. Surface data - binned
surface_binned_error_stats <- average_surface_binned %>%
  group_by(Trial, Area) %>%
  mutate(
    # For binned data, use Poisson statistics
    StdError = sqrt(Average_Count),
    Upper_raw = Average_Count + StdError,
    Lower_raw = pmax(Average_Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()

# 3. Edge data - cumulative
edge_error_stats <- calculate_error_stats(
  cumulative_edge, 
  group_vars = c("Trial", "Area"),
  count_var = "Cumulative_Count"
)

# 4. Edge data - binned
edge_binned_error_stats <- binned_edge %>%
  group_by(Trial, Area) %>%
  mutate(
    StdError = sqrt(Count),
    Upper_raw = Count + StdError,
    Lower_raw = pmax(Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()


# 5. Calibration edge data
calibration_edge_error_stats <- calculate_error_stats(
  cw_cumulative_edge,
  group_vars = c("Trial", "Area"),
  count_var = "Cumulative_Count"
)

# 6. Model data
# Since model data doesn't have sample variation, we'll use theoretical Poisson errors
model_edge_error_stats <- model_average_edge_cumulative%>%
  group_by(Trial, Area) %>%
  mutate(
    StdError = sqrt(Average_Count),
    Upper_raw = Average_Count + StdError,
    Lower_raw = pmax(Average_Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()

# 7. SLSM Starshade edge model
SSLSM_edge_error_stats <- rbind(
  SSLSM_edge_9, SSLSM_edge_10, SSLSM_edge_11, 
  SSLSM_edge_12, SSLSM_edge_13, SSLSM_edge_14
) %>%
  group_by(Trial, Area) %>%
  mutate(
    StdError = sqrt(Cumulative_Count),
    Upper_raw = Cumulative_Count + StdError,
    Lower_raw = pmax(Cumulative_Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()

# 8. SLSM Witness edge model
WSLSM_edge_error_stats <- rbind(
  WSLSM_edge_9, WSLSM_edge_10, WSLSM_edge_11, 
  WSLSM_edge_12, WSLSM_edge_13, WSLSM_edge_14
) %>%
  group_by(Trial, Area) %>%
  mutate(
    StdError = sqrt(Cumulative_Count),
    Upper_raw = Cumulative_Count + StdError,
    Lower_raw = pmax(Cumulative_Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()

# 9. Calibration wafer surface data
cw_surface_error_stats <- cw_average_surface_cumulative %>%
  group_by(Trial, Area) %>%
  mutate(
    StdError = sqrt(Average_Count),
    Upper_raw = Average_Count + StdError,
    Lower_raw = pmax(Average_Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()

# 10. Witness surface data
wit_surface_error_stats <- wit_average_surface_cumulative %>%
  group_by(Trial, Area) %>%
  mutate(
    StdError = sqrt(Average_Count),
    Upper_raw = Average_Count + StdError,
    Lower_raw = pmax(Average_Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()

# Function to extract trial-specific error stats
get_trial_error_stats <- function(error_stats_df, trial_num) {
  error_stats_df %>% filter(Trial == trial_num)
}
```

## 8. Trial Anlysis Graphs

### 8.1 Trial 9

```{r trial_9 graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_9,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
      geom_line(data = wit_surface_9,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
            linetype = "dashed") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 9: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange/Solid: Starshade Surface, Green/Dashed: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
      geom_line(data = wit_surface_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
            linetype = "dashed") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 9: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange/Solid: Starshade Surface, Green: Witness Surface") +
  custom_theme


# Plot the cumulative edge distributions
ggplot() +
  geom_line(data = edge_9,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_9,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_9,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_9,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
          geom_line(data = WSLSM_edge_9,
              aes(x = log_area, y = log_count),
                  color = "#56B4E9", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 9: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions
ggplot() +
  geom_line(data = edge_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_9_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_9_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_9_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
          geom_line(data = WSLSM_edge_9_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#56B4E9", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 9: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

ggplot() +
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 9 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_surface %>% 
              filter(Trial == 9 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 9 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 9 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 9 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 9 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 9 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 9 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "1"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "2"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "3"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "4"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "5"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 9 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 9 & Sample == "16"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 9 & Sample == "17"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 9 & Sample == "18"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 9 & Sample == "19"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 9 & Sample == "20"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 9 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_binned_edge %>% 
              filter(Trial == 9 & Sample == "16"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 9 & Sample == "17"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 9 & Sample == "18"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 9 & Sample == "19"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 9 & Sample == "20"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 9 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


```

```{r, include=FALSE, echo = FALSE, eval=FALSE}
# Plot the cumulative distribution of Surface data with error bars
ggplot() +
  # Starshade Surface with error bars
  geom_line(data = surface_9,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(surface_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # Witness Surface with error bars
  geom_line(data = wit_surface_9,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(wit_surface_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 9: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Green: Witness Surface") +
  custom_theme

# Plot the binned distribution of surface data with error bars
ggplot() +
  # Starshade Surface binned with error bars
  geom_line(data = surface_9_binned,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
            linetype = "solid") +
  geom_errorbar(data = surface_9_binned %>% 
                  mutate(StdError = sqrt(Average_Count),
                         Upper = log10(Average_Count + StdError),
                         Lower = log10(pmax(Average_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # Witness Surface binned with error bars
  geom_line(data = wit_surface_9_binned,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
            linetype = "dashed") +
  geom_errorbar(data = wit_surface_9_binned %>% 
                  mutate(StdError = sqrt(Average_Count),
                         Upper = log10(Average_Count + StdError),
                         Lower = log10(pmax(Average_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 9: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Green: Witness Surface") +
  custom_theme

# Plot the cumulative edge distributions with error bars
ggplot() +
  # Starshade Observed Edge with error bars
  geom_line(data = edge_9,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(edge_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Calibration Edge with error bars
  geom_line(data = cw_edge_9,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(calibration_edge_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#0072B2", alpha = 0.2) +
  
  # Model Edge with error bars
  geom_line(data = model_edge_9,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(model_edge_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  # SLSM Starshade with error bars
  geom_line(data = SSLSM_edge_9,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_ribbon(data = get_trial_error_stats(SSLSM_edge_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # SLSM Witness with error bars
  geom_line(data = WSLSM_edge_9,
            aes(x = log_area, y = log_count),
            color = "#56B4E9", 
                  linetype = "longdash") +
  geom_ribbon(data = get_trial_error_stats(WSLSM_edge_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#56B4E9", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 9: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions with error bars
ggplot() +
  # Starshade Edge binned with error bars
  geom_line(data = edge_9_binned,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_errorbar(data = edge_9_binned %>% 
                  mutate(StdError = sqrt(Average_Count),
                         Upper = log10(Average_Count + StdError),
                         Lower = log10(pmax(Average_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Calibration Edge binned with error bars
  geom_line(data = cw_edge_9_binned,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cw_edge_9_binned %>% 
                  mutate(StdError = sqrt(Average_Count),
                         Upper = log10(Average_Count + StdError),
                         Lower = log10(pmax(Average_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  # Model Edge binned with error bars
  geom_line(data = model_edge_9_binned,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = model_edge_9_binned %>% 
                  mutate(StdError = sqrt(Average_Count),
                         Upper = log10(Average_Count + StdError),
                         Lower = log10(pmax(Average_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  # SLSM Starshade binned with error bars
  geom_line(data = SSLSM_edge_9_binned,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_errorbar(data = SSLSM_edge_9_binned %>% 
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # SLSM Witness binned with error bars
  geom_line(data = WSLSM_edge_9_binned,
            aes(x = log_area, y = log_count),
            color = "#56B4E9", 
                  linetype = "longdash") +
  geom_errorbar(data = WSLSM_edge_9_binned %>% 
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 9: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Sample comparison plot with error bars
ggplot() +
  # Loop through samples 1-5 and add lines with error bars for each
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_surface %>% 
                  filter(Trial == 9 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_surface %>% 
                  filter(Trial == 9 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_surface %>% 
                  filter(Trial == 9 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_surface %>% 
                  filter(Trial == 9 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_surface %>% 
                  filter(Trial == 9 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 9 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme
```

### 8.2 Trial 10

```{r trial_10 graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_10,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
      geom_line(data = wit_surface_10,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
            linetype = "dashed") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 10: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange/Solid: Starshade Surface, Green/Dashed: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_10_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
      geom_line(data = wit_surface_10_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
            linetype = "dashed") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 10: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange/Solid: Starshade Surface, Green: Witness Surface") +
  custom_theme


# Plot the cumulative edge distributions
ggplot() +
  geom_line(data = edge_10,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_10,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_10,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
          geom_line(data = WSLSM_edge_10,
              aes(x = log_area, y = log_count),
                  color = "#56B4E9", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 10: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions
ggplot() +
  geom_line(data = edge_10_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_10_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_10_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
          geom_line(data = WSLSM_edge_10_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#56B4E9", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 10: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

ggplot() +
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 10 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 10 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 10 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 10 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 10 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 10 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_surface %>% 
              filter(Trial == 10 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 10 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 10 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 10 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 10 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 10 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "6"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "7"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "8"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "9"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "10"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 10 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "6"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "7"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "8"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "9"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "10"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 10 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 10 & Sample == "21"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 10 & Sample == "22"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 10 & Sample == "23"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 10 & Sample == "24"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 10 & Sample == "25"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 10 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_binned_edge %>% 
              filter(Trial == 10 & Sample == "21"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 10 & Sample == "22"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 10 & Sample == "23"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 10 & Sample == "24"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 10 & Sample == "25"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 10 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


```

### 8.2 Trial 10 with Error Bars

```{r trial_10_graphs_with_errors, include=FALSE, echo = FALSE, eval=FALSE}
# Plot the cumulative distribution of Surface data with error bars
ggplot() +
  # Starshade Surface with error bars
  geom_line(data = surface_10,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(surface_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # Witness Surface with error bars
  geom_line(data = wit_surface_10,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(wit_surface_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 10: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Green: Witness Surface") +
  custom_theme

# Plot the binned distribution of surface data with error bars
ggplot() +
  # Starshade Surface binned with error bars
  geom_line(data = surface_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
            linetype = "solid") +
  geom_errorbar(data = surface_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # Witness Surface binned with error bars
  geom_line(data = wit_surface_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
            linetype = "dashed") +
  geom_errorbar(data = wit_surface_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 10: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Green: Witness Surface") +
  custom_theme

# Plot the cumulative edge distributions with error bars
ggplot() +
  # Starshade Observed Edge with error bars
  geom_line(data = edge_10,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(edge_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Calibration Edge with error bars
  geom_line(data = cw_edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(calibration_edge_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#0072B2", alpha = 0.2) +
  
  # Model Edge with error bars
  geom_line(data = model_edge_10,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(model_edge_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  # SLSM Starshade with error bars
  geom_line(data = s_bmodel_edge_10,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_ribbon(data = get_trial_error_stats(s_bmodel_edge_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # SLSM Witness with error bars
  geom_line(data = w_bmodel_edge_10,
            aes(x = log_area, y = log_count),
            color = "#56B4E9", 
                  linetype = "longdash") +
  geom_ribbon(data = get_trial_error_stats(w_bmodel_edge_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#56B4E9", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 10: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions with error bars
ggplot() +
  # Starshade Edge binned with error bars
  geom_line(data = edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_errorbar(data = edge_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Calibration Edge binned with error bars
  geom_line(data = cw_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cw_edge_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  # Model Edge binned with error bars
  geom_line(data = model_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = model_edge_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  # SLSM Starshade binned with error bars
  geom_line(data = s_bmodel_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_errorbar(data = s_bmodel_edge_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # SLSM Witness binned with error bars
  geom_line(data = w_bmodel_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#56B4E9", 
                  linetype = "longdash") +
  geom_errorbar(data = w_bmodel_edge_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 10: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Sample comparison plot with error bars
ggplot() +
  # Loop through samples 1-5 and add lines with error bars for each
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 10 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 10 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 10 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 10 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 10 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 10 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 10 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 10 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 10 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 10 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 10 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme
```

### 8.3 Trial 11

```{r trial_11 graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_11,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
      geom_line(data = wit_surface_11,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
            linetype = "dashed") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 11: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange/Solid: Starshade Surface, Green/Dashed: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_11_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
      geom_line(data = wit_surface_11_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
            linetype = "dashed") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 11: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange/Solid: Starshade Surface, Green: Witness Surface") +
  custom_theme


# Plot the cumulative edge distributions
ggplot() +
  geom_line(data = edge_11,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_11,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
          geom_line(data = WSLSM_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#56B4E9", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 11: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions
ggplot() +
  geom_line(data = edge_11_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
          geom_line(data = WSLSM_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#56B4E9", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 11: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

ggplot() +
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 11 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 11 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 11 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 11 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 11 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 11 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_surface %>% 
              filter(Trial == 11 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 11 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 11 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 11 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 11 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 11 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "11"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "12"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "13"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "14"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "15"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 11 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "11"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "12"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "13"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "14"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "15"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 11 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 11 & Sample == "26"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 11 & Sample == "27"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 11 & Sample == "28"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 11 & Sample == "29"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 11 & Sample == "30"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 11 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_binned_edge %>% 
              filter(Trial == 11 & Sample == "26"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 11 & Sample == "27"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 11 & Sample == "28"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 11 & Sample == "29"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 11 & Sample == "30"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 11 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

```

```{r trial_11_graphs_with_errors, include=FALSE, echo = FALSE, eval=FALSE}
# Plot the cumulative distribution of Surface data with error bars
ggplot() +
  # Starshade Surface with error bars
  geom_line(data = surface_11,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(surface_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # Witness Surface with error bars
  geom_line(data = wit_surface_11,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(wit_surface_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 11: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Green: Witness Surface") +
  custom_theme

# Plot the binned distribution of surface data with error bars
ggplot() +
  # Starshade Surface binned with error bars
  geom_line(data = surface_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
            linetype = "solid") +
  geom_errorbar(data = surface_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # Witness Surface binned with error bars
  geom_line(data = wit_surface_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
            linetype = "dashed") +
  geom_errorbar(data = wit_surface_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 11: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Green: Witness Surface") +
  custom_theme

# Plot the cumulative edge distributions with error bars
ggplot() +
  # Starshade Observed Edge with error bars
  geom_line(data = edge_11,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(edge_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Calibration Edge with error bars
  geom_line(data = cw_edge_11,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(calibration_edge_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#0072B2", alpha = 0.2) +
  
  # Model Edge with error bars
  geom_line(data = model_edge_11,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(model_edge_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  # SLSM Starshade with error bars
  geom_line(data = s_bmodel_edge_11,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_ribbon(data = get_trial_error_stats(s_bmodel_edge_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # SLSM Witness with error bars
  geom_line(data = w_bmodel_edge_11,
            aes(x = log_area, y = log_count),
            color = "#56B4E9", 
                  linetype = "longdash") +
  geom_ribbon(data = get_trial_error_stats(w_bmodel_edge_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#56B4E9", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 11: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions with error bars
ggplot() +
  # Starshade Edge binned with error bars
  geom_line(data = edge_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_errorbar(data = edge_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Calibration Edge binned with error bars
  geom_line(data = cw_edge_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cw_edge_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  # Model Edge binned with error bars
  geom_line(data = model_edge_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = model_edge_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  # SLSM Starshade binned with error bars
  geom_line(data = s_bmodel_edge_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_errorbar(data = s_bmodel_edge_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # SLSM Witness binned with error bars
  geom_line(data = w_bmodel_edge_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#56B4E9", 
                  linetype = "longdash") +
  geom_errorbar(data = w_bmodel_edge_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 11: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Sample comparison plot with error bars
ggplot() +
  # Loop through samples 1-5 and add lines with error bars for each
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 11 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 11 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 11 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 11 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 11 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 11 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 11 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 11 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 11 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 11 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 11 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme
```

### 8.4 Trial 12

```{r trial_12 graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_12,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_12,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "dashed") +
      geom_line(data = wit_surface_12,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 12: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_12_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_12_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "dashed") +
        geom_line(data = wit_surface_12_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 12: Binned Particle Size Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme 


# Plot the cumulative edge distributions
ggplot() +
  geom_line(data = edge_12,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_12,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = CSLSM_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "longdash") +
        geom_line(data = WSLSM_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#56B4E9", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 12: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions
ggplot() +
  geom_line(data = edge_12_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
        geom_line(data = CSLSM_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "longdash") +
          geom_line(data = WSLSM_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#56B4E9", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 12: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

ggplot() +
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 12 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 12 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 12 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 12 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 12 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 12 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_surface %>% 
              filter(Trial == 12 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 12 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 12 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 12 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 12 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 12 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 12 & Sample == "16"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 12 & Sample == "17"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 12 & Sample == "18"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 12 & Sample == "19"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 12 & Sample == "20"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 12 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_edge %>% 
              filter(Trial == 12 & Sample == "16"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 12 & Sample == "17"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 12 & Sample == "18"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 12 & Sample == "19"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 12 & Sample == "20"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 12 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 12 & Sample == "31"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 12 & Sample == "32"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 12 & Sample == "33"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 12 & Sample == "34"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 12 & Sample == "35"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 12 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_binned_edge %>% 
              filter(Trial == 12 & Sample == "31"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 12 & Sample == "32"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 12 & Sample == "33"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 12 & Sample == "34"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 12 & Sample == "35"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 12 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

```

```{r trial_12_graphs_with_errors, include=FALSE, echo = FALSE, eval=FALSE}
# Plot the cumulative distribution of Surface data with error bars
ggplot() +
  # Starshade Surface with error bars
  geom_line(data = surface_12,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(surface_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # Calibration Surface with error bars
  geom_line(data = cw_surface_12,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(cw_surface_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Witness Surface with error bars
  geom_line(data = wit_surface_12,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(wit_surface_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 12: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme

# Plot the binned distribution of surface data with error bars
ggplot() +
  # Starshade Surface binned with error bars
  geom_line(data = surface_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
            linetype = "solid") +
  geom_errorbar(data = surface_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # Calibration Surface binned with error bars
  geom_line(data = cw_surface_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#CC79A7", 
            linetype = "dashed") +
  geom_errorbar(data = cw_surface_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Witness Surface binned with error bars
  geom_line(data = wit_surface_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = wit_surface_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 12: Binned Particle Size Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme

# Plot the cumulative edge distributions with error bars
ggplot() +
  # Starshade Observed Edge with error bars
  geom_line(data = edge_12,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(edge_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Calibration Edge with error bars
  geom_line(data = cw_edge_12,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(calibration_edge_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#0072B2", alpha = 0.2) +
  
  # Model Edge with error bars
  geom_line(data = model_edge_12,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(model_edge_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  # SLSM Starshade with error bars
  geom_line(data = s_bmodel_edge_12,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_ribbon(data = get_trial_error_stats(s_bmodel_edge_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # SLSM Calibration with error bars
  geom_line(data = c_bmodel_edge_12,
            aes(x = log_area, y = log_count),
            color = "#F0E442", 
                  linetype = "longdash") +
  geom_errorbar(data = c_bmodel_edge_12 %>% 
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#F0E442", alpha = 0.5) +
  
  # SLSM Witness with error bars
  geom_line(data = w_bmodel_edge_12,
            aes(x = log_area, y = log_count),
            color = "#56B4E9", 
                  linetype = "twodash") +
  geom_ribbon(data = get_trial_error_stats(w_bmodel_edge_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#56B4E9", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 12: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions with error bars
ggplot() +
  # Starshade Edge binned with error bars
  geom_line(data = edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_errorbar(data = edge_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Calibration Edge binned with error bars
  geom_line(data = cw_edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cw_edge_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  # Model Edge binned with error bars
  geom_line(data = model_edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = model_edge_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  # SLSM Starshade binned with error bars
  geom_line(data = s_bmodel_edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_errorbar(data = s_bmodel_edge_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # SLSM Calibration binned with error bars
  geom_line(data = c_bmodel_edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#F0E442", 
                  linetype = "longdash") +
  geom_errorbar(data = c_bmodel_edge_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#F0E442", alpha = 0.5) +
  
  # SLSM Witness binned with error bars
  geom_line(data = w_bmodel_edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#56B4E9", 
                  linetype = "twodash") +
  geom_errorbar(data = w_bmodel_edge_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 12: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Sample comparison plot with error bars
ggplot() +
  # Loop through samples 1-5 and add lines with error bars for each
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 12 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

# Calibration sample comparison plot with error bars
ggplot() +
  # Loop through calibration samples 1-5 and add lines with error bars for each
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Analysis 12 - Sample: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

# # Combined sample comparison with error bands
# ggplot() +
#   # Starshade Samples
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "1"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#56B4E9", 
#             linetype = "solid") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "1") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#56B4E9", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "2"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#0072B2", 
#             linetype = "dashed") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "2") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#0072B2", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "3"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#009E73") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "3") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#009E73", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "4"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#CC79A7") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "4") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#CC79A7", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "5"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#D55E00") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "5") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#D55E00", alpha = 0.1) +
#   
#   # Calibration Samples with dotted lines
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "1"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#56B4E9", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "1") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#56B4E9", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "2"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#0072B2", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "2") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#0072B2", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "3"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#009E73", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "3") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#009E73", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "4"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#CC79A7", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "4") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#CC79A7", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "5"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#D55E00", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "5") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#D55E00", alpha = 0.1) +
#   
#   # Witness Sample with dashed line
#   geom_line(data = witcumulative_surface_counts %>% 
#               filter(Trial == 12),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#56B4E9", linetype = "dashed") +
#   geom_ribbon(data = witcumulative_surface_counts %>% 
#                 filter(Trial == 12) %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#56B4E9", alpha = 0.1) +
#   
#   labs(
#     x = expression(log[10](Area)~"(square microns)"),
#     y = "log10(Particle Count)",
#     title = "All Surface Analysis 12 - Samples: Cumulative Particle Area Distribution",
#     subtitle = "Solid: Starshade Samples, Dotted: Calibration Samples, Dashed: Witness Sample\nColors: Sky Blue (1), Navy Blue (2), Green (3), Purple (4), Orange (5)") +
#   custom_theme

# Edge sample comparison with error bars
ggplot() +
  # Loop through samples 1-5 and add lines with error bars for each
  geom_line(data = cumulative_edge_counts1 %>% 
              filter(Trial == 12 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_edge_counts1 %>% 
                  filter(Trial == 12 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_edge_counts1 %>% 
              filter(Trial == 12 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_edge_counts1 %>% 
                  filter(Trial == 12 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_edge_counts1 %>% 
              filter(Trial == 12 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_edge_counts1 %>% 
                  filter(Trial == 12 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_edge_counts1 %>% 
              filter(Trial == 12 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_edge_counts1 %>% 
                  filter(Trial == 12 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_edge_counts1 %>% 
              filter(Trial == 12 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_edge_counts1 %>% 
                  filter(Trial == 12 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 12 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

# Calibration edge sample comparison with error bars
ggplot() +
  # Loop through samples and add lines with error bars for each
  geom_line(data = cumulative_calibration_counts %>% 
              filter(Trial == 12 & Sample == "31"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_calibration_counts %>% 
                  filter(Trial == 12 & Sample == "31") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_calibration_counts %>% 
              filter(Trial == 12 & Sample == "32"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_calibration_counts %>% 
                  filter(Trial == 12 & Sample == "32") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_calibration_counts %>% 
              filter(Trial == 12 & Sample == "33"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_calibration_counts %>% 
                  filter(Trial == 12 & Sample == "33") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_calibration_counts %>% 
              filter(Trial == 12 & Sample == "34"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_calibration_counts %>% 
                  filter(Trial == 12 & Sample == "34") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_calibration_counts %>% 
              filter(Trial == 12 & Sample == "35"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_calibration_counts %>% 
                  filter(Trial == 12 & Sample == "35") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 12 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 31, Navy Blue: Sample 32, Green: Sample 33, Purple: Sample 34, Orange: Sample 35") +
  custom_theme
```

### 8.5 Trial 13

```{r trial_13 graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_13,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_13,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "dashed") +
      geom_line(data = wit_surface_13,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 13: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_13_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_13_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "dashed") +
        geom_line(data = wit_surface_13_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 13: Binned Particle Size Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme 


# Plot the cumulative edge distributions
ggplot() +
  geom_line(data = edge_13,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_13,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = CSLSM_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "longdash") +
        geom_line(data = WSLSM_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#56B4E9", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 13: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions
ggplot() +
  geom_line(data = edge_13_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
        geom_line(data = CSLSM_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "longdash") +
          geom_line(data = WSLSM_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#56B4E9", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 13: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

ggplot() +
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 13 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 13 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 13 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 13 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 13 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 13 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_surface %>% 
              filter(Trial == 13 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 13 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 13 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 13 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 13 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 13 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 13 & Sample == "21"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 13 & Sample == "22"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 13 & Sample == "23"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 13 & Sample == "24"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 13 & Sample == "25"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 13 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_edge %>% 
              filter(Trial == 13 & Sample == "21"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 13 & Sample == "22"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 13 & Sample == "23"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 13 & Sample == "24"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 13 & Sample == "25"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 13 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 13 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 13 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 13 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 13 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 13 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Surface Analysis 13 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_binned_surface %>% 
              filter(Trial == 13 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_surface %>% 
              filter(Trial == 13 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_surface %>% 
              filter(Trial == 13 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_surface %>% 
              filter(Trial == 13 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_surface %>% 
              filter(Trial == 13 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Surface Analysis 13 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 13 & Sample == "36"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 13 & Sample == "37"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 13 & Sample == "38"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 13 & Sample == "39"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 13 & Sample == "40"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 13 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_binned_edge %>% 
              filter(Trial == 13 & Sample == "36"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 13 & Sample == "37"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 13 & Sample == "38"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 13 & Sample == "39"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 13 & Sample == "40"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 13 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme
```

```{r trial_13_graphs_with_errors, include=FALSE, echo = FALSE, eval=FALSE}
# Plot the cumulative distribution of Surface data with error bars
ggplot() +
  # Starshade Surface with error bars
  geom_line(data = surface_13,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(surface_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # Calibration Surface with error bars
  geom_line(data = cw_surface_13,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(cw_surface_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Witness Surface with error bars
  geom_line(data = wit_surface_13,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(wit_surface_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 13: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme

# Plot the binned distribution of surface data with error bars
ggplot() +
  # Starshade Surface binned with error bars
  geom_line(data = surface_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
            linetype = "solid") +
  geom_errorbar(data = surface_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # Calibration Surface binned with error bars
  geom_line(data = cw_surface_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#CC79A7", 
            linetype = "dashed") +
  geom_errorbar(data = cw_surface_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Witness Surface binned with error bars
  geom_line(data = wit_surface_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = wit_surface_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 13: Binned Particle Size Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme

# Plot the cumulative edge distributions with error bars
ggplot() +
  # Starshade Observed Edge with error bars
  geom_line(data = edge_13,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(edge_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Calibration Edge with error bars
  geom_line(data = cw_edge_13,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(calibration_edge_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#0072B2", alpha = 0.2) +
  
  # Model Edge with error bars
  geom_line(data = model_edge_13,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(model_edge_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  # SLSM Starshade with error bars
  geom_line(data = s_bmodel_edge_13,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_ribbon(data = get_trial_error_stats(s_bmodel_edge_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # SLSM Calibration with error bars
  geom_line(data = c_bmodel_edge_13,
            aes(x = log_area, y = log_count),
            color = "#F0E442", 
                  linetype = "longdash") +
  geom_errorbar(data = c_bmodel_edge_13 %>% 
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#F0E442", alpha = 0.5) +
  
  # SLSM Witness with error bars
  geom_line(data = w_bmodel_edge_13,
            aes(x = log_area, y = log_count),
            color = "#56B4E9", 
                  linetype = "twodash") +
  geom_ribbon(data = get_trial_error_stats(w_bmodel_edge_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#56B4E9", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 13: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions with error bars
ggplot() +
  # Starshade Edge binned with error bars
  geom_line(data = edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_errorbar(data = edge_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Calibration Edge binned with error bars
  geom_line(data = cw_edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cw_edge_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  # Model Edge binned with error bars
  geom_line(data = model_edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = model_edge_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  # SLSM Starshade binned with error bars
  geom_line(data = s_bmodel_edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_errorbar(data = s_bmodel_edge_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # SLSM Calibration binned with error bars
  geom_line(data = c_bmodel_edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#F0E442", 
                  linetype = "longdash") +
  geom_errorbar(data = c_bmodel_edge_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#F0E442", alpha = 0.5) +
  
  # SLSM Witness binned with error bars
  geom_line(data = w_bmodel_edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#56B4E9", 
                  linetype = "twodash") +
  geom_errorbar(data = w_bmodel_edge_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 13: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Sample comparison plot with error bars
ggplot() +
  # Loop through samples 1-5 and add lines with error bars for each
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 13 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

# Calibration sample comparison plot with error bars
ggplot() +
  # Loop through calibration samples 1-5 and add lines with error bars for each
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Analysis 13 - Sample: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

# # Combined sample comparison with error bands
# ggplot() +
#   # Starshade Samples
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "1"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#56B4E9", 
#             linetype = "solid") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "1") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#56B4E9", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "2"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#0072B2", 
#             linetype = "dashed") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "2") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#0072B2", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "3"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#009E73") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "3") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#009E73", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "4"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#CC79A7") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "4") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#CC79A7", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "5"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#D55E00") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "5") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#D55E00", alpha = 0.1) +
#   
#   # Calibration Samples with dotted lines
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "1"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#56B4E9", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "1") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#56B4E9", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "2"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#0072B2", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "2") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#0072B2", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "3"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#009E73", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "3") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#009E73", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "4"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#CC79A7", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "4") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#CC79A7", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "5"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#D55E00", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "5") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#D55E00", alpha = 0.1) +
#   
#   # Witness Sample with dashed line
#   geom_line(data = witcumulative_surface_counts %>% 
#               filter(Trial == 13),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#56B4E9", linetype = "dashed") +
#   geom_ribbon(data = witcumulative_surface_counts %>% 
#                 filter(Trial == 13) %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#56B4E9", alpha = 0.1) +
#   
#   labs(
#     x = expression(log[10](Area)~"(square microns)"),
#     y = "log10(Particle Count)",
#     title = "All Surface Analysis 13 - Samples: Cumulative Particle Area Distribution",
#     subtitle = "Solid: Starshade Samples, Dotted: Calibration Samples, Dashed: Witness Sample\nColors: Sky Blue (1), Navy Blue (2), Green (3), Purple (4), Orange (5)") +
#   custom_theme
```


### 8.6 Trial 14

```{r trial_14 graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_14,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_14,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "dashed") +
      geom_line(data = wit_surface_14,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 14: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_14_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_14_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "dashed") +
        geom_line(data = wit_surface_14_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 14: Binned Particle Size Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme 


# Plot the cumulative edge distributions
ggplot() +
  geom_line(data = edge_14,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_14,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = CSLSM_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "longdash") +
        geom_line(data = WSLSM_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#56B4E9", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 14: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions
ggplot() +
  geom_line(data = edge_14_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_14_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
        geom_line(data = CSLSM_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "longdash") +
          geom_line(data = WSLSM_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#56B4E9", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 14: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

ggplot() +
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 14 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 14 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 14 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 14 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 14 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 14 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_surface %>% 
              filter(Trial == 14 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 14 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 14 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 14 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 14 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 14 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 14 & Sample == "26"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 14 & Sample == "27"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 14 & Sample == "28"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 14 & Sample == "29"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 14 & Sample == "30"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 14 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_edge %>% 
              filter(Trial == 14 & Sample == "26"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 14 & Sample == "27"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 14 & Sample == "28"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 14 & Sample == "29"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 14 & Sample == "30"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 14 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 14 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 14 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 14 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 14 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 14 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Surface Analysis 14 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_binned_surface %>% 
              filter(Trial == 14 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_surface %>% 
              filter(Trial == 14 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_surface %>% 
              filter(Trial == 14 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_surface %>% 
              filter(Trial == 14 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_surface %>% 
              filter(Trial == 14 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Surface Analysis 14 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 14 & Sample == "41"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 14 & Sample == "42"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 14 & Sample == "43"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 14 & Sample == "44"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 14 & Sample == "45"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 14 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_binned_edge %>% 
              filter(Trial == 14 & Sample == "41"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 14 & Sample == "42"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 14 & Sample == "43"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 14 & Sample == "44"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 14 & Sample == "45"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 14 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme
```

# 9. Average Graphs


### 9.1 Average of Trials

```{r Average graphs}

# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_average,
            aes(x = log_area, y = log_count, 
                color = "Starshade Surface", 
                linetype = "Starshade Surface")) +
  # geom_line(data = cw_surface_average,
  #           aes(x = log_area, y = log_count, 
  #               color = "Calibration Surface", 
  #               linetype = "Calibration Surface")) +
  # geom_line(data = wit_surface_average,
  #           aes(x = log_area, y = log_count, 
  #               color = "Witness Surface", 
  #               linetype = "Witness Surface")) +
  scale_color_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "#D55E00",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73")
  ) +
  scale_linetype_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "solid",
               "Calibration Surface" = "dashed", 
               "Witness Surface" = "dotted")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Vacuum Surface Average",
    subtitle = "Cumulative Particle Area Distribution over 0.1 square meters"
  ) +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_average_binned,
            aes(x = log_area, y = log_count_bin, 
                color = "Starshade Surface", 
                linetype = "Starshade Surface")) +
  # geom_line(data = cw_surface_average_binned,
  #           aes(x = log_area, y = log_count_bin, 
  #               color = "Calibration Surface", 
  #               linetype = "Calibration Surface")) +
  # geom_line(data = wit_surface_average_binned,
  #           aes(x = log_area, y = log_count_bin, 
  #               color = "Witness Surface", 
  #               linetype = "Witness Surface")) +
  scale_color_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "#D55E00",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73")
  ) +
  scale_linetype_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "solid",
               "Calibration Surface" = "dashed", 
               "Witness Surface" = "dotted")
  ) +
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Vacuum Surface Average",
    subtitle = "Binned Particle Size Distribution over 0.1 square meters"
  ) +
  custom_theme

ggplot() +
  geom_line(data = edge_average,
            aes(x = log_area, y = log_count, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_line(data = cw_edge_average,
            aes(x = log_area, y = log_count, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  geom_line(data = model_edge_average,
            aes(x = log_area, y = log_count, 
                color = "Model", 
                linetype = "Model")) +
  # geom_line(data = SSLSM_edge_average,
  #           aes(x = log_area, y = log_count, 
  #               color = "SLSM Starshade", 
  #               linetype = "SLSM Starshade")) +
  # geom_line(data = CSLSM_edge_average,
  #           aes(x = log_area, y = log_count, 
  #               color = "SLSM Calibration", 
  #               linetype = "SLSM Calibration")) +
  # geom_line(data = WSLSM_edge_average,
  #           aes(x = log_area, y = log_count, 
  #               color = "SLSM Witness", 
  #               linetype = "SLSM Witness")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73",
               "SLSM Starshade" = "#D55E00",
               "SLSM Calibration" = "#F0E442",
               "SLSM Witness" = "#56B4E9")
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Vacuum Edge Average",
    subtitle = "Cumulative Particle Area Distribution over 0.01 meter"
  ) +
  custom_theme

ggplot() +
  geom_line(data = edge_average_binned,
            aes(x = log_area, y = log_count_bin, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_line(data = cw_edge_average_binned,
            aes(x = log_area, y = log_count_bin, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  geom_line(data = model_edge_average_binned,
            aes(x = log_area, y = log_count_bin, 
                color = "Model", 
                linetype = "Model")) +
  geom_line(data = SSLSM_edge_average_binned,
            aes(x = log_area, y = log_count_bin,
                color = "SLSM Starshade",
                linetype = "SLSM Starshade")) +
  geom_line(data = CSLSM_edge_average_binned,
            aes(x = log_area, y = log_count_bin,
                color = "SLSM Calibration",
                linetype = "SLSM Calibration")) +
  geom_line(data = WSLSM_edge_average_binned,
            aes(x = log_area, y = log_count_bin,
                color = "SLSM Witness",
                linetype = "SLSM Witness")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73",
               "SLSM Starshade" = "#D55E00",
               "SLSM Calibration" = "#F0E442",
               "SLSM Witness" = "#56B4E9")
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Vacuum Edge Average",
    subtitle = "Binned Particle Area Distribution over 0.01 meter"
  ) +
  custom_theme

```


```{r Paper_Graphs}
# First, let's prepare the data by joining the averages with their standard errors
#### Count Data ####
## Vacuum Data

# For cumulative surface data
surface_average_with_se <- surface_average %>%
  left_join(
    surface_cumcount_summary %>% 
      select(Area, SE_log_count_9_12, n_log_count_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_upper = log10(Average_Count + SE_log_count_9_12),
    log_count_lower = log10(Average_Count - SE_log_count_9_12)
  )

# For binned surface data
surface_average_binned_with_se <- surface_average_binned %>%
  left_join(
    surface_bincount_summary %>% 
      select(Area, SE_log_count_bin_9_12, n_log_count_bin_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_bin_upper = log10(Average_Count + SE_log_count_bin_9_12),
    log_count_bin_lower = log10(Average_Count - SE_log_count_bin_9_12)
  )

# Edge Data

#Starshade
# For cumulative edge data
edge_average_with_se <- edge_average %>%
  left_join(
    edge_cumcount_summary %>% 
      select(Area, SE_log_count_9_12, n_log_count_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_upper = log10(Average_Count + SE_log_count_9_12),
    log_count_lower = log10(Average_Count - SE_log_count_9_12)
  )

# For binned edge data
edge_average_binned_with_se <- edge_average_binned %>%
  left_join(
    edge_bincount_summary %>% 
      select(Area, SE_log_count_bin_9_12, n_log_count_bin_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_bin_upper = log10(Average_Count + SE_log_count_bin_9_12),
    log_count_bin_lower = log10(Average_Count - SE_log_count_bin_9_12)
  )

#Calibration
# For cumulative edge data
cw_edge_average_with_se <- cw_edge_average %>%
  left_join(
    cwedge_cumcount_summary %>% 
      select(Area, SE_log_count_9_12, n_log_count_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_upper = log10(Average_Count + SE_log_count_9_12),
    log_count_lower = log10(Average_Count - SE_log_count_9_12)
  )

# For binned edge data
cw_edge_average_binned_with_se <- cw_edge_average_binned %>%
  left_join(
    cwedge_bincount_summary %>% 
      select(Area, SE_log_count_bin_9_12, n_log_count_bin_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_bin_upper = log10(Average_Count + SE_log_count_bin_9_12),
    log_count_bin_lower = log10(Average_Count - SE_log_count_bin_9_12)
  )

#Model
# For cumulative edge data
mod_edge_average_with_se <- model_edge_average %>%
  left_join(
    modedge_cumcount_summary %>% 
      select(Area, SE_log_count_9_12, n_log_count_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_upper = log10(Average_Count + SE_log_count_9_12),
    log_count_lower = log10(Average_Count - SE_log_count_9_12)
  )

# For binned edge data
mod_edge_average_binned_with_se <- model_edge_average_binned %>%
  left_join(
    modedge_bincount_summary %>% 
      select(Area, SE_log_count_bin_9_12, n_log_count_bin_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_bin_upper = log10(Average_Count + SE_log_count_bin_9_12),
    log_count_bin_lower = log10(Average_Count - SE_log_count_bin_9_12)
  )

# For air data (trials 13-14)

## Surface Data

surface_average_air_with_se <- surface_average_air %>%
  left_join(
    surface_cumcount_summary %>% 
      select(Area, SE_log_count_13_14, n_log_count_13_14),
    by = "Area"
  ) %>%
  mutate(
    log_count_upper = log10(Average_Count + SE_log_count_13_14),
    log_count_lower = log10(Average_Count - SE_log_count_13_14)
  )

surface_average_air_binned_with_se <- surface_average_air_binned %>%
  left_join(
    surface_bincount_summary %>% 
      select(Area, SE_log_count_bin_13_14, n_log_count_bin_13_14),
    by = "Area"
  ) %>%
  mutate(
    log_count_bin_upper = log10(Average_Count + SE_log_count_bin_13_14),
    log_count_bin_lower = log10(Average_Count - SE_log_count_bin_13_14)
  )

## Edge Data

#Starshade
edge_average_air_with_se <- edge_average_air %>%
  left_join(
    edge_cumcount_summary %>% 
      select(Area, SE_log_count_13_14, n_log_count_13_14),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_upper = log10(Average_Count + SE_log_count_13_14),
    log_count_lower = log10(Average_Count - SE_log_count_13_14)
  )

# For binned edge data
edge_average_air_binned_with_se <- edge_average_air_binned %>%
  left_join(
    edge_bincount_summary %>% 
      select(Area, SE_log_count_bin_13_14, n_log_count_bin_13_14),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_bin_upper = log10(Average_Count + SE_log_count_bin_13_14),
    log_count_bin_lower = log10(Average_Count - SE_log_count_bin_13_14)
  )

#Calibration
cw_edge_average_air_with_se <- cw_edge_average_air %>%
  left_join(
    cwedge_cumcount_summary %>% 
      select(Area, SE_log_count_13_14, n_log_count_13_14),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_upper = log10(Average_Count + SE_log_count_13_14),
    log_count_lower = log10(Average_Count - SE_log_count_13_14)
  )

# For binned edge data
cw_edge_average_air_binned_with_se <- cw_edge_average_air_binned %>%
  left_join(
    cwedge_bincount_summary %>% 
      select(Area, SE_log_count_bin_13_14, n_log_count_bin_13_14),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_bin_upper = log10(Average_Count + SE_log_count_bin_13_14),
    log_count_bin_lower = log10(Average_Count - SE_log_count_bin_13_14)
  )

#Model
mod_edge_average_air_with_se <- model_edge_average_air %>%
  left_join(
    modedge_cumcount_summary %>% 
      select(Area, SE_log_count_13_14, n_log_count_13_14),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_upper = log10(Average_Count + SE_log_count_13_14),
    log_count_lower = log10(Average_Count - SE_log_count_13_14)
  )

# For binned edge data
mod_edge_average_air_binned_with_se <- model_edge_average_air_binned %>%
  left_join(
    modedge_bincount_summary %>% 
      select(Area, SE_log_count_bin_13_14, n_log_count_bin_13_14),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_count_bin_upper = log10(Average_Count + SE_log_count_bin_13_14),
    log_count_bin_lower = log10(Average_Count - SE_log_count_bin_13_14)
  )

######################
#### Scatter Data ####
######################


## Vacuum Data

# For cumulative surface data
sc_surface_average_with_se <- surface_average %>%
  left_join(
    surface_cumscatter_summary %>% 
      select(Area, SE_log_scatter_9_12, n_log_scatter_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_upper = Average_Scatter + SE_log_scatter_9_12,
    log_scatter_lower = Average_Scatter - SE_log_scatter_9_12
  )

# For binned surface data
sc_surface_average_binned_with_se <- surface_average_binned %>%
  left_join(
    surface_binscatter_summary %>% 
      select(Area, SE_log_scatter_bin_9_12, n_log_scatter_bin_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_bin_upper = Average_Scatter + SE_log_scatter_bin_9_12,
    log_scatter_bin_lower = Average_Scatter - SE_log_scatter_bin_9_12
  )

# Edge Data

#Starshade
# For cumulative edge data
sc_edge_average_with_se <- edge_average %>%
  left_join(
    edge_cumscatter_summary %>% 
      select(Area, SE_log_scatter_9_12, n_log_scatter_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_upper = Average_Scatter + SE_log_scatter_9_12,
    log_scatter_lower = Average_Scatter - SE_log_scatter_9_12
  )

# For binned edge data
sc_edge_average_binned_with_se <- edge_average_binned %>%
  left_join(
    edge_binscatter_summary %>% 
      select(Area, SE_log_scatter_bin_9_12, n_log_scatter_bin_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_bin_upper = Average_Scatter + SE_log_scatter_bin_9_12,
    log_scatter_bin_lower = Average_Scatter - SE_log_scatter_bin_9_12
  )

#Calibration
# For cumulative edge data
sc_cw_edge_average_with_se <- cw_edge_average %>%
  left_join(
    cwedge_cumscatter_summary %>% 
      select(Area, SE_log_scatter_9_12, n_log_scatter_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_upper = Average_Scatter + SE_log_scatter_9_12,
    log_scatter_lower = Average_Scatter - SE_log_scatter_9_12
  )

# For binned edge data
sc_cw_edge_average_binned_with_se <- cw_edge_average_binned %>%
  left_join(
    cwedge_binscatter_summary %>% 
      select(Area, SE_log_scatter_bin_9_12, n_log_scatter_bin_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_bin_upper = Average_Scatter + SE_log_scatter_bin_9_12,
    log_scatter_bin_lower = Average_Scatter - SE_log_scatter_bin_9_12
  )

#Model
# For cumulative edge data
sc_mod_edge_average_with_se <- model_edge_average %>%
  left_join(
    modedge_cumscatter_summary %>% 
      select(Area, SE_log_scatter_9_12, n_log_scatter_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_upper = Average_Scatter + SE_log_scatter_9_12,
    log_scatter_lower = Average_Scatter - SE_log_scatter_9_12
  )

# For binned edge data
sc_mod_edge_average_binned_with_se <- model_edge_average_binned %>%
  left_join(
    modedge_binscatter_summary %>% 
      select(Area, SE_log_scatter_bin_9_12, n_log_scatter_bin_9_12),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_bin_upper = Average_Scatter + SE_log_scatter_bin_9_12,
    log_scatter_bin_lower = Average_Scatter - SE_log_scatter_bin_9_12
  )

# For air data (trials 13-14)

## Surface Data

sc_surface_average_air_with_se <- surface_average_air %>%
  left_join(
    surface_cumscatter_summary %>% 
      select(Area, SE_log_scatter_13_14, n_log_scatter_13_14),
    by = "Area"
  ) %>%
  mutate(
    log_scatter_upper = Average_Scatter + SE_log_scatter_13_14,
    log_scatter_lower = Average_Scatter - SE_log_scatter_13_14
  )

sc_surface_average_air_binned_with_se <- surface_average_air_binned %>%
  left_join(
    surface_binscatter_summary %>% 
      select(Area, SE_log_scatter_bin_13_14, n_log_scatter_bin_13_14),
    by = "Area"
  ) %>%
  mutate(
    log_scatter_bin_upper = Average_Scatter + SE_log_scatter_bin_13_14,
    log_scatter_bin_lower = Average_Scatter - SE_log_scatter_bin_13_14
  )

## Edge Data

#Starshade
sc_edge_average_air_with_se <- edge_average_air %>%
  left_join(
    edge_cumscatter_summary %>% 
      select(Area, SE_log_scatter_13_14, n_log_scatter_13_14),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_upper = Average_Scatter + SE_log_scatter_13_14,
    log_scatter_lower = Average_Scatter - SE_log_scatter_13_14
  )

# For binned edge data
sc_edge_average_air_binned_with_se <- edge_average_air_binned %>%
  left_join(
    edge_binscatter_summary %>% 
      select(Area, SE_log_scatter_bin_13_14, n_log_scatter_bin_13_14),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_bin_upper = Average_Scatter + SE_log_scatter_bin_13_14,
    log_scatter_bin_lower = Average_Scatter - SE_log_scatter_bin_13_14
  )

#Calibration
sc_cw_edge_average_air_with_se <- cw_edge_average_air %>%
  left_join(
    cwedge_cumscatter_summary %>% 
      select(Area, SE_log_scatter_13_14, n_log_scatter_13_14),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_upper = Average_Scatter + SE_log_scatter_13_14,
    log_scatter_lower = Average_Scatter - SE_log_scatter_13_14
  )

# For binned edge data
sc_cw_edge_average_air_binned_with_se <- cw_edge_average_air_binned %>%
  left_join(
    cwedge_binscatter_summary %>% 
      select(Area, SE_log_scatter_bin_13_14, n_log_scatter_bin_13_14),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_bin_upper = Average_Scatter + SE_log_scatter_bin_13_14,
    log_scatter_bin_lower = Average_Scatter - SE_log_scatter_bin_13_14
  )

#Model
sc_mod_edge_average_air_with_se <- model_edge_average_air %>%
  left_join(
    modedge_cumscatter_summary %>% 
      select(Area, SE_log_scatter_13_14, n_log_scatter_13_14),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_upper = Average_Scatter + SE_log_scatter_13_14,
    log_scatter_lower = Average_Scatter - SE_log_scatter_13_14
  )

# For binned edge data
sc_mod_edge_average_air_binned_with_se <- model_edge_average_air_binned %>%
  left_join(
    modedge_binscatter_summary %>% 
      select(Area, SE_log_scatter_bin_13_14, n_log_scatter_bin_13_14),
    by = "Area"
  ) %>%
  mutate(
    # Calculate error bar limits
    log_scatter_bin_upper = Average_Scatter + SE_log_scatter_bin_13_14,
    log_scatter_bin_lower = Average_Scatter - SE_log_scatter_bin_13_14
  )



#####################
#### COUNT PLOTS ####
#####################

# Plot the cumulative distribution of Surface data with error bars

# Alternative version with error bars instead of ribbons
# ggplot() +
#   geom_line(data = surface_average_with_se,
#             aes(x = log_area, y = log_count, 
#                 color = "Starshade Surface", 
#                 linetype = "Starshade Surface")) +
#   # Error bars - only show every nth point to avoid overcrowding
#   geom_errorbar(data = surface_average_with_se %>% 
#                   filter(row_number() %% 5 == 1),  # Show every 5th point
#                 aes(x = log_area, 
#                     ymin = log_count_lower, 
#                     ymax = log_count_upper,
#                     color = "Starshade Surface"),
#                 width = 0.02,
#                 alpha = 0.7) +
#   geom_line(data = surface_average_air_with_se,
#             aes(x = log_area, y = log_count, 
#                 color = "Air Surface", 
#                 linetype = "Air Surface")) +
#   geom_errorbar(data = surface_average_air_with_se %>% 
#                   filter(row_number() %% 5 == 1),
#                 aes(x = log_area, 
#                     ymin = log_count_lower, 
#                     ymax = log_count_upper,
#                     color = "Air Surface"),
#                 width = 0.02,
#                 alpha = 0.7) +
#   scale_color_manual(
#     name = "Surface Type",
#     values = c("Starshade Surface" = "#D55E00",
#                "Air Surface" = "#0072B2",
#                "Calibration Surface" = "#CC79A7", 
#                "Witness Surface" = "#009E73")
#   ) +
#   scale_linetype_manual(
#     name = "Surface Type",
#     values = c("Starshade Surface" = "solid",
#                "Air Surface" = "dashed",
#                "Calibration Surface" = "dashed", 
#                "Witness Surface" = "dotted")
#   ) +
#   labs(
#     x = expression(log[10](Area)~"(square microns)"),
#     y = expression(log[10]("Particle Count")),
#     title = "Vacuum vs Air Surface Average",
#     subtitle = "Cumulative Particle Area Distribution over 0.1 square meters (with Error Bars)"
#   ) +
#   custom_theme +
#   theme(
#     legend.position = c(0.98, 0.98),  # Position in lower left (x, y coordinates from 0-1)
#     legend.justification = c(1,1),   # Anchor the legend at its bottom-left corner
#     legend.background = element_rect(fill = "white", color = "black", size = 0.5),  # White background with border
#     legend.margin = margin(5, 5, 5, 5),  # Add some padding inside the box
#     legend.key.size = unit(0.8, "lines")  # Make legend symbols a bit smaller if needed
#   )+
#   coord_cartesian(xlim = c(0, 4), ylim = c(2, 8.5))


ggplot() +
  # Error ribbon (shaded area) - add this first so it's behind the line
  geom_ribbon(data = surface_average_with_se,
              aes(x = log_area, 
                  ymin = log_count_lower, 
                  ymax = log_count_upper,
                  fill = "Vacuum Surface"),
              alpha = 0.3) +
  # Main line
  geom_line(data = surface_average_with_se,
            aes(x = log_area, y = log_count, 
                color = "Vacuum Surface", 
                linetype = "Vacuum Surface")) +
  # Optional: Add air data if you want to compare
  geom_ribbon(data = surface_average_air_with_se,
              aes(x = log_area, 
                  ymin = log_count_lower, 
                  ymax = log_count_upper,
                  fill = "Air Surface"),
              alpha = 0.3) +
  geom_line(data = surface_average_air_with_se,
            aes(x = log_area, y = log_count, 
                color = "Air Surface", 
                linetype = "Air Surface")) +
  scale_color_manual(
    name = "Surface Type",
    values = c("Vacuum Surface" = "#D55E00",
               "Air Surface" = "#0072B2",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73")
  ) +
  scale_fill_manual(
    name = "Surface Type",
    values = c("Vacuum Surface" = "#D55E00",
               "Air Surface" = "#0072B2",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73"),
    guide = "none"  # Hide fill legend since it's redundant with color
  ) +
  scale_linetype_manual(
    name = "Surface Type",
    values = c("Vacuum Surface" = "solid",
               "Air Surface" = "dashed",
               "Calibration Surface" = "dashed", 
               "Witness Surface" = "dotted")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = expression(log[10]("Particle Count")),
    title = "Vacuum vs Air Starshade Surface Average",
    subtitle = "Cumulative Particle Area Distribution over 0.1 square meters (with Standard Error)"
  ) +
  custom_theme+
  theme(
    legend.position = c(0.98, 0.98),  # Position in lower left (x, y coordinates from 0-1)
    legend.justification = c(1,1),   # Anchor the legend at its bottom-left corner
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),  # White background with border
    legend.margin = margin(5, 5, 5, 5),  # Add some padding inside the box
    legend.key.size = unit(0.8, "lines")  # Make legend symbols a bit smaller if needed
  )+
  coord_cartesian(xlim = c(0, 4), ylim = c(2, 8.5))



# Plot the binned distribution of surface data with error ribbons
ggplot() +
  geom_ribbon(data = surface_average_binned_with_se,
              aes(x = log_area, 
                  ymin = log_count_bin_lower, 
                  ymax = log_count_bin_upper,
                  fill = "Vacuum Surface"),
              alpha = 0.3) +
  geom_line(data = surface_average_binned_with_se,
            aes(x = log_area, y = log_count_bin, 
                color = "Vacuum Surface", 
                linetype = "Vacuum Surface")) +
  geom_ribbon(data = surface_average_air_binned_with_se,
              aes(x = log_area, 
                  ymin = log_count_bin_lower, 
                  ymax = log_count_bin_upper,
                  fill = "Air Surface"),
              alpha = 0.3) +
  geom_line(data = surface_average_air_binned_with_se,
            aes(x = log_area, y = log_count_bin, 
                color = "Air Surface", 
                linetype = "Air Surface")) +
  scale_color_manual(
    name = "Surface Type",
    values = c("Vacuum Surface" = "#D55E00",
               "Air Surface" = "#0072B2",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73")
  ) +
  scale_fill_manual(
    name = "Surface Type",
    values = c("Vacuum Surface" = "#D55E00",
               "Air Surface" = "#0072B2",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Surface Type",
    values = c("Vacuum Surface" = "solid",
               "Air Surface" = "dashed",
               "Calibration Surface" = "dashed", 
               "Witness Surface" = "dotted")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = expression(log[10]("Particle Count")),
    title = "Vacuum vs Air Starshade Surface Average",
    subtitle = "Binned Particle Size Distribution over 0.1 square meters (with Standard Error)"
  ) +
  custom_theme+
  theme(
    legend.position = c(0.98, 0.98),  # Position in lower left (x, y coordinates from 0-1)
    legend.justification = c(1,1),   # Anchor the legend at its bottom-left corner
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),  # White background with border
    legend.margin = margin(5, 5, 5, 5),  # Add some padding inside the box
    legend.key.size = unit(0.8, "lines")  # Make legend symbols a bit smaller if needed
  )+
  coord_cartesian(xlim = c(0, 4), ylim = c(2, 8.5))

## EDGE Vacuum

ggplot() +
    geom_ribbon(data = edge_average_with_se,
              aes(x = log_area, 
                  ymin = log_count_lower, 
                  ymax = log_count_upper,
                  fill = "Starshade Observed"),
              alpha = 0.3) +
   geom_line(data = edge_average_with_se,
            aes(x = log_area, y = log_count, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
   geom_ribbon(data = cw_edge_average_with_se,
              aes(x = log_area, 
                  ymin = log_count_lower, 
                  ymax = log_count_upper,
                  fill = "Calibration Observed"),
              alpha = 0.3) +
  geom_line(data = cw_edge_average_with_se,
            aes(x = log_area, y = log_count, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
   geom_ribbon(data = mod_edge_average_with_se,
              aes(x = log_area, 
                  ymin = log_count_lower, 
                  ymax = log_count_upper,
                  fill = "Model"),
              alpha = 0.3) +
  geom_line(data = mod_edge_average_with_se,
            aes(x = log_area, y = log_count, 
                color = "Model", 
                linetype = "Model")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73")
  ) +
  scale_fill_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = expression(log[10]("Particle Count")),
    title = "Vacuum Edge Average",
    subtitle = "Cumulative Particle Area Distribution over 0.01 meter"
  ) +
  custom_theme +
  theme(
    legend.position = c(0.98, 0.98),  # Position in lower left (x, y coordinates from 0-1)
    legend.justification = c(1,1),   # Anchor the legend at its bottom-left corner
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),  # White background with border
    legend.margin = margin(5, 5, 5, 5),  # Add some padding inside the box
    legend.key.size = unit(0.8, "lines")  # Make legend symbols a bit smaller if needed
  ) +
  coord_cartesian(xlim = c(0, 4), ylim = c(-3, 5))

ggplot() +
  geom_ribbon(data = edge_average_binned_with_se,
              aes(x = log_area, 
                  ymin = log_count_bin_lower, 
                  ymax = log_count_bin_upper,
                  fill = "Starshade Observed"),
              alpha = 0.3) +
  geom_line(data = edge_average_binned_with_se,
            aes(x = log_area, y = log_count_bin, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_ribbon(data = cw_edge_average_binned_with_se,
              aes(x = log_area, 
                  ymin = log_count_bin_lower, 
                  ymax = log_count_bin_upper,
                  fill = "Calibration Observed"),
              alpha = 0.3) +
  geom_line(data = cw_edge_average_binned_with_se,
            aes(x = log_area, y = log_count_bin, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  geom_ribbon(data = mod_edge_average_binned_with_se,
              aes(x = log_area, 
                  ymin = log_count_bin_lower, 
                  ymax = log_count_bin_upper,
                  fill = "Model"),
              alpha = 0.3) +
  geom_line(data = mod_edge_average_binned_with_se,
            aes(x = log_area, y = log_count_bin, 
                color = "Model", 
                linetype = "Model")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73")
  ) +
  scale_fill_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = expression(log[10]("Particle Count")),
    title = "Vacuum Edge Average",
    subtitle = "Binned Particle Area Distribution over 0.01 meter"
  ) +
  custom_theme +
  theme(
    legend.position = c(0.98, 0.98),  # Position in lower left (x, y coordinates from 0-1)
    legend.justification = c(1,1),   # Anchor the legend at its bottom-left corner
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),  # White background with border
    legend.margin = margin(5, 5, 5, 5),  # Add some padding inside the box
    legend.key.size = unit(0.8, "lines")  # Make legend symbols a bit smaller if needed
  ) +
  coord_cartesian(xlim = c(0, 4), ylim = c(-3, 5))


## EDGE Air

ggplot() +
    geom_ribbon(data = edge_average_air_with_se,
              aes(x = log_area, 
                  ymin = log_count_lower, 
                  ymax = log_count_upper,
                  fill = "Starshade Observed"),
              alpha = 0.3) +
   geom_line(data = edge_average_air_with_se,
            aes(x = log_area, y = log_count, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
   geom_ribbon(data = cw_edge_average_air_with_se,
              aes(x = log_area, 
                  ymin = log_count_lower, 
                  ymax = log_count_upper,
                  fill = "Calibration Observed"),
              alpha = 0.3) +
  geom_line(data = cw_edge_average_air_with_se,
            aes(x = log_area, y = log_count, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
   geom_ribbon(data = mod_edge_average_air_with_se,
              aes(x = log_area, 
                  ymin = log_count_lower, 
                  ymax = log_count_upper,
                  fill = "Model"),
              alpha = 0.3) +
  geom_line(data = mod_edge_average_air_with_se,
            aes(x = log_area, y = log_count, 
                color = "Model", 
                linetype = "Model")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73")
  ) +
  scale_fill_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = expression(log[10]("Particle Count")),
    title = "Air Edge Average",
    subtitle = "Cumulative Particle Area Distribution over 0.01 meter"
  ) +
  custom_theme +
  theme(
    legend.position = c(0.98, 0.98),  # Position in lower left (x, y coordinates from 0-1)
    legend.justification = c(1,1),   # Anchor the legend at its bottom-left corner
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),  # White background with border
    legend.margin = margin(5, 5, 5, 5),  # Add some padding inside the box
    legend.key.size = unit(0.8, "lines")  # Make legend symbols a bit smaller if needed
  ) +
  coord_cartesian(xlim = c(0, 4), ylim = c(-3, 5))

ggplot() +
  geom_ribbon(data = edge_average_air_binned_with_se,
              aes(x = log_area, 
                  ymin = log_count_bin_lower, 
                  ymax = log_count_bin_upper,
                  fill = "Starshade Observed"),
              alpha = 0.3) +
  geom_line(data = edge_average_air_binned_with_se,
            aes(x = log_area, y = log_count_bin, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_ribbon(data = cw_edge_average_air_binned_with_se,
              aes(x = log_area, 
                  ymin = log_count_bin_lower, 
                  ymax = log_count_bin_upper,
                  fill = "Calibration Observed"),
              alpha = 0.3) +
  geom_line(data = cw_edge_average_air_binned_with_se,
            aes(x = log_area, y = log_count_bin, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  geom_ribbon(data = mod_edge_average_air_binned_with_se,
              aes(x = log_area, 
                  ymin = log_count_bin_lower, 
                  ymax = log_count_bin_upper,
                  fill = "Model"),
              alpha = 0.3) +
  geom_line(data = mod_edge_average_air_binned_with_se,
            aes(x = log_area, y = log_count_bin, 
                color = "Model", 
                linetype = "Model")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73")
  ) +
  scale_fill_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = expression(log[10]("Particle Count")),
    title = "Air Edge Average",
    subtitle = "Binned Particle Area Distribution over 0.01 meter"
  ) +
  custom_theme +
  theme(
    legend.position = c(0.98, 0.98),  # Position in lower left (x, y coordinates from 0-1)
    legend.justification = c(1,1),   # Anchor the legend at its bottom-left corner
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),  # White background with border
    legend.margin = margin(5, 5, 5, 5),  # Add some padding inside the box
    legend.key.size = unit(0.8, "lines")  # Make legend symbols a bit smaller if needed
  ) +
  coord_cartesian(xlim = c(0, 4), ylim = c(-3, 5))

#######################
#### SCATTER PLOTS ####
#######################

# Plot the cumulative distribution of Surface data with error bars

ggplot() +
  # Error ribbon (shaded area) - add this first so it's behind the line
  geom_ribbon(data = sc_surface_average_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_lower, 
                  ymax = log_scatter_upper,
                  fill = "Vacuum Surface"),
              alpha = 0.3) +
  # Main line
  geom_line(data = sc_surface_average_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Vacuum Surface", 
                linetype = "Vacuum Surface")) +
  # Optional: Add air data if you want to compare
  geom_ribbon(data = sc_surface_average_air_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_lower, 
                  ymax = log_scatter_upper,
                  fill = "Air Surface"),
              alpha = 0.3) +
  geom_line(data = sc_surface_average_air_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Air Surface", 
                linetype = "Air Surface")) +
  scale_color_manual(
    name = "Surface Type",
    values = c("Vacuum Surface" = "#D55E00",
               "Air Surface" = "#0072B2",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73")
  ) +
  scale_fill_manual(
    name = "Surface Type",
    values = c("Vacuum Surface" = "#D55E00",
               "Air Surface" = "#0072B2",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73"),
    guide = "none"  # Hide fill legend since it's redundant with color
  ) +
  scale_linetype_manual(
    name = "Surface Type",
    values = c("Vacuum Surface" = "solid",
               "Air Surface" = "dashed",
               "Calibration Surface" = "dashed", 
               "Witness Surface" = "dotted")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Particle Area",
    title = "Vacuum vs Air Starshade Surface Average",
    subtitle = "Cumulative Particle Area Distribution over 0.1 square meters (with Standard Error)"
  ) +
  custom_theme+
  theme(
    legend.position = c(0.98, 0.98),  # Position in lower left (x, y coordinates from 0-1)
    legend.justification = c(1,1),   # Anchor the legend at its bottom-left corner
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),  # White background with border
    legend.margin = margin(5, 5, 5, 5),  # Add some padding inside the box
    legend.key.size = unit(0.8, "lines")  # Make legend symbols a bit smaller if needed
  )+
  coord_cartesian(xlim = c(0, 4), ylim = c(-3, 1800000000))

# Plot the binned distribution of surface data with error ribbons
ggplot() +
  geom_ribbon(data = sc_surface_average_binned_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_bin_lower, 
                  ymax = log_scatter_bin_upper,
                  fill = "Vacuum Surface"),
              alpha = 0.3) +
  geom_line(data = sc_surface_average_binned_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Vacuum Surface", 
                linetype = "Vacuum Surface")) +
  geom_ribbon(data = sc_surface_average_air_binned_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_bin_lower, 
                  ymax = log_scatter_bin_upper,
                  fill = "Air Surface"),
              alpha = 0.3) +
  geom_line(data = sc_surface_average_air_binned_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Air Surface", 
                linetype = "Air Surface")) +
  scale_color_manual(
    name = "Surface Type",
    values = c("Vacuum Surface" = "#D55E00",
               "Air Surface" = "#0072B2",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73")
  ) +
  scale_fill_manual(
    name = "Surface Type",
    values = c("Vacuum Surface" = "#D55E00",
               "Air Surface" = "#0072B2",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Surface Type",
    values = c("Vacuum Surface" = "solid",
               "Air Surface" = "dashed",
               "Calibration Surface" = "dashed", 
               "Witness Surface" = "dotted")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Particle Area",
    title = "Vacuum vs Air Starshade Surface Average",
    subtitle = "Binned Particle Area Distribution over 0.1 square meters (with Standard Error)"
  ) +
  custom_theme+
  theme(
    legend.position = c(0.98, 0.98),  # Position in lower left (x, y coordinates from 0-1)
    legend.justification = c(1,1),   # Anchor the legend at its bottom-left corner
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),  # White background with border
    legend.margin = margin(5, 5, 5, 5),  # Add some padding inside the box
    legend.key.size = unit(0.8, "lines")  # Make legend symbols a bit smaller if needed
  )+
  coord_cartesian(xlim = c(0, 4), ylim = c(-3, 50000000))

## EDGE Vacuum

ggplot() +
    geom_ribbon(data = sc_edge_average_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_lower, 
                  ymax = log_scatter_upper,
                  fill = "Starshade Observed"),
              alpha = 0.3) +
   geom_line(data = sc_edge_average_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
   geom_ribbon(data = sc_cw_edge_average_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_lower, 
                  ymax = log_scatter_upper,
                  fill = "Calibration Observed"),
              alpha = 0.3) +
  geom_line(data = sc_cw_edge_average_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
   geom_ribbon(data = sc_mod_edge_average_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_lower, 
                  ymax = log_scatter_upper,
                  fill = "Model"),
              alpha = 0.3) +
  geom_line(data = sc_mod_edge_average_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Model", 
                linetype = "Model")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73")
  ) +
  scale_fill_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Particle Area",
    title = "Vacuum Edge Average",
    subtitle = "Cumulative Particle Area Distribution over 0.01 meter"
  ) +
  custom_theme +
  theme(
    legend.position = c(0.98, 0.98),  # Position in lower left (x, y coordinates from 0-1)
    legend.justification = c(1,1),   # Anchor the legend at its bottom-left corner
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),  # White background with border
    legend.margin = margin(5, 5, 5, 5),  # Add some padding inside the box
    legend.key.size = unit(0.8, "lines")  # Make legend symbols a bit smaller if needed
  ) +
  coord_cartesian(xlim = c(0, 4), ylim = c(-3, 500000))

ggplot() +
  geom_ribbon(data = sc_edge_average_binned_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_bin_lower, 
                  ymax = log_scatter_bin_upper,
                  fill = "Starshade Observed"),
              alpha = 0.3) +
  geom_line(data = sc_edge_average_binned_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_ribbon(data = sc_cw_edge_average_binned_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_bin_lower, 
                  ymax = log_scatter_bin_upper,
                  fill = "Calibration Observed"),
              alpha = 0.3) +
  geom_line(data = sc_cw_edge_average_binned_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  geom_ribbon(data = sc_mod_edge_average_binned_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_bin_lower, 
                  ymax = log_scatter_bin_upper,
                  fill = "Model"),
              alpha = 0.3) +
  geom_line(data = sc_mod_edge_average_binned_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Model", 
                linetype = "Model")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73")
  ) +
  scale_fill_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Particle Area",
    title = "Vacuum Edge Average",
    subtitle = "Binned Particle Area Distribution over 0.01 meter"
  ) +
  custom_theme +
  theme(
    legend.position = c(0.98, 0.98),  # Position in lower left (x, y coordinates from 0-1)
    legend.justification = c(1,1),   # Anchor the legend at its bottom-left corner
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),  # White background with border
    legend.margin = margin(5, 5, 5, 5),  # Add some padding inside the box
    legend.key.size = unit(0.8, "lines")  # Make legend symbols a bit smaller if needed
  ) +
  coord_cartesian(xlim = c(0, 4), ylim = c(-3, 30000))


## EDGE Air

ggplot() +
    geom_ribbon(data = sc_edge_average_air_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_lower, 
                  ymax = log_scatter_upper,
                  fill = "Starshade Observed"),
              alpha = 0.3) +
   geom_line(data = sc_edge_average_air_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
   geom_ribbon(data = sc_cw_edge_average_air_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_lower, 
                  ymax = log_scatter_upper,
                  fill = "Calibration Observed"),
              alpha = 0.3) +
  geom_line(data = sc_cw_edge_average_air_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
   geom_ribbon(data = sc_mod_edge_average_air_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_lower, 
                  ymax = log_scatter_upper,
                  fill = "Model"),
              alpha = 0.3) +
  geom_line(data = mod_edge_average_air_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Model", 
                linetype = "Model")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73")
  ) +
  scale_fill_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Particle Area",
    title = "Air Edge Average",
    subtitle = "Cumulative Particle Area Distribution over 0.01 meter"
  ) +
  custom_theme +
  theme(
    legend.position = c(0.98, 0.98),  # Position in lower left (x, y coordinates from 0-1)
    legend.justification = c(1,1),   # Anchor the legend at its bottom-left corner
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),  # White background with border
    legend.margin = margin(5, 5, 5, 5),  # Add some padding inside the box
    legend.key.size = unit(0.8, "lines")  # Make legend symbols a bit smaller if needed
  ) +
  coord_cartesian(xlim = c(0, 4), ylim = c(-3, 500000))

ggplot() +
  geom_ribbon(data = sc_edge_average_air_binned_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_bin_lower, 
                  ymax = log_scatter_bin_upper,
                  fill = "Starshade Observed"),
              alpha = 0.3) +
  geom_line(data = sc_edge_average_air_binned_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_ribbon(data = sc_cw_edge_average_air_binned_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_bin_lower, 
                  ymax = log_scatter_bin_upper,
                  fill = "Calibration Observed"),
              alpha = 0.3) +
  geom_line(data = sc_cw_edge_average_air_binned_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  geom_ribbon(data = sc_mod_edge_average_air_binned_with_se,
              aes(x = log_area, 
                  ymin = log_scatter_bin_lower, 
                  ymax = log_scatter_bin_upper,
                  fill = "Model"),
              alpha = 0.3) +
  geom_line(data = sc_mod_edge_average_air_binned_with_se,
            aes(x = log_area, y = Average_Scatter, 
                color = "Model", 
                linetype = "Model")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73")
  ) +
  scale_fill_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Particle Area",
    title = "Air Edge Average",
    subtitle = "Binned Particle Area Distribution over 0.01 meter"
  ) +
  custom_theme +
  theme(
    legend.position = c(0.98, 0.98),  # Position in lower left (x, y coordinates from 0-1)
    legend.justification = c(1,1),   # Anchor the legend at its bottom-left corner
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),  # White background with border
    legend.margin = margin(5, 5, 5, 5),  # Add some padding inside the box
    legend.key.size = unit(0.8, "lines")  # Make legend symbols a bit smaller if needed
  ) +
  coord_cartesian(xlim = c(0, 4), ylim = c(-3, 30000))

```



## 8. Statistical Analysis: Slopes, PCL Levels, and Correlations

```{r statistical_analysis} 
# Function to calculate slope, intercept, R-squared, and PCL for particle distributions
# Enhanced to work with your specific datasets including standard error data
calculate_distribution_stats <- function(data, data_name, 
                                       area_col = "log_area", 
                                       count_col = "log_count",
                                       min_log_area = 0.5, 
                                       max_log_area = 3.0) {
  
  # Filter data to valid range and exclude zero counts (log_count = -3)
  filtered_data <- data %>%
    filter(!!sym(area_col) >= min_log_area,
           !!sym(area_col) <= max_log_area,
           !!sym(count_col) > -2.9,  # Exclude the -3 values representing zeros
           !is.na(!!sym(area_col)),
           !is.na(!!sym(count_col)))
  
  if (nrow(filtered_data) < 3) {
    # Return NA values if insufficient data
    return(tibble(
      dataset = data_name,
      n_points = nrow(filtered_data),
      slope = NA,
      intercept = NA,
      r_squared = NA,
      p_value = NA,
      pcl_area = NA,
      pcl_diameter = NA,
      std_error_slope = NA,
      std_error_intercept = NA
    ))
  }
  
  # Fit linear model: log_count ~ log_area
  model <- lm(as.formula(paste(count_col, "~", area_col)), data = filtered_data)
  
  # Extract model statistics
  model_summary <- summary(model)
  model_tidy <- tidy(model)
  
  # Calculate PCL: area where fitted line equals log10(1) = 0
  slope <- model_tidy$estimate[2]
  intercept <- model_tidy$estimate[1]
  
  # PCL area: solve 0 = intercept + slope * log_area for log_area
  pcl_log_area <- -intercept / slope
  pcl_area <- 10^pcl_log_area  # Convert back to area in square microns
  
  # Convert area to equivalent circular diameter
  pcl_diameter <- 2 * sqrt(pcl_area / pi)
  
  # Return comprehensive statistics
  tibble(
    dataset = data_name,
    n_points = nrow(filtered_data),
    slope = slope,
    intercept = intercept,
    r_squared = model_summary$r.squared,
    p_value = model_tidy$p.value[2],  # p-value for slope
    pcl_area = pcl_area,
    pcl_diameter = pcl_diameter,
    std_error_slope = model_tidy$std.error[2],
    std_error_intercept = model_tidy$std.error[1]
  )
}

# Calculate statistics for all major datasets using your specific data with standard errors
distribution_stats <- list(
  # Surface distributions (vacuum conditions - trials 9-12)
  surface_vacuum = calculate_distribution_stats(surface_average_with_se, "Surface_Vacuum"),
  surface_vacuum_binned = calculate_distribution_stats(surface_average_binned_with_se, "Surface_Vacuum_Binned", count_col = "log_count_bin"),
  
  # Surface distributions (air conditions - trials 13-14)  
  surface_air = calculate_distribution_stats(surface_average_air_with_se, "Surface_Air"),
  surface_air_binned = calculate_distribution_stats(surface_average_air_binned_with_se, "Surface_Air_Binned", count_col = "log_count_bin"),
  
  # Edge distributions (vacuum conditions)
  edge_vacuum = calculate_distribution_stats(edge_average_with_se, "Edge_Vacuum"),
  edge_vacuum_binned = calculate_distribution_stats(edge_average_binned_with_se, "Edge_Vacuum_Binned", count_col = "log_count_bin"),
  
  # Edge distributions (air conditions)
  edge_air = calculate_distribution_stats(edge_average_air_with_se, "Edge_Air"),
  edge_air_binned = calculate_distribution_stats(edge_average_air_binned_with_se, "Edge_Air_Binned", count_col = "log_count_bin"),
  
  # Calibration wafer edge distributions (vacuum)
  cw_edge_vacuum = calculate_distribution_stats(cw_edge_average_with_se, "CalWafer_Edge_Vacuum"),
  cw_edge_vacuum_binned = calculate_distribution_stats(cw_edge_average_binned_with_se, "CalWafer_Edge_Vacuum_Binned", count_col = "log_count_bin"),
  
  # Calibration wafer edge distributions (air)
  cw_edge_air = calculate_distribution_stats(cw_edge_average_air_with_se, "CalWafer_Edge_Air"),
  cw_edge_air_binned = calculate_distribution_stats(cw_edge_average_air_binned_with_se, "CalWafer_Edge_Air_Binned", count_col = "log_count_bin"),
  
  # Model predictions (vacuum)
  model_edge_vacuum = calculate_distribution_stats(mod_edge_average_with_se, "Model_Edge_Vacuum"),
  model_edge_vacuum_binned = calculate_distribution_stats(mod_edge_average_binned_with_se, "Model_Edge_Vacuum_Binned", count_col = "log_count_bin"),
  
  # Model predictions (air)
  model_edge_air = calculate_distribution_stats(mod_edge_average_air_with_se, "Model_Edge_Air"),
  model_edge_air_binned = calculate_distribution_stats(mod_edge_average_air_binned_with_se, "Model_Edge_Air_Binned", count_col = "log_count_bin")
) %>%
  bind_rows()

# Display the comprehensive statistics table
print("=== Particle Distribution Statistics ===")
distribution_stats %>%
  mutate(
    slope = round(slope, 3),
    intercept = round(intercept, 3),
    r_squared = round(r_squared, 3),
    p_value = round(p_value, 6),
    pcl_area = round(pcl_area, 1),
    pcl_diameter = round(pcl_diameter, 1)
  ) %>%
  kable(caption = "Slope, PCL, and Correlation Statistics for Particle Distributions") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r correlation_analysis}
# Function to prepare data for correlation analysis using your specific datasets
prepare_correlation_data <- function(data1, data2, name1, name2,
                                   min_log_area = 0.5, max_log_area = 3.0) {
  
  # Determine which log_count column to use for each dataset
  count_col1 <- if("log_count" %in% names(data1)) "log_count" else "log_count_bin"
  count_col2 <- if("log_count" %in% names(data2)) "log_count" else "log_count_bin"
  
  # Filter both datasets to the same area range and remove zeros
  data1_filtered <- data1 %>%
    filter(log_area >= min_log_area, log_area <= max_log_area, 
           !!sym(count_col1) > -2.9, !is.na(!!sym(count_col1))) %>%
    select(log_area, all_of(count_col1)) %>%
    rename(!!paste0("log_count_", name1) := !!sym(count_col1))
  
  data2_filtered <- data2 %>%
    filter(log_area >= min_log_area, log_area <= max_log_area, 
           !!sym(count_col2) > -2.9, !is.na(!!sym(count_col2))) %>%
    select(log_area, all_of(count_col2)) %>%
    rename(!!paste0("log_count_", name2) := !!sym(count_col2))
  
  # Join on log_area (find nearest matches)
  merged_data <- data1_filtered %>%
    full_join(data2_filtered, by = "log_area") %>%
    filter(!is.na(!!sym(paste0("log_count_", name1))),
           !is.na(!!sym(paste0("log_count_", name2))))
  
  if (nrow(merged_data) < 3) {
    return(tibble(
      comparison = paste(name1, "vs", name2),
      correlation = NA,
      p_value = NA,
      n_points = nrow(merged_data)
    ))
  }
  
  # Calculate correlation
  cor_test <- cor.test(merged_data[[paste0("log_count_", name1)]], 
                      merged_data[[paste0("log_count_", name2)]])
  
  tibble(
    comparison = paste(name1, "vs", name2),
    correlation = cor_test$estimate,
    p_value = cor_test$p.value,
    n_points = nrow(merged_data)
  )
}

# Calculate key correlations using your datasets with standard errors
correlation_results <- list(
  # Surface vs Edge comparisons (vacuum conditions)
  surf_edge_vac = prepare_correlation_data(surface_average_with_se, edge_average_with_se, 
                                          "Surface_Vac", "Edge_Vac"),
  
  # Surface vs Edge comparisons (air conditions)  
  surf_edge_air = prepare_correlation_data(surface_average_air_with_se, edge_average_air_with_se,
                                          "Surface_Air", "Edge_Air"),
  
  # Observed vs Model comparisons (vacuum)
  obs_model_vac = prepare_correlation_data(edge_average_with_se, mod_edge_average_with_se,
                                          "Observed_Edge_Vac", "Model_Edge_Vac"),
  
  # Observed vs Model comparisons (air)
  obs_model_air = prepare_correlation_data(edge_average_air_with_se, mod_edge_average_air_with_se,
                                          "Observed_Edge_Air", "Model_Edge_Air"),
  
  # Starshade vs Calibration Wafer edge comparisons (vacuum)
  star_cal_edge_vac = prepare_correlation_data(edge_average_with_se, cw_edge_average_with_se,
                                              "Starshade_Edge_Vac", "CalWafer_Edge_Vac"),
  
  # Starshade vs Calibration Wafer edge comparisons (air)
  star_cal_edge_air = prepare_correlation_data(edge_average_air_with_se, cw_edge_average_air_with_se,
                                              "Starshade_Edge_Air", "CalWafer_Edge_Air"),
  
  # Vacuum vs Air comparisons for surfaces
  vac_air_surf = prepare_correlation_data(surface_average_with_se, surface_average_air_with_se,
                                         "Surface_Vac", "Surface_Air"),
  
  # Vacuum vs Air comparisons for edges
  vac_air_edge = prepare_correlation_data(edge_average_with_se, edge_average_air_with_se,
                                         "Edge_Vac", "Edge_Air"),
  
  # Cumulative vs Binned comparisons (vacuum surface)
  cum_bin_surf_vac = prepare_correlation_data(surface_average_with_se, surface_average_binned_with_se,
                                             "Surface_Cumulative_Vac", "Surface_Binned_Vac"),
  
  # Cumulative vs Binned comparisons (vacuum edge)
  cum_bin_edge_vac = prepare_correlation_data(edge_average_with_se, edge_average_binned_with_se,
                                             "Edge_Cumulative_Vac", "Edge_Binned_Vac"),
  
  # Model validation: Calibration wafer vs Model
  cal_model_vac = prepare_correlation_data(cw_edge_average_with_se, mod_edge_average_with_se,
                                          "CalWafer_Edge_Vac", "Model_Edge_Vac")
) %>%
  bind_rows()

# Display correlation results
print("=== Correlation Analysis ===")
correlation_results %>%
  mutate(
    correlation = round(correlation, 3),
    p_value = round(p_value, 6)
  ) %>%
  arrange(desc(abs(correlation))) %>%
  kable(caption = "Correlations Between Different Measurements and Models") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r summary_statistics}
# Create summary statistics comparing vacuum vs air conditions
vacuum_air_comparison <- distribution_stats %>%
  filter(str_detect(dataset, "Vacuum|Air")) %>%
  # Clean up dataset names to separate type and condition
  mutate(
    dataset_clean = str_remove(dataset, "_Binned$"),  # Remove _Binned suffix
    type = str_extract(dataset_clean, "^[^_]+"),      # Extract first part (Surface, Edge, etc.)
    condition = str_extract(dataset_clean, "(Vacuum|Air)$"),  # Extract condition
    analysis_type = if_else(str_detect(dataset, "_Binned$"), "Binned", "Cumulative")
  ) %>%
  filter(!is.na(condition)) %>%  # Keep only rows with clear Vacuum/Air designation
  select(type, condition, analysis_type, slope, pcl_diameter, r_squared) %>%
  pivot_wider(names_from = condition, 
              values_from = c(slope, pcl_diameter, r_squared)) %>%
  mutate(
    slope_difference = slope_Vacuum - slope_Air,
    pcl_ratio = pcl_diameter_Vacuum / pcl_diameter_Air,
    r_squared_diff = r_squared_Vacuum - r_squared_Air
  )

print("=== Vacuum vs Air Comparison ===")
vacuum_air_comparison %>%
  mutate(across(where(is.numeric), ~round(.x, 3))) %>%
  kable(caption = "Comparison of Vacuum vs Air Conditions") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Create model validation summary
model_validation <- correlation_results %>%
  filter(str_detect(comparison, "Model")) %>%
  mutate(
    model_type = case_when(
      str_detect(comparison, "CalWafer.*Model") ~ "Calibration vs Model",
      str_detect(comparison, "Observed.*Model") ~ "Observed vs Model",
      TRUE ~ "Other Model Comparison"
    ),
    condition = case_when(
      str_detect(comparison, "Vac") ~ "Vacuum",
      str_detect(comparison, "Air") ~ "Air", 
      TRUE ~ "Unknown"
    )
  ) %>%
  select(model_type, condition, correlation, p_value, n_points)

# Additional analysis: Standard Error Impact
se_analysis <- tibble(
  dataset = c("Surface Vacuum", "Surface Air", "Edge Vacuum", "Edge Air", 
              "CalWafer Edge Vacuum", "CalWafer Edge Air"),
  has_se_data = c(
    "SE_log_count_9_12" %in% names(surface_average_with_se),
    "SE_log_count_13_14" %in% names(surface_average_air_with_se),
    "SE_log_count_9_12" %in% names(edge_average_with_se),
    "SE_log_count_13_14" %in% names(edge_average_air_with_se),
    "SE_log_count_9_12" %in% names(cw_edge_average_with_se),
    "SE_log_count_13_14" %in% names(cw_edge_average_air_with_se)
  )
)

print("=== Model Validation Summary ===")
model_validation %>%
  mutate(
    correlation = round(correlation, 3),
    p_value = round(p_value, 6)
  ) %>%
  kable(caption = "Model Performance vs Observed Data") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Export results for use in the paper
write_csv(distribution_stats, "distribution_statistics.csv")
write_csv(correlation_results, "correlation_analysis.csv")
write_csv(vacuum_air_comparison, "vacuum_air_comparison.csv")
write_csv(model_validation, "model_validation.csv")

print("Analysis complete. Results exported to CSV files.")
```



```{r}
####################################
#### NORMALIZED PROPORTION PLOTS ####
####################################

# Function to calculate proportions and propagate errors
calculate_proportions <- function(data, count_col, se_col) {
  # Convert log counts to actual counts
  data$actual_count <- 10^data[[count_col]]
  data$actual_count_upper <- 10^(data[[count_col]] + data[[se_col]])
  data$actual_count_lower <- 10^(data[[count_col]] - data[[se_col]])
  
  # Calculate total count for normalization
  total_count <- sum(data$actual_count, na.rm = TRUE)
  
  # Calculate proportions
  data$proportion <- data$actual_count / total_count
  data$proportion_upper <- data$actual_count_upper / total_count
  data$proportion_lower <- data$actual_count_lower / total_count
  
  # Convert proportions to log scale
  data$log_proportion <- log10(data$proportion)
  data$log_proportion_upper <- log10(data$proportion_upper)
  data$log_proportion_lower <- log10(data$proportion_lower)
  
  return(data)
}

#######################
#### VACUUM DATA ####
#######################

# Calculate proportions for vacuum cumulative data
edge_vacuum_cum_prop <- calculate_proportions(edge_average_with_se, "log_count", "SE_log_count_9_12")
cw_edge_vacuum_cum_prop <- calculate_proportions(cw_edge_average_with_se, "log_count", "SE_log_count_9_12")

# Calculate proportions for vacuum binned data
edge_vacuum_bin_prop <- calculate_proportions(edge_average_binned_with_se, "log_count_bin", "SE_log_count_bin_9_12")
cw_edge_vacuum_bin_prop <- calculate_proportions(cw_edge_average_binned_with_se, "log_count_bin", "SE_log_count_bin_9_12")

####################
#### AIR DATA ####
####################

# Calculate proportions for air cumulative data
edge_air_cum_prop <- calculate_proportions(edge_average_air_with_se, "log_count", "SE_log_count_13_14")
cw_edge_air_cum_prop <- calculate_proportions(cw_edge_average_air_with_se, "log_count", "SE_log_count_13_14")

# Calculate proportions for air binned data
edge_air_bin_prop <- calculate_proportions(edge_average_air_binned_with_se, "log_count_bin", "SE_log_count_bin_13_14")
cw_edge_air_bin_prop <- calculate_proportions(cw_edge_average_air_binned_with_se, "log_count_bin", "SE_log_count_bin_13_14")

###########################
#### PROPORTION PLOTS ####
###########################

## 1. VACUUM CUMULATIVE PROPORTIONS ##
ggplot() +
  geom_ribbon(data = edge_vacuum_cum_prop,
              aes(x = log_area, 
                  ymin = log_proportion_lower, 
                  ymax = log_proportion_upper,
                  fill = "Starshade Observed"),
              alpha = 0.3) +
  geom_line(data = edge_vacuum_cum_prop,
            aes(x = log_area, y = log_proportion, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_ribbon(data = cw_edge_vacuum_cum_prop,
              aes(x = log_area, 
                  ymin = log_proportion_lower, 
                  ymax = log_proportion_upper,
                  fill = "Calibration Observed"),
              alpha = 0.3) +
  geom_line(data = cw_edge_vacuum_cum_prop,
            aes(x = log_area, y = log_proportion, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2")
  ) +
  scale_fill_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = expression(log[10]("Proportion of Total Particles")),
    title = "Vacuum Edge Normalized Proportions",
    subtitle = "Cumulative Particle Area Distribution over 0.01 meter (Normalized)"
  ) +
  custom_theme +
  theme(
    legend.position = c(0.98, 0.98),  # Position in upper right
    legend.justification = c(1, 1),   # Anchor the legend at its top-right corner
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),
    legend.margin = margin(5, 5, 5, 5),
    legend.key.size = unit(0.8, "lines")
  ) +
  coord_cartesian(xlim = c(0, 4))

## 2. VACUUM BINNED PROPORTIONS ##
ggplot() +
  geom_ribbon(data = edge_vacuum_bin_prop,
              aes(x = log_area, 
                  ymin = log_proportion_lower, 
                  ymax = log_proportion_upper,
                  fill = "Starshade Observed"),
              alpha = 0.3) +
  geom_line(data = edge_vacuum_bin_prop,
            aes(x = log_area, y = log_proportion, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_ribbon(data = cw_edge_vacuum_bin_prop,
              aes(x = log_area, 
                  ymin = log_proportion_lower, 
                  ymax = log_proportion_upper,
                  fill = "Calibration Observed"),
              alpha = 0.3) +
  geom_line(data = cw_edge_vacuum_bin_prop,
            aes(x = log_area, y = log_proportion, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2")
  ) +
  scale_fill_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Proportion of Total Particles",
    title = "Vacuum Edge Normalized Proportions",
    subtitle = "Binned Particle Area Distribution over 0.01 meter (Normalized)"
  ) +
  custom_theme +
  theme(
    legend.position = c(0.98, 0.98),
    legend.justification = c(1, 1),
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),
    legend.margin = margin(5, 5, 5, 5),
    legend.key.size = unit(0.8, "lines")
  ) +
  coord_cartesian(xlim = c(0, 4))

## 3. AIR CUMULATIVE PROPORTIONS ##
ggplot() +
  geom_ribbon(data = edge_air_cum_prop,
              aes(x = log_area, 
                  ymin = log_proportion_lower, 
                  ymax = log_proportion_upper,
                  fill = "Starshade Observed"),
              alpha = 0.3) +
  geom_line(data = edge_air_cum_prop,
            aes(x = log_area, y = log_proportion, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_ribbon(data = cw_edge_air_cum_prop,
              aes(x = log_area, 
                  ymin = log_proportion_lower, 
                  ymax = log_proportion_upper,
                  fill = "Calibration Observed"),
              alpha = 0.3) +
  geom_line(data = cw_edge_air_cum_prop,
            aes(x = log_area, y = log_proportion, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2")
  ) +
  scale_fill_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Proportion of Total Particles",
    title = "Air Edge Normalized Proportions",
    subtitle = "Cumulative Particle Area Distribution over 0.01 meter (Normalized)"
  ) +
  custom_theme +
  theme(
    legend.position = c(0.98, 0.98),
    legend.justification = c(1, 1),
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),
    legend.margin = margin(5, 5, 5, 5),
    legend.key.size = unit(0.8, "lines")
  ) +
  coord_cartesian(xlim = c(0, 4))

## 4. AIR BINNED PROPORTIONS ##
ggplot() +
  geom_ribbon(data = edge_air_bin_prop,
              aes(x = log_area, 
                  ymin = log_proportion_lower, 
                  ymax = log_proportion_upper,
                  fill = "Starshade Observed"),
              alpha = 0.3) +
  geom_line(data = edge_air_bin_prop,
            aes(x = log_area, y = log_proportion, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_ribbon(data = cw_edge_air_bin_prop,
              aes(x = log_area, 
                  ymin = log_proportion_lower, 
                  ymax = log_proportion_upper,
                  fill = "Calibration Observed"),
              alpha = 0.3) +
  geom_line(data = cw_edge_air_bin_prop,
            aes(x = log_area, y = log_proportion, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2")
  ) +
  scale_fill_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2"),
    guide = "none"
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Proportion of Total Particles",
    title = "Air Edge Normalized Proportions",
    subtitle = "Binned Particle Area Distribution over 0.01 meter (Normalized)"
  ) +
  custom_theme +
  theme(
    legend.position = c(0.98, 0.98),
    legend.justification = c(1, 1),
    legend.background = element_rect(fill = "white", color = "black", size = 0.5),
    legend.margin = margin(5, 5, 5, 5),
    legend.key.size = unit(0.8, "lines")
  ) +
  coord_cartesian(xlim = c(0, 4))
```




### 9.2 Average Air of Trials

```{r Average Air graphs}

ggplot() +
  geom_line(data = surface_average_air,
            aes(x = log_area, y = log_count, 
                color = "Starshade Surface", 
                linetype = "Starshade Surface")) +
  # geom_line(data = cw_surface_average_air,
  #           aes(x = log_area, y = log_count, 
  #               color = "Calibration Surface", 
  #               linetype = "Calibration Surface")) +
  # geom_line(data = wit_surface_average_air,
  #           aes(x = log_area, y = log_count, 
  #               color = "Witness Surface", 
  #               linetype = "Witness Surface")) +
  scale_color_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "#D55E00",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73")
  ) +
  scale_linetype_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "solid",
               "Calibration Surface" = "dashed", 
               "Witness Surface" = "dotted")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "In Air Surface Average",
    subtitle = "Cumulative Particle Area Distribution over 0.1 square meters"
  ) +
  custom_theme

ggplot() +
  geom_line(data = surface_average_air_binned,
            aes(x = log_area, y = log_count_bin, 
                color = "Starshade Surface", 
                linetype = "Starshade Surface")) +
  # geom_line(data = cw_surface_average_air_binned,
  #           aes(x = log_area, y = log_count_bin, 
  #               color = "Calibration Surface", 
  #               linetype = "Calibration Surface")) +
  # geom_line(data = wit_surface_average_air_binned,
  #           aes(x = log_area, y = log_count_bin, 
  #               color = "Witness Surface", 
  #               linetype = "Witness Surface")) +
  scale_color_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "#D55E00",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73")
  ) +
  scale_linetype_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "solid",
               "Calibration Surface" = "dashed", 
               "Witness Surface" = "dotted")
  ) +
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "In Air Surface Average",
    subtitle = "Binned Particle Area Distribution over 0.1 square meters"
  ) +
  custom_theme

ggplot() +
  geom_line(data = edge_average_air,
            aes(x = log_area, y = log_count, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_line(data = cw_edge_average_air,
            aes(x = log_area, y = log_count, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  geom_line(data = model_edge_average_air,
            aes(x = log_area, y = log_count, 
                color = "Model", 
                linetype = "Model")) +
  # geom_line(data = SSLSM_edge_average_air,
  #           aes(x = log_area, y = log_count, 
  #               color = "SLSM Starshade", 
  #               linetype = "SLSM Starshade")) +
  # geom_line(data = CSLSM_edge_average_air,
  #           aes(x = log_area, y = log_count, 
  #               color = "SLSM Calibration", 
  #               linetype = "SLSM Calibration")) +
  # geom_line(data = WSLSM_edge_average_air,
  #           aes(x = log_area, y = log_count, 
  #               color = "SLSM Witness", 
  #               linetype = "SLSM Witness")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73",
               "SLSM Starshade" = "#D55E00",
               "SLSM Calibration" = "#F0E442",
               "SLSM Witness" = "#56B4E9")
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "In Air Edge Average",
    subtitle = "Cumulative Particle Area Distribution over 0.01 meter"
  ) +
  custom_theme

ggplot() +
  geom_line(data = edge_average_air_binned,
            aes(x = log_area, y = log_count_bin, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_line(data = cw_edge_average_air_binned,
            aes(x = log_area, y = log_count_bin, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  geom_line(data = model_edge_average_air_binned,
            aes(x = log_area, y = log_count_bin, 
                color = "Model", 
                linetype = "Model")) +
  geom_line(data = SSLSM_edge_average_air_binned,
            aes(x = log_area, y = log_count_bin,
                color = "SLSM Starshade",
                linetype = "SLSM Starshade")) +
  geom_line(data = CSLSM_edge_average_air_binned,
            aes(x = log_area, y = log_count_bin,
                color = "SLSM Calibration",
                linetype = "SLSM Calibration")) +
  geom_line(data = WSLSM_edge_average_air_binned,
            aes(x = log_area, y = log_count_bin,
                color = "SLSM Witness",
                linetype = "SLSM Witness")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73",
               "SLSM Starshade" = "#D55E00",
               "SLSM Calibration" = "#F0E442",
               "SLSM Witness" = "#56B4E9")
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "In Air Edge Average",
    subtitle = "Binned Particle Area Distribution over 0.01 meter"
  ) +
  custom_theme
 
```

### 9.3 Scatter Graphs

```{r scatter_graphs}

 # Scatter

ggplot() +
  geom_line(data = surface_average,
            aes(x = log_area, y = Average_Scatter, 
                color = "Starshade Surface", 
                linetype = "Starshade Surface")) +
  # geom_line(data = cw_surface_average,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "Calibration Surface", 
  #               linetype = "Calibration Surface")) +
  # geom_line(data = wit_surface_average,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "Witness Surface", 
  #               linetype = "Witness Surface")) +
  scale_color_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "#D55E00",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73")
  ) +
  scale_linetype_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "solid",
               "Calibration Surface" = "dashed", 
               "Witness Surface" = "dotted")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Total Particle Area",
    title = "Vacuum Surface Average",
    subtitle = "Cumulative Particle Scatter Distribution over 0.1 square meters"
  ) +
  custom_theme

ggplot() +
  geom_line(data = surface_average_binned,
            aes(x = log_area, y = Average_Scatter, 
                color = "Starshade Surface", 
                linetype = "Starshade Surface")) +
  # geom_line(data = cw_surface_average_binned,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "Calibration Surface", 
  #               linetype = "Calibration Surface")) +
  # geom_line(data = wit_surface_average_binned,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "Witness Surface", 
  #               linetype = "Witness Surface")) +
  scale_color_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "#D55E00",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73")
  ) +
  scale_linetype_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "solid",
               "Calibration Surface" = "dashed", 
               "Witness Surface" = "dotted")
  ) +
  labs(
    x = expression(Area~"(square microns)"),
    y = "Total Particle Area",
    title = "Vacuum Surface Average",
    subtitle = "Binned Particle Scatter Distribution over 0.1 square meters"
  ) +
  custom_theme

ggplot() +
  geom_line(data = edge_average,
            aes(x = log_area, y = Average_Scatter, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_line(data = cw_edge_average,
            aes(x = log_area, y = Average_Scatter, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  geom_line(data = model_edge_average,
            aes(x = log_area, y = Average_Scatter, 
                color = "Model", 
                linetype = "Model")) +
  # geom_line(data = SSLSM_edge_average,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "SLSM Starshade", 
  #               linetype = "SLSM Starshade")) +
  # geom_line(data = CSLSM_edge_average,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "SLSM Calibration", 
  #               linetype = "SLSM Calibration")) +
  # geom_line(data = WSLSM_edge_average,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "SLSM Witness", 
  #               linetype = "SLSM Witness")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73",
               "SLSM Starshade" = "#D55E00",
               "SLSM Calibration" = "#F0E442",
               "SLSM Witness" = "#56B4E9")
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed",
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Total Particle Area",
    title = "Vacuum Edge Average",
    subtitle = "Cumulative Particle Scatter Distribution over 0.01 meter"
  ) +
  custom_theme

ggplot() +
  geom_line(data = edge_average_binned,
            aes(x = log_area, y = Average_Scatter, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_line(data = cw_edge_average_binned,
            aes(x = log_area, y = Average_Scatter, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
    geom_line(data = model_edge_average_binned,
            aes(x = log_area, y = Average_Scatter, 
                color = "Model", 
                linetype = "Model")) +
  # geom_line(data = SSLSM_edge_average_binned,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "SLSM Starshade", 
  #               linetype = "SLSM Starshade")) +
  # geom_line(data = CSLSM_edge_average_binned,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "SLSM Calibration", 
  #               linetype = "SLSM Calibration")) +
  # geom_line(data = WSLSM_edge_average_binned,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "SLSM Witness", 
  #               linetype = "SLSM Witness")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73",
               "SLSM Starshade" = "#D55E00",
               "SLSM Calibration" = "#F0E442",
               "SLSM Witness" = "#56B4E9")
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Total Particle Area",
    title = "Vacuum Edge Average",
    subtitle = "Binned Particle Scatter Distribution over 0.01 meter"
  ) +
  custom_theme
```


### 9.4 Scatter Air Graphs

```{r Scatter Air Graphs}
# Scatter
ggplot() +
  geom_line(data = surface_average_air,
            aes(x = log_area, y = Average_Scatter, 
                color = "Starshade Surface", 
                linetype = "Starshade Surface")) +
  # geom_line(data = cw_surface_average_air,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "Calibration Surface", 
  #               linetype = "Calibration Surface")) +
  # geom_line(data = wit_surface_average_air,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "Witness Surface", 
  #               linetype = "Witness Surface")) +
  scale_color_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "#D55E00",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73")
  ) +
  scale_linetype_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "solid",
               "Calibration Surface" = "dashed", 
               "Witness Surface" = "dotted")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Total Particle Area",
    title = "In Air Surface Average",
    subtitle = "Cumulative Particle Scatter Distribution over 0.1 square meters"
  ) +
  custom_theme

ggplot() +
  geom_line(data = surface_average_air_binned,
            aes(x = log_area, y = Average_Scatter, 
                color = "Starshade Surface", 
                linetype = "Starshade Surface")) +
  # geom_line(data = cw_surface_average_air_binned,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "Calibration Surface", 
  #               linetype = "Calibration Surface")) +
  # geom_line(data = wit_surface_average_air_binned,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "Witness Surface", 
  #               linetype = "Witness Surface")) +
  scale_color_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "#D55E00",
               "Calibration Surface" = "#CC79A7", 
               "Witness Surface" = "#009E73")
  ) +
  scale_linetype_manual(
    name = "Surface Type",
    values = c("Starshade Surface" = "solid",
               "Calibration Surface" = "dashed", 
               "Witness Surface" = "dotted")
  ) +
  labs(
    x = expression(Area~"(square microns)"),
    y = "Total Particle Area",
    title = "In Air Surface Average",
    subtitle = "Binned Particle Scatter Distribution over 0.1 square meters"
  ) +
  custom_theme

ggplot() +
  geom_line(data = edge_average_air,
            aes(x = log_area, y = Average_Scatter, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_line(data = cw_edge_average_air,
            aes(x = log_area, y = Average_Scatter, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  geom_line(data = model_edge_average_air,
            aes(x = log_area, y = Average_Scatter, 
                color = "Model", 
                linetype = "Model")) +
  # geom_line(data = SSLSM_edge_average_air,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "SLSM Starshade", 
  #               linetype = "SLSM Starshade")) +
  # geom_line(data = CSLSM_edge_average_air,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "SLSM Calibration", 
  #               linetype = "SLSM Calibration")) +
  # geom_line(data = WSLSM_edge_average_air,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "SLSM Witness", 
  #               linetype = "SLSM Witness")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73",
               "SLSM Starshade" = "#D55E00",
               "SLSM Calibration" = "#F0E442",
               "SLSM Witness" = "#56B4E9")
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Total Particle Area",
    title = "In Air Edge Average",
    subtitle = "Cumulative Particle Scatter Distribution over 0.01 meter"
  ) +
  custom_theme

ggplot() +
  geom_line(data = edge_average_air_binned,
            aes(x = log_area, y = Average_Scatter, 
                color = "Starshade Observed", 
                linetype = "Starshade Observed")) +
  geom_line(data = cw_edge_average_air_binned,
            aes(x = log_area, y = Average_Scatter, 
                color = "Calibration Observed", 
                linetype = "Calibration Observed")) +
  geom_line(data = model_edge_average_air_binned,
            aes(x = log_area, y = Average_Scatter, 
                color = "Model", 
                linetype = "Model")) +
  # geom_line(data = SSLSM_edge_average_air_binned,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "SLSM Starshade", 
  #               linetype = "SLSM Starshade")) +
  # geom_line(data = CSLSM_edge_average_air_binned,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "SLSM Calibration", 
  #               linetype = "SLSM Calibration")) +
  # geom_line(data = WSLSM_edge_average_air_binned,
  #           aes(x = log_area, y = Average_Scatter, 
  #               color = "SLSM Witness", 
  #               linetype = "SLSM Witness")) +
  scale_color_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "#CC79A7",
               "Calibration Observed" = "#0072B2", 
               "Model" = "#009E73",
               "SLSM Starshade" = "#D55E00",
               "SLSM Calibration" = "#F0E442",
               "SLSM Witness" = "#56B4E9")
  ) +
  scale_linetype_manual(
    name = "Analysis Type",
    values = c("Starshade Observed" = "solid",
               "Calibration Observed" = "dashed", 
               "Model" = "dotted",
               "SLSM Starshade" = "dotdash",
               "SLSM Calibration" = "longdash",
               "SLSM Witness" = "twodash")
  ) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "Total Particle Area",
    title = "In Air Edge Average",
    subtitle = "Binned Particle Scatter Distribution over 0.01 meter"
  ) +
  custom_theme
 
```



# 10. Comparison Graphics

### 10.1 Graph Comparison Graphic Count

```{r comparison}
# 8.8 Comprehensive Trial Comparison

# Create a comprehensive comparison grid showing all trials and analysis types
library(tidyverse)
library(gridExtra)
library(grid)

# Define trials in the requested order
trial_order <- c(9, 10, 11, 12, 13, 14)

# Custom theme for consistent appearance with minimal margins
compact_theme <- theme_minimal() +
  theme(
    plot.title = element_blank(),  # Remove individual plot titles
    plot.margin = margin(2, 2, 2, 2, "pt"),  # Minimize plot margins
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    legend.position = "none",
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray95")
  )

# Create lists to store plots
surface_cumulative_plots <- list()
surface_binned_plots <- list()
edge_cumulative_plots <- list()
edge_binned_plots <- list()

# Function to create a fallback plot when data isn't available
create_fallback_plot <- function() {
  ggplot() + 
    annotate("text", x = 2, y = 2, label = "Data not available") +
    theme_minimal() +
    theme(plot.margin = margin(2, 2, 2, 2, "pt")) +
    labs(x = expression(log[10](Area)), y = "log10(Count)")
}

# Helper function to check for column names
get_column_name <- function(data, possible_names) {
  for (name in possible_names) {
    if (name %in% names(data)) {
      return(name)
    }
  }
  return(NULL)
}

# Generate plots for each trial with error handling
for (i in 1:length(trial_order)) {
  trial_num <- trial_order[i]
  
  # 1. Surface cumulative plots
  tryCatch({
    surface_data <- get(paste0("surface_", trial_num))
    witness_data <- get(paste0("wit_surface_", trial_num))
    
    # Check column names
    area_col <- get_column_name(surface_data, c("log_area", "Area"))
    count_col <- get_column_name(surface_data, c("log_count", "Count", "Average_Count"))
    
    wit_area_col <- get_column_name(witness_data, c("log_area", "Area"))
    wit_count_col <- get_column_name(witness_data, c("log_count", "Count", "Average_Count"))
    
    # Base plot for surface cumulative
    p_surf_cum <- ggplot()
    
    if (!is.null(area_col) && !is.null(count_col)) {
      p_surf_cum <- p_surf_cum + 
        geom_line(data = surface_data,
                  aes_string(x = area_col, y = count_col),
                  color = "#D55E00", 
                  linetype = "solid")
    }
    
    if (!is.null(wit_area_col) && !is.null(wit_count_col)) {
      p_surf_cum <- p_surf_cum + 
        geom_line(data = witness_data,
                  aes_string(x = wit_area_col, y = wit_count_col),
                  color = "#009E73", 
                  linetype = "dashed")
    }
    
    # Add calibration data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("cw_surface_", trial_num))) {
        cw_data <- get(paste0("cw_surface_", trial_num))
        cw_area_col <- get_column_name(cw_data, c("log_area", "Area"))
        cw_count_col <- get_column_name(cw_data, c("log_count", "Count", "Average_Count"))
        
        if (!is.null(cw_area_col) && !is.null(cw_count_col)) {
          p_surf_cum <- p_surf_cum +
            geom_line(data = cw_data,
                      aes_string(x = cw_area_col, y = cw_count_col),
                      color = "#CC79A7", 
                      linetype = "dotted")
        }
      }
    }
    
    # Finalize surface cumulative plot with minimal spacing
    p_surf_cum <- p_surf_cum +
      labs(
        x = expression(log[10](Area)),
        y = "log10(Count)"
      ) +
      xlim(0, 4) +
      ylim(-5, 9) +
      compact_theme
    
    surface_cumulative_plots[[i]] <- p_surf_cum
  }, error = function(e) {
    surface_cumulative_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating surface cumulative plot for trial", trial_num, ":", e$message))
  })
  
  # 2. Surface binned plots
  tryCatch({
    surface_bin_data <- get(paste0("surface_", trial_num, "_binned"))
    witness_bin_data <- get(paste0("wit_surface_", trial_num, "_binned"))
    
    # Check column names
    bin_area_col <- get_column_name(surface_bin_data, c("log_area", "Area"))
    bin_count_col <- get_column_name(surface_bin_data, c("log_count_bin"))
    
    wit_bin_area_col <- get_column_name(witness_bin_data, c("log_area", "Area"))
    wit_bin_count_col <- get_column_name(witness_bin_data, c("log_count_bin"))
    
    # Base plot for surface binned
    p_surf_bin <- ggplot()
    
    if (!is.null(bin_area_col) && !is.null(bin_count_col)) {
      p_surf_bin <- p_surf_bin + 
        geom_line(data = surface_bin_data,
                  aes_string(x = bin_area_col, y = bin_count_col),
                  color = "#D55E00", 
                  linetype = "solid")
    }
    
    if (!is.null(wit_bin_area_col) && !is.null(wit_bin_count_col)) {
      p_surf_bin <- p_surf_bin + 
        geom_line(data = witness_bin_data,
                  aes_string(x = wit_bin_area_col, y = wit_bin_count_col),
                  color = "#009E73", 
                  linetype = "dashed")
    }
    
    # Add calibration data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("cw_surface_", trial_num, "_binned"))) {
        cw_bin_data <- get(paste0("cw_surface_", trial_num, "_binned"))
        cw_bin_area_col <- get_column_name(cw_bin_data, c("log_area", "Area"))
        cw_bin_count_col <- get_column_name(cw_bin_data, c("log_count_bin"))
        
        if (!is.null(cw_bin_area_col) && !is.null(cw_bin_count_col)) {
          p_surf_bin <- p_surf_bin +
            geom_line(data = cw_bin_data,
                      aes_string(x = cw_bin_area_col, y = cw_bin_count_col),
                      color = "#CC79A7", 
                      linetype = "dotted")
        }
      }
    }
    
    # Finalize surface binned plot
    p_surf_bin <- p_surf_bin +
      labs(
        x = expression(log[10](Area)),
        y = "log10(Count)"
      ) +
      xlim(0, 4) +
  ylim(-5, 8) +
      compact_theme
    
    surface_binned_plots[[i]] <- p_surf_bin
  }, error = function(e) {
    surface_binned_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating surface binned plot for trial", trial_num, ":", e$message))
  })
  
  # 3. Edge cumulative plots 
  tryCatch({
    edge_data <- get(paste0("edge_", trial_num))
    cw_edge_data <- get(paste0("cw_edge_", trial_num))
    model_edge_data <- get(paste0("model_edge_", trial_num))
    SSLSM_edge_data <- get(paste0("SSLSM_edge_", trial_num))
    WSLSM_edge_data <- get(paste0("WSLSM_edge_", trial_num))
    
    # Check column names for each dataset
    edge_area_col <- get_column_name(edge_data, c("log_area", "Area"))
    edge_count_col <- get_column_name(edge_data, c("log_count", "Count", "Average_Count"))
    
    cw_edge_area_col <- get_column_name(cw_edge_data, c("log_area", "Area"))
    cw_edge_count_col <- get_column_name(cw_edge_data, c("log_count", "Count", "Average_Count"))
    
    model_edge_area_col <- get_column_name(model_edge_data, c("log_area", "Area"))
    model_edge_count_col <- get_column_name(model_edge_data, c("log_count", "Count", "Average_Count"))
    
    SSLSM_edge_area_col <- get_column_name(SSLSM_edge_data, c("log_area", "Area"))
    SSLSM_edge_count_col <- get_column_name(SSLSM_edge_data, c("log_count", "Count", "Average_Count", "Cumulative_Count"))
    
    WSLSM_edge_area_col <- get_column_name(WSLSM_edge_data, c("log_area", "Area"))
    WSLSM_edge_count_col <- get_column_name(WSLSM_edge_data, c("log_count", "Count", "Average_Count", "Cumulative_Count"))
    
    # Base plot for edge cumulative
    p_edge_cum <- ggplot()
    
    if (!is.null(edge_area_col) && !is.null(edge_count_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = edge_data,
                  aes_string(x = edge_area_col, y = edge_count_col),
                  color = "#CC79A7", 
                  linetype = "solid")
    }
    
    if (!is.null(cw_edge_area_col) && !is.null(cw_edge_count_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = cw_edge_data,
                  aes_string(x = cw_edge_area_col, y = cw_edge_count_col),
                  color = "#0072B2", 
                  linetype = "dashed")
    }
    
    if (!is.null(model_edge_area_col) && !is.null(model_edge_count_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = model_edge_data,
                  aes_string(x = model_edge_area_col, y = model_edge_count_col),
                  color = "#009E73", 
                  linetype = "dotted")
    }
    
    if (!is.null(SSLSM_edge_area_col) && !is.null(SSLSM_edge_count_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = SSLSM_edge_data,
                  aes_string(x = SSLSM_edge_area_col, y = SSLSM_edge_count_col),
                  color = "#D55E00", 
                  linetype = "dotdash")
    }
    
    if (!is.null(WSLSM_edge_area_col) && !is.null(WSLSM_edge_count_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = WSLSM_edge_data,
                  aes_string(x = WSLSM_edge_area_col, y = WSLSM_edge_count_col),
                  color = "#56B4E9", 
                  linetype = "longdash")
    }
    
    # Add calibration SLSM data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("CSLSM_edge_", trial_num))) {
        CSLSM_edge_data <- get(paste0("CSLSM_edge_", trial_num))
        CSLSM_edge_area_col <- get_column_name(CSLSM_edge_data, c("log_area", "Area"))
        CSLSM_edge_count_col <- get_column_name(CSLSM_edge_data, c("log_count", "Count", "Average_Count", "Cumulative_Count"))
        
        if (!is.null(CSLSM_edge_area_col) && !is.null(CSLSM_edge_count_col)) {
          p_edge_cum <- p_edge_cum +
            geom_line(data = CSLSM_edge_data,
                      aes_string(x = CSLSM_edge_area_col, y = CSLSM_edge_count_col),
                      color = "#F0E442", 
                      linetype = "twodash")
        }
      }
    }
    
    # Finalize edge cumulative plot
    p_edge_cum <- p_edge_cum +
      labs(
        x = expression(log[10](Area)),
        y = "log10(Count)"
      ) +
      xlim(0, 4) +
  ylim(-5, 5) +
      compact_theme
    
    edge_cumulative_plots[[i]] <- p_edge_cum
  }, error = function(e) {
    edge_cumulative_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating edge cumulative plot for trial", trial_num, ":", e$message))
  })
  
  # 4. Edge binned plots
  tryCatch({
    edge_bin_data <- get(paste0("edge_", trial_num, "_binned"))
    cw_edge_bin_data <- get(paste0("cw_edge_", trial_num, "_binned"))
    model_edge_bin_data <- get(paste0("model_edge_", trial_num, "_binned"))
    SSLSM_edge_bin_data <- get(paste0("SSLSM_edge_", trial_num, "_binned"))
    WSLSM_edge_bin_data <- get(paste0("WSLSM_edge_", trial_num, "_binned"))
    
    # Check column names for each dataset
    edge_bin_area_col <- get_column_name(edge_bin_data, c("log_area", "Area"))
    edge_bin_count_col <- get_column_name(edge_bin_data, c("log_count_bin"))
    
    cw_edge_bin_area_col <- get_column_name(cw_edge_bin_data, c("log_area", "Area"))
    cw_edge_bin_count_col <- get_column_name(cw_edge_bin_data, c("log_count_bin"))
    
    model_edge_bin_area_col <- get_column_name(model_edge_bin_data, c("log_area", "Area"))
    model_edge_bin_count_col <- get_column_name(model_edge_bin_data, c("log_count_bin"))
    
    SSLSM_edge_bin_area_col <- get_column_name(SSLSM_edge_bin_data, c("log_area", "Area"))
    SSLSM_edge_bin_count_col <- get_column_name(SSLSM_edge_bin_data, c("log_count_bin"))
    
    WSLSM_edge_bin_area_col <- get_column_name(WSLSM_edge_bin_data, c("log_area", "Area"))
    WSLSM_edge_bin_count_col <- get_column_name(WSLSM_edge_bin_data, c("log_count_bin"))
    
    # Base plot for edge binned
    p_edge_bin <- ggplot()
    
    if (!is.null(edge_bin_area_col) && !is.null(edge_bin_count_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = edge_bin_data,
                  aes_string(x = edge_bin_area_col, y = edge_bin_count_col),
                  color = "#CC79A7", 
                  linetype = "solid")
    }
    
    if (!is.null(cw_edge_bin_area_col) && !is.null(cw_edge_bin_count_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = cw_edge_bin_data,
                  aes_string(x = cw_edge_bin_area_col, y = cw_edge_bin_count_col),
                  color = "#0072B2", 
                  linetype = "dashed")
    }
    
    if (!is.null(model_edge_bin_area_col) && !is.null(model_edge_bin_count_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = model_edge_bin_data,
                  aes_string(x = model_edge_bin_area_col, y = model_edge_bin_count_col),
                  color = "#009E73", 
                  linetype = "dotted")
    }
    
    if (!is.null(SSLSM_edge_bin_area_col) && !is.null(SSLSM_edge_bin_count_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = SSLSM_edge_bin_data,
                  aes_string(x = SSLSM_edge_bin_area_col, y = SSLSM_edge_bin_count_col),
                  color = "#D55E00", 
                  linetype = "dotdash")
    }
    
    if (!is.null(WSLSM_edge_bin_area_col) && !is.null(WSLSM_edge_bin_count_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = WSLSM_edge_bin_data,
                  aes_string(x = WSLSM_edge_bin_area_col, y = WSLSM_edge_bin_count_col),
                  color = "#56B4E9", 
                  linetype = "longdash")
    }
    
    # Add calibration SLSM data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("CSLSM_edge_", trial_num, "_binned"))) {
        CSLSM_edge_bin_data <- get(paste0("CSLSM_edge_", trial_num, "_binned"))
        CSLSM_edge_bin_area_col <- get_column_name(CSLSM_edge_bin_data, c("log_area", "Area"))
        CSLSM_edge_bin_count_col <- get_column_name(CSLSM_edge_bin_data, c("log_count_bin"))
        
        if (!is.null(CSLSM_edge_bin_area_col) && !is.null(CSLSM_edge_bin_count_col)) {
          p_edge_bin <- p_edge_bin +
            geom_line(data = CSLSM_edge_bin_data,
                      aes_string(x = CSLSM_edge_bin_area_col, y = CSLSM_edge_bin_count_col),
                      color = "#F0E442", 
                      linetype = "twodash")
        }
      }
    }
    
    # Finalize edge binned plot
    p_edge_bin <- p_edge_bin +
      labs(
        x = expression(log[10](Area)),
        y = "log10(Count)"
      ) +
      xlim(0, 4) +
  ylim(-5, 4) +
      compact_theme
    
    edge_binned_plots[[i]] <- p_edge_bin
  }, error = function(e) {
    edge_binned_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating edge binned plot for trial", trial_num, ":", e$message))
  })
}

# Add the average plots and air average plots (from trials 13-14)
# Surface cumulative average
tryCatch({
  surface_avg_cum_plot <- ggplot()
  surface_avg_air_cum_plot <- ggplot()
  
  # Check column names for standard average
  s_avg_area_col <- get_column_name(surface_average, c("log_area", "Area"))
  s_avg_count_col <- get_column_name(surface_average, c("log_count", "Count", "Average_Count"))
  
  wit_avg_area_col <- get_column_name(wit_surface_average, c("log_area", "Area"))
  wit_avg_count_col <- get_column_name(wit_surface_average, c("log_count", "Count", "Average_Count"))
  
  cw_avg_area_col <- get_column_name(cw_surface_average, c("log_area", "Area"))
  cw_avg_count_col <- get_column_name(cw_surface_average, c("log_count", "Count", "Average_Count"))
  
  # Check column names for air average (trials 13-14)
  s_avg_air_area_col <- get_column_name(surface_average_air, c("log_area", "Area"))
  s_avg_air_count_col <- get_column_name(surface_average_air, c("log_count", "Count", "Average_Count"))
  
  wit_avg_air_area_col <- get_column_name(wit_surface_average_air, c("log_area", "Area"))
  wit_avg_air_count_col <- get_column_name(wit_surface_average_air, c("log_count", "Count", "Average_Count"))
  
  cw_avg_air_area_col <- get_column_name(cw_surface_average_air, c("log_area", "Area"))
  cw_avg_air_count_col <- get_column_name(cw_surface_average_air, c("log_count", "Count", "Average_Count"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(s_avg_area_col) && !is.null(s_avg_count_col)) {
    surface_avg_cum_plot <- surface_avg_cum_plot +
      geom_line(data = surface_average,
                aes_string(x = s_avg_area_col, y = s_avg_count_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_area_col) && !is.null(wit_avg_count_col)) {
    surface_avg_cum_plot <- surface_avg_cum_plot +
      geom_line(data = wit_surface_average,
                aes_string(x = wit_avg_area_col, y = wit_avg_count_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_area_col) && !is.null(cw_avg_count_col)) {
    surface_avg_cum_plot <- surface_avg_cum_plot +
      geom_line(data = cw_surface_average,
                aes_string(x = cw_avg_area_col, y = cw_avg_count_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(s_avg_air_area_col) && !is.null(s_avg_air_count_col)) {
    surface_avg_air_cum_plot <- surface_avg_air_cum_plot +
      geom_line(data = surface_average_air,
                aes_string(x = s_avg_air_area_col, y = s_avg_air_count_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_air_area_col) && !is.null(wit_avg_air_count_col)) {
    surface_avg_air_cum_plot <- surface_avg_air_cum_plot +
      geom_line(data = wit_surface_average_air,
                aes_string(x = wit_avg_air_area_col, y = wit_avg_air_count_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_air_area_col) && !is.null(cw_avg_air_count_col)) {
    surface_avg_air_cum_plot <- surface_avg_air_cum_plot +
      geom_line(data = cw_surface_average_air,
                aes_string(x = cw_avg_air_area_col, y = cw_avg_air_count_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  surface_avg_cum_plot <- surface_avg_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    xlim(0, 4) +
  ylim(-5, 9) +
    compact_theme
  
  surface_avg_air_cum_plot <- surface_avg_air_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    xlim(0, 4) +
  ylim(-5, 9) +
    compact_theme
  
  surface_cumulative_plots[[length(trial_order) + 1]] <- surface_avg_cum_plot
  surface_cumulative_plots[[length(trial_order) + 2]] <- surface_avg_air_cum_plot
}, error = function(e) {
  surface_cumulative_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  surface_cumulative_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating surface cumulative average plots:", e$message))
})

# Surface binned average
tryCatch({
  surface_avg_bin_plot <- ggplot()
  surface_avg_air_bin_plot <- ggplot()
  
  # Check column names for standard average
  s_avg_bin_area_col <- get_column_name(surface_average_binned, c("log_area", "Area"))
  s_avg_bin_count_col <- get_column_name(surface_average_binned, c("log_count_bin"))
  
  wit_avg_bin_area_col <- get_column_name(wit_surface_average_binned, c("log_area", "Area"))
  wit_avg_bin_count_col <- get_column_name(wit_surface_average_binned, c("log_count_bin"))
  
  cw_avg_bin_area_col <- get_column_name(cw_surface_average_binned, c("log_area", "Area"))
  cw_avg_bin_count_col <- get_column_name(cw_surface_average_binned, c("log_count_bin"))
  
  # Check column names for air average (trials 13-14)
  s_avg_air_bin_area_col <- get_column_name(surface_average_air_binned, c("log_area", "Area"))
  s_avg_air_bin_count_col <- get_column_name(surface_average_air_binned, c("log_count_bin"))
  
  wit_avg_air_bin_area_col <- get_column_name(wit_surface_average_air_binned, c("log_area", "Area"))
  wit_avg_air_bin_count_col <- get_column_name(wit_surface_average_air_binned, c("log_count_bin"))
  
  cw_avg_air_bin_area_col <- get_column_name(cw_surface_average_air_binned, c("log_area", "Area"))
  cw_avg_air_bin_count_col <- get_column_name(cw_surface_average_air_binned, c("log_count_bin"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(s_avg_bin_area_col) && !is.null(s_avg_bin_count_col)) {
    surface_avg_bin_plot <- surface_avg_bin_plot +
      geom_line(data = surface_average_binned,
                aes_string(x = s_avg_bin_area_col, y = s_avg_bin_count_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_bin_area_col) && !is.null(wit_avg_bin_count_col)) {
    surface_avg_bin_plot <- surface_avg_bin_plot +
      geom_line(data = wit_surface_average_binned,
                aes_string(x = wit_avg_bin_area_col, y = wit_avg_bin_count_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
 if (!is.null(cw_avg_bin_area_col) && !is.null(cw_avg_bin_count_col)) {
    surface_avg_bin_plot <- surface_avg_bin_plot +
      geom_line(data = cw_surface_average_binned,
                aes_string(x = cw_avg_bin_area_col, y = cw_avg_bin_count_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(s_avg_air_bin_area_col) && !is.null(s_avg_air_bin_count_col)) {
    surface_avg_air_bin_plot <- surface_avg_air_bin_plot +
      geom_line(data = surface_average_air_binned,
                aes_string(x = s_avg_air_bin_area_col, y = s_avg_air_bin_count_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_air_bin_area_col) && !is.null(wit_avg_air_bin_count_col)) {
    surface_avg_air_bin_plot <- surface_avg_air_bin_plot +
      geom_line(data = wit_surface_average_air_binned,
                aes_string(x = wit_avg_air_bin_area_col, y = wit_avg_air_bin_count_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_air_bin_area_col) && !is.null(cw_avg_air_bin_count_col)) {
    surface_avg_air_bin_plot <- surface_avg_air_bin_plot +
      geom_line(data = cw_surface_average_air_binned,
                aes_string(x = cw_avg_air_bin_area_col, y = cw_avg_air_bin_count_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  surface_avg_bin_plot <- surface_avg_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    xlim(0, 4) +
  ylim(-5, 8) +
    compact_theme
  
  surface_avg_air_bin_plot <- surface_avg_air_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +xlim(0, 4) +
  ylim(-5, 8) +
    compact_theme
  
  surface_binned_plots[[length(trial_order) + 1]] <- surface_avg_bin_plot
  surface_binned_plots[[length(trial_order) + 2]] <- surface_avg_air_bin_plot
}, error = function(e) {
  surface_binned_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  surface_binned_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating surface binned average plots:", e$message))
})

# Edge cumulative average
tryCatch({
  edge_avg_cum_plot <- ggplot()
  edge_avg_air_cum_plot <- ggplot()
  
  # Check column names for standard average
  e_avg_area_col <- get_column_name(edge_average, c("log_area", "Area"))
  e_avg_count_col <- get_column_name(edge_average, c("log_count", "Count", "Average_Count"))
  
  cw_e_avg_area_col <- get_column_name(cw_edge_average, c("log_area", "Area"))
  cw_e_avg_count_col <- get_column_name(cw_edge_average, c("log_count", "Count", "Average_Count"))
  
  m_e_avg_area_col <- get_column_name(model_edge_average, c("log_area", "Area"))
  m_e_avg_count_col <- get_column_name(model_edge_average, c("log_count", "Count", "Average_Count"))
  
  SSLSM_e_avg_area_col <- get_column_name(SSLSM_edge_average, c("log_area", "Area"))
  SSLSM_e_avg_count_col <- get_column_name(SSLSM_edge_average, c("log_count", "Count", "Average_Count"))
  
  WSLSM_e_avg_area_col <- get_column_name(WSLSM_edge_average, c("log_area", "Area"))
  WSLSM_e_avg_count_col <- get_column_name(WSLSM_edge_average, c("log_count", "Count", "Average_Count"))
  
  CSLSM_e_avg_area_col <- get_column_name(CSLSM_edge_average, c("log_area", "Area"))
  CSLSM_e_avg_count_col <- get_column_name(CSLSM_edge_average, c("log_count", "Count", "Average_Count"))
  
  # Check column names for air average (trials 13-14)
  e_avg_air_area_col <- get_column_name(edge_average_air, c("log_area", "Area"))
  e_avg_air_count_col <- get_column_name(edge_average_air, c("log_count", "Count", "Average_Count"))
  
  cw_e_avg_air_area_col <- get_column_name(cw_edge_average_air, c("log_area", "Area"))
  cw_e_avg_air_count_col <- get_column_name(cw_edge_average_air, c("log_count", "Count", "Average_Count"))
  
  m_e_avg_air_area_col <- get_column_name(model_edge_average_air, c("log_area", "Area"))
  m_e_avg_air_count_col <- get_column_name(model_edge_average_air, c("log_count", "Count", "Average_Count"))
  
  SSLSM_e_avg_air_area_col <- get_column_name(SSLSM_edge_average_air, c("log_area", "Area"))
  SSLSM_e_avg_air_count_col <- get_column_name(SSLSM_edge_average_air, c("log_count", "Count", "Average_Count"))
  
  WSLSM_e_avg_air_area_col <- get_column_name(WSLSM_edge_average_air, c("log_area", "Area"))
  WSLSM_e_avg_air_count_col <- get_column_name(WSLSM_edge_average_air, c("log_count", "Count", "Average_Count"))
  
  CSLSM_e_avg_air_area_col <- get_column_name(CSLSM_edge_average_air, c("log_area", "Area"))
  CSLSM_e_avg_air_count_col <- get_column_name(CSLSM_edge_average_air, c("log_count", "Count", "Average_Count"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(e_avg_area_col) && !is.null(e_avg_count_col)) {
    edge_avg_cum_plot <- edge_avg_cum_plot +
      geom_line(data = edge_average,
                aes_string(x = e_avg_area_col, y = e_avg_count_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_area_col) && !is.null(cw_e_avg_count_col)) {
    edge_avg_cum_plot <- edge_avg_cum_plot +
      geom_line(data = cw_edge_average,
                aes_string(x = cw_e_avg_area_col, y = cw_e_avg_count_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  if (!is.null(m_e_avg_area_col) && !is.null(m_e_avg_count_col)) {
    edge_avg_cum_plot <- edge_avg_cum_plot +
      geom_line(data = model_edge_average,
                aes_string(x = m_e_avg_area_col, y = m_e_avg_count_col),
                color = "#009E73", 
                linetype = "dotted")
  }
  
  if (!is.null(SSLSM_e_avg_area_col) && !is.null(SSLSM_e_avg_count_col)) {
    edge_avg_cum_plot <- edge_avg_cum_plot +
      geom_line(data = SSLSM_edge_average,
                aes_string(x = SSLSM_e_avg_area_col, y = SSLSM_e_avg_count_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_area_col) && !is.null(WSLSM_e_avg_count_col)) {
    edge_avg_cum_plot <- edge_avg_cum_plot +
      geom_line(data = WSLSM_edge_average,
                aes_string(x = WSLSM_e_avg_area_col, y = WSLSM_e_avg_count_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_area_col) && !is.null(CSLSM_e_avg_count_col)) {
    edge_avg_cum_plot <- edge_avg_cum_plot +
      geom_line(data = CSLSM_edge_average,
                aes_string(x = CSLSM_e_avg_area_col, y = CSLSM_e_avg_count_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(e_avg_air_area_col) && !is.null(e_avg_air_count_col)) {
    edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
      geom_line(data = edge_average_air,
                aes_string(x = e_avg_air_area_col, y = e_avg_air_count_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_air_area_col) && !is.null(cw_e_avg_air_count_col)) {
    edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
      geom_line(data = cw_edge_average_air,
                aes_string(x = cw_e_avg_air_area_col, y = cw_e_avg_air_count_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  if (!is.null(m_e_avg_air_area_col) && !is.null(m_e_avg_air_count_col)) {
    edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
      geom_line(data = model_edge_average_air,
                aes_string(x = m_e_avg_air_area_col, y = m_e_avg_air_count_col),
                color = "#009E73", 
                linetype = "dotted")
  }
  
  if (!is.null(SSLSM_e_avg_air_area_col) && !is.null(SSLSM_e_avg_air_count_col)) {
    edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
      geom_line(data = SSLSM_edge_average_air,
                aes_string(x = SSLSM_e_avg_air_area_col, y = SSLSM_e_avg_air_count_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_air_area_col) && !is.null(WSLSM_e_avg_air_count_col)) {
    edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
      geom_line(data = WSLSM_edge_average_air,
                aes_string(x = WSLSM_e_avg_air_area_col, y = WSLSM_e_avg_air_count_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_air_area_col) && !is.null(CSLSM_e_avg_air_count_col)) {
    edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
      geom_line(data = CSLSM_edge_average_air,
                aes_string(x = CSLSM_e_avg_air_area_col, y = CSLSM_e_avg_air_count_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  edge_avg_cum_plot <- edge_avg_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    xlim(0, 4) +
  ylim(-5, 5) +
    compact_theme
  
  edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    xlim(0, 4) +
  ylim(-5, 5) +
    compact_theme
  
  edge_cumulative_plots[[length(trial_order) + 1]] <- edge_avg_cum_plot
  edge_cumulative_plots[[length(trial_order) + 2]] <- edge_avg_air_cum_plot
}, error = function(e) {
  edge_cumulative_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  edge_cumulative_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating edge cumulative average plots:", e$message))
})

# Edge binned average
tryCatch({
  edge_avg_bin_plot <- ggplot()
  edge_avg_air_bin_plot <- ggplot()
  
  # Check column names for standard average
  e_avg_bin_area_col <- get_column_name(edge_average_binned, c("log_area", "Area"))
  e_avg_bin_count_col <- get_column_name(edge_average_binned, c("log_count_bin"))
  
  cw_e_avg_bin_area_col <- get_column_name(cw_edge_average_binned, c("log_area", "Area"))
  cw_e_avg_bin_count_col <- get_column_name(cw_edge_average_binned, c("log_count_bin"))
  
  m_e_avg_bin_area_col <- get_column_name(model_edge_average_binned, c("log_area", "Area"))
  m_e_avg_bin_count_col <- get_column_name(model_edge_average_binned, c("log_count_bin"))
  
  SSLSM_e_avg_bin_area_col <- get_column_name(SSLSM_edge_average_binned, c("log_area", "Area"))
  SSLSM_e_avg_bin_count_col <- get_column_name(SSLSM_edge_average_binned, c("log_count_bin"))
  
  WSLSM_e_avg_bin_area_col <- get_column_name(WSLSM_edge_average_binned, c("log_area", "Area"))
  WSLSM_e_avg_bin_count_col <- get_column_name(WSLSM_edge_average_binned, c("log_count_bin"))
  
  CSLSM_e_avg_bin_area_col <- get_column_name(CSLSM_edge_average_binned, c("log_area", "Area"))
  CSLSM_e_avg_bin_count_col <- get_column_name(CSLSM_edge_average_binned, c("log_count_bin"))
  
  # Check column names for air average (trials 13-14)
  e_avg_air_bin_area_col <- get_column_name(edge_average_air_binned, c("log_area", "Area"))
  e_avg_air_bin_count_col <- get_column_name(edge_average_air_binned, c("log_count_bin"))
  
  cw_e_avg_air_bin_area_col <- get_column_name(cw_edge_average_air_binned, c("log_area", "Area"))
  cw_e_avg_air_bin_count_col <- get_column_name(cw_edge_average_air_binned, c("log_count_bin"))
  
  m_e_avg_air_bin_area_col <- get_column_name(model_edge_average_air_binned, c("log_area", "Area"))
  m_e_avg_air_bin_count_col <- get_column_name(model_edge_average_air_binned, c("log_count_bin"))
  
  SSLSM_e_avg_air_bin_area_col <- get_column_name(SSLSM_edge_average_air_binned, c("log_area", "Area"))
  SSLSM_e_avg_air_bin_count_col <- get_column_name(SSLSM_edge_average_air_binned, c("log_count_bin"))
  
  WSLSM_e_avg_air_bin_area_col <- get_column_name(WSLSM_edge_average_air_binned, c("log_area", "Area"))
  WSLSM_e_avg_air_bin_count_col <- get_column_name(WSLSM_edge_average_air_binned, c("log_count_bin"))
  
  CSLSM_e_avg_air_bin_area_col <- get_column_name(CSLSM_edge_average_air_binned, c("log_area", "Area"))
  CSLSM_e_avg_air_bin_count_col <- get_column_name(CSLSM_edge_average_air_binned, c("log_count_bin"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(e_avg_bin_area_col) && !is.null(e_avg_bin_count_col)) {
    edge_avg_bin_plot <- edge_avg_bin_plot +
      geom_line(data = edge_average_binned,
                aes_string(x = e_avg_bin_area_col, y = e_avg_bin_count_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_bin_area_col) && !is.null(cw_e_avg_bin_count_col)) {
    edge_avg_bin_plot <- edge_avg_bin_plot +
      geom_line(data = cw_edge_average_binned,
                aes_string(x = cw_e_avg_bin_area_col, y = cw_e_avg_bin_count_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  if (!is.null(m_e_avg_bin_area_col) && !is.null(m_e_avg_bin_count_col)) {
    edge_avg_bin_plot <- edge_avg_bin_plot +
      geom_line(data = model_edge_average_binned,
                aes_string(x = m_e_avg_bin_area_col, y = m_e_avg_bin_count_col),
                color = "#009E73", 
                linetype = "dotted")
  }
  
  if (!is.null(SSLSM_e_avg_bin_area_col) && !is.null(SSLSM_e_avg_bin_count_col)) {
    edge_avg_bin_plot <- edge_avg_bin_plot +
      geom_line(data = SSLSM_edge_average_binned,
                aes_string(x = SSLSM_e_avg_bin_area_col, y = SSLSM_e_avg_bin_count_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_bin_area_col) && !is.null(WSLSM_e_avg_bin_count_col)) {
    edge_avg_bin_plot <- edge_avg_bin_plot +
      geom_line(data = WSLSM_edge_average_binned,
                aes_string(x = WSLSM_e_avg_bin_area_col, y = WSLSM_e_avg_bin_count_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_bin_area_col) && !is.null(CSLSM_e_avg_bin_count_col)) {
    edge_avg_bin_plot <- edge_avg_bin_plot +
      geom_line(data = CSLSM_edge_average_binned,
                aes_string(x = CSLSM_e_avg_bin_area_col, y = CSLSM_e_avg_bin_count_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(e_avg_air_bin_area_col) && !is.null(e_avg_air_bin_count_col)) {
    edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
      geom_line(data = edge_average_air_binned,
                aes_string(x = e_avg_air_bin_area_col, y = e_avg_air_bin_count_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_air_bin_area_col) && !is.null(cw_e_avg_air_bin_count_col)) {
    edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
      geom_line(data = cw_edge_average_air_binned,
                aes_string(x = cw_e_avg_air_bin_area_col, y = cw_e_avg_air_bin_count_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  if (!is.null(m_e_avg_air_bin_area_col) && !is.null(m_e_avg_air_bin_count_col)) {
    edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
      geom_line(data = model_edge_average_air_binned,
                aes_string(x = m_e_avg_air_bin_area_col, y = m_e_avg_air_bin_count_col),
                color = "#009E73", 
                linetype = "dotted")
  }
  
  if (!is.null(SSLSM_e_avg_air_bin_area_col) && !is.null(SSLSM_e_avg_air_bin_count_col)) {
    edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
      geom_line(data = SSLSM_edge_average_air_binned,
                aes_string(x = SSLSM_e_avg_air_bin_area_col, y = SSLSM_e_avg_air_bin_count_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_air_bin_area_col) && !is.null(WSLSM_e_avg_air_bin_count_col)) {
    edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
      geom_line(data = WSLSM_edge_average_air_binned,
                aes_string(x = WSLSM_e_avg_air_bin_area_col, y = WSLSM_e_avg_air_bin_count_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_air_bin_area_col) && !is.null(CSLSM_e_avg_air_bin_count_col)) {
    edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
      geom_line(data = CSLSM_edge_average_air_binned,
                aes_string(x = CSLSM_e_avg_air_bin_area_col, y = CSLSM_e_avg_air_bin_count_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  edge_avg_bin_plot <- edge_avg_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    xlim(0, 4) +
  ylim(-5, 4) +
    compact_theme
  
  edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    xlim(0, 4) +
  ylim(-5, 4) +
    compact_theme
  
  edge_binned_plots[[length(trial_order) + 1]] <- edge_avg_bin_plot
  edge_binned_plots[[length(trial_order) + 2]] <- edge_avg_air_bin_plot
}, error = function(e) {
  edge_binned_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  edge_binned_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating edge binned average plots:", e$message))
})

# Create standalone legend grobs for surface and edge plots
surface_legend <- grobTree(
  # Starshade
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#D55E00", lty = "solid", lwd = 4)),
  textGrob("Starshade", x = unit(0.5, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Witness
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#009E73", lty = "dashed", lwd = 4)),
  textGrob("Witness", x = unit(0.5, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Calibration
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#CC79A7", lty = "dotted", lwd = 4)),
  textGrob("Calibration", x = unit(0.5, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20))
)

# Edge legend (more complex with 6 items)
edge_legend <- grobTree(
  # First column
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#CC79A7", lty = "solid", lwd = 4)),
  textGrob("Starshade Observed", x = unit(0.3, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#0072B2", lty = "dashed", lwd = 4)),
  textGrob("Calibration Observed", x = unit(0.3, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#009E73", lty = "dotted", lwd = 4)),
  textGrob("Model", x = unit(0.3, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Second column
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#D55E00", lty = "dotdash", lwd = 4)),
  textGrob("SLSM Starshade", x = unit(0.8, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#56B4E9", lty = "longdash", lwd = 4)),
  textGrob("SLSM Witness", x = unit(0.8, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#F0E442", lty = "twodash", lwd = 4)),
  textGrob("SLSM Calibration", x = unit(0.8, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20))
)

# Create column and row labels with consistent formatting
col_labels <- c(
  lapply(trial_order, function(t) textGrob(paste("Trial", t), gp = gpar(fontsize = 22, fontface = "bold"))),
  list(
    textGrob("Average", gp = gpar(fontsize = 22, fontface = "bold")),
    textGrob("Air Average", gp = gpar(fontsize = 22, fontface = "bold"))
  )
)

row_labels <- list(
  textGrob("Surface\nCumulative", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Surface\nBinned", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Edge\nCumulative", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Edge\nBinned", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90)
)

# Assemble the complete grid layout
complete_grid <- grid.arrange(
  # Main title 
  textGrob("Comprehensive Particle Distribution Analysis Across Trials", 
           gp = gpar(fontsize = 36, fontface = "bold"), y = 0.7),
  
  # Main grid
  grid.arrange(
    # Column labels
    arrangeGrob(
      nullGrob(), 
      col_labels[[1]], col_labels[[2]], col_labels[[3]], col_labels[[4]], 
      col_labels[[5]], col_labels[[6]], col_labels[[7]], col_labels[[8]],
      ncol = 9, widths = c(0.25, 1, 1, 1, 1, 1, 1, 1, 1),
      heights = unit(0.2, "cm")
    ),
    
    # Main plot grid with row labels
    arrangeGrob(
      # Surface Cumulative row
      row_labels[[1]],
      surface_cumulative_plots[[1]], surface_cumulative_plots[[2]], 
      surface_cumulative_plots[[3]], surface_cumulative_plots[[4]], 
      surface_cumulative_plots[[5]], surface_cumulative_plots[[6]], 
      surface_cumulative_plots[[7]], surface_cumulative_plots[[8]],
      
      # Surface Binned row
      row_labels[[2]],
      surface_binned_plots[[1]], surface_binned_plots[[2]], 
      surface_binned_plots[[3]], surface_binned_plots[[4]], 
      surface_binned_plots[[5]], surface_binned_plots[[6]], 
      surface_binned_plots[[7]], surface_binned_plots[[8]],
      
      # Edge Cumulative row
      row_labels[[3]],
      edge_cumulative_plots[[1]], edge_cumulative_plots[[2]], 
      edge_cumulative_plots[[3]], edge_cumulative_plots[[4]], 
      edge_cumulative_plots[[5]], edge_cumulative_plots[[6]], 
      edge_cumulative_plots[[7]], edge_cumulative_plots[[8]],
      
      # Edge Binned row
      row_labels[[4]],
      edge_binned_plots[[1]], edge_binned_plots[[2]], 
      edge_binned_plots[[3]], edge_binned_plots[[4]], 
      edge_binned_plots[[5]], edge_binned_plots[[6]], 
      edge_binned_plots[[7]], edge_binned_plots[[8]],
      
      ncol = 9, widths = c(0.25, 1, 1, 1, 1, 1, 1, 1, 1)
    ),
    
    # Legend section
    arrangeGrob(
      textGrob("Surface Plot Legend:", gp = gpar(fontsize = 22, fontface = "bold")), 
      surface_legend,
      textGrob("Edge Plot Legend:", gp = gpar(fontsize = 22, fontface = "bold")), 
      edge_legend,
      ncol = 4, widths = c(0.4, 1.3, 0.4, 1.3)
    ),
    
    # Layout adjustment
    nrow = 3,
    heights = c(0.1, 4, 0.5)
  ),
  
  # Overall layout parameters
  heights = c(0.05, 0.95)
)

# Display the complete grid
print(complete_grid)

# Save to high-resolution image
ggsave("particle_distribution_comparison1.png", complete_grid, width = 40, height = 20, dpi = 300)
```

### 10.2 Graph Comparison Graphic Scatter
```{r}
# 10.2 Create a comprehensive comparison grid showing all trials and analysis types for scatter data
library(tidyverse)
library(gridExtra)
library(grid)

# Define trials in the requested order
trial_order <- c(9, 10, 11, 12, 13, 14)

# Custom theme for consistent appearance with minimal margins
compact_theme <- theme_minimal() +
  theme(
    plot.title = element_blank(),  # Remove individual plot titles
    plot.margin = margin(2, 2, 2, 2, "pt"),  # Minimize plot margins
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    legend.position = "none",
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray95")
  )

# Create lists to store plots
surface_scatter_cumulative_plots <- list()
surface_scatter_binned_plots <- list()
edge_scatter_cumulative_plots <- list()
edge_scatter_binned_plots <- list()

# Function to create a fallback plot when data isn't available
create_fallback_plot <- function() {
  ggplot() + 
    annotate("text", x = 2, y = 2, label = "Data not available") +
    theme_minimal() +
    theme(plot.margin = margin(2, 2, 2, 2, "pt")) +
    labs(x = expression(log[10](Area)), y = "Scatter Area")
}

# Helper function to check for column names
get_column_name <- function(data, possible_names) {
  for (name in possible_names) {
    if (name %in% names(data)) {
      return(name)
    }
  }
  return(NULL)
}

# Generate plots for each trial with error handling
for (i in 1:length(trial_order)) {
  trial_num <- trial_order[i]
  
  # 1. Surface cumulative scatter plots
  tryCatch({
    surface_data <- get(paste0("surface_", trial_num))
    witness_data <- get(paste0("wit_surface_", trial_num))
    
    # Check column names
    area_col <- get_column_name(surface_data, c("log_area", "Area"))
    scatter_col <- get_column_name(surface_data, c("Average_Scatter"))
    
    wit_area_col <- get_column_name(witness_data, c("log_area", "Area"))
    wit_scatter_col <- get_column_name(witness_data, c("Average_Scatter"))
    
    # Base plot for surface cumulative
    p_surf_cum <- ggplot()
    
    if (!is.null(area_col) && !is.null(scatter_col)) {
      p_surf_cum <- p_surf_cum + 
        geom_line(data = surface_data,
                  aes_string(x = area_col, y = scatter_col),
                  color = "#D55E00", 
                  linetype = "solid")
    }
    
    if (!is.null(wit_area_col) && !is.null(wit_scatter_col)) {
      p_surf_cum <- p_surf_cum + 
        geom_line(data = witness_data,
                  aes_string(x = wit_area_col, y = wit_scatter_col),
                  color = "#009E73", 
                  linetype = "dashed")
    }
    
    # Add calibration data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("cw_surface_", trial_num))) {
        cw_data <- get(paste0("cw_surface_", trial_num))
        cw_area_col <- get_column_name(cw_data, c("log_area", "Area"))
        cw_scatter_col <- get_column_name(cw_data, c("Average_Scatter"))
        
        if (!is.null(cw_area_col) && !is.null(cw_scatter_col)) {
          p_surf_cum <- p_surf_cum +
            geom_line(data = cw_data,
                      aes_string(x = cw_area_col, y = cw_scatter_col),
                      color = "#CC79A7", 
                      linetype = "dotted")
        }
      }
    }
    
    # Finalize surface cumulative plot with minimal spacing
    p_surf_cum <- p_surf_cum +
      labs(
        x = expression(log[10](Area)),
        y = "Scatter Area"
      ) +
      compact_theme
    
    surface_scatter_cumulative_plots[[i]] <- p_surf_cum
  }, error = function(e) {
    surface_scatter_cumulative_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating surface cumulative scatter plot for trial", trial_num, ":", e$message))
  })
  
  # 2. Surface binned scatter plots
  tryCatch({
    surface_bin_data <- get(paste0("surface_", trial_num, "_binned"))
    witness_bin_data <- get(paste0("wit_surface_", trial_num, "_binned"))
    
    # Check column names
    bin_area_col <- get_column_name(surface_bin_data, c("log_area", "Area"))
    bin_scatter_col <- get_column_name(surface_bin_data, c("Average_Scatter"))
    
    wit_bin_area_col <- get_column_name(witness_bin_data, c("log_area", "Area"))
    wit_bin_scatter_col <- get_column_name(witness_bin_data, c("Average_Scatter"))
    
    # Base plot for surface binned
    p_surf_bin <- ggplot()
    
    if (!is.null(bin_area_col) && !is.null(bin_scatter_col)) {
      p_surf_bin <- p_surf_bin + 
        geom_line(data = surface_bin_data,
                  aes_string(x = bin_area_col, y = bin_scatter_col),
                  color = "#D55E00", 
                  linetype = "solid")
    }
    
    if (!is.null(wit_bin_area_col) && !is.null(wit_bin_scatter_col)) {
      p_surf_bin <- p_surf_bin + 
        geom_line(data = witness_bin_data,
                  aes_string(x = wit_bin_area_col, y = wit_bin_scatter_col),
                  color = "#009E73", 
                  linetype = "dashed")
    }
    
    # Add calibration data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("cw_surface_", trial_num, "_binned"))) {
        cw_bin_data <- get(paste0("cw_surface_", trial_num, "_binned"))
        cw_bin_area_col <- get_column_name(cw_bin_data, c("log_area", "Area"))
        cw_bin_scatter_col <- get_column_name(cw_bin_data, c("Average_Scatter"))
        
        if (!is.null(cw_bin_area_col) && !is.null(cw_bin_scatter_col)) {
          p_surf_bin <- p_surf_bin +
            geom_line(data = cw_bin_data,
                      aes_string(x = cw_bin_area_col, y = cw_bin_scatter_col),
                      color = "#CC79A7", 
                      linetype = "dotted")
        }
      }
    }
    
    # Finalize surface binned plot
    p_surf_bin <- p_surf_bin +
      labs(
        x = expression(log[10](Area)),
        y = "Scatter Area"
      ) +
      compact_theme
    
    surface_scatter_binned_plots[[i]] <- p_surf_bin
  }, error = function(e) {
    surface_scatter_binned_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating surface binned scatter plot for trial", trial_num, ":", e$message))
  })
  
  # 3. Edge cumulative scatter plots 
  tryCatch({
    edge_data <- get(paste0("edge_", trial_num))
    cw_edge_data <- get(paste0("cw_edge_", trial_num))
    SSLSM_edge_data <- get(paste0("SSLSM_edge_", trial_num))
    WSLSM_edge_data <- get(paste0("WSLSM_edge_", trial_num))
    
    # Check column names for each dataset
    edge_area_col <- get_column_name(edge_data, c("log_area", "Area"))
    edge_scatter_col <- get_column_name(edge_data, c("Average_Scatter"))
    
    cw_edge_area_col <- get_column_name(cw_edge_data, c("log_area", "Area"))
    cw_edge_scatter_col <- get_column_name(cw_edge_data, c("Average_Scatter"))
    
    SSLSM_edge_area_col <- get_column_name(SSLSM_edge_data, c("log_area", "Area"))
    SSLSM_edge_scatter_col <- get_column_name(SSLSM_edge_data, c("Cumulative_Scatter"))
    
    WSLSM_edge_area_col <- get_column_name(WSLSM_edge_data, c("log_area", "Area"))
    WSLSM_edge_scatter_col <- get_column_name(WSLSM_edge_data, c("Cumulative_Scatter"))
    
    # Base plot for edge cumulative
    p_edge_cum <- ggplot()
    
    if (!is.null(edge_area_col) && !is.null(edge_scatter_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = edge_data,
                  aes_string(x = edge_area_col, y = edge_scatter_col),
                  color = "#CC79A7", 
                  linetype = "solid")
    }
    
    if (!is.null(cw_edge_area_col) && !is.null(cw_edge_scatter_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = cw_edge_data,
                  aes_string(x = cw_edge_area_col, y = cw_edge_scatter_col),
                  color = "#0072B2", 
                  linetype = "dashed")
    }
    
    if (!is.null(SSLSM_edge_area_col) && !is.null(SSLSM_edge_scatter_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = SSLSM_edge_data,
                  aes_string(x = SSLSM_edge_area_col, y = SSLSM_edge_scatter_col),
                  color = "#D55E00", 
                  linetype = "dotdash")
    }
    
    if (!is.null(WSLSM_edge_area_col) && !is.null(WSLSM_edge_scatter_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = WSLSM_edge_data,
                  aes_string(x = WSLSM_edge_area_col, y = WSLSM_edge_scatter_col),
                  color = "#56B4E9", 
                  linetype = "longdash")
    }
    
    # Add calibration SLSM data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("CSLSM_edge_", trial_num))) {
        CSLSM_edge_data <- get(paste0("CSLSM_edge_", trial_num))
        CSLSM_edge_area_col <- get_column_name(CSLSM_edge_data, c("log_area", "Area"))
        CSLSM_edge_scatter_col <- get_column_name(CSLSM_edge_data, c("Cumulative_Scatter"))
        
        if (!is.null(CSLSM_edge_area_col) && !is.null(CSLSM_edge_scatter_col)) {
          p_edge_cum <- p_edge_cum +
            geom_line(data = CSLSM_edge_data,
                      aes_string(x = CSLSM_edge_area_col, y = CSLSM_edge_scatter_col),
                      color = "#F0E442", 
                      linetype = "twodash")
        }
      }
    }
    
    # Finalize edge cumulative plot
    p_edge_cum <- p_edge_cum +
      labs(
        x = expression(log[10](Area)),
        y = "Scatter Area"
      ) +
      compact_theme
    
    edge_scatter_cumulative_plots[[i]] <- p_edge_cum
  }, error = function(e) {
    edge_scatter_cumulative_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating edge cumulative scatter plot for trial", trial_num, ":", e$message))
  })
  
  # 4. Edge binned scatter plots
  tryCatch({
    edge_bin_data <- get(paste0("edge_", trial_num, "_binned"))
    cw_edge_bin_data <- get(paste0("cw_edge_", trial_num, "_binned"))
    
    # NEW: Add SSLSM and WSLSM binned data for all trials
    SSLSM_edge_bin_data <- get(paste0("SSLSM_edge_", trial_num, "_binned"))
    WSLSM_edge_bin_data <- get(paste0("WSLSM_edge_", trial_num, "_binned"))
    
    # Check column names for each dataset
    edge_bin_area_col <- get_column_name(edge_bin_data, c("log_area", "Area"))
    edge_bin_scatter_col <- get_column_name(edge_bin_data, c("Average_Scatter"))
    
    cw_edge_bin_area_col <- get_column_name(cw_edge_bin_data, c("log_area", "Area"))
    cw_edge_bin_scatter_col <- get_column_name(cw_edge_bin_data, c("Average_Scatter"))
    
    # NEW: Check column names for SSLSM and WSLSM binned data
    SSLSM_edge_bin_area_col <- get_column_name(SSLSM_edge_bin_data, c("log_area", "Area"))
    SSLSM_edge_bin_scatter_col <- get_column_name(SSLSM_edge_bin_data, c("Scatter"))
    
    WSLSM_edge_bin_area_col <- get_column_name(WSLSM_edge_bin_data, c("log_area", "Area"))
    WSLSM_edge_bin_scatter_col <- get_column_name(WSLSM_edge_bin_data, c("Scatter"))
    
    # Base plot for edge binned
    p_edge_bin <- ggplot()
    
    if (!is.null(edge_bin_area_col) && !is.null(edge_bin_scatter_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = edge_bin_data,
                  aes_string(x = edge_bin_area_col, y = edge_bin_scatter_col),
                  color = "#CC79A7", 
                  linetype = "solid")
    }
    
    if (!is.null(cw_edge_bin_area_col) && !is.null(cw_edge_bin_scatter_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = cw_edge_bin_data,
                  aes_string(x = cw_edge_bin_area_col, y = cw_edge_bin_scatter_col),
                  color = "#0072B2", 
                  linetype = "dashed")
    }
    
    # NEW: Add SSLSM and WSLSM lines to binned plots
    if (!is.null(SSLSM_edge_bin_area_col) && !is.null(SSLSM_edge_bin_scatter_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = SSLSM_edge_bin_data,
                  aes_string(x = SSLSM_edge_bin_area_col, y = SSLSM_edge_bin_scatter_col),
                  color = "#D55E00", 
                  linetype = "dotdash")
    }
    
    if (!is.null(WSLSM_edge_bin_area_col) && !is.null(WSLSM_edge_bin_scatter_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = WSLSM_edge_bin_data,
                  aes_string(x = WSLSM_edge_bin_area_col, y = WSLSM_edge_bin_scatter_col),
                  color = "#56B4E9", 
                  linetype = "longdash")
    }
    
    # NEW: Add calibration SLSM data for trials 12-14 binned plots
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("CSLSM_edge_", trial_num, "_binned"))) {
        CSLSM_edge_bin_data <- get(paste0("CSLSM_edge_", trial_num, "_binned"))
        CSLSM_edge_bin_area_col <- get_column_name(CSLSM_edge_bin_data, c("log_area", "Area"))
        CSLSM_edge_bin_scatter_col <- get_column_name(CSLSM_edge_bin_data, c("Scatter"))
        
        if (!is.null(CSLSM_edge_bin_area_col) && !is.null(CSLSM_edge_bin_scatter_col)) {
          p_edge_bin <- p_edge_bin +
            geom_line(data = CSLSM_edge_bin_data,
                      aes_string(x = CSLSM_edge_bin_area_col, y = CSLSM_edge_bin_scatter_col),
                      color = "#F0E442", 
                      linetype = "twodash")
        }
      }
    }
    
    # Finalize edge binned plot
    p_edge_bin <- p_edge_bin +
      labs(
        x = expression(log[10](Area)),
        y = "Scatter Area"
      ) +
      compact_theme
    
    edge_scatter_binned_plots[[i]] <- p_edge_bin
  }, error = function(e) {
    edge_scatter_binned_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating edge binned scatter plot for trial", trial_num, ":", e$message))
  })
}

# Add the average plots and air average plots
# Surface cumulative scatter average
tryCatch({
  surface_avg_scatter_cum_plot <- ggplot()
  surface_avg_air_scatter_cum_plot <- ggplot()
  
  # Check column names for standard average
  s_avg_area_col <- get_column_name(surface_average, c("log_area", "Area"))
  s_avg_scatter_col <- get_column_name(surface_average, c("Average_Scatter"))
  
  wit_avg_area_col <- get_column_name(wit_surface_average, c("log_area", "Area"))
  wit_avg_scatter_col <- get_column_name(wit_surface_average, c("Average_Scatter"))
  
  cw_avg_area_col <- get_column_name(cw_surface_average, c("log_area", "Area"))
  cw_avg_scatter_col <- get_column_name(cw_surface_average, c("Average_Scatter"))
  
  # Check column names for air average (trials 13-14)
  s_avg_air_area_col <- get_column_name(surface_average_air, c("log_area", "Area"))
  s_avg_air_scatter_col <- get_column_name(surface_average_air, c("Average_Scatter"))
  
  wit_avg_air_area_col <- get_column_name(wit_surface_average_air, c("log_area", "Area"))
  wit_avg_air_scatter_col <- get_column_name(wit_surface_average_air, c("Average_Scatter"))
  
  cw_avg_air_area_col <- get_column_name(cw_surface_average_air, c("log_area", "Area"))
  cw_avg_air_scatter_col <- get_column_name(cw_surface_average_air, c("Average_Scatter"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(s_avg_area_col) && !is.null(s_avg_scatter_col)) {
    surface_avg_scatter_cum_plot <- surface_avg_scatter_cum_plot +
      geom_line(data = surface_average,
                aes_string(x = s_avg_area_col, y = s_avg_scatter_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_area_col) && !is.null(wit_avg_scatter_col)) {
    surface_avg_scatter_cum_plot <- surface_avg_scatter_cum_plot +
      geom_line(data = wit_surface_average,
                aes_string(x = wit_avg_area_col, y = wit_avg_scatter_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_area_col) && !is.null(cw_avg_scatter_col)) {
    surface_avg_scatter_cum_plot <- surface_avg_scatter_cum_plot +
      geom_line(data = cw_surface_average,
                aes_string(x = cw_avg_area_col, y = cw_avg_scatter_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(s_avg_air_area_col) && !is.null(s_avg_air_scatter_col)) {
    surface_avg_air_scatter_cum_plot <- surface_avg_air_scatter_cum_plot +
      geom_line(data = surface_average_air,
                aes_string(x = s_avg_air_area_col, y = s_avg_air_scatter_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_air_area_col) && !is.null(wit_avg_air_scatter_col)) {
    surface_avg_air_scatter_cum_plot <- surface_avg_air_scatter_cum_plot +
      geom_line(data = wit_surface_average_air,
                aes_string(x = wit_avg_air_area_col, y = wit_avg_air_scatter_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_air_area_col) && !is.null(cw_avg_air_scatter_col)) {
    surface_avg_air_scatter_cum_plot <- surface_avg_air_scatter_cum_plot +
      geom_line(data = cw_surface_average_air,
                aes_string(x = cw_avg_air_area_col, y = cw_avg_air_scatter_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  surface_avg_scatter_cum_plot <- surface_avg_scatter_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  surface_avg_air_scatter_cum_plot <- surface_avg_air_scatter_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  surface_scatter_cumulative_plots[[length(trial_order) + 1]] <- surface_avg_scatter_cum_plot
  surface_scatter_cumulative_plots[[length(trial_order) + 2]] <- surface_avg_air_scatter_cum_plot
}, error = function(e) {
  surface_scatter_cumulative_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  surface_scatter_cumulative_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating surface cumulative scatter average plots:", e$message))
})

# Surface binned scatter average
tryCatch({
  surface_avg_scatter_bin_plot <- ggplot()
  surface_avg_air_scatter_bin_plot <- ggplot()
  
  # Check column names for standard average
  s_avg_bin_area_col <- get_column_name(surface_average_binned, c("log_area", "Area"))
  s_avg_bin_scatter_col <- get_column_name(surface_average_binned, c("Average_Scatter"))
  
  wit_avg_bin_area_col <- get_column_name(wit_surface_average_binned, c("log_area", "Area"))
  wit_avg_bin_scatter_col <- get_column_name(wit_surface_average_binned, c("Average_Scatter"))
  
  cw_avg_bin_area_col <- get_column_name(cw_surface_average_binned, c("log_area", "Area"))
  cw_avg_bin_scatter_col <- get_column_name(cw_surface_average_binned, c("Average_Scatter"))
  
  # Check column names for air average (trials 13-14)
  s_avg_air_bin_area_col <- get_column_name(surface_average_air_binned, c("log_area", "Area"))
  s_avg_air_bin_scatter_col <- get_column_name(surface_average_air_binned, c("Average_Scatter"))
  
  wit_avg_air_bin_area_col <- get_column_name(wit_surface_average_air_binned, c("log_area", "Area"))
  wit_avg_air_bin_scatter_col <- get_column_name(wit_surface_average_air_binned, c("Average_Scatter"))
  
  cw_avg_air_bin_area_col <- get_column_name(cw_surface_average_air_binned, c("log_area", "Area"))
  cw_avg_air_bin_scatter_col <- get_column_name(cw_surface_average_air_binned, c("Average_Scatter"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(s_avg_bin_area_col) && !is.null(s_avg_bin_scatter_col)) {
    surface_avg_scatter_bin_plot <- surface_avg_scatter_bin_plot +
      geom_line(data = surface_average_binned,
                aes_string(x = s_avg_bin_area_col, y = s_avg_bin_scatter_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_bin_area_col) && !is.null(wit_avg_bin_scatter_col)) {
    surface_avg_scatter_bin_plot <- surface_avg_scatter_bin_plot +
      geom_line(data = wit_surface_average_binned,
                aes_string(x = wit_avg_bin_area_col, y = wit_avg_bin_scatter_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_bin_area_col) && !is.null(cw_avg_bin_scatter_col)) {
    surface_avg_scatter_bin_plot <- surface_avg_scatter_bin_plot +
      geom_line(data = cw_surface_average_binned,
                aes_string(x = cw_avg_bin_area_col, y = cw_avg_bin_scatter_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(s_avg_air_bin_area_col) && !is.null(s_avg_air_bin_scatter_col)) {
    surface_avg_air_scatter_bin_plot <- surface_avg_air_scatter_bin_plot +
      geom_line(data = surface_average_air_binned,
                aes_string(x = s_avg_air_bin_area_col, y = s_avg_air_bin_scatter_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_air_bin_area_col) && !is.null(wit_avg_air_bin_scatter_col)) {
    surface_avg_air_scatter_bin_plot <- surface_avg_air_scatter_bin_plot +
      geom_line(data = wit_surface_average_air_binned,
                aes_string(x = wit_avg_air_bin_area_col, y = wit_avg_air_bin_scatter_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_air_bin_area_col) && !is.null(cw_avg_air_bin_scatter_col)) {
    surface_avg_air_scatter_bin_plot <- surface_avg_air_scatter_bin_plot +
      geom_line(data = cw_surface_average_air_binned,
                aes_string(x = cw_avg_air_bin_area_col, y = cw_avg_air_bin_scatter_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  surface_avg_scatter_bin_plot <- surface_avg_scatter_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  surface_avg_air_scatter_bin_plot <- surface_avg_air_scatter_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  surface_scatter_binned_plots[[length(trial_order) + 1]] <- surface_avg_scatter_bin_plot
  surface_scatter_binned_plots[[length(trial_order) + 2]] <- surface_avg_air_scatter_bin_plot
}, error = function(e) {
  surface_scatter_binned_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  surface_scatter_binned_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating surface binned scatter average plots:", e$message))
})

# Edge cumulative scatter average
tryCatch({
  edge_avg_scatter_cum_plot <- ggplot()
  edge_avg_air_scatter_cum_plot <- ggplot()
  
  # Check column names for standard average
  e_avg_area_col <- get_column_name(edge_average, c("log_area", "Area"))
  e_avg_scatter_col <- get_column_name(edge_average, c("Average_Scatter"))
  
  cw_e_avg_area_col <- get_column_name(cw_edge_average, c("log_area", "Area"))
  cw_e_avg_scatter_col <- get_column_name(cw_edge_average, c("Average_Scatter"))
  
  SSLSM_e_avg_area_col <- get_column_name(SSLSM_edge_average, c("log_area", "Area"))
  SSLSM_e_avg_scatter_col <- get_column_name(SSLSM_edge_average, c("Average_Scatter"))
  
  WSLSM_e_avg_area_col <- get_column_name(WSLSM_edge_average, c("log_area", "Area"))
  WSLSM_e_avg_scatter_col <- get_column_name(WSLSM_edge_average, c("Average_Scatter"))
  
  CSLSM_e_avg_area_col <- get_column_name(CSLSM_edge_average, c("log_area", "Area"))
  CSLSM_e_avg_scatter_col <- get_column_name(CSLSM_edge_average, c("Average_Scatter"))
  
 # Check column names for air average (trials 13-14)
  e_avg_air_area_col <- get_column_name(edge_average_air, c("log_area", "Area"))
  e_avg_air_scatter_col <- get_column_name(edge_average_air, c("Average_Scatter"))
  
  cw_e_avg_air_area_col <- get_column_name(cw_edge_average_air, c("log_area", "Area"))
  cw_e_avg_air_scatter_col <- get_column_name(cw_edge_average_air, c("Average_Scatter"))
  
  SSLSM_e_avg_air_area_col <- get_column_name(SSLSM_edge_average_air, c("log_area", "Area"))
  SSLSM_e_avg_air_scatter_col <- get_column_name(SSLSM_edge_average_air, c("Average_Scatter"))
  
  WSLSM_e_avg_air_area_col <- get_column_name(WSLSM_edge_average_air, c("log_area", "Area"))
  WSLSM_e_avg_air_scatter_col <- get_column_name(WSLSM_edge_average_air, c("Average_Scatter"))
  
  CSLSM_e_avg_air_area_col <- get_column_name(CSLSM_edge_average_air, c("log_area", "Area"))
  CSLSM_e_avg_air_scatter_col <- get_column_name(CSLSM_edge_average_air, c("Average_Scatter"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(e_avg_area_col) && !is.null(e_avg_scatter_col)) {
    edge_avg_scatter_cum_plot <- edge_avg_scatter_cum_plot +
      geom_line(data = edge_average,
                aes_string(x = e_avg_area_col, y = e_avg_scatter_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_area_col) && !is.null(cw_e_avg_scatter_col)) {
    edge_avg_scatter_cum_plot <- edge_avg_scatter_cum_plot +
      geom_line(data = cw_edge_average,
                aes_string(x = cw_e_avg_area_col, y = cw_e_avg_scatter_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  if (!is.null(SSLSM_e_avg_area_col) && !is.null(SSLSM_e_avg_scatter_col)) {
    edge_avg_scatter_cum_plot <- edge_avg_scatter_cum_plot +
      geom_line(data = SSLSM_edge_average,
                aes_string(x = SSLSM_e_avg_area_col, y = SSLSM_e_avg_scatter_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_area_col) && !is.null(WSLSM_e_avg_scatter_col)) {
    edge_avg_scatter_cum_plot <- edge_avg_scatter_cum_plot +
      geom_line(data = WSLSM_edge_average,
                aes_string(x = WSLSM_e_avg_area_col, y = WSLSM_e_avg_scatter_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_area_col) && !is.null(CSLSM_e_avg_scatter_col)) {
    edge_avg_scatter_cum_plot <- edge_avg_scatter_cum_plot +
      geom_line(data = CSLSM_edge_average,
                aes_string(x = CSLSM_e_avg_area_col, y = CSLSM_e_avg_scatter_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(e_avg_air_area_col) && !is.null(e_avg_air_scatter_col)) {
    edge_avg_air_scatter_cum_plot <- edge_avg_air_scatter_cum_plot +
      geom_line(data = edge_average_air,
                aes_string(x = e_avg_air_area_col, y = e_avg_air_scatter_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_air_area_col) && !is.null(cw_e_avg_air_scatter_col)) {
    edge_avg_air_scatter_cum_plot <- edge_avg_air_scatter_cum_plot +
      geom_line(data = cw_edge_average_air,
                aes_string(x = cw_e_avg_air_area_col, y = cw_e_avg_air_scatter_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  if (!is.null(SSLSM_e_avg_air_area_col) && !is.null(SSLSM_e_avg_air_scatter_col)) {
    edge_avg_air_scatter_cum_plot <- edge_avg_air_scatter_cum_plot +
      geom_line(data = SSLSM_edge_average_air,
                aes_string(x = SSLSM_e_avg_air_area_col, y = SSLSM_e_avg_air_scatter_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_air_area_col) && !is.null(WSLSM_e_avg_air_scatter_col)) {
    edge_avg_air_scatter_cum_plot <- edge_avg_air_scatter_cum_plot +
      geom_line(data = WSLSM_edge_average_air,
                aes_string(x = WSLSM_e_avg_air_area_col, y = WSLSM_e_avg_air_scatter_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_air_area_col) && !is.null(CSLSM_e_avg_air_scatter_col)) {
    edge_avg_air_scatter_cum_plot <- edge_avg_air_scatter_cum_plot +
      geom_line(data = CSLSM_edge_average_air,
                aes_string(x = CSLSM_e_avg_air_area_col, y = CSLSM_e_avg_air_scatter_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  edge_avg_scatter_cum_plot <- edge_avg_scatter_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  edge_avg_air_scatter_cum_plot <- edge_avg_air_scatter_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  edge_scatter_cumulative_plots[[length(trial_order) + 1]] <- edge_avg_scatter_cum_plot
  edge_scatter_cumulative_plots[[length(trial_order) + 2]] <- edge_avg_air_scatter_cum_plot
}, error = function(e) {
  edge_scatter_cumulative_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  edge_scatter_cumulative_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating edge cumulative scatter average plots:", e$message))
})

# Edge binned scatter average
tryCatch({
  edge_avg_scatter_bin_plot <- ggplot()
  edge_avg_air_scatter_bin_plot <- ggplot()
  
  # Check column names for standard average
  e_avg_bin_area_col <- get_column_name(edge_average_binned, c("log_area", "Area"))
  e_avg_bin_scatter_col <- get_column_name(edge_average_binned, c("Average_Scatter"))
  
  cw_e_avg_bin_area_col <- get_column_name(cw_edge_average_binned, c("log_area", "Area"))
  cw_e_avg_bin_scatter_col <- get_column_name(cw_edge_average_binned, c("Average_Scatter"))
  
  # NEW: Add SSLSM, WSLSM, and CSLSM for binned average plots
  SSLSM_e_avg_bin_area_col <- get_column_name(SSLSM_edge_average_binned, c("log_area", "Area"))
  SSLSM_e_avg_bin_scatter_col <- get_column_name(SSLSM_edge_average_binned, c("Average_Scatter"))
  
  WSLSM_e_avg_bin_area_col <- get_column_name(WSLSM_edge_average_binned, c("log_area", "Area"))
  WSLSM_e_avg_bin_scatter_col <- get_column_name(WSLSM_edge_average_binned, c("Average_Scatter"))
  
  CSLSM_e_avg_bin_area_col <- get_column_name(CSLSM_edge_average_binned, c("log_area", "Area"))
  CSLSM_e_avg_bin_scatter_col <- get_column_name(CSLSM_edge_average_binned, c("Average_Scatter"))
  
  # Check column names for air average (trials 13-14)
  e_avg_air_bin_area_col <- get_column_name(edge_average_air_binned, c("log_area", "Area"))
  e_avg_air_bin_scatter_col <- get_column_name(edge_average_air_binned, c("Average_Scatter"))
  
  cw_e_avg_air_bin_area_col <- get_column_name(cw_edge_average_air_binned, c("log_area", "Area"))
  cw_e_avg_air_bin_scatter_col <- get_column_name(cw_edge_average_air_binned, c("Average_Scatter"))
  
  # NEW: Add SSLSM, WSLSM, and CSLSM for air binned average plots
  SSLSM_e_avg_air_bin_area_col <- get_column_name(SSLSM_edge_average_air_binned, c("log_area", "Area"))
  SSLSM_e_avg_air_bin_scatter_col <- get_column_name(SSLSM_edge_average_air_binned, c("Average_Scatter"))
  
  WSLSM_e_avg_air_bin_area_col <- get_column_name(WSLSM_edge_average_air_binned, c("log_area", "Area"))
  WSLSM_e_avg_air_bin_scatter_col <- get_column_name(WSLSM_edge_average_air_binned, c("Average_Scatter"))
  
  CSLSM_e_avg_air_bin_area_col <- get_column_name(CSLSM_edge_average_air_binned, c("log_area", "Area"))
  CSLSM_e_avg_air_bin_scatter_col <- get_column_name(CSLSM_edge_average_air_binned, c("Average_Scatter"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(e_avg_bin_area_col) && !is.null(e_avg_bin_scatter_col)) {
    edge_avg_scatter_bin_plot <- edge_avg_scatter_bin_plot +
      geom_line(data = edge_average_binned,
                aes_string(x = e_avg_bin_area_col, y = e_avg_bin_scatter_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_bin_area_col) && !is.null(cw_e_avg_bin_scatter_col)) {
    edge_avg_scatter_bin_plot <- edge_avg_scatter_bin_plot +
      geom_line(data = cw_edge_average_binned,
                aes_string(x = cw_e_avg_bin_area_col, y = cw_e_avg_bin_scatter_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  # NEW: Add SSLSM, WSLSM, and CSLSM to standard average binned plot
  if (!is.null(SSLSM_e_avg_bin_area_col) && !is.null(SSLSM_e_avg_bin_scatter_col)) {
    edge_avg_scatter_bin_plot <- edge_avg_scatter_bin_plot +
      geom_line(data = SSLSM_edge_average_binned,
                aes_string(x = SSLSM_e_avg_bin_area_col, y = SSLSM_e_avg_bin_scatter_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_bin_area_col) && !is.null(WSLSM_e_avg_bin_scatter_col)) {
    edge_avg_scatter_bin_plot <- edge_avg_scatter_bin_plot +
      geom_line(data = WSLSM_edge_average_binned,
                aes_string(x = WSLSM_e_avg_bin_area_col, y = WSLSM_e_avg_bin_scatter_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_bin_area_col) && !is.null(CSLSM_e_avg_bin_scatter_col)) {
    edge_avg_scatter_bin_plot <- edge_avg_scatter_bin_plot +
      geom_line(data = CSLSM_edge_average_binned,
                aes_string(x = CSLSM_e_avg_bin_area_col, y = CSLSM_e_avg_bin_scatter_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(e_avg_air_bin_area_col) && !is.null(e_avg_air_bin_scatter_col)) {
    edge_avg_air_scatter_bin_plot <- edge_avg_air_scatter_bin_plot +
      geom_line(data = edge_average_air_binned,
                aes_string(x = e_avg_air_bin_area_col, y = e_avg_air_bin_scatter_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_air_bin_area_col) && !is.null(cw_e_avg_air_bin_scatter_col)) {
    edge_avg_air_scatter_bin_plot <- edge_avg_air_scatter_bin_plot +
      geom_line(data = cw_edge_average_air_binned,
                aes_string(x = cw_e_avg_air_bin_area_col, y = cw_e_avg_air_bin_scatter_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  # NEW: Add SSLSM, WSLSM, and CSLSM to air average binned plot
  if (!is.null(SSLSM_e_avg_air_bin_area_col) && !is.null(SSLSM_e_avg_air_bin_scatter_col)) {
    edge_avg_air_scatter_bin_plot <- edge_avg_air_scatter_bin_plot +
      geom_line(data = SSLSM_edge_average_air_binned,
                aes_string(x = SSLSM_e_avg_air_bin_area_col, y = SSLSM_e_avg_air_bin_scatter_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_air_bin_area_col) && !is.null(WSLSM_e_avg_air_bin_scatter_col)) {
    edge_avg_air_scatter_bin_plot <- edge_avg_air_scatter_bin_plot +
      geom_line(data = WSLSM_edge_average_air_binned,
                aes_string(x = WSLSM_e_avg_air_bin_area_col, y = WSLSM_e_avg_air_bin_scatter_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_air_bin_area_col) && !is.null(CSLSM_e_avg_air_bin_scatter_col)) {
    edge_avg_air_scatter_bin_plot <- edge_avg_air_scatter_bin_plot +
      geom_line(data = CSLSM_edge_average_air_binned,
                aes_string(x = CSLSM_e_avg_air_bin_area_col, y = CSLSM_e_avg_air_bin_scatter_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  edge_avg_scatter_bin_plot <- edge_avg_scatter_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  edge_avg_air_scatter_bin_plot <- edge_avg_air_scatter_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  edge_scatter_binned_plots[[length(trial_order) + 1]] <- edge_avg_scatter_bin_plot
  edge_scatter_binned_plots[[length(trial_order) + 2]] <- edge_avg_air_scatter_bin_plot
}, error = function(e) {
  edge_scatter_binned_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  edge_scatter_binned_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating edge binned scatter average plots:", e$message))
})

# Create standalone legend grobs for surface and edge plots
surface_legend <- grobTree(
  # Starshade
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#D55E00", lty = "solid", lwd = 4)),
  textGrob("Starshade", x = unit(0.5, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Witness
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#009E73", lty = "dashed", lwd = 4)),
  textGrob("Witness", x = unit(0.5, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Calibration
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#CC79A7", lty = "dotted", lwd = 4)),
  textGrob("Calibration", x = unit(0.5, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20))
)

# Edge legend (more complex with 6 items)
edge_legend <- grobTree(
  # First column
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#CC79A7", lty = "solid", lwd = 4)),
  textGrob("Starshade Observed", x = unit(0.3, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#0072B2", lty = "dashed", lwd = 4)),
  textGrob("Calibration Observed", x = unit(0.3, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Second column
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#D55E00", lty = "dotdash", lwd = 4)),
  textGrob("SLSM Starshade", x = unit(0.8, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#56B4E9", lty = "longdash", lwd = 4)),
  textGrob("SLSM Witness", x = unit(0.8, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#F0E442", lty = "twodash", lwd = 4)),
  textGrob("SLSM Calibration", x = unit(0.8, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20))
)

# Create column and row labels with consistent formatting
col_labels <- c(
  lapply(trial_order, function(t) textGrob(paste("Trial", t), gp = gpar(fontsize = 22, fontface = "bold"))),
  list(
    textGrob("Average", gp = gpar(fontsize = 22, fontface = "bold")),
    textGrob("Air Average", gp = gpar(fontsize = 22, fontface = "bold"))
  )
)

row_labels <- list(
  textGrob("Surface\nCumulative\nScatter", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Surface\nBinned\nScatter", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Edge\nCumulative\nScatter", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Edge\nBinned\nScatter", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90)
)

# Assemble the complete grid layout
scatter_grid <- grid.arrange(
  # Main title 
  textGrob("Comprehensive Particle Scatter Distribution Analysis Across Trials", 
           gp = gpar(fontsize = 36, fontface = "bold"), y = 0.7),
  
  # Main grid
  grid.arrange(
    # Column labels
    arrangeGrob(
      nullGrob(), 
      col_labels[[1]], col_labels[[2]], col_labels[[3]], col_labels[[4]], 
      col_labels[[5]], col_labels[[6]], col_labels[[7]], col_labels[[8]],
      ncol = 9, widths = c(0.25, 1, 1, 1, 1, 1, 1, 1, 1),
      heights = unit(0.2, "cm")
    ),
    
    # Main plot grid with row labels
    arrangeGrob(
      # Surface Cumulative row
      row_labels[[1]],
      surface_scatter_cumulative_plots[[1]], surface_scatter_cumulative_plots[[2]], 
      surface_scatter_cumulative_plots[[3]], surface_scatter_cumulative_plots[[4]], 
      surface_scatter_cumulative_plots[[5]], surface_scatter_cumulative_plots[[6]], 
      surface_scatter_cumulative_plots[[7]], surface_scatter_cumulative_plots[[8]],
      
      # Surface Binned row
      row_labels[[2]],
      surface_scatter_binned_plots[[1]], surface_scatter_binned_plots[[2]], 
      surface_scatter_binned_plots[[3]], surface_scatter_binned_plots[[4]], 
      surface_scatter_binned_plots[[5]], surface_scatter_binned_plots[[6]], 
      surface_scatter_binned_plots[[7]], surface_scatter_binned_plots[[8]],
      
      # Edge Cumulative row
      row_labels[[3]],
      edge_scatter_cumulative_plots[[1]], edge_scatter_cumulative_plots[[2]], 
      edge_scatter_cumulative_plots[[3]], edge_scatter_cumulative_plots[[4]], 
      edge_scatter_cumulative_plots[[5]], edge_scatter_cumulative_plots[[6]], 
      edge_scatter_cumulative_plots[[7]], edge_scatter_cumulative_plots[[8]],
      
      # Edge Binned row
      row_labels[[4]],
      edge_scatter_binned_plots[[1]], edge_scatter_binned_plots[[2]], 
      edge_scatter_binned_plots[[3]], edge_scatter_binned_plots[[4]], 
      edge_scatter_binned_plots[[5]], edge_scatter_binned_plots[[6]], 
      edge_scatter_binned_plots[[7]], edge_scatter_binned_plots[[8]],
      
      ncol = 9, widths = c(0.25, 1, 1, 1, 1, 1, 1, 1, 1)
    ),
    
    # Legend section
    arrangeGrob(
      textGrob("Surface Plot Legend:", gp = gpar(fontsize = 22, fontface = "bold")), 
      surface_legend,
      textGrob("Edge Plot Legend:", gp = gpar(fontsize = 22, fontface = "bold")), 
      edge_legend,
      ncol = 4, widths = c(0.4, 1.3, 0.4, 1.3)
    ),
    
    # Layout adjustment
    nrow = 3,
    heights = c(0.1, 4, 0.5)
  ),
  
  # Overall layout parameters
  heights = c(0.05, 0.95)
)

# Display the complete grid
print(scatter_grid)

# Save to high-resolution image
ggsave("particle_scatter_distribution_comparison.png", scatter_grid, width = 40, height = 20, dpi = 300)
```


### 10.3 Graph Comparison Graphic - Normalized Count

```{r normalized_count_comparison}
# Create a comprehensive comparison grid showing all trials and analysis types with normalized counts
# This normalization makes it easier to compare slopes across different trials
library(tidyverse)
library(gridExtra)
library(grid)

# Define trials in the requested order
trial_order <- c(9, 10, 11, 12, 13, 14)

# Custom theme for consistent appearance with minimal margins
compact_theme <- theme_minimal() +
  theme(
    plot.title = element_blank(),  # Remove individual plot titles
    plot.margin = margin(2, 2, 2, 2, "pt"),  # Minimize plot margins
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    legend.position = "none",
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray95")
  )

# Function to normalize log count data directly
normalize_count_data <- function(data, count_col) {
  data %>%
    mutate(
      # Get the log count values (already in log scale)
      log_count_value = get(count_col),
      
      # Handle invalid values
      log_count_clean = case_when(
        is.na(log_count_value) ~ -Inf,
        is.infinite(log_count_value) & log_count_value < 0 ~ -Inf,
        log_count_value < -10 ~ -Inf,  # Very small log values become -Inf
        TRUE ~ log_count_value
      ),
      
      # Determine if this is cumulative or binned data based on column name
      is_binned = grepl("bin", count_col, ignore.case = TRUE),
      
      # For normalization, we'll work directly with log values
      # Find the range of valid log values
      valid_logs = log_count_clean[is.finite(log_count_clean)],
      min_valid_log = ifelse(length(valid_logs) > 0, min(valid_logs, na.rm = TRUE), 0),
      max_valid_log = ifelse(length(valid_logs) > 0, max(valid_logs, na.rm = TRUE), 0),
      log_range = max_valid_log - min_valid_log,
      
      # Normalize log values to 0-1 range
      normalized_count = case_when(
        !is.finite(log_count_clean) ~ 0,
        log_range == 0 ~ 0.5,  # If all values are the same, set to middle
        TRUE ~ (log_count_clean - min_valid_log) / log_range
      )
    ) %>%
    # Clean up intermediate columns
    select(-log_count_value, -log_count_clean, -is_binned, -valid_logs, 
           -min_valid_log, -max_valid_log, -log_range)
}

# Create lists to store plots
surface_cumulative_norm_plots <- list()
surface_binned_norm_plots <- list()
edge_cumulative_norm_plots <- list()
edge_binned_norm_plots <- list()

# Create logging lists to track missing data
missing_data_log <- list()

# Function to create a fallback plot when NO data is available
create_fallback_plot <- function() {
  ggplot() + 
    annotate("text", x = 2, y = 2, label = "No data available") +
    theme_minimal() +
    theme(plot.margin = margin(2, 2, 2, 2, "pt")) +
    labs(x = expression(log[10](Area)), y = "Normalized Count")
}

# Helper function to check for column names
get_column_name <- function(data, possible_names) {
  for (name in possible_names) {
    if (name %in% names(data)) {
      return(name)
    }
  }
  return(NULL)
}

# Function to log missing data
log_missing_data <- function(trial_num, plot_type, dataset_name, reason) {
  log_entry <- paste0("Trial ", trial_num, " - ", plot_type, " - ", dataset_name, ": ", reason)
  missing_data_log <<- append(missing_data_log, log_entry)
  message(log_entry)
}

# Generate plots for each trial with error handling and normalization
for (i in 1:length(trial_order)) {
  trial_num <- trial_order[i]
  
  # 1. Surface cumulative plots with normalization
  tryCatch({
    # Initialize variables to track successful line additions
    lines_added <- 0
    
    # Base plot for surface cumulative
    p_surf_cum <- ggplot()
    
    # Try to add surface data
    if(exists(paste0("surface_", trial_num))) {
      surface_data <- get(paste0("surface_", trial_num))
      area_col <- get_column_name(surface_data, c("log_area", "Area"))
      count_col <- get_column_name(surface_data, c("log_count", "Count", "Average_Count"))
      
      if (!is.null(area_col) && !is.null(count_col)) {
        surface_norm <- normalize_count_data(surface_data, count_col)
        p_surf_cum <- p_surf_cum + 
          geom_line(data = surface_norm,
                    aes_string(x = area_col, y = "normalized_count"),
                    color = "#D55E00", 
                    linetype = "solid")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Surface Cumulative", "Surface", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Surface Cumulative", "Surface", "Dataset does not exist")
    }
    
    # Try to add witness data
    if(exists(paste0("wit_surface_", trial_num))) {
      witness_data <- get(paste0("wit_surface_", trial_num))
      wit_area_col <- get_column_name(witness_data, c("log_area", "Area"))
      wit_count_col <- get_column_name(witness_data, c("log_count", "Count", "Average_Count"))
      
      if (!is.null(wit_area_col) && !is.null(wit_count_col)) {
        witness_norm <- normalize_count_data(witness_data, wit_count_col)
        p_surf_cum <- p_surf_cum + 
          geom_line(data = witness_norm,
                    aes_string(x = wit_area_col, y = "normalized_count"),
                    color = "#009E73", 
                    linetype = "dashed")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Surface Cumulative", "Witness", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Surface Cumulative", "Witness", "Dataset does not exist")
    }
    
    # Try to add calibration data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("cw_surface_", trial_num))) {
        cw_data <- get(paste0("cw_surface_", trial_num))
        cw_area_col <- get_column_name(cw_data, c("log_area", "Area"))
        cw_count_col <- get_column_name(cw_data, c("log_count", "Count", "Average_Count"))
        
        if (!is.null(cw_area_col) && !is.null(cw_count_col)) {
          cw_norm <- normalize_count_data(cw_data, cw_count_col)
          p_surf_cum <- p_surf_cum +
            geom_line(data = cw_norm,
                      aes_string(x = cw_area_col, y = "normalized_count"),
                      color = "#CC79A7", 
                      linetype = "dotted")
          lines_added <- lines_added + 1
        } else {
          log_missing_data(trial_num, "Surface Cumulative", "Calibration", "Missing required columns")
        }
      } else {
        log_missing_data(trial_num, "Surface Cumulative", "Calibration", "Dataset does not exist")
      }
    }
    
    # Only use fallback if NO lines were added
    if(lines_added == 0) {
      surface_cumulative_norm_plots[[i]] <- create_fallback_plot()
      log_missing_data(trial_num, "Surface Cumulative", "ALL", "No data lines available - using fallback")
    } else {
      # Finalize surface cumulative plot with minimal spacing
      p_surf_cum <- p_surf_cum +
        labs(
          x = expression(log[10](Area)),
          y = "Normalized Count"
        ) +
        compact_theme
      
      surface_cumulative_norm_plots[[i]] <- p_surf_cum
    }
  }, error = function(e) {
    surface_cumulative_norm_plots[[i]] <<- create_fallback_plot()
    log_missing_data(trial_num, "Surface Cumulative", "ERROR", paste("Error occurred:", e$message))
  })
  
  # 2. Surface binned plots with normalization
  tryCatch({
    lines_added <- 0
    p_surf_bin <- ggplot()
    
    # Try to add surface binned data
    if(exists(paste0("surface_", trial_num, "_binned"))) {
      surface_bin_data <- get(paste0("surface_", trial_num, "_binned"))
      bin_area_col <- get_column_name(surface_bin_data, c("log_area", "Area"))
      bin_count_col <- get_column_name(surface_bin_data, c("log_count_bin"))
      
      if (!is.null(bin_area_col) && !is.null(bin_count_col)) {
        surface_bin_norm <- normalize_count_data(surface_bin_data, bin_count_col)
        p_surf_bin <- p_surf_bin + 
          geom_line(data = surface_bin_norm,
                    aes_string(x = bin_area_col, y = "normalized_count"),
                    color = "#D55E00", 
                    linetype = "solid")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Surface Binned", "Surface", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Surface Binned", "Surface", "Dataset does not exist")
    }
    
    # Try to add witness binned data
    if(exists(paste0("wit_surface_", trial_num, "_binned"))) {
      witness_bin_data <- get(paste0("wit_surface_", trial_num, "_binned"))
      wit_bin_area_col <- get_column_name(witness_bin_data, c("log_area", "Area"))
      wit_bin_count_col <- get_column_name(witness_bin_data, c("log_count_bin"))
      
      if (!is.null(wit_bin_area_col) && !is.null(wit_bin_count_col)) {
        witness_bin_norm <- normalize_count_data(witness_bin_data, wit_bin_count_col)
        p_surf_bin <- p_surf_bin + 
          geom_line(data = witness_bin_norm,
                    aes_string(x = wit_bin_area_col, y = "normalized_count"),
                    color = "#009E73", 
                    linetype = "dashed")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Surface Binned", "Witness", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Surface Binned", "Witness", "Dataset does not exist")
    }
    
    # Try to add calibration binned data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("cw_surface_", trial_num, "_binned"))) {
        cw_bin_data <- get(paste0("cw_surface_", trial_num, "_binned"))
        cw_bin_area_col <- get_column_name(cw_bin_data, c("log_area", "Area"))
        cw_bin_count_col <- get_column_name(cw_bin_data, c("log_count_bin"))
        
        if (!is.null(cw_bin_area_col) && !is.null(cw_bin_count_col)) {
          cw_bin_norm <- normalize_count_data(cw_bin_data, cw_bin_count_col)
          p_surf_bin <- p_surf_bin +
            geom_line(data = cw_bin_norm,
                      aes_string(x = cw_bin_area_col, y = "normalized_count"),
                      color = "#CC79A7", 
                      linetype = "dotted")
          lines_added <- lines_added + 1
        } else {
          log_missing_data(trial_num, "Surface Binned", "Calibration", "Missing required columns")
        }
      } else {
        log_missing_data(trial_num, "Surface Binned", "Calibration", "Dataset does not exist")
      }
    }
    
    # Only use fallback if NO lines were added
    if(lines_added == 0) {
      surface_binned_norm_plots[[i]] <- create_fallback_plot()
      log_missing_data(trial_num, "Surface Binned", "ALL", "No data lines available - using fallback")
    } else {
      p_surf_bin <- p_surf_bin +
        labs(
          x = expression(log[10](Area)),
          y = "Normalized Count"
        ) +
        compact_theme
      
      surface_binned_norm_plots[[i]] <- p_surf_bin
    }
  }, error = function(e) {
    surface_binned_norm_plots[[i]] <<- create_fallback_plot()
    log_missing_data(trial_num, "Surface Binned", "ERROR", paste("Error occurred:", e$message))
  })
  
  # 3. Edge cumulative plots with normalization
  tryCatch({
    lines_added <- 0
    p_edge_cum <- ggplot()
    
    # Try to add edge data
    if(exists(paste0("edge_", trial_num))) {
      edge_data <- get(paste0("edge_", trial_num))
      edge_area_col <- get_column_name(edge_data, c("log_area", "Area"))
      edge_count_col <- get_column_name(edge_data, c("log_count", "Count", "Average_Count"))
      
      if (!is.null(edge_area_col) && !is.null(edge_count_col)) {
        edge_norm <- normalize_count_data(edge_data, edge_count_col)
        p_edge_cum <- p_edge_cum + 
          geom_line(data = edge_norm,
                    aes_string(x = edge_area_col, y = "normalized_count"),
                    color = "#CC79A7", 
                    linetype = "solid")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Edge Cumulative", "Edge", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Edge Cumulative", "Edge", "Dataset does not exist")
    }
    
    # Try to add cw_edge data
    if(exists(paste0("cw_edge_", trial_num))) {
      cw_edge_data <- get(paste0("cw_edge_", trial_num))
      cw_edge_area_col <- get_column_name(cw_edge_data, c("log_area", "Area"))
      cw_edge_count_col <- get_column_name(cw_edge_data, c("log_count", "Count", "Average_Count"))
      
      if (!is.null(cw_edge_area_col) && !is.null(cw_edge_count_col)) {
        cw_edge_norm <- normalize_count_data(cw_edge_data, cw_edge_count_col)
        p_edge_cum <- p_edge_cum + 
          geom_line(data = cw_edge_norm,
                    aes_string(x = cw_edge_area_col, y = "normalized_count"),
                    color = "#0072B2", 
                    linetype = "dashed")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Edge Cumulative", "CW_Edge", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Edge Cumulative", "CW_Edge", "Dataset does not exist")
    }
    
    # Try to add model_edge data
    if(exists(paste0("model_edge_", trial_num))) {
      model_edge_data <- get(paste0("model_edge_", trial_num))
      model_edge_area_col <- get_column_name(model_edge_data, c("log_area", "Area"))
      model_edge_count_col <- get_column_name(model_edge_data, c("log_count", "Count", "Average_Count"))
      
      if (!is.null(model_edge_area_col) && !is.null(model_edge_count_col)) {
        model_edge_norm <- normalize_count_data(model_edge_data, model_edge_count_col)
        p_edge_cum <- p_edge_cum + 
          geom_line(data = model_edge_norm,
                    aes_string(x = model_edge_area_col, y = "normalized_count"),
                    color = "#009E73", 
                    linetype = "dotted")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Edge Cumulative", "Model_Edge", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Edge Cumulative", "Model_Edge", "Dataset does not exist")
    }
    
    # Try to add SSLSM_edge data
    if(exists(paste0("SSLSM_edge_", trial_num))) {
      SSLSM_edge_data <- get(paste0("SSLSM_edge_", trial_num))
      SSLSM_edge_area_col <- get_column_name(SSLSM_edge_data, c("log_area", "Area"))
      SSLSM_edge_count_col <- get_column_name(SSLSM_edge_data, c("log_count", "Count", "Average_Count", "Cumulative_Count"))
      
      if (!is.null(SSLSM_edge_area_col) && !is.null(SSLSM_edge_count_col)) {
        SSLSM_edge_norm <- normalize_count_data(SSLSM_edge_data, SSLSM_edge_count_col)
        p_edge_cum <- p_edge_cum + 
          geom_line(data = SSLSM_edge_norm,
                    aes_string(x = SSLSM_edge_area_col, y = "normalized_count"),
                    color = "#D55E00", 
                    linetype = "dotdash")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Edge Cumulative", "SSLSM_Edge", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Edge Cumulative", "SSLSM_Edge", "Dataset does not exist")
    }
    
    # Try to add WSLSM_edge data
    if(exists(paste0("WSLSM_edge_", trial_num))) {
      WSLSM_edge_data <- get(paste0("WSLSM_edge_", trial_num))
      WSLSM_edge_area_col <- get_column_name(WSLSM_edge_data, c("log_area", "Area"))
      WSLSM_edge_count_col <- get_column_name(WSLSM_edge_data, c("log_count", "Count", "Average_Count", "Cumulative_Count"))
      
      if (!is.null(WSLSM_edge_area_col) && !is.null(WSLSM_edge_count_col)) {
        WSLSM_edge_norm <- normalize_count_data(WSLSM_edge_data, WSLSM_edge_count_col)
        p_edge_cum <- p_edge_cum + 
          geom_line(data = WSLSM_edge_norm,
                    aes_string(x = WSLSM_edge_area_col, y = "normalized_count"),
                    color = "#56B4E9", 
                    linetype = "longdash")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Edge Cumulative", "WSLSM_Edge", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Edge Cumulative", "WSLSM_Edge", "Dataset does not exist")
    }
    
    # Try to add calibration SLSM data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("CSLSM_edge_", trial_num))) {
        CSLSM_edge_data <- get(paste0("CSLSM_edge_", trial_num))
        CSLSM_edge_area_col <- get_column_name(CSLSM_edge_data, c("log_area", "Area"))
        CSLSM_edge_count_col <- get_column_name(CSLSM_edge_data, c("log_count", "Count", "Average_Count", "Cumulative_Count"))
        
        if (!is.null(CSLSM_edge_area_col) && !is.null(CSLSM_edge_count_col)) {
          CSLSM_edge_norm <- normalize_count_data(CSLSM_edge_data, CSLSM_edge_count_col)
          p_edge_cum <- p_edge_cum +
            geom_line(data = CSLSM_edge_norm,
                      aes_string(x = CSLSM_edge_area_col, y = "normalized_count"),
                      color = "#F0E442", 
                      linetype = "twodash")
          lines_added <- lines_added + 1
        } else {
          log_missing_data(trial_num, "Edge Cumulative", "CSLSM_Edge", "Missing required columns")
        }
      } else {
        log_missing_data(trial_num, "Edge Cumulative", "CSLSM_Edge", "Dataset does not exist")
      }
    }
    
    # Only use fallback if NO lines were added
    if(lines_added == 0) {
      edge_cumulative_norm_plots[[i]] <- create_fallback_plot()
      log_missing_data(trial_num, "Edge Cumulative", "ALL", "No data lines available - using fallback")
    } else {
      p_edge_cum <- p_edge_cum +
        labs(
          x = expression(log[10](Area)),
          y = "Normalized Count"
        ) +
        compact_theme
      
      edge_cumulative_norm_plots[[i]] <- p_edge_cum
    }
  }, error = function(e) {
    edge_cumulative_norm_plots[[i]] <<- create_fallback_plot()
    log_missing_data(trial_num, "Edge Cumulative", "ERROR", paste("Error occurred:", e$message))
  })
  
  # 4. Edge binned plots with normalization
  tryCatch({
    lines_added <- 0
    p_edge_bin <- ggplot()
    
    # Try to add edge binned data
    if(exists(paste0("edge_", trial_num, "_binned"))) {
      edge_bin_data <- get(paste0("edge_", trial_num, "_binned"))
      edge_bin_area_col <- get_column_name(edge_bin_data, c("log_area", "Area"))
      edge_bin_count_col <- get_column_name(edge_bin_data, c("log_count_bin"))
      
      if (!is.null(edge_bin_area_col) && !is.null(edge_bin_count_col)) {
        edge_bin_norm <- normalize_count_data(edge_bin_data, edge_bin_count_col)
        p_edge_bin <- p_edge_bin + 
          geom_line(data = edge_bin_norm,
                    aes_string(x = edge_bin_area_col, y = "normalized_count"),
                    color = "#CC79A7", 
                    linetype = "solid")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Edge Binned", "Edge", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Edge Binned", "Edge", "Dataset does not exist")
    }
    
    # Try to add cw_edge binned data
    if(exists(paste0("cw_edge_", trial_num, "_binned"))) {
      cw_edge_bin_data <- get(paste0("cw_edge_", trial_num, "_binned"))
      cw_edge_bin_area_col <- get_column_name(cw_edge_bin_data, c("log_area", "Area"))
      cw_edge_bin_count_col <- get_column_name(cw_edge_bin_data, c("log_count_bin"))
      
      if (!is.null(cw_edge_bin_area_col) && !is.null(cw_edge_bin_count_col)) {
        cw_edge_bin_norm <- normalize_count_data(cw_edge_bin_data, cw_edge_bin_count_col)
        p_edge_bin <- p_edge_bin + 
          geom_line(data = cw_edge_bin_norm,
                    aes_string(x = cw_edge_bin_area_col, y = "normalized_count"),
                    color = "#0072B2", 
                    linetype = "dashed")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Edge Binned", "CW_Edge", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Edge Binned", "CW_Edge", "Dataset does not exist")
    }
    
    # Try to add model_edge binned data
    if(exists(paste0("model_edge_", trial_num, "_binned"))) {
      model_edge_bin_data <- get(paste0("model_edge_", trial_num, "_binned"))
      model_edge_bin_area_col <- get_column_name(model_edge_bin_data, c("log_area", "Area"))
      model_edge_bin_count_col <- get_column_name(model_edge_bin_data, c("log_count_bin"))
      
      if (!is.null(model_edge_bin_area_col) && !is.null(model_edge_bin_count_col)) {
        model_edge_bin_norm <- normalize_count_data(model_edge_bin_data, model_edge_bin_count_col)
        p_edge_bin <- p_edge_bin + 
          geom_line(data = model_edge_bin_norm,
                    aes_string(x = model_edge_bin_area_col, y = "normalized_count"),
                    color = "#009E73", 
                    linetype = "dotted")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Edge Binned", "Model_Edge", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Edge Binned", "Model_Edge", "Dataset does not exist")
    }
    
    # Try to add SSLSM_edge binned data
    if(exists(paste0("SSLSM_edge_", trial_num, "_binned"))) {
      SSLSM_edge_bin_data <- get(paste0("SSLSM_edge_", trial_num, "_binned"))
      SSLSM_edge_bin_area_col <- get_column_name(SSLSM_edge_bin_data, c("log_area", "Area"))
      SSLSM_edge_bin_count_col <- get_column_name(SSLSM_edge_bin_data, c("log_count_bin"))
      
      if (!is.null(SSLSM_edge_bin_area_col) && !is.null(SSLSM_edge_bin_count_col)) {
        SSLSM_edge_bin_norm <- normalize_count_data(SSLSM_edge_bin_data, SSLSM_edge_bin_count_col)
        p_edge_bin <- p_edge_bin + 
          geom_line(data = SSLSM_edge_bin_norm,
                    aes_string(x = SSLSM_edge_bin_area_col, y = "normalized_count"),
                    color = "#D55E00", 
                    linetype = "dotdash")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Edge Binned", "SSLSM_Edge", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Edge Binned", "SSLSM_Edge", "Dataset does not exist")
    }
    
    # Try to add WSLSM_edge binned data
    if(exists(paste0("WSLSM_edge_", trial_num, "_binned"))) {
      WSLSM_edge_bin_data <- get(paste0("WSLSM_edge_", trial_num, "_binned"))
      WSLSM_edge_bin_area_col <- get_column_name(WSLSM_edge_bin_data, c("log_area", "Area"))
      WSLSM_edge_bin_count_col <- get_column_name(WSLSM_edge_bin_data, c("log_count_bin"))
      
      if (!is.null(WSLSM_edge_bin_area_col) && !is.null(WSLSM_edge_bin_count_col)) {
        WSLSM_edge_bin_norm <- normalize_count_data(WSLSM_edge_bin_data, WSLSM_edge_bin_count_col)
        p_edge_bin <- p_edge_bin + 
          geom_line(data = WSLSM_edge_bin_norm,
                    aes_string(x = WSLSM_edge_bin_area_col, y = "normalized_count"),
                    color = "#56B4E9", 
                    linetype = "longdash")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Edge Binned", "WSLSM_Edge", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Edge Binned", "WSLSM_Edge", "Dataset does not exist")
    }
    
    # Try to add calibration SLSM binned data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("CSLSM_edge_", trial_num, "_binned"))) {
        CSLSM_edge_bin_data <- get(paste0("CSLSM_edge_", trial_num, "_binned"))
        CSLSM_edge_bin_area_col <- get_column_name(CSLSM_edge_bin_data, c("log_area", "Area"))
        CSLSM_edge_bin_count_col <- get_column_name(CSLSM_edge_bin_data, c("log_count_bin"))
        
        if (!is.null(CSLSM_edge_bin_area_col) && !is.null(CSLSM_edge_bin_count_col)) {
          CSLSM_edge_bin_norm <- normalize_count_data(CSLSM_edge_bin_data, CSLSM_edge_bin_count_col)
          p_edge_bin <- p_edge_bin +
            geom_line(data = CSLSM_edge_bin_norm,
                      aes_string(x = CSLSM_edge_bin_area_col, y = "normalized_count"),
                      color = "#F0E442", 
                      linetype = "twodash")
          lines_added <- lines_added + 1
        } else {
          log_missing_data(trial_num, "Edge Binned", "CSLSM_Edge", "Missing required columns")
        }
      } else {
        log_missing_data(trial_num, "Edge Binned", "CSLSM_Edge", "Dataset does not exist")
      }
    }
    
    # Only use fallback if NO lines were added
    if(lines_added == 0) {
      edge_binned_norm_plots[[i]] <- create_fallback_plot()
      log_missing_data(trial_num, "Edge Binned", "ALL", "No data lines available - using fallback")
    } else {
      p_edge_bin <- p_edge_bin +
        labs(
          x = expression(log[10](Area)),
          y = "Normalized Count"
        ) +
        compact_theme
      
      edge_binned_norm_plots[[i]] <- p_edge_bin
    }
  }, error = function(e) {
    edge_binned_norm_plots[[i]] <<- create_fallback_plot()
    log_missing_data(trial_num, "Edge Binned", "ERROR", paste("Error occurred:", e$message))
  })
}

# Add the average plots with normalization and logging
# Surface cumulative average
tryCatch({
  lines_added_avg <- 0
  lines_added_air <- 0
  
  surface_avg_cum_norm_plot <- ggplot()
  surface_avg_air_cum_norm_plot <- ggplot()
  
  # Try standard average data
  if(exists("surface_average")) {
    s_avg_area_col <- get_column_name(surface_average, c("log_area", "Area"))
    s_avg_count_col <- get_column_name(surface_average, c("log_count", "Count", "Average_Count"))
    
    if (!is.null(s_avg_area_col) && !is.null(s_avg_count_col)) {
      surface_avg_norm <- normalize_count_data(surface_average, s_avg_count_col)
      surface_avg_cum_norm_plot <- surface_avg_cum_norm_plot +
        geom_line(data = surface_avg_norm,
                  aes_string(x = s_avg_area_col, y = "normalized_count"),
                  color = "#D55E00", 
                  linetype = "solid")
      lines_added_avg <- lines_added_avg + 1
    } else {
      log_missing_data("Average", "Surface Cumulative", "Surface", "Missing required columns")
    }
  } else {
    log_missing_data("Average", "Surface Cumulative", "Surface", "Dataset does not exist")
  }
  
  if(exists("wit_surface_average")) {
    wit_avg_area_col <- get_column_name(wit_surface_average, c("log_area", "Area"))
    wit_avg_count_col <- get_column_name(wit_surface_average, c("log_count", "Count", "Average_Count"))
    
    if (!is.null(wit_avg_area_col) && !is.null(wit_avg_count_col)) {
      wit_avg_norm <- normalize_count_data(wit_surface_average, wit_avg_count_col)
      surface_avg_cum_norm_plot <- surface_avg_cum_norm_plot +
        geom_line(data = wit_avg_norm,
                  aes_string(x = wit_avg_area_col, y = "normalized_count"),
                  color = "#009E73", 
                  linetype = "dashed")
      lines_added_avg <- lines_added_avg + 1
    } else {
      log_missing_data("Average", "Surface Cumulative", "Witness", "Missing required columns")
    }
  } else {
    log_missing_data("Average", "Surface Cumulative", "Witness", "Dataset does not exist")
  }
  
  if(exists("cw_surface_average")) {
    cw_avg_area_col <- get_column_name(cw_surface_average, c("log_area", "Area"))
    cw_avg_count_col <- get_column_name(cw_surface_average, c("log_count", "Count", "Average_Count"))
    
    if (!is.null(cw_avg_area_col) && !is.null(cw_avg_count_col)) {
      cw_avg_norm <- normalize_count_data(cw_surface_average, cw_avg_count_col)
      surface_avg_cum_norm_plot <- surface_avg_cum_norm_plot +
        geom_line(data = cw_avg_norm,
                  aes_string(x = cw_avg_area_col, y = "normalized_count"),
                  color = "#CC79A7", 
                  linetype = "dotted")
      lines_added_avg <- lines_added_avg + 1
    } else {
      log_missing_data("Average", "Surface Cumulative", "Calibration", "Missing required columns")
    }
  } else {
    log_missing_data("Average", "Surface Cumulative", "Calibration", "Dataset does not exist")
  }
  
  # Try air average data
  if(exists("surface_average_air")) {
    s_avg_air_area_col <- get_column_name(surface_average_air, c("log_area", "Area"))
    s_avg_air_count_col <- get_column_name(surface_average_air, c("log_count", "Count", "Average_Count"))
    
    if (!is.null(s_avg_air_area_col) && !is.null(s_avg_air_count_col)) {
      surface_avg_air_norm <- normalize_count_data(surface_average_air, s_avg_air_count_col)
      surface_avg_air_cum_norm_plot <- surface_avg_air_cum_norm_plot +
        geom_line(data = surface_avg_air_norm,
                  aes_string(x = s_avg_air_area_col, y = "normalized_count"),
                  color = "#D55E00", 
                  linetype = "solid")
      lines_added_air <- lines_added_air + 1
    } else {
      log_missing_data("Air Average", "Surface Cumulative", "Surface", "Missing required columns")
    }
  } else {
    log_missing_data("Air Average", "Surface Cumulative", "Surface", "Dataset does not exist")
  }
  
  if(exists("wit_surface_average_air")) {
    wit_avg_air_area_col <- get_column_name(wit_surface_average_air, c("log_area", "Area"))
    wit_avg_air_count_col <- get_column_name(wit_surface_average_air, c("log_count", "Count", "Average_Count"))
    
    if (!is.null(wit_avg_air_area_col) && !is.null(wit_avg_air_count_col)) {
      wit_avg_air_norm <- normalize_count_data(wit_surface_average_air, wit_avg_air_count_col)
      surface_avg_air_cum_norm_plot <- surface_avg_air_cum_norm_plot +
        geom_line(data = wit_avg_air_norm,
                  aes_string(x = wit_avg_air_area_col, y = "normalized_count"),
                  color = "#009E73", 
                  linetype = "dashed")
      lines_added_air <- lines_added_air + 1
    } else {
      log_missing_data("Air Average", "Surface Cumulative", "Witness", "Missing required columns")
    }
  } else {
    log_missing_data("Air Average", "Surface Cumulative", "Witness", "Dataset does not exist")
  }
  
  if(exists("cw_surface_average_air")) {
    cw_avg_air_area_col <- get_column_name(cw_surface_average_air, c("log_area", "Area"))
    cw_avg_air_count_col <- get_column_name(cw_surface_average_air, c("log_count", "Count", "Average_Count"))
    
    if (!is.null(cw_avg_air_area_col) && !is.null(cw_avg_air_count_col)) {
      cw_avg_air_norm <- normalize_count_data(cw_surface_average_air, cw_avg_air_count_col)
      surface_avg_air_cum_norm_plot <- surface_avg_air_cum_norm_plot +
        geom_line(data = cw_avg_air_norm,
                  aes_string(x = cw_avg_air_area_col, y = "normalized_count"),
                  color = "#CC79A7", 
                  linetype = "dotted")
      lines_added_air <- lines_added_air + 1
    } else {
      log_missing_data("Air Average", "Surface Cumulative", "Calibration", "Missing required columns")
    }
  } else {
    log_missing_data("Air Average", "Surface Cumulative", "Calibration", "Dataset does not exist")
  }
  
  # Finalize plots or use fallback
  if(lines_added_avg == 0) {
    surface_cumulative_norm_plots[[length(trial_order) + 1]] <- create_fallback_plot()
    log_missing_data("Average", "Surface Cumulative", "ALL", "No data lines available - using fallback")
  } else {
    surface_avg_cum_norm_plot <- surface_avg_cum_norm_plot +
      labs(
        x = expression(log[10](Area)),
        y = "Normalized Count"
      ) +
      compact_theme
    surface_cumulative_norm_plots[[length(trial_order) + 1]] <- surface_avg_cum_norm_plot
  }
  
  if(lines_added_air == 0) {
    surface_cumulative_norm_plots[[length(trial_order) + 2]] <- create_fallback_plot()
    log_missing_data("Air Average", "Surface Cumulative", "ALL", "No data lines available - using fallback")
  } else {
    surface_avg_air_cum_norm_plot <- surface_avg_air_cum_norm_plot +
      labs(
        x = expression(log[10](Area)),
        y = "Normalized Count"
      ) +
      compact_theme
    surface_cumulative_norm_plots[[length(trial_order) + 2]] <- surface_avg_air_cum_norm_plot
  }
}, error = function(e) {
  surface_cumulative_norm_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  surface_cumulative_norm_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  log_missing_data("Average", "Surface Cumulative", "ERROR", paste("Error occurred:", e$message))
})

# Surface binned average with normalization and logging
tryCatch({
  lines_added_avg <- 0
  lines_added_air <- 0
  
  surface_avg_bin_norm_plot <- ggplot()
  surface_avg_air_bin_norm_plot <- ggplot()
  
  # Try standard average binned data
  if(exists("surface_average_binned")) {
    s_avg_bin_area_col <- get_column_name(surface_average_binned, c("log_area", "Area"))
    s_avg_bin_count_col <- get_column_name(surface_average_binned, c("log_count_bin"))
    
    if (!is.null(s_avg_bin_area_col) && !is.null(s_avg_bin_count_col)) {
      surface_avg_bin_norm <- normalize_count_data(surface_average_binned, s_avg_bin_count_col)
      surface_avg_bin_norm_plot <- surface_avg_bin_norm_plot +
        geom_line(data = surface_avg_bin_norm,
                  aes_string(x = s_avg_bin_area_col, y = "normalized_count"),
                  color = "#D55E00", 
                  linetype = "solid")
      lines_added_avg <- lines_added_avg + 1
    } else {
      log_missing_data("Average", "Surface Binned", "Surface", "Missing required columns")
    }
  } else {
    log_missing_data("Average", "Surface Binned", "Surface", "Dataset does not exist")
  }
  
  if(exists("wit_surface_average_binned")) {
    wit_avg_bin_area_col <- get_column_name(wit_surface_average_binned, c("log_area", "Area"))
    wit_avg_bin_count_col <- get_column_name(wit_surface_average_binned, c("log_count_bin"))
    
    if (!is.null(wit_avg_bin_area_col) && !is.null(wit_avg_bin_count_col)) {
      wit_avg_bin_norm <- normalize_count_data(wit_surface_average_binned, wit_avg_bin_count_col)
      surface_avg_bin_norm_plot <- surface_avg_bin_norm_plot +
        geom_line(data = wit_avg_bin_norm,
                  aes_string(x = wit_avg_bin_area_col, y = "normalized_count"),
                  color = "#009E73", 
                  linetype = "dashed")
      lines_added_avg <- lines_added_avg + 1
    } else {
      log_missing_data("Average", "Surface Binned", "Witness", "Missing required columns")
    }
  } else {
    log_missing_data("Average", "Surface Binned", "Witness", "Dataset does not exist")
  }
  
  if(exists("cw_surface_average_binned")) {
    cw_avg_bin_area_col <- get_column_name(cw_surface_average_binned, c("log_area", "Area"))
    cw_avg_bin_count_col <- get_column_name(cw_surface_average_binned, c("log_count_bin"))
    
    if (!is.null(cw_avg_bin_area_col) && !is.null(cw_avg_bin_count_col)) {
      cw_avg_bin_norm <- normalize_count_data(cw_surface_average_binned, cw_avg_bin_count_col)
      surface_avg_bin_norm_plot <- surface_avg_bin_norm_plot +
        geom_line(data = cw_avg_bin_norm,
                  aes_string(x = cw_avg_bin_area_col, y = "normalized_count"),
                  color = "#CC79A7", 
                  linetype = "dotted")
      lines_added_avg <- lines_added_avg + 1
    } else {
      log_missing_data("Average", "Surface Binned", "Calibration", "Missing required columns")
    }
  } else {
    log_missing_data("Average", "Surface Binned", "Calibration", "Dataset does not exist")
  }
  
  # Try air average binned data
  if(exists("surface_average_air_binned")) {
    s_avg_air_bin_area_col <- get_column_name(surface_average_air_binned, c("log_area", "Area"))
    s_avg_air_bin_count_col <- get_column_name(surface_average_air_binned, c("log_count_bin"))
    
    if (!is.null(s_avg_air_bin_area_col) && !is.null(s_avg_air_bin_count_col)) {
      surface_avg_air_bin_norm <- normalize_count_data(surface_average_air_binned, s_avg_air_bin_count_col)
      surface_avg_air_bin_norm_plot <- surface_avg_air_bin_norm_plot +
        geom_line(data = surface_avg_air_bin_norm,
                  aes_string(x = s_avg_air_bin_area_col, y = "normalized_count"),
                  color = "#D55E00", 
                  linetype = "solid")
      lines_added_air <- lines_added_air + 1
    } else {
      log_missing_data("Air Average", "Surface Binned", "Surface", "Missing required columns")
    }
  } else {
    log_missing_data("Air Average", "Surface Binned", "Surface", "Dataset does not exist")
  }
  
  if(exists("wit_surface_average_air_binned")) {
    wit_avg_air_bin_area_col <- get_column_name(wit_surface_average_air_binned, c("log_area", "Area"))
    wit_avg_air_bin_count_col <- get_column_name(wit_surface_average_air_binned, c("log_count_bin"))
    
    if (!is.null(wit_avg_air_bin_area_col) && !is.null(wit_avg_air_bin_count_col)) {
      wit_avg_air_bin_norm <- normalize_count_data(wit_surface_average_air_binned, wit_avg_air_bin_count_col)
      surface_avg_air_bin_norm_plot <- surface_avg_air_bin_norm_plot +
        geom_line(data = wit_avg_air_bin_norm,
                  aes_string(x = wit_avg_air_bin_area_col, y = "normalized_count"),
                  color = "#009E73", 
                  linetype = "dashed")
      lines_added_air <- lines_added_air + 1
    } else {
      log_missing_data("Air Average", "Surface Binned", "Witness", "Missing required columns")
    }
  } else {
    log_missing_data("Air Average", "Surface Binned", "Witness", "Dataset does not exist")
  }
  
  if(exists("cw_surface_average_air_binned")) {
    cw_avg_air_bin_area_col <- get_column_name(cw_surface_average_air_binned, c("log_area", "Area"))
    cw_avg_air_bin_count_col <- get_column_name(cw_surface_average_air_binned, c("log_count_bin"))
    
    if (!is.null(cw_avg_air_bin_area_col) && !is.null(cw_avg_air_bin_count_col)) {
      cw_avg_air_bin_norm <- normalize_count_data(cw_surface_average_air_binned, cw_avg_air_bin_count_col)
      surface_avg_air_bin_norm_plot <- surface_avg_air_bin_norm_plot +
        geom_line(data = cw_avg_air_bin_norm,
                  aes_string(x = cw_avg_air_bin_area_col, y = "normalized_count"),
                  color = "#CC79A7", 
                  linetype = "dotted")
      lines_added_air <- lines_added_air + 1
    } else {
      log_missing_data("Air Average", "Surface Binned", "Calibration", "Missing required columns")
    }
  } else {
    log_missing_data("Air Average", "Surface Binned", "Calibration", "Dataset does not exist")
  }
  
  # Finalize plots or use fallback
  if(lines_added_avg == 0) {
    surface_binned_norm_plots[[length(trial_order) + 1]] <- create_fallback_plot()
    log_missing_data("Average", "Surface Binned", "ALL", "No data lines available - using fallback")
  } else {
    surface_avg_bin_norm_plot <- surface_avg_bin_norm_plot +
      labs(
        x = expression(log[10](Area)),
        y = "Normalized Count"
      ) +
      compact_theme
    surface_binned_norm_plots[[length(trial_order) + 1]] <- surface_avg_bin_norm_plot
  }
  
  if(lines_added_air == 0) {
    surface_binned_norm_plots[[length(trial_order) + 2]] <- create_fallback_plot()
    log_missing_data("Air Average", "Surface Binned", "ALL", "No data lines available - using fallback")
  } else {
    surface_avg_air_bin_norm_plot <- surface_avg_air_bin_norm_plot +
      labs(
        x = expression(log[10](Area)),
        y = "Normalized Count"
      ) +
      compact_theme
    surface_binned_norm_plots[[length(trial_order) + 2]] <- surface_avg_air_bin_norm_plot
  }
}, error = function(e) {
  surface_binned_norm_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  surface_binned_norm_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  log_missing_data("Average", "Surface Binned", "ERROR", paste("Error occurred:", e$message))
})

# Edge cumulative average with normalization and logging
tryCatch({
  lines_added_avg <- 0
  lines_added_air <- 0
  
  edge_avg_cum_norm_plot <- ggplot()
  edge_avg_air_cum_norm_plot <- ggplot()
  
  # Try standard average data for edge cumulative
  edge_datasets <- list(
    list(name = "edge_average", color = "#CC79A7", linetype = "solid", label = "Edge"),
    list(name = "cw_edge_average", color = "#0072B2", linetype = "dashed", label = "CW_Edge"),
    list(name = "model_edge_average", color = "#009E73", linetype = "dotted", label = "Model_Edge"),
    list(name = "SSLSM_edge_average", color = "#D55E00", linetype = "dotdash", label = "SSLSM_Edge"),
    list(name = "WSLSM_edge_average", color = "#56B4E9", linetype = "longdash", label = "WSLSM_Edge"),
    list(name = "CSLSM_edge_average", color = "#F0E442", linetype = "twodash", label = "CSLSM_Edge")
  )
  
  edge_air_datasets <- list(
    list(name = "edge_average_air", color = "#CC79A7", linetype = "solid", label = "Edge"),
    list(name = "cw_edge_average_air", color = "#0072B2", linetype = "dashed", label = "CW_Edge"),
    list(name = "model_edge_average_air", color = "#009E73", linetype = "dotted", label = "Model_Edge"),
    list(name = "SSLSM_edge_average_air", color = "#D55E00", linetype = "dotdash", label = "SSLSM_Edge"),
    list(name = "WSLSM_edge_average_air", color = "#56B4E9", linetype = "longdash", label = "WSLSM_Edge"),
    list(name = "CSLSM_edge_average_air", color = "#F0E442", linetype = "twodash", label = "CSLSM_Edge")
  )
  
  # Process standard average datasets
  for(dataset in edge_datasets) {
    if(exists(dataset$name)) {
      data <- get(dataset$name)
      area_col <- get_column_name(data, c("log_area", "Area"))
      count_col <- get_column_name(data, c("log_count", "Count", "Average_Count"))
      
      if (!is.null(area_col) && !is.null(count_col)) {
        data_norm <- normalize_count_data(data, count_col)
        edge_avg_cum_norm_plot <- edge_avg_cum_norm_plot +
          geom_line(data = data_norm,
                    aes_string(x = area_col, y = "normalized_count"),
                    color = dataset$color, 
                    linetype = dataset$linetype)
        lines_added_avg <- lines_added_avg + 1
      } else {
        log_missing_data("Average", "Edge Cumulative", dataset$label, "Missing required columns")
      }
    } else {
      log_missing_data("Average", "Edge Cumulative", dataset$label, "Dataset does not exist")
    }
  }
  
  # Process air average datasets
  for(dataset in edge_air_datasets) {
    if(exists(dataset$name)) {
      data <- get(dataset$name)
      area_col <- get_column_name(data, c("log_area", "Area"))
      count_col <- get_column_name(data, c("log_count", "Count", "Average_Count"))
      
      if (!is.null(area_col) && !is.null(count_col)) {
        data_norm <- normalize_count_data(data, count_col)
        edge_avg_air_cum_norm_plot <- edge_avg_air_cum_norm_plot +
          geom_line(data = data_norm,
                    aes_string(x = area_col, y = "normalized_count"),
                    color = dataset$color, 
                    linetype = dataset$linetype)
        lines_added_air <- lines_added_air + 1
      } else {
        log_missing_data("Air Average", "Edge Cumulative", dataset$label, "Missing required columns")
      }
    } else {
      log_missing_data("Air Average", "Edge Cumulative", dataset$label, "Dataset does not exist")
    }
  }
  
  # Finalize plots or use fallback
  if(lines_added_avg == 0) {
    edge_cumulative_norm_plots[[length(trial_order) + 1]] <- create_fallback_plot()
    log_missing_data("Average", "Edge Cumulative", "ALL", "No data lines available - using fallback")
  } else {
    edge_avg_cum_norm_plot <- edge_avg_cum_norm_plot +
      labs(
        x = expression(log[10](Area)),
        y = "Normalized Count"
      ) +
      compact_theme
    edge_cumulative_norm_plots[[length(trial_order) + 1]] <- edge_avg_cum_norm_plot
  }
  
  if(lines_added_air == 0) {
    edge_cumulative_norm_plots[[length(trial_order) + 2]] <- create_fallback_plot()
    log_missing_data("Air Average", "Edge Cumulative", "ALL", "No data lines available - using fallback")
  } else {
    edge_avg_air_cum_norm_plot <- edge_avg_air_cum_norm_plot +
      labs(
        x = expression(log[10](Area)),
        y = "Normalized Count"
      ) +
      compact_theme
    edge_cumulative_norm_plots[[length(trial_order) + 2]] <- edge_avg_air_cum_norm_plot
  }
}, error = function(e) {
  edge_cumulative_norm_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  edge_cumulative_norm_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  log_missing_data("Average", "Edge Cumulative", "ERROR", paste("Error occurred:", e$message))
})

# Edge binned average with normalization and logging
tryCatch({
  lines_added_avg <- 0
  lines_added_air <- 0
  
  edge_avg_bin_norm_plot <- ggplot()
  edge_avg_air_bin_norm_plot <- ggplot()
  
  # Define datasets for edge binned average
  edge_bin_datasets <- list(
    list(name = "edge_average_binned", color = "#CC79A7", linetype = "solid", label = "Edge"),
    list(name = "cw_edge_average_binned", color = "#0072B2", linetype = "dashed", label = "CW_Edge"),
    list(name = "model_edge_average_binned", color = "#009E73", linetype = "dotted", label = "Model_Edge"),
    list(name = "SSLSM_edge_average_binned", color = "#D55E00", linetype = "dotdash", label = "SSLSM_Edge"),
    list(name = "WSLSM_edge_average_binned", color = "#56B4E9", linetype = "longdash", label = "WSLSM_Edge"),
    list(name = "CSLSM_edge_average_binned", color = "#F0E442", linetype = "twodash", label = "CSLSM_Edge")
  )
  
  edge_air_bin_datasets <- list(
    list(name = "edge_average_air_binned", color = "#CC79A7", linetype = "solid", label = "Edge"),
    list(name = "cw_edge_average_air_binned", color = "#0072B2", linetype = "dashed", label = "CW_Edge"),
    list(name = "model_edge_average_air_binned", color = "#009E73", linetype = "dotted", label = "Model_Edge"),
    list(name = "SSLSM_edge_average_air_binned", color = "#D55E00", linetype = "dotdash", label = "SSLSM_Edge"),
    list(name = "WSLSM_edge_average_air_binned", color = "#56B4E9", linetype = "longdash", label = "WSLSM_Edge"),
    list(name = "CSLSM_edge_average_air_binned", color = "#F0E442", linetype = "twodash", label = "CSLSM_Edge")
  )
  
  # Process standard average binned datasets
  for(dataset in edge_bin_datasets) {
    if(exists(dataset$name)) {
      data <- get(dataset$name)
      area_col <- get_column_name(data, c("log_area", "Area"))
      count_col <- get_column_name(data, c("log_count_bin"))
      
      if (!is.null(area_col) && !is.null(count_col)) {
        data_norm <- normalize_count_data(data, count_col)
        edge_avg_bin_norm_plot <- edge_avg_bin_norm_plot +
          geom_line(data = data_norm,
                    aes_string(x = area_col, y = "normalized_count"),
                    color = dataset$color, 
                    linetype = dataset$linetype)
        lines_added_avg <- lines_added_avg + 1
      } else {
        log_missing_data("Average", "Edge Binned", dataset$label, "Missing required columns")
      }
    } else {
      log_missing_data("Average", "Edge Binned", dataset$label, "Dataset does not exist")
    }
  }
  
  # Process air average binned datasets
  for(dataset in edge_air_bin_datasets) {
    if(exists(dataset$name)) {
      data <- get(dataset$name)
      area_col <- get_column_name(data, c("log_area", "Area"))
      count_col <- get_column_name(data, c("log_count_bin"))
      
      if (!is.null(area_col) && !is.null(count_col)) {
        data_norm <- normalize_count_data(data, count_col)
        edge_avg_air_bin_norm_plot <- edge_avg_air_bin_norm_plot +
          geom_line(data = data_norm,
                    aes_string(x = area_col, y = "normalized_count"),
                    color = dataset$color, 
                    linetype = dataset$linetype)
        lines_added_air <- lines_added_air + 1
      } else {
        log_missing_data("Air Average", "Edge Binned", dataset$label, "Missing required columns")
      }
    } else {
      log_missing_data("Air Average", "Edge Binned", dataset$label, "Dataset does not exist")
    }
  }
  
  # Finalize plots or use fallback
  if(lines_added_avg == 0) {
    edge_binned_norm_plots[[length(trial_order) + 1]] <- create_fallback_plot()
    log_missing_data("Average", "Edge Binned", "ALL", "No data lines available - using fallback")
  } else {
    edge_avg_bin_norm_plot <- edge_avg_bin_norm_plot +
      labs(
        x = expression(log[10](Area)),
        y = "Normalized Count"
      ) +
      compact_theme
    edge_binned_norm_plots[[length(trial_order) + 1]] <- edge_avg_bin_norm_plot
  }
  
  if(lines_added_air == 0) {
    edge_binned_norm_plots[[length(trial_order) + 2]] <- create_fallback_plot()
    log_missing_data("Air Average", "Edge Binned", "ALL", "No data lines available - using fallback")
  } else {
    edge_avg_air_bin_norm_plot <- edge_avg_air_bin_norm_plot +
      labs(
        x = expression(log[10](Area)),
        y = "Normalized Count"
      ) +
      compact_theme
    edge_binned_norm_plots[[length(trial_order) + 2]] <- edge_avg_air_bin_norm_plot
  }
}, error = function(e) {
  edge_binned_norm_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  edge_binned_norm_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  log_missing_data("Average", "Edge Binned", "ERROR", paste("Error occurred:", e$message))
})

# Print comprehensive missing data log
cat("\n=== MISSING DATA LOG ===\n")
cat("Total missing data entries:", length(missing_data_log), "\n\n")
if(length(missing_data_log) > 0) {
  for(i in 1:length(missing_data_log)) {
    cat(paste0(i, ". ", missing_data_log[[i]], "\n"))
  }
} else {
  cat("No missing data detected - all datasets loaded successfully!\n")
}
cat("\n========================\n")

# Create standalone legend grobs for surface and edge plots
surface_legend <- grobTree(
  # Starshade
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#D55E00", lty = "solid", lwd = 4)),
  textGrob("Starshade", x = unit(0.5, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Witness
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#009E73", lty = "dashed", lwd = 4)),
  textGrob("Witness", x = unit(0.5, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Calibration
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#CC79A7", lty = "dotted", lwd = 4)),
  textGrob("Calibration", x = unit(0.5, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20))
)

# Edge legend (more complex with 6 items)
edge_legend <- grobTree(
  # First column
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#CC79A7", lty = "solid", lwd = 4)),
  textGrob("Starshade Observed", x = unit(0.3, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#0072B2", lty = "dashed", lwd = 4)),
  textGrob("Calibration Observed", x = unit(0.3, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#009E73", lty = "dotted", lwd = 4)),
  textGrob("Model", x = unit(0.3, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Second column
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#D55E00", lty = "dotdash", lwd = 4)),
  textGrob("SLSM Starshade", x = unit(0.8, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#56B4E9", lty = "longdash", lwd = 4)),
  textGrob("SLSM Witness", x = unit(0.8, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#F0E442", lty = "twodash", lwd = 4)),
  textGrob("SLSM Calibration", x = unit(0.8, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20))
)

# Create column and row labels with consistent formatting
col_labels <- c(
  lapply(trial_order, function(t) textGrob(paste("Trial", t), gp = gpar(fontsize = 22, fontface = "bold"))),
  list(
    textGrob("Average", gp = gpar(fontsize = 22, fontface = "bold")),
    textGrob("Air Average", gp = gpar(fontsize = 22, fontface = "bold"))
  )
)

row_labels <- list(
  textGrob("Surface\nCumulative", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Surface\nBinned", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Edge\nCumulative", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Edge\nBinned", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90)
)

# Assemble the complete grid layout
complete_grid <- grid.arrange(
  # Main title 
  textGrob("Comprehensive Particle Distribution Analysis Across Trials - Normalized Counts", 
           gp = gpar(fontsize = 36, fontface = "bold"), y = 0.7),
  
  # Main grid
  grid.arrange(
    # Column labels
    arrangeGrob(
      nullGrob(), 
      col_labels[[1]], col_labels[[2]], col_labels[[3]], col_labels[[4]], 
      col_labels[[5]], col_labels[[6]], col_labels[[7]], col_labels[[8]],
      ncol = 9, widths = c(0.25, 1, 1, 1, 1, 1, 1, 1, 1),
      heights = unit(0.2, "cm")
    ),
    
    # Main plot grid with row labels
    arrangeGrob(
      # Surface Cumulative row
      row_labels[[1]],
      surface_cumulative_norm_plots[[1]], surface_cumulative_norm_plots[[2]], 
      surface_cumulative_norm_plots[[3]], surface_cumulative_norm_plots[[4]], 
      surface_cumulative_norm_plots[[5]], surface_cumulative_norm_plots[[6]], 
      surface_cumulative_norm_plots[[7]], surface_cumulative_norm_plots[[8]],
      
      # Surface Binned row
      row_labels[[2]],
      surface_binned_norm_plots[[1]], surface_binned_norm_plots[[2]], 
      surface_binned_norm_plots[[3]], surface_binned_norm_plots[[4]], 
      surface_binned_norm_plots[[5]], surface_binned_norm_plots[[6]], 
      surface_binned_norm_plots[[7]], surface_binned_norm_plots[[8]],
      
      # Edge Cumulative row
      row_labels[[3]],
      edge_cumulative_norm_plots[[1]], edge_cumulative_norm_plots[[2]], 
      edge_cumulative_norm_plots[[3]], edge_cumulative_norm_plots[[4]], 
      edge_cumulative_norm_plots[[5]], edge_cumulative_norm_plots[[6]], 
      edge_cumulative_norm_plots[[7]], edge_cumulative_norm_plots[[8]],
      
      # Edge Binned row
      row_labels[[4]],
      edge_binned_norm_plots[[1]], edge_binned_norm_plots[[2]], 
      edge_binned_norm_plots[[3]], edge_binned_norm_plots[[4]], 
      edge_binned_norm_plots[[5]], edge_binned_norm_plots[[6]], 
      edge_binned_norm_plots[[7]], edge_binned_norm_plots[[8]],
      
      ncol = 9, widths = c(0.25, 1, 1, 1, 1, 1, 1, 1, 1)
    ),
    
    # Legend section
    arrangeGrob(
      textGrob("Surface Plot Legend:", gp = gpar(fontsize = 22, fontface = "bold")), 
      surface_legend,
      textGrob("Edge Plot Legend:", gp = gpar(fontsize = 22, fontface = "bold")), 
      edge_legend,
      ncol = 4, widths = c(0.4, 1.3, 0.4, 1.3)
    ),
    
    # Layout adjustment
    nrow = 3,
    heights = c(0.1, 4, 0.5)
  ),
  
  # Overall layout parameters
  heights = c(0.05, 0.95)
)

# Display the complete grid
print(complete_grid)

# Save to high-resolution image
ggsave("particle_distribution_comparison_normalized.png", complete_grid, width = 40, height = 20, dpi = 300)
```

### 10.4 Normalized Scatter Graph
```{r normalized_scatter_graph}
# MISSING INITIALIZATION CODE - Add this before your existing code
library(tidyverse)
library(gridExtra)
library(grid)

# Define trials in the requested order
trial_order <- c(9, 10, 11, 12, 13, 14)

# Custom theme for consistent appearance with minimal margins
compact_theme <- theme_minimal() +
  theme(
    plot.title = element_blank(),  # Remove individual plot titles
    plot.margin = margin(2, 2, 2, 2, "pt"),  # Minimize plot margins
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    legend.position = "none",
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray95")
  )

# Function to normalize scatter data directly
normalize_scatter_data <- function(data, scatter_col) {
  data %>%
    mutate(
      # Get the scatter values
      scatter_value = get(scatter_col),
      
      # Handle invalid values
      scatter_clean = case_when(
        is.na(scatter_value) ~ 0,
        is.infinite(scatter_value) & scatter_value < 0 ~ 0,
        scatter_value < 0 ~ 0,  # Negative scatter values become 0
        TRUE ~ scatter_value
      ),
      
      # For normalization, find the range of valid scatter values
      valid_scatters = scatter_clean[is.finite(scatter_clean) & scatter_clean > 0],
      min_valid_scatter = ifelse(length(valid_scatters) > 0, min(valid_scatters, na.rm = TRUE), 0),
      max_valid_scatter = ifelse(length(valid_scatters) > 0, max(valid_scatters, na.rm = TRUE), 1),
      scatter_range = max_valid_scatter - min_valid_scatter,
      
      # Normalize scatter values to 0-1 range
      normalized_scatter = case_when(
        !is.finite(scatter_clean) | scatter_clean <= 0 ~ 0,
        scatter_range == 0 ~ 0.5,  # If all values are the same, set to middle
        TRUE ~ (scatter_clean - min_valid_scatter) / scatter_range
      )
    ) %>%
    # Clean up intermediate columns
    select(-scatter_value, -scatter_clean, -valid_scatters, 
           -min_valid_scatter, -max_valid_scatter, -scatter_range)
}

# Create lists to store plots
surface_scatter_cumulative_norm_plots <- list()
surface_scatter_binned_norm_plots <- list()
edge_scatter_cumulative_norm_plots <- list()
edge_scatter_binned_norm_plots <- list()

# Create logging lists to track missing data
missing_data_log <- list()

# Function to create a fallback plot when NO data is available
create_fallback_plot <- function() {
  ggplot() + 
    annotate("text", x = 2, y = 2, label = "No data available") +
    theme_minimal() +
    theme(plot.margin = margin(2, 2, 2, 2, "pt")) +
    labs(x = expression(log[10](Area)), y = "Normalized Scatter")
}

# Helper function to check for column names
get_column_name <- function(data, possible_names) {
  for (name in possible_names) {
    if (name %in% names(data)) {
      return(name)
    }
  }
  return(NULL)
}

# Function to log missing data
log_missing_data <- function(trial_num, plot_type, dataset_name, reason) {
  log_entry <- paste0("Trial ", trial_num, " - ", plot_type, " - ", dataset_name, ": ", reason)
  missing_data_log <<- append(missing_data_log, log_entry)
  message(log_entry)
}

# Generate plots for each trial with error handling and normalization
for (i in 1:length(trial_order)) {
  trial_num <- trial_order[i]
  
  # 1. Surface cumulative scatter plots with normalization
  tryCatch({
    lines_added <- 0
    p_surf_cum <- ggplot()
    
    # Try to add surface data
    if(exists(paste0("surface_", trial_num))) {
      surface_data <- get(paste0("surface_", trial_num))
      area_col <- get_column_name(surface_data, c("log_area", "Area"))
      scatter_col <- get_column_name(surface_data, c("Average_Scatter"))
      
      if (!is.null(area_col) && !is.null(scatter_col)) {
        surface_norm <- normalize_scatter_data(surface_data, scatter_col)
        p_surf_cum <- p_surf_cum + 
          geom_line(data = surface_norm,
                    aes_string(x = area_col, y = "normalized_scatter"),
                    color = "#D55E00", 
                    linetype = "solid")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Surface Cumulative Scatter", "Surface", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Surface Cumulative Scatter", "Surface", "Dataset does not exist")
    }
    
    # Try to add witness data
    if(exists(paste0("wit_surface_", trial_num))) {
      witness_data <- get(paste0("wit_surface_", trial_num))
      wit_area_col <- get_column_name(witness_data, c("log_area", "Area"))
      wit_scatter_col <- get_column_name(witness_data, c("Average_Scatter"))
      
      if (!is.null(wit_area_col) && !is.null(wit_scatter_col)) {
        witness_norm <- normalize_scatter_data(witness_data, wit_scatter_col)
        p_surf_cum <- p_surf_cum +
          geom_line(data = witness_norm,
                    aes_string(x = wit_area_col, y = "normalized_scatter"),
                    color = "#009E73", 
                    linetype = "dashed")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Surface Cumulative Scatter", "Witness", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Surface Cumulative Scatter", "Witness", "Dataset does not exist")
    }
    
    # Try to add calibration data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("cw_surface_", trial_num))) {
        cw_data <- get(paste0("cw_surface_", trial_num))
        cw_area_col <- get_column_name(cw_data, c("log_area", "Area"))
        cw_scatter_col <- get_column_name(cw_data, c("Average_Scatter"))
        
        if (!is.null(cw_area_col) && !is.null(cw_scatter_col)) {
          cw_norm <- normalize_scatter_data(cw_data, cw_scatter_col)
          p_surf_cum <- p_surf_cum +
            geom_line(data = cw_norm,
                      aes_string(x = cw_area_col, y = "normalized_scatter"),
                      color = "#CC79A7", 
                      linetype = "dotted")
          lines_added <- lines_added + 1
        } else {
          log_missing_data(trial_num, "Surface Cumulative Scatter", "Calibration", "Missing required columns")
        }
      } else {
        log_missing_data(trial_num, "Surface Cumulative Scatter", "Calibration", "Dataset does not exist")
      }
    }
    
    # Only use fallback if NO lines were added
    if(lines_added == 0) {
      surface_scatter_cumulative_norm_plots[[i]] <- create_fallback_plot()
      log_missing_data(trial_num, "Surface Cumulative Scatter", "ALL", "No data lines available - using fallback")
    } else {
      # Finalize surface cumulative plot with minimal spacing
      p_surf_cum <- p_surf_cum +
        labs(
          x = expression(log[10](Area)),
          y = "Normalized Scatter"
        ) +
        compact_theme
      
      surface_scatter_cumulative_norm_plots[[i]] <- p_surf_cum
    }
  }, error = function(e) {
    surface_scatter_cumulative_norm_plots[[i]] <<- create_fallback_plot()
    log_missing_data(trial_num, "Surface Cumulative Scatter", "ERROR", paste("Error occurred:", e$message))
  })
  
  # 2. Surface binned scatter plots with normalization
  tryCatch({
    lines_added <- 0
    p_surf_bin <- ggplot()
    
    # Try to add surface binned data
    if(exists(paste0("surface_", trial_num, "_binned"))) {
      surface_bin_data <- get(paste0("surface_", trial_num, "_binned"))
      bin_area_col <- get_column_name(surface_bin_data, c("log_area", "Area"))
      bin_scatter_col <- get_column_name(surface_bin_data, c("Average_Scatter"))
      
      if (!is.null(bin_area_col) && !is.null(bin_scatter_col)) {
        surface_bin_norm <- normalize_scatter_data(surface_bin_data, bin_scatter_col)
        p_surf_bin <- p_surf_bin + 
          geom_line(data = surface_bin_norm,
                    aes_string(x = bin_area_col, y = "normalized_scatter"),
                    color = "#D55E00", 
                    linetype = "solid")
        lines_added <- lines_added + 1
      } else {
        log_missing_data(trial_num, "Surface Binned Scatter", "Surface", "Missing required columns")
      }
    } else {
      log_missing_data(trial_num, "Surface Binned Scatter", "Surface", "Dataset does not exist")
    }
    
    # Similar pattern for witness and calibration binned data...
    # (Add similar blocks for witness and calibration binned data)
    
    # Only use fallback if NO lines were added
    if(lines_added == 0) {
      surface_scatter_binned_norm_plots[[i]] <- create_fallback_plot()
      log_missing_data(trial_num, "Surface Binned Scatter", "ALL", "No data lines available - using fallback")
    } else {
      p_surf_bin <- p_surf_bin +
        labs(
          x = expression(log[10](Area)),
          y = "Normalized Scatter"
        ) +
        compact_theme
      
      surface_scatter_binned_norm_plots[[i]] <- p_surf_bin
    }
  }, error = function(e) {
    surface_scatter_binned_norm_plots[[i]] <<- create_fallback_plot()
    log_missing_data(trial_num, "Surface Binned Scatter", "ERROR", paste("Error occurred:", e$message))
  })
  
  # 3. Edge cumulative scatter plots with normalization
  tryCatch({
    lines_added <- 0
    p_edge_cum <- ggplot()
    
    # Try to add edge data - this will likely have different dataset naming patterns
    # You'll need to adjust these names based on your actual data structure
    
    # Only use fallback if NO lines were added
    if(lines_added == 0) {
      edge_scatter_cumulative_norm_plots[[i]] <- create_fallback_plot()
      log_missing_data(trial_num, "Edge Cumulative Scatter", "ALL", "No data lines available - using fallback")
    } else {
      p_edge_cum <- p_edge_cum +
        labs(
          x = expression(log[10](Area)),
          y = "Normalized Scatter"
        ) +
        compact_theme
      
      edge_scatter_cumulative_norm_plots[[i]] <- p_edge_cum
    }
  }, error = function(e) {
    edge_scatter_cumulative_norm_plots[[i]] <<- create_fallback_plot()
    log_missing_data(trial_num, "Edge Cumulative Scatter", "ERROR", paste("Error occurred:", e$message))
  })
  
  # 4. Edge binned scatter plots with normalization
  tryCatch({
    lines_added <- 0
    p_edge_bin <- ggplot()
    
    # Try to add edge binned data - adjust based on your data structure
    
    # Only use fallback if NO lines were added
    if(lines_added == 0) {
      edge_scatter_binned_norm_plots[[i]] <- create_fallback_plot()
      log_missing_data(trial_num, "Edge Binned Scatter", "ALL", "No data lines available - using fallback")
    } else {
      p_edge_bin <- p_edge_bin +
        labs(
          x = expression(log[10](Area)),
          y = "Normalized Scatter"
        ) +
        compact_theme
      
      edge_scatter_binned_norm_plots[[i]] <- p_edge_bin
    }
  }, error = function(e) {
    edge_scatter_binned_norm_plots[[i]] <<- create_fallback_plot()
    log_missing_data(trial_num, "Edge Binned Scatter", "ERROR", paste("Error occurred:", e$message))
  })
}

# Add average plots (simplified - you can expand based on your data)
# Add 2 more plots for averages to each list
for(plot_list_name in c("surface_scatter_cumulative_norm_plots", "surface_scatter_binned_norm_plots",
                        "edge_scatter_cumulative_norm_plots", "edge_scatter_binned_norm_plots")) {
  current_list <- get(plot_list_name)
  # Add two fallback plots for the averages (you can replace with actual average plots)
  current_list[[length(trial_order) + 1]] <- create_fallback_plot()
  current_list[[length(trial_order) + 2]] <- create_fallback_plot()
  assign(plot_list_name, current_list)
}

# Print summary of missing data
if(length(missing_data_log) > 0) {
  cat("Summary of missing data:\n")
  for(entry in missing_data_log) {
    cat(entry, "\n")
  }
  cat("\n")
}

# NOW YOUR ORIGINAL CODE CAN RUN:
# Function to ensure plot lists have the correct length
ensure_plot_list_length <- function(plot_list, required_length) {
  current_length <- length(plot_list)
  if (current_length < required_length) {
    # Add fallback plots for missing elements
    for (i in (current_length + 1):required_length) {
      plot_list[[i]] <- create_fallback_plot()
    }
  }
  return(plot_list)
}

# Calculate the required length (6 trials + 2 averages)
required_length <- length(trial_order) + 2

# Ensure all plot lists have the correct length before creating the grid
surface_scatter_cumulative_norm_plots <- ensure_plot_list_length(surface_scatter_cumulative_norm_plots, required_length)
surface_scatter_binned_norm_plots <- ensure_plot_list_length(surface_scatter_binned_norm_plots, required_length)
edge_scatter_cumulative_norm_plots <- ensure_plot_list_length(edge_scatter_cumulative_norm_plots, required_length)
edge_scatter_binned_norm_plots <- ensure_plot_list_length(edge_scatter_binned_norm_plots, required_length)

# Function to ensure plot lists have the correct length
ensure_plot_list_length <- function(plot_list, required_length) {
  current_length <- length(plot_list)
  if (current_length < required_length) {
    # Add fallback plots for missing elements
    for (i in (current_length + 1):required_length) {
      plot_list[[i]] <- create_fallback_plot()
    }
  }
  return(plot_list)
}

# Calculate the required length (6 trials + 2 averages)
required_length <- length(trial_order) + 2

# Ensure all plot lists have the correct length before creating the grid
surface_scatter_cumulative_norm_plots <- ensure_plot_list_length(surface_scatter_cumulative_norm_plots, required_length)
surface_scatter_binned_norm_plots <- ensure_plot_list_length(surface_scatter_binned_norm_plots, required_length)
edge_scatter_cumulative_norm_plots <- ensure_plot_list_length(edge_scatter_cumulative_norm_plots, required_length)
edge_scatter_binned_norm_plots <- ensure_plot_list_length(edge_scatter_binned_norm_plots, required_length)

# Print lengths for debugging
cat("Plot list lengths:\n")
cat("Surface cumulative:", length(surface_scatter_cumulative_norm_plots), "\n")
cat("Surface binned:", length(surface_scatter_binned_norm_plots), "\n")
cat("Edge cumulative:", length(edge_scatter_cumulative_norm_plots), "\n")
cat("Edge binned:", length(edge_scatter_binned_norm_plots), "\n")
cat("Required length:", required_length, "\n\n")

# Create column and row labels with consistent formatting
col_labels <- c(
  lapply(trial_order, function(t) textGrob(paste("Trial", t), gp = gpar(fontsize = 22, fontface = "bold"))),
  list(
    textGrob("Average", gp = gpar(fontsize = 22, fontface = "bold")),
    textGrob("Air Average", gp = gpar(fontsize = 22, fontface = "bold"))
  )
)

row_labels <- list(
  textGrob("Surface\nCumulative\nScatter", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Surface\nBinned\nScatter", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Edge\nCumulative\nScatter", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Edge\nBinned\nScatter", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90)
)

# Create standalone legend grobs for surface and edge plots
surface_legend <- grobTree(
  # Starshade
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#D55E00", lty = "solid", lwd = 4)),
  textGrob("Starshade", x = unit(0.5, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Witness
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#009E73", lty = "dashed", lwd = 4)),
  textGrob("Witness", x = unit(0.5, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Calibration
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#CC79A7", lty = "dotted", lwd = 4)),
  textGrob("Calibration", x = unit(0.5, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20))
)

# Edge legend (more complex with 5 items)
edge_legend <- grobTree(
  # First column
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#CC79A7", lty = "solid", lwd = 4)),
  textGrob("Starshade Observed", x = unit(0.3, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#0072B2", lty = "dashed", lwd = 4)),
  textGrob("Calibration Observed", x = unit(0.3, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Second column
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#D55E00", lty = "dotdash", lwd = 4)),
  textGrob("SLSM Starshade", x = unit(0.8, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#56B4E9", lty = "longdash", lwd = 4)),
  textGrob("SLSM Witness", x = unit(0.8, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#F0E442", lty = "twodash", lwd = 4)),
  textGrob("SLSM Calibration", x = unit(0.8, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20))
)

# Wrap the grid creation in a tryCatch block for better error handling
tryCatch({
  # Assemble the complete grid layout
  scatter_grid <- grid.arrange(
    # Main title 
    textGrob("Comprehensive Particle Scatter Distribution Analysis Across Trials - Normalized Scatter", 
             gp = gpar(fontsize = 36, fontface = "bold"), y = 0.7),
    
    # Main grid
    grid.arrange(
      # Column labels
      arrangeGrob(
        nullGrob(), 
        col_labels[[1]], col_labels[[2]], col_labels[[3]], col_labels[[4]], 
        col_labels[[5]], col_labels[[6]], col_labels[[7]], col_labels[[8]],
        ncol = 9, widths = c(0.25, 1, 1, 1, 1, 1, 1, 1, 1),
        heights = unit(0.2, "cm")
      ),
      
      # Main plot grid with row labels
      arrangeGrob(
        # Surface Cumulative row
        row_labels[[1]],
        surface_scatter_cumulative_norm_plots[[1]], surface_scatter_cumulative_norm_plots[[2]], 
        surface_scatter_cumulative_norm_plots[[3]], surface_scatter_cumulative_norm_plots[[4]], 
        surface_scatter_cumulative_norm_plots[[5]], surface_scatter_cumulative_norm_plots[[6]], 
        surface_scatter_cumulative_norm_plots[[7]], surface_scatter_cumulative_norm_plots[[8]],
        
        # Surface Binned row
        row_labels[[2]],
        surface_scatter_binned_norm_plots[[1]], surface_scatter_binned_norm_plots[[2]], 
        surface_scatter_binned_norm_plots[[3]], surface_scatter_binned_norm_plots[[4]], 
        surface_scatter_binned_norm_plots[[5]], surface_scatter_binned_norm_plots[[6]], 
        surface_scatter_binned_norm_plots[[7]], surface_scatter_binned_norm_plots[[8]],
        
        # Edge Cumulative row
        row_labels[[3]],
        edge_scatter_cumulative_norm_plots[[1]], edge_scatter_cumulative_norm_plots[[2]], 
        edge_scatter_cumulative_norm_plots[[3]], edge_scatter_cumulative_norm_plots[[4]], 
        edge_scatter_cumulative_norm_plots[[5]], edge_scatter_cumulative_norm_plots[[6]], 
        edge_scatter_cumulative_norm_plots[[7]], edge_scatter_cumulative_norm_plots[[8]],
        
        # Edge Binned row
        row_labels[[4]],
        edge_scatter_binned_norm_plots[[1]], edge_scatter_binned_norm_plots[[2]], 
        edge_scatter_binned_norm_plots[[3]], edge_scatter_binned_norm_plots[[4]], 
        edge_scatter_binned_norm_plots[[5]], edge_scatter_binned_norm_plots[[6]], 
        edge_scatter_binned_norm_plots[[7]], edge_scatter_binned_norm_plots[[8]],
        
        ncol = 9, widths = c(0.25, 1, 1, 1, 1, 1, 1, 1, 1)
      ),
      
      # Legend section
      arrangeGrob(
        textGrob("Surface Plot Legend:", gp = gpar(fontsize = 22, fontface = "bold")), 
        surface_legend,
        textGrob("Edge Plot Legend:", gp = gpar(fontsize = 22, fontface = "bold")), 
        edge_legend,
        ncol = 4, widths = c(0.4, 1.3, 0.4, 1.3)
      ),
      
      # Layout adjustment
      nrow = 3,
      heights = c(0.1, 4, 0.5)
    ),
    
    # Overall layout parameters
    heights = c(0.05, 0.95)
  )
  
  # Display the complete grid
  print(scatter_grid)
  
  # Save to high-resolution image
  ggsave("particle_scatter_distribution_comparison_normalized.png", scatter_grid, width = 40, height = 20, dpi = 300)
  
  cat("Grid created successfully!\n")
  
}, error = function(e) {
  cat("Error creating grid:", e$message, "\n")
  cat("Debugging information:\n")
  cat("Surface cumulative plots length:", length(surface_scatter_cumulative_norm_plots), "\n")
  cat("Surface binned plots length:", length(surface_scatter_binned_norm_plots), "\n")
  cat("Edge cumulative plots length:", length(edge_scatter_cumulative_norm_plots), "\n")
  cat("Edge binned plots length:", length(edge_scatter_binned_norm_plots), "\n")
  
  # Try to create a simpler fallback grid
  cat("Attempting to create fallback grid...\n")
  
  # Create simple fallback grid with available plots
  max_plots <- min(length(surface_scatter_cumulative_norm_plots),
                   length(surface_scatter_binned_norm_plots),
                   length(edge_scatter_cumulative_norm_plots),
                   length(edge_scatter_binned_norm_plots))
  
  if(max_plots > 0) {
    simple_grid <- grid.arrange(
      surface_scatter_cumulative_norm_plots[[1]],
      surface_scatter_binned_norm_plots[[1]],
      edge_scatter_cumulative_norm_plots[[1]],
      edge_scatter_binned_norm_plots[[1]],
      ncol = 2, nrow = 2,
      top = "Simplified Scatter Plot Grid"
    )
    print(simple_grid)
  } else {
    cat("No plots available for fallback grid.\n")
  }
})
```

## 11. Combined Analysis and Comparison

<!-- This section combines and compares all analyses to validate the edge contamination model -->

### 11.1 Cumulative Comparison

```{r combined_cumulative graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = surface_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = surface_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = surface_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = surface_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = surface_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis: \n Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

# Plot the cumulative distribution of witness data
ggplot() +
  geom_line(data = wit_surface_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = wit_surface_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = wit_surface_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = wit_surface_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = wit_surface_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = wit_surface_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Witness Surface Analysis: \n Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

# Plot the cumulative starshade edge distributions
ggplot() +
  geom_line(data = edge_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = edge_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = edge_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis: \n Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

# Plot the cumulative calibration edge distributions
ggplot() +
  geom_line(data = cw_edge_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = cw_edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = cw_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = cw_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = cw_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis: \n Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

# Plot the cumulative model edge distributions
ggplot() +
  geom_line(data = model_edge_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = model_edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = model_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = model_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = model_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Model Edge Analysis: \n Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

# Plot the cumulative starshade edge distributions
ggplot() +
  geom_line(data = SSLSM_edge_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = SSLSM_edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = SSLSM_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = SSLSM_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = SSLSM_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "SLSM Starshade Edge Analysis: \n Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

# Plot the cumulative witness edge distributions
ggplot() +
    geom_line(data = CSLSM_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = CSLSM_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
  geom_line(data = CSLSM_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "SLSM Calibration Edge Analysis: \n Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme


# Plot the cumulative witness edge distributions
ggplot() +
  geom_line(data = WSLSM_edge_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = WSLSM_edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = WSLSM_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = WSLSM_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = WSLSM_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
  geom_line(data = WSLSM_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "SLSM Witness Edge Analysis: \n Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

```

### 11.2 Binned Comparison

```{r combined_binned graphs}
# Plot the Binned distribution of Surface data
ggplot() +
  geom_line(data = surface_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = surface_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = surface_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = surface_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = surface_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = surface_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis: \n Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

# Plot the Binned distribution of witness data
ggplot() +
  geom_line(data = wit_surface_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = wit_surface_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = wit_surface_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = wit_surface_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = wit_surface_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = wit_surface_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Witness Surface Analysis: \n Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

# Plot the Binned starshade edge distributions
ggplot() +
  geom_line(data = edge_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis: \n Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

# Plot the Binned calibration edge distributions
ggplot() +
  geom_line(data = cw_edge_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = cw_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = cw_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = cw_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = cw_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis: \n Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

# Plot the Binned model edge distributions
ggplot() +
  geom_line(data = model_edge_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = model_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = model_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = model_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = model_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Model Edge Analysis: \n Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

# Plot the Binned starshade edge distributions
ggplot() +
  geom_line(data = SSLSM_edge_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = SSLSM_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = SSLSM_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = SSLSM_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = SSLSM_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "SLSM Starshade Edge Analysis: \n Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

# Plot the Binned witness edge distributions
ggplot() +
    geom_line(data = CSLSM_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = CSLSM_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
  geom_line(data = CSLSM_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "SLSM Calibration Edge Analysis: \n Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme


# Plot the Binned witness edge distributions
ggplot() +
  geom_line(data = WSLSM_edge_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = WSLSM_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = WSLSM_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = WSLSM_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = WSLSM_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
  geom_line(data = WSLSM_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "SLSM Witness Edge Analysis: \n Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Blue(Solid): Trial 9, Navy Blue(Dashed): Trial 10, Green(Dotted): Trial 11,\n Orange(Dot-Dash): Trial 12, Purple(LongDash): Trial 13, Yellow(twodash): Trial 14"
  ) +
  custom_theme

```

## 12. Multiple Line analysis

```{r Multiple_line_analysis, include=FALSE, echo = FALSE, eval=FALSE}
# This section simulates drawing a line across surfaces and analyzes how particles intersect with it
# Expanded to cover trials 9, 12, 13, 14 and all three surfaces: starshade, calibration, and witness

# Define trials to analyze
trials_to_analyze <- c(9, 12, 13, 14)

# Calculate image dimensions for positioning
image_width <- 600  
image_height <- 450 

# Define line positions for edge simulation
lines <- c(10, 50, 100, 130, 185, 225, 290, 320, 350, 380)

# Function to check if a particle intersects with a horizontal line and calculate overhang area
particle_intersects_line <- function(particle, line_y) {
  # Check for missing values in required fields
  if (is.na(particle$BY) || is.na(particle$Height) || is.na(particle$Area) || 
      particle$Height <= 0 || particle$Area <= 0) {
    return(list(intersects = FALSE))
  }
  
  # Calculate the top and bottom boundaries of the particle
  particle_top <- particle$BY + particle$Height
  particle_bottom <- particle$BY 
  
  # Check for missing values in calculated positions
  if (is.na(particle_top) || is.na(particle_bottom)) {
    return(list(intersects = FALSE))
  }
  
  # Check if the line passes through the particle
  if (line_y <= particle_top && line_y >= particle_bottom) {
    # Calculate proportion of area that would overhang
    proportion_above_line <- (particle_top - line_y) / particle$Height
    
    # Calculate the area that would overhang the edge (below the line)
    overhang_area <- particle$Area * (proportion_above_line)
    
    # Additional safety checks
    if (is.na(proportion_above_line) || is.na(overhang_area)) {
      return(list(intersects = FALSE))
    }
    
    # Return intersection details
    return(list(
      intersects = TRUE,
      area = as.numeric(particle$Area),
      overhang_proportion = as.numeric(proportion_above_line),
      overhang_area = as.numeric(overhang_area),
      diameter = 2 * sqrt(particle$Area / pi),
      distance_from_line = min(abs(line_y - particle_top), abs(particle_bottom - line_y)),
      relative_position = (line_y - particle_bottom) / particle$Height
    ))
  } else {
    return(list(intersects = FALSE))
  }
}

# Function to analyze intersections for a single line
analyze_line_intersections <- function(particles_data, line_positions = NULL) {
  if (is.null(line_positions)) {
    line_positions <- image_height / 2
  }
  
  # Check if particles_data is empty or has no rows
  if (is.null(particles_data) || nrow(particles_data) == 0) {
    # Return empty results for all line positions
    all_results <- list()
    for (i in 1:length(line_positions)) {
      all_results[[i]] <- list(
        line_position = line_positions[i],
        num_intersections = 0,
        intersecting_particles = list(),
        total_area = 0,
        overhang_area = 0,
        size_data = tibble(area = numeric(0), diameter = numeric(0), overhang_prop = numeric(0))
      )
    }
    return(all_results)
  }
  
  all_results <- list()
  
  for (i in 1:length(line_positions)) {
    line_y <- line_positions[i]
    
    # Use tryCatch to handle any remaining errors in individual particle processing
    intersections <- tryCatch({
      map(1:nrow(particles_data), function(j) {
        particle_intersects_line(particles_data[j,], line_y)
      })
    }, error = function(e) {
      cat("Error processing particles for line", i, ":", e$message, "\n")
      return(list())
    })
    
    # Filter to only intersecting particles, with additional safety check
    intersecting_particles <- tryCatch({
      intersections[sapply(intersections, function(x) {
        !is.null(x) && is.list(x) && !is.null(x$intersects) && x$intersects == TRUE
      })]
    }, error = function(e) {
      cat("Error filtering intersections for line", i, ":", e$message, "\n")
      return(list())
    })
    
    if (length(intersecting_particles) > 0) {
      all_results[[i]] <- list(
        line_position = line_y,
        num_intersections = length(intersecting_particles),
        intersecting_particles = intersecting_particles,
        total_area = sum(sapply(intersecting_particles, function(x) x$area), na.rm = TRUE),
        overhang_area = sum(sapply(intersecting_particles, function(x) x$overhang_area), na.rm = TRUE),
        size_data = tibble(
          area = sapply(intersecting_particles, function(x) x$area),
          diameter = sapply(intersecting_particles, function(x) x$diameter),
          overhang_prop = sapply(intersecting_particles, function(x) x$overhang_proportion)
        )
      )
    } else {
      all_results[[i]] <- list(
        line_position = line_y,
        num_intersections = 0,
        intersecting_particles = list(),
        total_area = 0,
        overhang_area = 0,
        size_data = tibble(area = numeric(0), diameter = numeric(0), overhang_prop = numeric(0))
      )
    }
  }
  
  return(all_results)
}

# Function to process results to dataframe
process_results_to_df <- function(results_list, source_name, time_label, trial_number) {
  # Initialize empty list to store all dataframes
  result_dfs <- list()
  
  for (i in seq_along(results_list)) {
    result <- results_list[[i]]
    
    if (length(result$intersecting_particles) > 0) {
      # Process each intersecting particle individually to avoid data type conflicts
      particle_dfs <- list()
      
      for (j in seq_along(result$intersecting_particles)) {
        particle <- result$intersecting_particles[[j]]
        
        # Create a single-row dataframe for this particle
        particle_df <- data.frame(
          intersects = TRUE,  # Always TRUE for intersecting particles
          area = as.numeric(particle$area),
          overhang_proportion = as.numeric(particle$overhang_proportion),
          overhang_area = as.numeric(particle$overhang_area),
          diameter = as.numeric(particle$diameter),
          distance_from_line = as.numeric(particle$distance_from_line),
          relative_position = as.numeric(particle$relative_position),
          source = source_name,
          time = time_label,
          Trial = trial_number,
          line_index = i,
          stringsAsFactors = FALSE
        )
        
        particle_dfs[[j]] <- particle_df
      }
      
      # Combine all particles for this line
      if (length(particle_dfs) > 0) {
        result_dfs[[i]] <- bind_rows(particle_dfs)
      }
    }
    # If no intersecting particles, we don't add anything to result_dfs for this line
  }
  
  # Combine all results, return empty dataframe if no results
  if (length(result_dfs) > 0) {
    return(bind_rows(result_dfs))
  } else {
    # Return empty dataframe with correct structure
    return(data.frame(
      intersects = logical(0),
      area = numeric(0),
      overhang_proportion = numeric(0),
      overhang_area = numeric(0),
      diameter = numeric(0),
      distance_from_line = numeric(0),
      relative_position = numeric(0),
      source = character(0),
      time = character(0),
      Trial = character(0),
      line_index = numeric(0),
      stringsAsFactors = FALSE
    ))
  }
}

# Initialize storage for all results
all_starshade_sim_before <- list()
all_starshade_sim_after <- list()
all_calibration_sim_before <- list()
all_calibration_sim_after <- list()
all_witness_sim_before <- list()
all_witness_sim_after <- list()

# Process each trial
for (trial in trials_to_analyze) {
  cat("Processing Trial", trial, "\n")
  
  # STARSHADE SURFACE
  # Filter data for current trial and remove rows with missing critical data
  starshade_surface_before <- surface_before_particles %>%
    filter(Trial == trial) %>%
    select(Area, BX, BY, Width, Height) %>%
    filter(!is.na(Area), !is.na(BX), !is.na(BY), !is.na(Width), !is.na(Height),
           Area > 0, Width > 0, Height > 0)
  
  starshade_surface_after <- surface_after_particles %>%
    filter(Trial == trial) %>%
    select(Area, BX, BY, Width, Height) %>%
    filter(!is.na(Area), !is.na(BX), !is.na(BY), !is.na(Width), !is.na(Height),
           Area > 0, Width > 0, Height > 0)
  
  cat("  Starshade before:", nrow(starshade_surface_before), "particles\n")
  cat("  Starshade after:", nrow(starshade_surface_after), "particles\n")
  
  # Analyze intersections
  starshade_before_results <- analyze_line_intersections(starshade_surface_before, lines)
  starshade_after_results <- analyze_line_intersections(starshade_surface_after, lines)
  
  # Process to dataframes
  all_starshade_sim_before[[as.character(trial)]] <- process_results_to_df(
    starshade_before_results, "starshade_surface", "before", as.character(trial)
  )
  
  all_starshade_sim_after[[as.character(trial)]] <- process_results_to_df(
    starshade_after_results, "starshade_surface", "after", as.character(trial)
  )
  
  # CALIBRATION SURFACE
  # Filter data for current trial and remove rows with missing critical data
  calibration_surface_before <- Cwsurface_before_data$particle_data %>%
    filter(Trial == trial, Area > 1) %>%
    select(Area, BX, BY, Width, Height) %>%
    filter(!is.na(Area), !is.na(BX), !is.na(BY), !is.na(Width), !is.na(Height),
           Area > 0, Width > 0, Height > 0)
  
  calibration_surface_after <- Cwsurface_after_data$particle_data %>%
    filter(Trial == trial, Area > 1) %>%
    select(Area, BX, BY, Width, Height) %>%
    filter(!is.na(Area), !is.na(BX), !is.na(BY), !is.na(Width), !is.na(Height),
           Area > 0, Width > 0, Height > 0)
  
  cat("  Calibration before:", nrow(calibration_surface_before), "particles\n")
  cat("  Calibration after:", nrow(calibration_surface_after), "particles\n")
  
  # Analyze intersections
  calibration_before_results <- analyze_line_intersections(calibration_surface_before, lines)
  calibration_after_results <- analyze_line_intersections(calibration_surface_after, lines)
  
  # Process to dataframes
  all_calibration_sim_before[[as.character(trial)]] <- process_results_to_df(
    calibration_before_results, "calibration_surface", "before", as.character(trial)
  )
  
  all_calibration_sim_after[[as.character(trial)]] <- process_results_to_df(
    calibration_after_results, "calibration_surface", "after", as.character(trial)
  )
  
  # WITNESS SURFACE
  # Filter data for current trial and remove rows with missing critical data
  witness_surface_before <- wit_surface_before_particles %>%
    filter(Trial == trial, Area > 1) %>%
    select(Area, BX, BY, Width, Height) %>%
    filter(!is.na(Area), !is.na(BX), !is.na(BY), !is.na(Width), !is.na(Height),
           Area > 0, Width > 0, Height > 0)
  
  witness_surface_after <- wit_surface_after_particles %>%
    filter(Trial == trial, Area > 1) %>%
    select(Area, BX, BY, Width, Height) %>%
    filter(!is.na(Area), !is.na(BX), !is.na(BY), !is.na(Width), !is.na(Height),
           Area > 0, Width > 0, Height > 0)
  
  cat("  Witness before:", nrow(witness_surface_before), "particles\n")
  cat("  Witness after:", nrow(witness_surface_after), "particles\n")
  
  # Analyze intersections
  witness_before_results <- analyze_line_intersections(witness_surface_before, lines)
  witness_after_results <- analyze_line_intersections(witness_surface_after, lines)
  
  # Process to dataframes
  all_witness_sim_before[[as.character(trial)]] <- process_results_to_df(
    witness_before_results, "witness_surface", "before", as.character(trial)
  )
  
  all_witness_sim_after[[as.character(trial)]] <- process_results_to_df(
    witness_after_results, "witness_surface", "after", as.character(trial)
  )
}

# Combine all results
s_bmodel_edge_before <- bind_rows(all_starshade_sim_before)
s_bmodel_edge_after <- bind_rows(all_starshade_sim_after)
c_bmodel_edge_before <- bind_rows(all_calibration_sim_before)
c_bmodel_edge_after <- bind_rows(all_calibration_sim_after)
w_bmodel_edge_before <- bind_rows(all_witness_sim_before)
w_bmodel_edge_after <- bind_rows(all_witness_sim_after)

# Function to get area counts
get_area_counts <- function(data, area_thresholds, normalization_factor) {
  counts <- numeric(length(area_thresholds))
  
  for(i in 1:(length(area_thresholds) - 1)) {
    counts[i] <- sum(data$overhang_area >= area_thresholds[i] & 
                    data$overhang_area < area_thresholds[i + 1]) * normalization_factor
  }
  
  counts[length(area_thresholds)] <- sum(data$overhang_area >= area_thresholds[length(area_thresholds)]) * normalization_factor
  
  tibble(
    Area = area_thresholds,
    Count = counts
  )
}

# Function to process edge data for a surface type
process_edge_data <- function(edge_before, edge_after, normalization_data, surface_name) {
  # Calculate normalization factors
  edge_factors <- normalization_data %>%
    group_by(Trial) %>%
    summarise(
      Total_Width = n() * 600 * 1e-6,  # Convert microns to meters
      .groups = "drop"
    )
  
  # Calculate area-based counts for before data
  edge_counts_before <- edge_before %>%
    group_by(Trial, line_index) %>%
    group_modify(~ {
      norm_factor <- 0.1 / edge_factors$Total_Width[edge_factors$Trial == .y$Trial]
      counts <- get_area_counts(.x, area_thresholds, norm_factor)
      tibble(
        Area = area_thresholds,
        Count = counts$Count
      )
    })
  
  # Calculate area-based counts for after data
  edge_counts_after <- edge_after %>%
    group_by(Trial, line_index) %>%
    group_modify(~ {
      norm_factor <- 0.1 / edge_factors$Total_Width[edge_factors$Trial == .y$Trial]
      counts <- get_area_counts(.x, area_thresholds, norm_factor)
      tibble(
        Area = area_thresholds,
        Count = counts$Count
      )
    })
  
  # Calculate differences
  surface_count_diff <- edge_counts_after %>%
    full_join(edge_counts_before, 
              by = c("Trial", "Area", "line_index"), 
              suffix = c("_After", "_Before")) %>%
    mutate(
      Count_After = replace_na(Count_After, 0),
      Count_Before = replace_na(Count_Before, 0),
      Count_Diff = Count_After - Count_Before,
      Positive_Diff = pmax(Count_Diff, 0)
    )
  
  # Calculate cumulative counts
  cumulative_edge_counts <- surface_count_diff %>%
    group_by(Trial, line_index) %>%
    arrange(desc(Area)) %>%
    mutate(Cumulative_Count = cumsum(Positive_Diff)) %>%
    ungroup() %>%
    mutate(
      log_area = log10(Area),
      log_count = log10(Cumulative_Count),
      log_count = ifelse(is.infinite(log_count) | log_count < 0, 0, log_count)
    ) %>% 
    arrange(Trial, line_index, desc(Area))
  
  # Calculate binned counts from cumulative data
  edge_binned <- cumulative_edge_counts %>%
    group_by(Trial, line_index) %>%
    arrange(desc(Area)) %>%
    mutate(
      Count = c(Cumulative_Count[1], -diff(Cumulative_Count))  # Use negative diff for reverse cumsum
    ) %>%
    ungroup() %>% 
    mutate(
      log_count_bin = log10(Count),
      log_count_bin = ifelse(is.infinite(log_count_bin) | log_count_bin < 0, 0, log_count_bin)
    )
  
  return(list(
    cumulative = cumulative_edge_counts,
    binned = edge_binned
  ))
}

# Process all surface types
cat("Processing starshade edge data...\n")
starshade_edge_results <- process_edge_data(
  s_bmodel_edge_before, s_bmodel_edge_after, 
  surface_before_data$summary_data, "starshade"
)

cat("Processing calibration edge data...\n")
calibration_edge_results <- process_edge_data(
  c_bmodel_edge_before, c_bmodel_edge_after, 
  Cwsurface_before_data$summary_data, "calibration"
)

cat("Processing witness edge data...\n")
witness_edge_results <- process_edge_data(
  w_bmodel_edge_before, w_bmodel_edge_after, 
  Witsurface_before_data$summary_data, "witness"
)

# Extract results for easier access
s_bmodel_edge_mult <- starshade_edge_results$cumulative
s_bmodel_edge_mult_binned <- starshade_edge_results$binned

c_bmodel_edge_mult <- calibration_edge_results$cumulative
c_bmodel_edge_mult_binned <- calibration_edge_results$binned

w_bmodel_edge_mult <- witness_edge_results$cumulative
w_bmodel_edge_mult_binned <- witness_edge_results$binned

# Create summary plots for each trial and surface type
for (trial in trials_to_analyze) {
  cat("Creating plots for Trial", trial, "\n")
  
  # STARSHADE PLOTS
  # Cumulative plot
  p1 <- ggplot() +
    geom_line(data = s_bmodel_edge_mult %>% filter(Trial == trial),
              aes(x = log_area, y = log_count,
                  color = factor(line_index), 
                  group = line_index)) +
    labs(
      x = expression(log[10](Area)~"(square microns)"),
      y = "log10(Particle Count)",
      title = paste("Trial", trial, "Starshade: Cumulative Particle Area Distribution over 0.1 meter"),
      color = "Line Index"
    ) +
    custom_theme
  
  print(p1)
  
  # Binned plot
  p2 <- ggplot() +
    geom_line(data = s_bmodel_edge_mult_binned %>% filter(Trial == trial),
              aes(x = log_area, y = log_count_bin,
                  color = factor(line_index), 
                  group = line_index)) +
    labs(
      x = expression(log[10](Area)~"(square microns)"),
      y = "log10(Particle Count)",
      title = paste("Trial", trial, "Starshade: Binned Particle Area Distribution over 0.1 meter"),
      color = "Line Index"
    ) +
    custom_theme
  
  print(p2)
  
  # CALIBRATION PLOTS
  # Cumulative plot
  p3 <- ggplot() +
    geom_line(data = c_bmodel_edge_mult %>% filter(Trial == trial),
              aes(x = log_area, y = log_count,
                  color = factor(line_index), 
                  group = line_index)) +
    labs(
      x = expression(log[10](Area)~"(square microns)"),
      y = "log10(Particle Count)",
      title = paste("Trial", trial, "Calibration: Cumulative Particle Area Distribution over 0.1 meter"),
      color = "Line Index"
    ) +
    custom_theme
  
  print(p3)
  
  # Binned plot
  p4 <- ggplot() +
    geom_line(data = c_bmodel_edge_mult_binned %>% filter(Trial == trial),
              aes(x = log_area, y = log_count_bin,
                  color = factor(line_index), 
                  group = line_index)) +
    labs(
      x = expression(log[10](Area)~"(square microns)"),
      y = "log10(Particle Count)",
      title = paste("Trial", trial, "Calibration: Binned Particle Area Distribution over 0.1 meter"),
      color = "Line Index"
    ) +
    custom_theme
  
  print(p4)
  
  # WITNESS PLOTS
  # Cumulative plot
  p5 <- ggplot() +
    geom_line(data = w_bmodel_edge_mult %>% filter(Trial == trial),
              aes(x = log_area, y = log_count,
                  color = factor(line_index), 
                  group = line_index)) +
    labs(
      x = expression(log[10](Area)~"(square microns)"),
      y = "log10(Particle Count)",
      title = paste("Trial", trial, "Witness: Cumulative Particle Area Distribution over 0.1 meter"),
      color = "Line Index"
    ) +
    custom_theme
  
  print(p5)
  
  # Binned plot
  p6 <- ggplot() +
    geom_line(data = w_bmodel_edge_mult_binned %>% filter(Trial == trial),
              aes(x = log_area, y = log_count_bin,
                  color = factor(line_index), 
                  group = line_index)) +
    labs(
      x = expression(log[10](Area)~"(square microns)"),
      y = "log10(Particle Count)",
      title = paste("Trial", trial, "Witness: Binned Particle Area Distribution over 0.1 meter"),
      color = "Line Index"
    ) +
    custom_theme
  
  print(p6)
}

# Create comparison plots across all trials for each surface type
# Starshade comparison
ggplot() +
  geom_line(data = s_bmodel_edge_mult,
            aes(x = log_area, y = log_count,
                color = factor(Trial), 
                linetype = factor(line_index),
                group = interaction(Trial, line_index))) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade: Cumulative Edge Analysis Comparison Across Trials",
    color = "Trial",
    linetype = "Line Index"
  ) +
  custom_theme

# Calibration comparison
ggplot() +
  geom_line(data = c_bmodel_edge_mult,
            aes(x = log_area, y = log_count,
                color = factor(Trial), 
                linetype = factor(line_index),
                group = interaction(Trial, line_index))) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration: Cumulative Edge Analysis Comparison Across Trials",
    color = "Trial",
    linetype = "Line Index"
  ) +
  custom_theme

# Witness comparison
ggplot() +
  geom_line(data = w_bmodel_edge_mult,
            aes(x = log_area, y = log_count,
                color = factor(Trial), 
                linetype = factor(line_index),
                group = interaction(Trial, line_index))) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Witness: Cumulative Edge Analysis Comparison Across Trials",
    color = "Trial",
    linetype = "Line Index"
  ) +
  custom_theme

cat("Edge analysis complete for all trials and surfaces!\n")
```

## Instrument signature

```{r instrument_signature_analysis}
# Combined Instrument Signature Gap Prediction Analysis
# Generates predicted gaps for both Starshade Edge (threshold 60) and Calibration Edge (threshold 40)

library(tidyverse)
library(gridExtra)
library(grid)

# Fundamental parameters from Fiji scripts
PIXELS_PER_50_MICRONS <- 240
MICRONS_PER_PIXEL <- 50 / 240  # 0.208333 microns/pixel
AREA_PER_PIXEL_SQUARED <- MICRONS_PER_PIXEL^2  # 0.04340 microns²/pixel²

# Analysis parameters
min_area <- 1.0
max_area <- 6000.0
log_min <- log10(min_area)
log_max <- log10(max_area)
area_thresholds <- 10^(seq(log_min, log_max, length.out = 100))

# Thresholds from FIJI scripts
STARSHADE_THRESHOLD <- 60    # From Registration_loop_edge.ijm
CALIBRATION_THRESHOLD <- 40  # From Registration_loop_Calibration.ijm

print("=== INSTRUMENT SIGNATURE GAP PREDICTION ===")
print(paste("Scale:", round(MICRONS_PER_PIXEL, 6), "microns/pixel"))
print(paste("Area conversion:", round(AREA_PER_PIXEL_SQUARED, 6), "microns²/pixel²"))

# Function to generate all gap types for a given threshold
generate_all_gaps <- function(threshold_value, scenario_name) {
  
  # TYPE 1: Perfect Circle Quantization Gaps (threshold-independent)
  r_pixels <- 1:49
  circle_gaps <- data.frame(
    log_area_gap = (log10(pi * r_pixels[-length(r_pixels)]^2 * AREA_PER_PIXEL_SQUARED) + 
                   log10(pi * (r_pixels[-1])^2 * AREA_PER_PIXEL_SQUARED)) / 2,
    gap_type = "circle_quantization"
  )
  
  # TYPE 2: Logarithmic Bin Boundary Artifacts (threshold-independent)
  log_bin_gaps <- data.frame()
  for(i in 1:(length(area_thresholds)-1)) {
    lower_bound <- area_thresholds[i]
    upper_bound <- area_thresholds[i+1]
    
    lower_pixels <- lower_bound / AREA_PER_PIXEL_SQUARED
    upper_pixels <- upper_bound / AREA_PER_PIXEL_SQUARED
    n_possible <- length(ceiling(lower_pixels):floor(upper_pixels))
    
    if(n_possible <= 2) {
      log_bin_gaps <- rbind(log_bin_gaps, data.frame(
        log_area_gap = (log10(lower_bound) + log10(upper_bound)) / 2,
        gap_type = "logarithmic_binning"
      ))
    }
  }
  
  # TYPE 3: Threshold-Sensitive Size Artifacts (THRESHOLD-SPECIFIC)
  threshold_gaps <- data.frame()
  intensity_spans <- c(8, 16, 32, 64, 128)
  
  for(span in intensity_spans) {
    # Artifacts scale with distance from threshold
    contrast_range <- 255 - threshold_value
    
    small_diameter_pixels <- contrast_range / span * 1.5
    large_diameter_pixels <- contrast_range / span * 3
    
    small_area_microns <- pi * (small_diameter_pixels/2)^2 * AREA_PER_PIXEL_SQUARED
    large_area_microns <- pi * (large_diameter_pixels/2)^2 * AREA_PER_PIXEL_SQUARED
    
    if(small_area_microns >= min_area && small_area_microns <= max_area) {
      threshold_gaps <- rbind(threshold_gaps, data.frame(
        log_area_gap = log10(small_area_microns),
        gap_type = "threshold_artifact"
      ))
    }
    
    if(large_area_microns >= min_area && large_area_microns <= max_area) {
      threshold_gaps <- rbind(threshold_gaps, data.frame(
        log_area_gap = log10(large_area_microns),
        gap_type = "threshold_artifact"
      ))
    }
  }
  
  # TYPE 4: Scale Conversion Artifacts (threshold-independent)
  conversion_ratio <- 240/50
  problematic_scales <- c(1, 2, 3, 4, 5, 6, 8, 10, 12, 15, 16, 20, 24)
  
  scale_gaps <- data.frame()
  for(scale in problematic_scales) {
    diameter_microns <- scale / conversion_ratio
    area_microns <- pi * (diameter_microns/2)^2
    
    if(area_microns >= min_area && area_microns <= max_area) {
      scale_gaps <- rbind(scale_gaps, data.frame(
        log_area_gap = log10(area_microns),
        gap_type = "scale_conversion"
      ))
    }
  }
  
  # Combine all gaps
  all_gaps <- bind_rows(
    circle_gaps,
    log_bin_gaps,
    threshold_gaps,
    scale_gaps
  ) %>%
    filter(log_area_gap >= log_min, log_area_gap <= log_max) %>%
    arrange(log_area_gap)
  
  # Merge nearby gaps (within 0.05 log units)
  gap_tolerance <- 0.05
  predicted_gaps <- c()
  i <- 1
  
  while(i <= nrow(all_gaps)) {
    current_gap <- all_gaps$log_area_gap[i]
    
    # Find nearby gaps to merge
    j <- i + 1
    while(j <= nrow(all_gaps) && abs(all_gaps$log_area_gap[j] - current_gap) < gap_tolerance) {
      current_gap <- mean(c(current_gap, all_gaps$log_area_gap[j]))
      j <- j + 1
    }
    
    predicted_gaps <- c(predicted_gaps, current_gap)
    i <- j
  }
  
  return(list(
    predicted_gaps = predicted_gaps,
    all_gaps = all_gaps,
    scenario = scenario_name,
    threshold = threshold_value
  ))
}

# Generate gaps for both scenarios
starshade_results <- generate_all_gaps(STARSHADE_THRESHOLD, "Starshade Edge")
calibration_results <- generate_all_gaps(CALIBRATION_THRESHOLD, "Calibration Edge")

# Extract arrays
starshade_predicted_gaps <- starshade_results$predicted_gaps
calibration_predicted_gaps <- calibration_results$predicted_gaps

# Summary comparison
print("\n=== SUMMARY COMPARISON ===")

# Raw gap counts (before merging)
raw_comparison_df <- data.frame(
  Scenario = c("Starshade Edge", "Calibration Edge"),
  Threshold = c(STARSHADE_THRESHOLD, CALIBRATION_THRESHOLD),
  Circle_Gaps = c(
    sum(starshade_results$all_gaps$gap_type == "circle_quantization"),
    sum(calibration_results$all_gaps$gap_type == "circle_quantization")
  ),
  Bin_Gaps = c(
    sum(starshade_results$all_gaps$gap_type == "logarithmic_binning"),
    sum(calibration_results$all_gaps$gap_type == "logarithmic_binning")
  ),
  Threshold_Gaps = c(
    sum(starshade_results$all_gaps$gap_type == "threshold_artifact"),
    sum(calibration_results$all_gaps$gap_type == "threshold_artifact")
  ),
  Scale_Gaps = c(
    sum(starshade_results$all_gaps$gap_type == "scale_conversion"),
    sum(calibration_results$all_gaps$gap_type == "scale_conversion")
  ),
  Raw_Total = c(nrow(starshade_results$all_gaps), nrow(calibration_results$all_gaps))
)

print("Raw Gap Counts (before merging nearby gaps):")
print(raw_comparison_df)

# Merged gap counts (after combining nearby gaps)
merged_comparison_df <- data.frame(
  Scenario = c("Starshade Edge", "Calibration Edge"),
  Threshold = c(STARSHADE_THRESHOLD, CALIBRATION_THRESHOLD),
  Merged_Total = c(length(starshade_predicted_gaps), length(calibration_predicted_gaps)),
  Reduction = c(
    nrow(starshade_results$all_gaps) - length(starshade_predicted_gaps),
    nrow(calibration_results$all_gaps) - length(calibration_predicted_gaps)
  ),
  Percent_Reduction = c(
    round((nrow(starshade_results$all_gaps) - length(starshade_predicted_gaps)) / nrow(starshade_results$all_gaps) * 100, 1),
    round((nrow(calibration_results$all_gaps) - length(calibration_predicted_gaps)) / nrow(calibration_results$all_gaps) * 100, 1)
  )
)

print("\nMerged Gap Counts (after combining gaps within 0.05 log units):")
print(merged_comparison_df)

# Find unique gaps between scenarios
gap_tolerance_comparison <- 0.02
unique_to_starshade <- c()
unique_to_calibration <- c()

for(gap in starshade_predicted_gaps) {
  if(!any(abs(calibration_predicted_gaps - gap) < gap_tolerance_comparison)) {
    unique_to_starshade <- c(unique_to_starshade, gap)
  }
}

for(gap in calibration_predicted_gaps) {
  if(!any(abs(starshade_predicted_gaps - gap) < gap_tolerance_comparison)) {
    unique_to_calibration <- c(unique_to_calibration, gap)
  }
}

print(paste("\nGaps unique to Starshade Edge:", length(unique_to_starshade)))
print(paste("Gaps unique to Calibration Edge:", length(unique_to_calibration)))

if(length(unique_to_starshade) > 0) {
  print("Starshade-specific gaps (first 5):")
  print(round(head(unique_to_starshade, 5), 3))
}

if(length(unique_to_calibration) > 0) {
  print("Calibration-specific gaps (first 5):")
  print(round(head(unique_to_calibration, 5), 3))
}

# Analysis of observed gap at log10(area) = 2.3
observed_gap <- 2.3
observed_area <- 10^observed_gap

print("\n=== ANALYSIS OF OBSERVED GAP ===")
print(paste("Observed gap at log10(area) =", observed_gap))
print(paste("Area:", round(observed_area, 1), "μm²"))
print(paste("Diameter:", round(2*sqrt(observed_area/pi), 1), "μm"))

# Check which scenario better predicts the observed gap
starshade_distances <- abs(starshade_predicted_gaps - observed_gap)
calibration_distances <- abs(calibration_predicted_gaps - observed_gap)

closest_starshade <- min(starshade_distances)
closest_calibration <- min(calibration_distances)

print(paste("Closest Starshade prediction:", round(closest_starshade, 3), "log units away"))
print(paste("Closest Calibration prediction:", round(closest_calibration, 3), "log units away"))

if(closest_starshade < closest_calibration) {
  print("*** Starshade Edge model better predicts your observed gap ***")
} else {
  print("*** Calibration Edge model better predicts your observed gap ***")
}

# Output arrays for RMarkdown
print("\n=== ARRAYS FOR RMARKDOWN ===")
cat("# Starshade Edge Predicted Gaps (Threshold 60)\n")
cat("starshade_predicted_gaps <- c(", paste(sprintf("%.3f", starshade_predicted_gaps), collapse = ", "), ")\n\n")

cat("# Calibration Edge Predicted Gaps (Threshold 40)\n")
cat("calibration_predicted_gaps <- c(", paste(sprintf("%.3f", calibration_predicted_gaps), collapse = ", "), ")\n\n")

# Validation function (streamlined)
validate_gaps_simple <- function(particle_data, area_column = "Area", predicted_gaps, gap_tolerance = 0.05) {
  
  areas <- particle_data[[area_column]]
  areas <- areas[areas > 0 & !is.na(areas)]
  log_areas <- log10(areas)
  
  # Create histogram for gap detection
  hist_data <- hist(log_areas, breaks = 50, plot = FALSE)
  bin_centers <- (hist_data$breaks[-1] + hist_data$breaks[-length(hist_data$breaks)]) / 2
  
  # Find actual gaps (bins with very low counts)
  expected_count <- median(hist_data$counts[hist_data$counts > 0])
  actual_gaps <- bin_centers[hist_data$counts < (expected_count * 0.3)]
  
  # Check predictions
  confirmed_gaps <- 0
  for(predicted_gap in predicted_gaps) {
    if(any(abs(actual_gaps - predicted_gap) < gap_tolerance)) {
      confirmed_gaps <- confirmed_gaps + 1
    }
  }
  
  confirmation_rate <- round(confirmed_gaps / length(predicted_gaps) * 100, 1)
  
  return(list(
    total_predicted = length(predicted_gaps),
    confirmed = confirmed_gaps,
    rate = confirmation_rate,
    summary = paste0(confirmed_gaps, "/", length(predicted_gaps), " gaps confirmed (", confirmation_rate, "%)")
  ))
}

print("\n=== VALIDATION READY ===")
print("Use validate_gaps_simple() with your edge particle data:")
print("starshade_validation <- validate_gaps_simple(edge_particles_data, 'Area', starshade_predicted_gaps)")
print("calibration_validation <- validate_gaps_simple(calibration_particles_data, 'Area', calibration_predicted_gaps)")
```

<!-- Next steps include comparison to paper sections, Witness Analysis, Cropped Surface Analysis -->

## 13. Paper Comparisons

<!-- This section creates figures that can be directly compared with those in the research paper -->

```{r comparison graphs}

# ========================================================================
# PARTICLE DISTRIBUTION ANALYSIS - RECREATING FIGURES 15 & 16
# ========================================================================
# This code recreates the particle distribution analysis from the paper
# Updated to work with R markdown environment

# Load required packages
suppressPackageStartupMessages({
  library(ggplot2)
  library(dplyr)
  library(scales)
})

# Function to safely check if dataset exists and has required columns
check_dataset <- function(dataset_name, required_cols = c("log_area", "log_count_bin")) {
  if (!exists(dataset_name, envir = .GlobalEnv)) {
    cat("Warning: Dataset", dataset_name, "does not exist\n")
    return(FALSE)
  }
  
  dataset <- get(dataset_name, envir = .GlobalEnv)
  if (is.null(dataset) || nrow(dataset) == 0) {
    cat("Warning: Dataset", dataset_name, "is empty\n")
    return(FALSE)
  }
  
  missing_cols <- setdiff(required_cols, names(dataset))
  if (length(missing_cols) > 0) {
    cat("Warning: Dataset", dataset_name, "missing columns:", paste(missing_cols, collapse = ", "), "\n")
    return(FALSE)
  }
  
  return(TRUE)
}

# Check what datasets are available for analysis
cat("=== CHECKING AVAILABLE DATASETS ===\n")
available_datasets <- list(
  surface_binned = check_dataset("surface_average_binned", c("log_area", "log_count_bin")),
  edge_binned = check_dataset("edge_average_binned", c("log_area", "log_count_bin")),
  cw_edge_binned = check_dataset("cw_edge_average_binned", c("log_area", "log_count_bin")),
  model_edge_binned = check_dataset("model_edge_average_binned", c("log_area", "log_count_bin"))
)

cat("Available datasets:\n")
for(i in 1:length(available_datasets)) {
  cat("-", names(available_datasets)[i], ":", available_datasets[[i]], "\n")
}
cat("\n")

# Updated plot theme with improved readability for publication-quality figures
plot_theme <- theme_minimal() +
  theme(
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray95"),
    text = element_text(size = 12),
    legend.position = "top",
    legend.text = element_text(size = 11),
    legend.title = element_blank(),
    plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.text = element_text(size = 11),
    axis.title = element_text(size = 12)
  )

# Initialize variables to track successful plots
plots_created <- list()

# ========================================================================
# FIGURE 15(a) - TOTAL MEASURED SURFACE PARTICULATE DISTRIBUTION
# ========================================================================

if (available_datasets$surface_binned) {
  tryCatch({
    cat("Creating surface distribution plot...\n")
    
    # Get surface data and clean it
    surface_data <- get("surface_average_binned", envir = .GlobalEnv) %>%
      filter(!is.na(log_area), !is.na(log_count_bin), 
             is.finite(log_area), is.finite(log_count_bin))
    
    # Calculate surface binned fit parameters for comparison with literature
    surface_model <- lm(log_count_bin ~ log_area, data = surface_data)
    surface_binned_fit <- data.frame(
      slope = coef(surface_model)[2],
      intercept = coef(surface_model)[1]
    ) %>%
      mutate(PCL = 10^(sqrt(abs(-intercept/slope))))
    
    # Create Figure 15(a) - Surface distribution
    p1 <- ggplot() +
      geom_line(data = surface_data,
                aes(x = 10^log_area, y = 10^log_count_bin, color = "Measured on Surface"),
                size = 1.2) +
      geom_abline(
        slope = surface_binned_fit$slope, 
        intercept = surface_binned_fit$intercept,
        linetype = "dashed",
        color = "black",
        size = 1
      ) +
      scale_x_log10(
        limits = c(10, 1e5),
        breaks = 10^(1:5),
        labels = scales::scientific_format(digits = 1)
      ) +
      scale_y_log10(
        limits = c(1, 1e6),
        breaks = 10^(0:6)
      ) +
      scale_color_manual(values = c("Measured on Surface" = "#0072BD")) +
      labs(
        x = expression("Overhanging Particle Area ("*mu*m^2*")"),
        y = "# Surface Particles",
        title = "Total Measured Surface Particulate Distribution"
      ) +
      plot_theme +
      annotate(
        "text",
        x = 100,
        y = 1e5,
        label = sprintf("IEST Fit: PCL %.0f, slope %.2f",
                       round(surface_binned_fit$PCL),
                       surface_binned_fit$slope),
        hjust = 0,
        size = 4
      )
    
    print(p1)
    plots_created[["surface"]] <- TRUE
    cat("Surface distribution plot created successfully\n\n")
    
  }, error = function(e) {
    cat("Error creating surface distribution plot:", e$message, "\n\n")
    plots_created[["surface"]] <- FALSE
  })
} else {
  cat("Cannot create surface distribution plot - missing surface_average_binned dataset\n\n")
  plots_created[["surface"]] <- FALSE
}

# ========================================================================
# FIGURE 15(b) - TOTAL MEASURED EDGE PARTICULATE DISTRIBUTION
# ========================================================================

if (available_datasets$edge_binned && available_datasets$model_edge_binned) {
  tryCatch({
    cat("Creating edge distribution plot...\n")
    
    # Get edge data and clean it
    edge_data <- get("edge_average_binned", envir = .GlobalEnv) %>%
      filter(!is.na(log_area), !is.na(log_count_bin), 
             is.finite(log_area), is.finite(log_count_bin))
    
    model_data <- get("model_edge_average_binned", envir = .GlobalEnv) %>%
      filter(!is.na(log_area), !is.na(log_count_bin), 
             is.finite(log_area), is.finite(log_count_bin))
    
    # Create Figure 15(b) - Edge distribution comparison
    p2 <- ggplot() +
      geom_line(data = edge_data,
                aes(x = 10^log_area, y = 10^log_count_bin, color = "Measured on Edge"),
                size = 1.2) +
      geom_line(data = model_data,
                aes(x = 10^log_area, y = 10^log_count_bin, color = "Predicted from Surface"),
                size = 1.2) +
      scale_x_log10(
        limits = c(10, 1e4),
        breaks = c(10, 100, 1000, 10000),
        labels = scales::scientific_format(digits = 1)
      ) +
      scale_y_log10(
        limits = c(0.1, 1e4),
        breaks = 10^seq(-1, 4, by = 1)
      ) +
      scale_color_manual(
        values = c(
          "Measured on Edge" = "#0072BD",
          "Predicted from Surface" = "#D95319"
        )
      ) +
      labs(
        x = expression("Overhanging Particle Area ("*mu*m^2*")"),
        y = "# Edge Particles",
        title = "Total Measured Edge Particulate Distribution"
      ) +
      plot_theme
    
    print(p2)
    plots_created[["edge"]] <- TRUE
    cat("Edge distribution plot created successfully\n\n")
    
  }, error = function(e) {
    cat("Error creating edge distribution plot:", e$message, "\n\n")
    plots_created[["edge"]] <- FALSE
  })
} else {
  cat("Cannot create edge distribution plot - missing required datasets\n\n")
  plots_created[["edge"]] <- FALSE
}

# ========================================================================
# FIGURE 16(a) - NORMALIZED EDGE PARTICULATE DISTRIBUTIONS
# ========================================================================

if (available_datasets$edge_binned && available_datasets$cw_edge_binned) {
  tryCatch({
    cat("Creating normalized distribution plot...\n")
    
    # Normalize calibration data for comparison
    calibration_data <- get("cw_edge_average_binned", envir = .GlobalEnv) %>%
      filter(!is.na(log_count_bin), is.finite(log_count_bin))
    
    calibration_normalized <- calibration_data %>%
      mutate(
        Count = 10^log_count_bin,
        Total_Count = sum(Count, na.rm = TRUE),
        Normalized_Count = Count / Total_Count
      ) 
      
    # Normalize edge data similarly
    edge_data_norm <- get("edge_average_binned", envir = .GlobalEnv) %>%
      filter(!is.na(log_count_bin), is.finite(log_count_bin))
    
    edge_normalized <- edge_data_norm %>%
      mutate(
        Count = 10^log_count_bin,
        Total_Count = sum(Count, na.rm = TRUE),
        Normalized_Count = Count / Total_Count
      )
    
    # Create Figure 16(a) - Normalized distributions
    p3 <- ggplot() +
      geom_line(data = calibration_normalized,
                aes(x = 10^log_area, y = Normalized_Count, color = "Calibration Mask"),
                size = 1.2) +
      geom_line(data = edge_normalized,
                aes(x = 10^log_area, y = Normalized_Count, color = "Etched Samples"),
                size = 1.2) +
      scale_x_log10(
        limits = c(10, 1e4),
        breaks = c(10, 100, 1000, 10000),
        labels = scales::scientific_format(digits = 1)
      ) +
      scale_y_log10(
        limits = c(1e-4, 1),
        breaks = 10^seq(-4, 0, by = 1)
      ) +
      scale_color_manual(
        values = c(
          "Calibration Mask" = "#D95319",
          "Etched Samples" = "#0072BD"
        )
      ) +
      labs(
        x = expression("Particle Area ("*mu*m^2*")"),
        y = "Proportion of Particulates",
        title = "Normalized Edge Particulate Distributions"
      ) +
      plot_theme
    
    print(p3)
    plots_created[["normalized"]] <- TRUE
    cat("Normalized distribution plot created successfully\n\n")
    
  }, error = function(e) {
    cat("Error creating normalized distribution plot:", e$message, "\n\n")
    plots_created[["normalized"]] <- FALSE
  })
} else {
  cat("Cannot create normalized distribution plot - missing required datasets\n\n")
  plots_created[["normalized"]] <- FALSE
}

# ========================================================================
# FIGURE 16(b) - MISSING EDGE PARTICULATE RATIO
# ========================================================================

if (plots_created[["normalized"]] && exists("calibration_normalized") && exists("edge_normalized")) {
  tryCatch({
    cat("Creating ratio analysis plot...\n")
    
    # Calculate the ratio between normalized distributions
    normalized_ratio <- calibration_normalized %>% 
      inner_join(edge_normalized, by = c("Area", "log_area"), suffix = c("_calib", "_edge")) %>% 
      mutate(
        observed_over_calibration = Normalized_Count_edge / Normalized_Count_calib,
        theoretical_ratio = 1 / (2 * sqrt(10^log_area / pi))
      ) %>% 
      filter(!is.na(observed_over_calibration), is.finite(observed_over_calibration),
             observed_over_calibration > 0) %>%
      select(Area, log_area, observed_over_calibration, theoretical_ratio)
    
    # Create Figure 16(b) - Ratio analysis
    p4 <- ggplot() +
      geom_line(data = normalized_ratio,
                aes(x = 10^log_area, y = observed_over_calibration, color = "Observed Ratio"),
                size = 1.2) +
      geom_line(data = normalized_ratio,
                aes(x = 10^log_area, y = theoretical_ratio, color = "1/diam. Fitted Curve"),
                linetype = "dashed",
                size = 1.2) +
      scale_x_log10(
        limits = c(10, 1e4),
        breaks = c(10, 100, 1000, 10000)
      ) +
      scale_y_continuous(
        limits = c(0, 2),
        breaks = seq(0, 2, 0.5)
      ) +
      scale_color_manual(
        values = c(
          "Observed Ratio" = "#0072BD",
          "1/diam. Fitted Curve" = "#D95319"
        )
      ) +
      labs(
        x = expression("Particle Area ("*mu*m^2*")"),
        y = "Edge Particulate Ratio\nEtched/Calibration",
        title = "Missing Edge Particulate Ratio"
      ) +
      plot_theme
    
    print(p4)
    plots_created[["ratio"]] <- TRUE
    cat("Ratio analysis plot created successfully\n\n")
    
  }, error = function(e) {
    cat("Error creating ratio plot:", e$message, "\n\n")
    plots_created[["ratio"]] <- FALSE
  })
} else {
  cat("Cannot create ratio plot - missing required normalized data\n\n")
  plots_created[["ratio"]] <- FALSE
}

# ========================================================================
# SUMMARY STATISTICS
# ========================================================================

cat("=== ANALYSIS SUMMARY ===\n")

# Surface analysis summary
if (plots_created[["surface"]] && exists("surface_binned_fit")) {
  cat("Surface Distribution Analysis:\n")
  cat("- PCL:", round(surface_binned_fit$PCL), "μm²\n")
  cat("- Slope:", round(surface_binned_fit$slope, 2), "\n")
  if (exists("surface_data")) {
    cat("- Data points:", nrow(surface_data), "\n")
  }
  cat("\n")
}

# Edge analysis summary
if (available_datasets$edge_binned) {
  tryCatch({
    edge_data_summary <- get("edge_average_binned", envir = .GlobalEnv)
    edge_stats <- edge_data_summary %>%
      filter(!is.na(log_count_bin), is.finite(log_count_bin)) %>%
      summarise(
        total_particles = sum(10^log_count_bin, na.rm = TRUE),
        area_range_min = min(10^log_area, na.rm = TRUE),
        area_range_max = max(10^log_area, na.rm = TRUE),
        data_points = n()
      )
    
    cat("Edge Distribution Analysis:\n")
    cat("- Total particles:", round(edge_stats$total_particles), "\n")
    cat("- Area range:", round(edge_stats$area_range_min), "-", round(edge_stats$area_range_max), "μm²\n")
    cat("- Data points:", edge_stats$data_points, "\n")
    cat("\n")
  }, error = function(e) {
    cat("Error calculating edge statistics:", e$message, "\n")
  })
}

# Ratio analysis summary
if (plots_created[["ratio"]] && exists("normalized_ratio")) {
  tryCatch({
    ratio_stats <- normalized_ratio %>%
      summarise(
        mean_ratio = mean(observed_over_calibration, na.rm = TRUE),
        median_ratio = median(observed_over_calibration, na.rm = TRUE),
        max_ratio = max(observed_over_calibration, na.rm = TRUE)
      )
    
    cat("Ratio Analysis:\n")
    cat("- Mean etched/calibration ratio:", round(ratio_stats$mean_ratio, 2), "\n")
    cat("- Median ratio:", round(ratio_stats$median_ratio, 2), "\n")
    cat("- Maximum ratio:", round(ratio_stats$max_ratio, 2), "\n")
    cat("\n")
  }, error = function(e) {
    cat("Error calculating ratio statistics:", e$message, "\n")
  })
}

# Final summary
successful_plots <- sum(unlist(plots_created))
cat("Plots successfully created:", successful_plots, "out of 4\n")
cat("========================\n")

```


```{r combined comparison}
# Functions to create combined figures for comparison with paper figures

# Create image grid from PNG file
create_image_grob <- function(img_path) {
  img <- readPNG(img_path)
  rasterGrob(img, interpolate = TRUE)
}

# Create text grid for labels
create_label <- function(text) {
  textGrob(text, gp = gpar(fontsize = 12, fontface = "bold"))
}

# Compare Figure 15 - Side by side comparison with original paper figure
grid.arrange(
  create_image_grob("/Users/brandontitensor/Desktop/College/Research/Dust_Contamination/starshade_dust_particle/data_analysis/Images/Figure_15.png"),
  arrangeGrob(p1, p2, ncol = 2),
  ncol = 1,
  heights = c(1, 1),
  top = textGrob("Figure 15: Etched Samples Comparison", 
                 gp = gpar(fontsize = 14, fontface = "bold"))
)

# Function to compare reference and generated plots
compare_plots <- function(reference_img, generated_plot, title) {
  grid.arrange(
    reference_img, generated_plot,
    ncol = 2,
    top = textGrob(title, gp = gpar(fontsize = 14, fontface = "bold")),
    widths = c(1, 1)
  )
}

# Compare Figure 16 - Side by side with original paper figure
grid.arrange(
  create_image_grob("/Users/brandontitensor/Desktop/College/Research/Dust_Contamination/starshade_dust_particle/data_analysis/Images/Figure_16.png"),
  arrangeGrob(p3, p4, ncol = 2),
  ncol = 1,
  heights = c(1, 1),
  top = textGrob("Figure 16: Comparative Analysis Comparison", 
                 gp = gpar(fontsize = 14, fontface = "bold"))
)
```
