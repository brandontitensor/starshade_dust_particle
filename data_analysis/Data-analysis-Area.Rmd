---
title: "Area_based_analysis"
author: "Brandon Titensor"
date: "2025-01-08"
output: 
   html_document:
    toc: true
    toc_float: true
    theme: cosmo
---

```{r setup, include=FALSE}
# 
#   html_document:
#     toc: true
#     toc_float: true
#     theme: cosmo

# Load required libraries
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(knitr)
library(rstatix)
library(ggpubr)
library(gridExtra)
library(data.table)
library(cowplot)
library(ggplot2)
library(dplyr)
library(grid)
library(fs)
library(png)
library(kableExtra)
library(broom)

# Create unified theme for consistent plot appearance across the analysis
custom_theme <- theme_minimal() +
  theme(
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    legend.position = "bottom",
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray95")
  )

# Define consistent color palette for different trials
trial_colors <- c(
  "8" = "#0072B2",  # Navy Blue
  "9" = "#D55E00",  # Orange
  "10" = "#009E73",  # Green
  "11" = "#56B4E9",  # Sky Blue
  "12" = "#CC79A7", # Purple
  "13" = "#F0E442", #Yellow
  "14" = "#661100" #Dark Brown
)

# Define consistent line types for different data categories
line_types <- c(
  "Observed" = "solid",
  "Modeled" = "dashed",
  "Calibration" = "dotted"
)


```

## 1. Data Loading and Preprocessing

### 1.1 Edge Data

<!-- This section loads particle data from the edges of samples to analyze particulate contamination -->

```{r load_edge_data}
# Function to load and process a single sample of edge data
# This reads both particle details and summary information from CSV files
load_sample_data <- function(sample_number) {
  # Format sample number with leading zeros
  sample_str <- sprintf("%02d", sample_number)
  
  # Construct file paths for particles and summary data
  particles_path <- sprintf("/Volumes/BRANDONMEGA/Research/Dust_Contamination/Trials/Data/Edges/Edge Measurements/Bef_%s minus Aft_%s/Particles Bef_%s minus Aft_%s.csv", 
                          sample_str, sample_str, sample_str, sample_str)
  summary_path <- sprintf("/Volumes/BRANDONMEGA/Research/Dust_Contamination/Trials/Data/Edges/Edge Measurements/Bef_%s minus Aft_%s/Summary Bef_%s minus Aft_%s_updated.csv", 
                         sample_str, sample_str, sample_str, sample_str)
  
  # Load and preprocess particle data
  particles_data <- read.csv(particles_path)
  particles_data$Sample <- sample_number
  
  # Load and preprocess summary data
  summary_data <- read.csv(summary_path)
  names(summary_data) <- make.names(names(summary_data))
  summary_data$Count <- as.numeric(gsub("[^0-9.]", "", summary_data$Count))
  summary_data$width <- as.numeric(gsub("[^0-9.]", "", summary_data$width))
  summary_data <- summary_data %>% drop_na()
  summary_data$Sample <- sample_number
  
  # Convert width from pixels to microns (calibration factor is 50/240)
  summary_data$width <- summary_data$edge_width * (50/240)
  
  list(particles = particles_data, summary = summary_data)
}

# Load data for samples 51-60 (Trials 9-12, 5 samples each)
edge_data <- map(c(01:30), load_sample_data)

# Combine all particle data into one dataset
edge_particles_data <- bind_rows(map(edge_data, "particles"))

# Combine all summary data into one dataset
edge_summary_data <- bind_rows(map(edge_data, "summary"))

# Assign trials to samples (5 samples per trial)
edge_particles_data$Trial <- ceiling((edge_particles_data$Sample - 5) / 5) + 9
edge_summary_data$Trial <- ceiling((edge_summary_data$Sample - 5) / 5) + 9

# Calculate total width for each trial to normalize data
total_width_by_trial <- edge_summary_data %>%
  group_by(Trial) %>%
  summarise(Total_Width = sum(width))

# Calculate the normalization factor based on the maximum width
max_width <- max(total_width_by_trial$Total_Width)
normalization_factors <- max_width / total_width_by_trial$Total_Width
```

### 1.2 Surface Data

<!-- This section loads data from the surfaces of samples before and after contamination -->

```{r load_surface_data}
# Function to load and process surface data
# This handles both before and after contamination measurements
load_data <- function(condition) {
  # Function to load and process particle data for a single sample
  load_particle_data <- function(trial_number, sample_number, cond) {
    tryCatch({
      particle_path <- sprintf("/Volumes/BRANDONMEGA/Research/Dust_Contamination/Trials/Data/Surfaces/%sTr%dSa%dSurf/Particles_%sTr%dSa%dSurf.csv", 
                             cond, trial_number, sample_number, cond, trial_number, sample_number)
      
      particle_data <- read_csv(particle_path)
      particle_data <- particle_data[, 2:(ncol(particle_data)-2)]
      particle_data$Sample <- sample_number
      particle_data$Trial <- trial_number
      
      return(particle_data)
    }, error = function(e) {
      message(sprintf("Error loading particle data for %s Trial %d, Sample %d: %s", 
                     cond, trial_number, sample_number, e$message))
      return(NULL)
    })
  }

  # Load and process summary data with error handling
  load_summary_data <- function(trial_number, sample_number, cond) {
    tryCatch({
      summary_path <- sprintf("/Volumes/BRANDONMEGA/Research/Dust_Contamination/Trials/Data/Surfaces/%sTr%dSa%dSurf/Summary_%sTr%dSa%dSurf.csv", 
                            cond, trial_number, sample_number, cond, trial_number, sample_number)
      
      summary_data <- read_csv(summary_path, col_select = c(1, 2, 3, 5))
      names(summary_data) <- make.names(names(summary_data))
      summary_data <- summary_data %>% 
        drop_na() %>%
        mutate(
          Sample = sample_number,
          Trial = trial_number,
          Slice_Number = as.integer(substr(Slice, nchar(Slice)-6, nchar(Slice)-4))
        )
      
      return(summary_data)
    }, error = function(e) {
      message(sprintf("Error loading summary data for %s Trial %d, Sample %d: %s", 
                     cond, trial_number, sample_number, e$message))
      return(NULL)
    })
  }

  # Load data for trials 8-12 (5 samples per trial)
  surface_particle_data <- map2(rep(9:14, each = 5), rep(1:5, times = 6), 
                              ~load_particle_data(.x, .y, condition))
  surface_summary_data <- map2(rep(9:14, each = 5), rep(1:5, times = 6), 
                             ~load_summary_data(.x, .y, condition))

  # Combine all data
  surface_particle_data <- bind_rows(surface_particle_data)
  surface_summary_data <- bind_rows(surface_summary_data)

  # Add cleaning method information based on trial number
  add_cleaning_method <- function(data) {
    data %>%
      mutate(Cleaning_Method = case_when(
        Trial %in% c(2, 3) ~ "IPA rinse",
        Trial %in% c(4, 5) ~ "Drag and wipe",
        Trial %in% c(6, 7) ~ "First contact",
        Trial %in% c(8, 9, 10, 11, 12,13,14) ~ "First contact & Drag and wipe",
        TRUE ~ NA_character_
      ))
  }

  surface_particle_data <- add_cleaning_method(surface_particle_data)
  surface_summary_data <- add_cleaning_method(surface_summary_data)

  # Calculate imaged areas to normalize counts (600 x 450 microns per image)
  image_size <- 600 * 450 # microns^2
  trial_areas <- surface_summary_data %>%
    group_by(Trial, Cleaning_Method) %>%
    summarise(
      Total_Images = n(),
      Total_Area = Total_Images * image_size * 1e-12, # Convert to m^2
      .groups = "drop"
    )

  list(particle_data = surface_particle_data, 
       summary_data = surface_summary_data, 
       trial_areas = trial_areas)
}

# Load before and after surface data for comparison
surface_before_data <- load_data("Bef")
surface_after_data <- load_data("Aft")
```

### 1.3 Calibration Wafer Data

<!-- This section loads data from calibration wafers which serve as reference standards -->

```{r load_calibration_data}
# Function to load and process calibration wafer data
load_calibration_data <- function(sample_number) {
  # Format sample number with leading zeros
  sample_str <- sprintf("%02d", sample_number)
  
  # Construct file paths
  particles_path <- sprintf("/Volumes/BRANDONMEGA/Research/Dust_Contamination/Trials/Data/Calibration/Edge Measurements/Bef_%s minus Aft_%s/Particles Bef_%s minus Aft_%s.csv", sample_str, sample_str, sample_str, sample_str)
  summary_path <- sprintf("/Volumes/BRANDONMEGA/Research/Dust_Contamination/Trials/Data/Calibration/Edge Measurements/Bef_%s minus Aft_%s/Summary Bef_%s minus Aft_%s_updated.csv", sample_str, sample_str, sample_str, sample_str)
  
  # Load particle data
  particles_data <- read.csv(particles_path)
  particles_data$Sample <- sample_number
  
  # Load summary data and clean up formatting
  summary_data <- read.csv(summary_path)
  names(summary_data) <- make.names(names(summary_data))
  summary_data$Count <- as.numeric(gsub("[^0-9.]", "", summary_data$Count))
  summary_data$width <- as.numeric(gsub("[^0-9.]", "", summary_data$width))
  summary_data$Sample <- sample_number
  summary_data <- summary_data %>% drop_na()
   # Convert width from pixels to microns (calibration factor is 50/240)
  summary_data$width <- summary_data$edge_width * (50/240)
  
  list(particles = particles_data, summary = summary_data)
}

# Load data for calibration samples (11-30)
calibration_data <- map(c(16:45), load_calibration_data)

# Combine all particle data
calibration_particles_data <- bind_rows(map(calibration_data, "particles"))

# Combine all summary data
calibration_summary_data <- bind_rows(map(calibration_data, "summary"))

# Assign trials to samples
calibration_particles_data$Trial <- ceiling((calibration_particles_data$Sample  - 15) / 5) + 8
calibration_summary_data$Trial <- ceiling((calibration_summary_data$Sample) / 5) + 5

# Calculate total width and normalization factors
total_width_by_trial <- calibration_summary_data %>%
  group_by(Trial) %>%
  summarise(Total_Width = sum(edge_width))

# Use same max_width as edge data for consistent normalization
calibration_max_width <- max_width
calibration_normalization_factors <- calibration_max_width / total_width_by_trial$Total_Width

# Free memory by removing the raw data
rm(calibration_data)
```

### 1.4 Calibration Surface Data

<!-- This section loads surface data from calibration wafers for complete comparison -->

```{r load_cal_surface_data}
# Function to load and process surface data from calibration wafers
# This is similar to the regular surface data function but with different file paths
load_data <- function(condition) {
  # Function to load and process particle data for a single sample
  load_particle_data <- function(trial_number, sample_number, cond) {
    tryCatch({
      particle_path <- sprintf("/Volumes/BRANDONMEGA/Research/Dust_Contamination/Trials/Data/Cal_Surfaces/%sTr%dSa%dCwSurf/Particles_%sTr%dSa%dCwSurf.csv", 
                             cond, trial_number, sample_number, cond, trial_number, sample_number)
      
      particle_data <- read_csv(particle_path)
      particle_data <- particle_data[, 2:(ncol(particle_data)-2)]
      particle_data$Sample <- sample_number
      particle_data$Trial <- trial_number
      
      return(particle_data)
    }, error = function(e) {
      message(sprintf("Error loading particle data for %s Trial %d, Sample %d: %s", 
                     cond, trial_number, sample_number, e$message))
      return(NULL)
    })
  }

  # Load and process summary data
  load_summary_data <- function(trial_number, sample_number, cond) {
    tryCatch({
      summary_path <- sprintf("/Volumes/BRANDONMEGA/Research/Dust_Contamination/Trials/Data/Cal_Surfaces/%sTr%dSa%dCwSurf/Summary_%sTr%dSa%dCwSurf.csv", 
                            cond, trial_number, sample_number, cond, trial_number, sample_number)
      
      summary_data <- read_csv(summary_path, col_select = c(1, 2, 3, 5))
      names(summary_data) <- make.names(names(summary_data))
      summary_data <- summary_data %>% 
        drop_na() %>%
        mutate(
          Sample = sample_number,
          Trial = trial_number,
          Slice_Number = as.integer(substr(Slice, nchar(Slice)-6, nchar(Slice)-4))
        )
      
      return(summary_data)
    }, error = function(e) {
      message(sprintf("Error loading summary data for %s Trial %d, Sample %d: %s", 
                     cond, trial_number, sample_number, e$message))
      return(NULL)
    })
  }

  # Load data for trial 12 (5 samples)
  surface_particle_data <- map2(rep(12:14, each = 5), rep(1:5, times = 3), 
                              ~load_particle_data(.x, .y, condition))
  surface_summary_data <- map2(rep(12:14, each = 5), rep(1:5, times = 3), 
                             ~load_summary_data(.x, .y, condition))

  # Combine all data
  surface_particle_data <- bind_rows(surface_particle_data)
  surface_summary_data <- bind_rows(surface_summary_data)

  # Add cleaning method information
  add_cleaning_method <- function(data) {
    data %>%
      mutate(Cleaning_Method = case_when(
        Trial %in% c(2, 3) ~ "IPA rinse",
        Trial %in% c(4, 5) ~ "Drag and wipe",
        Trial %in% c(6, 7) ~ "First contact",
        Trial %in% c(8, 9, 10, 11, 12,13,14) ~ "First contact & Drag and wipe",
        TRUE ~ NA_character_
      ))
  }

  surface_particle_data <- add_cleaning_method(surface_particle_data)
  surface_summary_data <- add_cleaning_method(surface_summary_data)

  # Calculate imaged areas
  image_size <- 600 * 450 # microns^2
  trial_areas <- surface_summary_data %>%
    group_by(Trial, Cleaning_Method) %>%
    summarise(
      Total_Images = n(),
      Total_Area = Total_Images * image_size * 1e-12, # Convert to m^2
      .groups = "drop"
    )

  list(particle_data = surface_particle_data, 
       summary_data = surface_summary_data, 
       trial_areas = trial_areas)
}

# Load before and after calibration surface data
Cwsurface_before_data <- load_data("Bef")
Cwsurface_after_data <- load_data("Aft")
```

### 1.5 Witness Surface Data

<!-- This section loads surface data from Witness sample for complete comparison -->

```{r load_wit_surface_data}
# Function to load and process surface data from calibration wafers
# This is similar to the regular surface data function but with different file paths
load_data <- function(condition) {
  # Function to load and process particle data for a single sample
  load_particle_data <- function(trial_number, cond) {
    tryCatch({
      particle_path <- sprintf("/Volumes/BRANDONMEGA/Research/Dust_Contamination/Trials/Data/Witness/Witness_%s_%d/Particles_Witness_%s_%d.csv", 
                             cond, trial_number, cond, trial_number)
      
      particle_data <- read_csv(particle_path)
      particle_data <- particle_data[, 2:(ncol(particle_data)-2)]
      particle_data$Trial <- trial_number
      
      return(particle_data)
    }, error = function(e) {
      message(sprintf("Error loading particle data for %s Trial %d", 
                     cond, trial_number, e$message))
      return(NULL)
    })
  }

  # Load and process summary data
  load_summary_data <- function(trial_number, cond) {
    tryCatch({
      summary_path <- sprintf("/Volumes/BRANDONMEGA/Research/Dust_Contamination/Trials/Data/Witness/Witness_%s_%d/Summary_Witness_%s_%d.csv", 
                            cond, trial_number, cond, trial_number)
      
      summary_data <- read_csv(summary_path, col_select = c(1, 2, 3, 5))
      names(summary_data) <- make.names(names(summary_data))
      summary_data <- summary_data %>% 
        drop_na() %>%
        mutate(
          Trial = trial_number,
          Slice_Number = as.integer(substr(Slice, nchar(Slice)-6, nchar(Slice)-4))
        )
      
      return(summary_data)
    }, error = function(e) {
      message(sprintf("Error loading summary data for %s Trial %d", 
                     cond, trial_number, e$message))
      return(NULL)
    })
  }

  # Load data for trial 12 (5 samples)
  surface_particle_data <- map2(rep(9:14, each = 1), rep(1, times = 6), 
                              ~load_particle_data(.x, condition))
  surface_summary_data <- map2(rep(9:14, each = 1), rep(1, times = 6), 
                             ~load_summary_data(.x, condition))

  # Combine all data
  surface_particle_data <- bind_rows(surface_particle_data)
  surface_summary_data <- bind_rows(surface_summary_data)

  # Add cleaning method information
  add_cleaning_method <- function(data) {
    data %>%
      mutate(Cleaning_Method = case_when(
        Trial %in% c(2, 3) ~ "IPA rinse",
        Trial %in% c(4, 5) ~ "Drag and wipe",
        Trial %in% c(6, 7) ~ "First contact",
        Trial %in% c(8, 9, 10, 11, 12,13,14) ~ "First contact & Drag and wipe",
        TRUE ~ NA_character_
      ))
  }

  surface_particle_data <- add_cleaning_method(surface_particle_data)
  surface_summary_data <- add_cleaning_method(surface_summary_data)

  # Calculate imaged areas
  image_size <- 600 * 450 # microns^2
  trial_areas <- surface_summary_data %>%
    group_by(Trial, Cleaning_Method) %>%
    summarise(
      Total_Images = n(),
      Total_Area = Total_Images * image_size * 1e-12, # Convert to m^2
      .groups = "drop"
    )

  list(particle_data = surface_particle_data, 
       summary_data = surface_summary_data, 
       trial_areas = trial_areas)
}

# Load before and after calibration surface data
Witsurface_before_data <- load_data("bef")
Witsurface_after_data <- load_data("aft")
```

## 2. Surface Area Distribution Analysis

<!-- This section analyzes the particle size distribution on the sample surfaces -->

```{r surface_area_distribution_analysis}
# Filter surface particles by minimum area (1 )
surface_before_particles <- surface_before_data$particle_data %>%
 filter(Area > 1, Area < 6000) 
surface_after_particles <- surface_after_data$particle_data %>%
 filter(Area > 1, Area < 6000) 
combined_surface_data <- bind_rows(surface_before_particles,surface_after_particles)

# Create logarithmically spaced area thresholds from minimum to maximum particle size
min_area <- 1  # Starting from 1 as per previous filter
max_area <- max(combined_surface_data$Area)
log_min <- log10(min_area)
log_max <- log10(max_area)

# Create 250 evenly spaced points on log scale for binning particles
area_thresholds <- 10^(seq(log_min, log_max, length.out = 100))

# Define IEST standard parameters (Industry standard for contamination control)
# and calculate sample areas for normalization
slope <- -0.926  # Standard IEST slope
image_size <- 600 * 450 
new_sample_areas <- surface_before_data$summary_data %>%
  group_by(Sample, Trial, Cleaning_Method) %>%
  summarise(
    Total_Images = n(),
    Total_Area = n() * image_size * 1e-12,  # Convert to m^2
    .groups = "drop"
  )


# Function to get area-based counts - counts particles that exceed each threshold
# and applies normalization factor to standardize to 0.1 m²
get_area_counts <- function(data, area_thresholds, normalization_factor) {
  # Initialize counts vector
  counts <- numeric(length(area_thresholds))
  areas <- numeric(length(area_thresholds))
    
  # For bins except the last one
  for(i in 1:(length(area_thresholds) - 1)) {
    bin_particles <- data$Area >= area_thresholds[i] & data$Area < area_thresholds[i + 1]
    counts[i] <- sum(bin_particles) * normalization_factor
    areas[i] <- sum(data$Area[bin_particles]) * normalization_factor
  }
  
  # For the last bin
    last_bin <- data$Area >= area_thresholds[length(area_thresholds)]
  counts[length(area_thresholds)] <- sum(last_bin) * normalization_factor
  areas[length(area_thresholds)] <- sum(data$Area[last_bin]) * normalization_factor

  
  # Return results in the same format as expected by the original code
  tibble(
    Area = area_thresholds,
    Count = counts,
    Scatter_Area = areas
  )
}



# Calculate area-based counts for before and after data
# Normalizes each sample to 0.1 m² for standardized comparison
surface_before_counts <- surface_before_particles %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <- 0.1 /  new_sample_areas$Total_Area[new_sample_areas$Sample == .y$Sample &  new_sample_areas$Trial == .y$Trial]
    get_area_counts(.x,area_thresholds, norm_factor)
  })

surface_after_counts <- surface_after_data$particle_data %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <- 0.1 /  new_sample_areas$Total_Area[new_sample_areas$Sample == .y$Sample &  new_sample_areas$Trial == .y$Trial]
  get_area_counts(.x, area_thresholds, norm_factor)
  })

# Calculate differences (after - before) to get contamination effect
# and find positive differences (actual contamination)
surface_diff <- surface_after_counts %>%
  full_join(surface_before_counts, 
            by = c("Trial", "Sample", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Scatter_Diff = Scatter_Area_After - Scatter_Area_Before,
         Positive_Count_Diff = pmax(Count_Diff, 0),
         Positive_Scatter_Diff = pmax(Scatter_Diff, 0))

# Calculate cumulative counts (running sum of particles larger than threshold)
cumulative_surface <- surface_diff %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Positive_Count_Diff),
         Cumulative_Scatter = rev(cumsum(rev(Positive_Scatter_Diff)))) %>%
  ungroup()

binned_surface <- surface_diff %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  ungroup()

# Calculate average counts by trial to reduce noise from individual samples
average_surface_cumulative <- cumulative_surface %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count = log10(Average_Count),
         log_scatter = log10(Average_Scatter),
         log_count = ifelse(log_count < 0, 0, log_count),
         log_scatter = ifelse(log_scatter < 0, 0, log_scatter))

# Extract trial 12 data for later comparison
surface_9 <- average_surface_cumulative %>% 
  filter( Trial == 9)

surface_10 <- average_surface_cumulative %>% 
  filter( Trial == 10)

surface_11 <- average_surface_cumulative %>% 
  filter( Trial == 11)

surface_12 <- average_surface_cumulative %>% 
  filter( Trial == 12)

surface_13 <- average_surface_cumulative %>% 
  filter( Trial == 13)

surface_14 <- average_surface_cumulative %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
surface_average <- bind_rows(surface_9, surface_10, surface_11, surface_12) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

surface_average_air <- bind_rows(surface_13, surface_14) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

# Calculate average counts by trial to reduce noise from individual samples
average_surface_binned <- binned_surface %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Positive_Count_Diff, na.rm = TRUE),
    Average_Scatter = mean(Positive_Scatter_Diff, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count_bin = log10(Average_Count),
         log_scatter_bin = log10(Average_Scatter),
         log_count_bin = ifelse(log_count_bin < 0, 0, log_count_bin),
         log_scatter_bin = ifelse(log_scatter_bin < 0, 0, log_scatter_bin))



# Extract trials binned data for later comparison
surface_9_binned <- average_surface_binned %>% 
  filter( Trial == 9)

surface_10_binned <- average_surface_binned %>% 
  filter( Trial == 10)

surface_11_binned <- average_surface_binned %>% 
  filter( Trial == 11)

surface_12_binned <- average_surface_binned %>% 
  filter( Trial == 12)

surface_13_binned <- average_surface_binned %>% 
  filter( Trial == 13)

surface_14_binned <- average_surface_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
surface_average_binned <- bind_rows(surface_9_binned, surface_10_binned, surface_11_binned, surface_12_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )

surface_average_air_binned <- bind_rows(surface_13_binned, surface_14_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )

```

## 3. Edge Area Distribution Analysis

<!-- This section analyzes particle distributions on the edges of samples -->

```{r edge_area_distribution_analysis}

edge_particles_data <- edge_particles_data %>%
  filter(Area > 1) %>% 
  filter(Area < 6000)

# Calculate normalization factors for edge measurements
new_edge_factors<- edge_summary_data %>%
  group_by(Sample, Trial) %>%
  summarise(
    Total_Width = sum(width)* 1e-6,  # Convert microns to meters
    .groups = "drop"
  )

# Calculate area-based counts for edge data using the same function as surface data
edge_counts <- edge_particles_data %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <-  0.1 / new_edge_factors$Total_Width[new_edge_factors$Sample == .y$Sample & new_edge_factors$Trial == .y$Trial]
    get_area_counts(.x, area_thresholds, norm_factor)
  })

# Calculate cumulative counts (particles larger than each threshold)
cumulative_edge <- edge_counts %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Count),
         Cumulative_Scatter = rev(cumsum(rev(Scatter_Area)))) %>%
  ungroup()

# Calculate cumulative counts (particles larger than each threshold)
binned_edge <- edge_counts %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  ungroup()

# Calculate average counts by trial to reduce sample variation
average_edge_cumulative <- cumulative_edge %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count = log10(Average_Count),
         log_scatter = log10(Average_Scatter),
         log_count = ifelse(log_count < 0, 0, log_count),
         log_scatter = ifelse(log_scatter < 0, 0, log_scatter)) %>% 
  arrange(Trial, desc(Area)) 

edge_9 <- average_edge_cumulative %>% 
  filter( Trial == 9)

edge_10 <- average_edge_cumulative %>% 
  filter( Trial == 10)

edge_11 <- average_edge_cumulative %>% 
  filter( Trial == 11)

edge_12 <- average_edge_cumulative %>% 
  filter( Trial == 12)

edge_13 <- average_edge_cumulative %>% 
  filter( Trial == 13)

edge_14 <- average_edge_cumulative %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
edge_average <- bind_rows(edge_9, edge_10, edge_11, edge_12) %>%
  group_by(Area, log_area) %>%
  summarize(
       Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

edge_average_air <- bind_rows(edge_13, edge_14) %>%
  group_by(Area, log_area) %>%
  summarize(
       Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

# Calculate average counts by trial to reduce noise from individual samples
average_edge_binned <- binned_edge %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter_Area, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count_bin = log10(Average_Count),
         log_scatter_bin = log10(Average_Scatter),
         log_count_bin = ifelse(log_count_bin < 0, 0, log_count_bin),
         log_scatter_bin = ifelse(log_scatter_bin < 0, 0, log_scatter_bin))


edge_9_binned <- average_edge_binned %>% 
  filter( Trial == 9)

edge_10_binned <- average_edge_binned %>% 
  filter( Trial == 10)

edge_11_binned <- average_edge_binned %>% 
  filter( Trial == 11)

edge_12_binned <- average_edge_binned %>% 
  filter( Trial == 12)

edge_13_binned <- average_edge_binned %>% 
  filter( Trial == 13)

edge_14_binned <- average_edge_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
edge_average_binned <- bind_rows(edge_9_binned, edge_10_binned, edge_11_binned, edge_12_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
      Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )

edge_average_air_binned <- bind_rows(edge_13_binned, edge_14_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
      Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )

```

## 4. Calibration Wafer Analysis - Edge

<!-- This section analyzes particle distributions on calibration wafer edges for comparison with sample edges -->

```{r calibration_wafer_analysis_edge}

calibration_particles_data <- calibration_particles_data %>%
  filter(Area > 1) %>% 
  filter(Area < 6000)

# Calculate normalization factors for edge measurements
new_calibration_factors<- calibration_summary_data %>%
  group_by(Sample, Trial) %>%
  summarise(
    Total_Width = sum(width)* 1e-6,  # Convert microns to meters
    .groups = "drop"
  )

# Filter qualified particles and associate them with the correct image
cw_particles_data_edge <- calibration_particles_data %>%
  filter(IsQualified == 1) %>%
  group_by(Sample, Trial) %>%
  mutate(
    ParticleIndex = row_number(),
    # Find which image a particle belongs to based on cumulative counts
    Image = findInterval(ParticleIndex, calibration_summary_data$CumulativeCount[calibration_summary_data$Sample == first(Sample) & calibration_summary_data$Trial == first(Trial)]) + 1
  ) %>%
  ungroup()


# Calculate area-based counts for edge data using the same function as surface data
cw_edge_counts <- cw_particles_data_edge %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <-  0.1 / new_calibration_factors$Total_Width[new_calibration_factors$Sample == .y$Sample & new_calibration_factors$Trial == .y$Trial]
    get_area_counts(.x, area_thresholds, norm_factor)
  })

# Calculate cumulative counts (particles larger than each threshold)
cw_cumulative_edge <- cw_edge_counts %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Count),
         Cumulative_Scatter = rev(cumsum(rev(Scatter_Area)))) %>%
  ungroup()

# Calculate cumulative counts (particles larger than each threshold)
cw_binned_edge <- cw_edge_counts %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  ungroup()

# Calculate average counts by trial to reduce sample variation
cw_average_edge_cumulative <- cw_cumulative_edge %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count = log10(Average_Count),
         log_scatter = log10(Average_Scatter),
         log_count = ifelse(log_count < 0, 0, log_count),
         log_scatter = ifelse(log_scatter < 0, 0, log_scatter)) %>% 
  arrange(Trial, desc(Area)) 

cw_edge_9 <- cw_average_edge_cumulative %>% 
  filter( Trial == 9)

cw_edge_10 <- cw_average_edge_cumulative %>% 
  filter( Trial == 10)

cw_edge_11 <- cw_average_edge_cumulative %>% 
  filter( Trial == 11)

cw_edge_12 <- cw_average_edge_cumulative %>% 
  filter( Trial == 12)

cw_edge_13 <- cw_average_edge_cumulative %>% 
  filter( Trial == 13)

cw_edge_14 <- cw_average_edge_cumulative %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
cw_edge_average <- bind_rows(cw_edge_9, cw_edge_10, cw_edge_11, cw_edge_12) %>%
  group_by(Area, log_area) %>%
  summarize(
       Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

cw_edge_average_air <- bind_rows(cw_edge_13, cw_edge_14) %>%
  group_by(Area, log_area) %>%
  summarize(
       Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

# Calculate average counts by trial to reduce noise from individual samples
cw_average_edge_binned <- cw_binned_edge %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter_Area, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count_bin = log10(Average_Count),
         log_scatter_bin = log10(Average_Scatter),
         log_count_bin = ifelse(log_count_bin < 0, 0, log_count_bin),
         log_scatter_bin = ifelse(log_scatter_bin < 0, 0, log_scatter_bin))


cw_edge_9_binned <- cw_average_edge_binned %>% 
  filter( Trial == 9)

cw_edge_10_binned <- cw_average_edge_binned %>% 
  filter( Trial == 10)

cw_edge_11_binned <- cw_average_edge_binned %>% 
  filter( Trial == 11)

cw_edge_12_binned <- cw_average_edge_binned %>% 
  filter( Trial == 12)

cw_edge_13_binned <- cw_average_edge_binned %>% 
  filter( Trial == 13)

cw_edge_14_binned <- cw_average_edge_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
cw_edge_average_binned <- bind_rows(cw_edge_9_binned, cw_edge_10_binned, cw_edge_11_binned, cw_edge_12_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
      Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )

cw_edge_average_air_binned <- bind_rows(cw_edge_13_binned, cw_edge_14_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
      Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )

```

## 5. Calibration Surface Analysis

<!-- This section analyzes particle distributions on calibration wafer surfaces -->

```{r cal_surface_area_distribution_analysis}
# Filter surface particles by minimum area (1 )
Cwsurface_before_data$particle_data <- Cwsurface_before_data$particle_data %>%
 filter(Area > 1, Area < 6000) 

Cwsurface_after_data$particle_data <- Cwsurface_after_data$particle_data %>%
 filter(Area > 1, Area < 6000) 


cw_new_sample_areas <- Cwsurface_before_data$summary_data %>%
  group_by(Sample, Trial, Cleaning_Method) %>%
  summarise(
    Total_Images = n(),
    Total_Area = n() * image_size * 1e-12,  # Convert to m^2
    .groups = "drop"
  )

# Calculate area-based counts for before and after data
# Normalizes each sample to 0.1 m² for standardized comparison
cw_surface_before_counts <- Cwsurface_before_data$particle_data %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <- 0.1 /  cw_new_sample_areas$Total_Area[cw_new_sample_areas$Sample == .y$Sample &  cw_new_sample_areas$Trial == .y$Trial]
    get_area_counts(.x,area_thresholds, norm_factor)
  })

cw_surface_after_counts <- Cwsurface_after_data$particle_data %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <- 0.1 /  cw_new_sample_areas$Total_Area[cw_new_sample_areas$Sample == .y$Sample &  cw_new_sample_areas$Trial == .y$Trial]
  get_area_counts(.x, area_thresholds, norm_factor)
  })

# Calculate differences (after - before) to get contamination effect
# and find positive differences (actual contamination)
cw_surface_diff <- cw_surface_after_counts %>%
  full_join(cw_surface_before_counts, 
            by = c("Trial", "Sample", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Scatter_Diff = Scatter_Area_After - Scatter_Area_Before,
         Positive_Count_Diff = pmax(Count_Diff, 0),
         Positive_Scatter_Diff = pmax(Scatter_Diff, 0))

# Calculate cumulative counts (running sum of particles larger than threshold)
cw_cumulative_surface <- cw_surface_diff %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Positive_Count_Diff),
         Cumulative_Scatter = rev(cumsum(rev(Positive_Scatter_Diff)))) %>%
  ungroup()

cw_binned_surface <- cw_surface_diff %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  ungroup()

# Calculate average counts by trial to reduce noise from individual samples
cw_average_surface_cumulative <- cw_cumulative_surface %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count = log10(Average_Count),
         log_scatter = log10(Average_Scatter),
         log_count = ifelse(log_count < 0, 0, log_count),
         log_scatter = ifelse(log_scatter < 0, 0, log_scatter))

# Extract trial 12 data for later comparison
cw_surface_9 <- cw_average_surface_cumulative %>% 
  filter( Trial == 9)

cw_surface_10 <- cw_average_surface_cumulative %>% 
  filter( Trial == 10)

cw_surface_11 <- cw_average_surface_cumulative %>% 
  filter( Trial == 11)

cw_surface_12 <- cw_average_surface_cumulative %>% 
  filter( Trial == 12)

cw_surface_13 <- cw_average_surface_cumulative %>% 
  filter( Trial == 13)

cw_surface_14 <- cw_average_surface_cumulative %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
cw_surface_average <- bind_rows(cw_surface_9, cw_surface_10, cw_surface_11, cw_surface_12) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

cw_surface_average_air <- bind_rows(cw_surface_13, cw_surface_14) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

# Calculate average counts by trial to reduce noise from individual samples
cw_average_surface_binned <- cw_binned_surface %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Positive_Count_Diff, na.rm = TRUE),
    Average_Scatter = mean(Positive_Scatter_Diff, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count_bin = log10(Average_Count),
         log_scatter_bin = log10(Average_Scatter),
         log_count_bin = ifelse(log_count_bin < 0, 0, log_count_bin),
         log_scatter_bin = ifelse(log_scatter_bin < 0, 0, log_scatter_bin))

# Extract trials binned data for later comparison
cw_surface_9_binned <- cw_average_surface_binned %>% 
  filter( Trial == 9)

cw_surface_10_binned <- cw_average_surface_binned %>% 
  filter( Trial == 10)

cw_surface_11_binned <- cw_average_surface_binned %>% 
  filter( Trial == 11)

cw_surface_12_binned <- cw_average_surface_binned %>% 
  filter( Trial == 12)

cw_surface_13_binned <- cw_average_surface_binned %>% 
  filter( Trial == 13)

cw_surface_14_binned <- cw_average_surface_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
cw_surface_average_binned <- bind_rows(cw_surface_9_binned, cw_surface_10_binned, cw_surface_11_binned, cw_surface_12_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )

cw_surface_average_air_binned <- bind_rows(cw_surface_13_binned, cw_surface_14_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )

```

## 6. Witness Surface Analysis

<!-- This section analyzes particle distributions on calibration wafer surfaces -->

```{r wit_surface_area_distribution_analysis}
# Filter surface particles by minimum area (1 )
wit_surface_before_particles <- Witsurface_before_data$particle_data %>%
  filter(Area > 1) %>% 
  filter(Area < 6000)

wit_surface_after_particles <- Witsurface_after_data$particle_data %>%
  filter(Area > 1) %>% 
  filter(Area < 6000)

wit_combined_surface_data <- bind_rows(wit_surface_before_particles,wit_surface_after_particles)

wit_new_sample_areas <- Witsurface_before_data$summary_data %>%
  group_by(Trial, Cleaning_Method) %>%
  summarise(
    Total_Images = n(),
    Total_Area = n() * image_size * 1e-12,  # Convert to m^2
    .groups = "drop"
  )

# Calculate area-based counts for before and after data
# Normalizes each sample to 0.1 m² for standardized comparison
wit_surface_before_counts <- wit_surface_before_particles %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <- 0.1 /  wit_new_sample_areas$Total_Area[wit_new_sample_areas$Trial == .y$Trial]
    get_area_counts(.x,area_thresholds, norm_factor)
  })

wit_surface_after_counts <- Witsurface_after_data$particle_data %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <- 0.1 /  wit_new_sample_areas$Total_Area[wit_new_sample_areas$Trial == .y$Trial]
  get_area_counts(.x, area_thresholds, norm_factor)
  })

# Calculate differences (after - before) to get contamination effect
# and find positive differences (actual contamination)
wit_surface_diff <- wit_surface_after_counts %>%
  full_join(wit_surface_before_counts, 
            by = c("Trial", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Scatter_Diff = Scatter_Area_After - Scatter_Area_Before,
         Positive_Count_Diff = pmax(Count_Diff, 0),
         Positive_Scatter_Diff = pmax(Scatter_Diff, 0))

# Calculate cumulative counts (running sum of particles larger than threshold)
wit_cumulative_surface <- wit_surface_diff %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Positive_Count_Diff),
         Cumulative_Scatter = rev(cumsum(rev(Positive_Scatter_Diff)))) %>%
  ungroup()

wit_binned_surface <- wit_surface_diff %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%
  ungroup()

# Calculate average counts by trial to reduce noise from individual samples
wit_average_surface_cumulative <- wit_cumulative_surface %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count = log10(Average_Count),
         log_scatter = log10(Average_Scatter),
         log_count = ifelse(log_count < 0, 0, log_count),
         log_scatter = ifelse(log_scatter < 0, 0, log_scatter))

# Extract trial 12 data for later comparison
wit_surface_9 <- wit_average_surface_cumulative %>% 
  filter( Trial == 9)

wit_surface_10 <- wit_average_surface_cumulative %>% 
  filter( Trial == 10)

wit_surface_11 <- wit_average_surface_cumulative %>% 
  filter( Trial == 11)

wit_surface_12 <- wit_average_surface_cumulative %>% 
  filter( Trial == 12)

wit_surface_13 <- wit_average_surface_cumulative %>% 
  filter( Trial == 13)

wit_surface_14 <- wit_average_surface_cumulative %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
wit_surface_average <- bind_rows(wit_surface_9, wit_surface_10, wit_surface_11, wit_surface_12) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

wit_surface_average_air <- bind_rows(wit_surface_13, wit_surface_14) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

# Calculate average counts by trial to reduce noise from individual samples
wit_average_surface_binned <- wit_binned_surface %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Positive_Count_Diff, na.rm = TRUE),
    Average_Scatter = mean(Positive_Scatter_Diff, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area),
         log_count_bin = log10(Average_Count),
         log_scatter_bin = log10(Average_Scatter),
         log_count_bin = ifelse(log_count_bin < 0, 0, log_count_bin),
         log_scatter_bin = ifelse(log_scatter_bin < 0, 0, log_scatter_bin))

# Extract trials binned data for later comparison
wit_surface_9_binned <- wit_average_surface_binned %>% 
  filter( Trial == 9)

wit_surface_10_binned <- wit_average_surface_binned %>% 
  filter( Trial == 10)

wit_surface_11_binned <- wit_average_surface_binned %>% 
  filter( Trial == 11)

wit_surface_12_binned <- wit_average_surface_binned %>% 
  filter( Trial == 12)

wit_surface_13_binned <- wit_average_surface_binned %>% 
  filter( Trial == 13)

wit_surface_14_binned <- wit_average_surface_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
wit_surface_average_binned <- bind_rows(wit_surface_9_binned, wit_surface_10_binned, wit_surface_11_binned, wit_surface_12_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )

wit_surface_average_air_binned <- bind_rows(wit_surface_13_binned, wit_surface_14_binned) %>%
  group_by(Area, log_area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    Average_Scatter = mean(Average_Scatter, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )
```

## 6. Edge Model Analysis

<!-- This section creates a model to predict edge contamination from surface contamination data -->

```{r edge_model_analysis}
# Get sample areas for normalization
new_sample_areas <- surface_before_data$summary_data %>%
  group_by(Sample, Trial, Cleaning_Method) %>%
  summarise(
    Total_Images = n(),
    Total_Area = n() * image_size * 1e-12,  # Convert to m^2
    .groups = "drop"
  )

# New function to sum areas of particles within threshold bins
# Not just counting particles but summing their areas
get_area_sums <- function(data, area_thresholds, normalization_factor) {
  # Initialize sums vector
  areas <- numeric(length(area_thresholds))
  counts <- numeric(length(area_thresholds))
  
  # For all bins except the last one
  for(i in 1:(length(area_thresholds) - 1)) {
    # Sum areas of particles that fall within this bin
    bin_mask <- data$Area >= area_thresholds[i] & data$Area < area_thresholds[i + 1]
    areas[i] <- sum(data$Area[bin_mask], na.rm = TRUE) * normalization_factor
  }
  
  # Handle the last bin separately
  last_bin_mask <- data$Area >= area_thresholds[length(area_thresholds)]
  areas[length(area_thresholds)] <- sum(data$Area[last_bin_mask], na.rm = TRUE) * normalization_factor
  
  # Also calculate counts (similar to get_area_counts function)
  for(i in 1:(length(area_thresholds) - 1)) {
    counts[i] <- sum(data$Area >= area_thresholds[i] & 
                    data$Area < area_thresholds[i + 1]) * normalization_factor
  }
  
  # For the last bin
  counts[length(area_thresholds)] <- sum(data$Area >= area_thresholds[length(area_thresholds)]) * normalization_factor
  
  # Return both counts and areas
  tibble(
    Area = area_thresholds,
    Count = counts,
    areas = areas
  )
}

# Calculate model parameters using area summation for after contamination
model_surface_after <- surface_after_data$particle_data %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <- 0.1 / new_sample_areas$Total_Area[new_sample_areas$Sample == .y$Sample & new_sample_areas$Trial == .y$Trial]
    areas <- get_area_sums(.x, area_thresholds, norm_factor)
    tibble(
      Area = area_thresholds,
      Total_Area = areas$areas,
      Count = areas$Count,
      norm_factor = norm_factor
    )
  }) 

# Calculate model parameters for before contamination
model_surface_before <- surface_before_data$particle_data %>%
  group_by(Trial, Sample) %>%
  group_modify(~ {
    norm_factor <- 0.1 / new_sample_areas$Total_Area[new_sample_areas$Sample == .y$Sample & new_sample_areas$Trial == .y$Trial]
    areas <- get_area_sums(.x, area_thresholds, norm_factor)
    tibble(
      Area = area_thresholds,
      Total_Area = areas$areas,
      Count = areas$Count
    )
  }) 

# Calculate differences to isolate contamination effect
model_surface_diff <- model_surface_after %>%
  full_join(model_surface_before, 
            by = c("Trial", "Sample", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Area_Diff = Total_Area_After - Total_Area_Before,
         Positive_Diff_Count = pmax(Count_Diff, 0),
         Positive_Diff_Area = pmax(Area_Diff, 0))

# Calculate model parameters using area-based approach
# This implements the surface-to-edge contamination model
model_edge_data <- model_surface_diff %>%
  group_by(Trial, Sample, Area) %>%
  mutate(
    # Calculate F = sum of particle areas / box area
    F = (Positive_Diff_Area * 1e-12) / (.1),
    
    # Calculate D (diameter) from Area
    D = (2 * sqrt(Area/pi))* 1e-6,
    
    # Calculate nl (number per unit length) = 4F/πD
    nl = (4 * F) / (pi * D),
    
    # Calculate total particles on edge
    Nedge = nl * .1
  ) %>%
  ungroup()

# Calculate cumulative counts for modeled edge particles
model_cumulative_counts <- model_edge_data %>%
  group_by(Trial, Sample) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Nedge)) %>%
  ungroup()

# Calculate average modeled counts by trial
model_average_edge_cumulative <- model_cumulative_counts %>%
  group_by(Trial, Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(log_area = log10(Area) - log10(2),
         log_count = log10(Average_Count),
         log_count = ifelse(log_count < 0, 0, log_count))


model_edge_9 <- model_average_edge_cumulative %>% 
  filter( Trial == 9)

model_edge_10 <- model_average_edge_cumulative %>% 
  filter( Trial == 10)

model_edge_11 <- model_average_edge_cumulative %>% 
  filter( Trial == 11)

model_edge_12 <- model_average_edge_cumulative %>% 
  filter( Trial == 12)

model_edge_13 <- model_average_edge_cumulative %>% 
  filter( Trial == 13)

model_edge_14 <- model_average_edge_cumulative %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
model_edge_average <- bind_rows(model_edge_9, model_edge_10, model_edge_11, model_edge_12) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    .groups = "drop"
  )

model_edge_average_air <- bind_rows(model_edge_13, model_edge_14) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    .groups = "drop"
  )

# Convert to binned data for size distribution analysis
model_average_edge_binned <- model_average_edge_cumulative %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%  # Ensure data is sorted by descending area
  mutate(
    Count = c(Average_Count[1], diff(Average_Count))  # First value is the total, then differences
  ) %>%
  ungroup() %>% 
  mutate(log_count_bin = log10(Count),
         log_count_bin = ifelse(log_count_bin < 0, 0, log_count_bin))

model_edge_9_binned <- model_average_edge_binned %>% 
  filter( Trial == 9)

model_edge_10_binned <- model_average_edge_binned %>% 
  filter( Trial == 10)

model_edge_11_binned <- model_average_edge_binned %>% 
  filter( Trial == 11)

model_edge_12_binned <- model_average_edge_binned %>% 
  filter( Trial == 12)

model_edge_13_binned <- model_average_edge_binned %>% 
  filter( Trial == 13)

model_edge_14_binned <- model_average_edge_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
model_edge_average_binned <- bind_rows(model_edge_9_binned, model_edge_10_binned, model_edge_11_binned, model_edge_12_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    .groups = "drop"
  )

# Calculate the average of trials 9 through 12
model_edge_average_air_binned <- bind_rows(model_edge_13_binned, model_edge_14_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Average_Count, na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    .groups = "drop"
  )


```

## 7. Straight Line Model (SLSM)

```{r Straight_Line_Model}
## 9. Edge Contamination Line Intersection Analysis
# This section simulates drawing a line across surfaces and analyzes how particles intersect with it
get_area_counts <- function(data, area_thresholds, normalization_factor) {
  # Initialize counts vector
  counts <- numeric(length(area_thresholds))
  areas <- numeric(length(area_thresholds))
    
  # For bins except the last one
  for(i in 1:(length(area_thresholds) - 1)) {
    
     bin_particles <- data$overhang_area >= area_thresholds[i] & data$overhang_area < area_thresholds[i + 1]
    counts[i] <- sum(bin_particles) * normalization_factor
    areas[i] <- sum(data$overhang_area[bin_particles]) * normalization_factor
  }
  
  # For the last bin
  last_bin <- data$overhang_area >= area_thresholds[length(area_thresholds)]
  counts[length(area_thresholds)] <- sum(last_bin) * normalization_factor
  areas[length(area_thresholds)] <- sum(data$overhang_area[last_bin]) * normalization_factor

  
  # Return results in the same format as expected by the original code
  tibble(
    Area = area_thresholds,
    Count = counts,
    Scatter_Area = areas
  )
}



# Filter Trial 12 data from both surfaces, BEFORE contamination
starshade_surface_before9 <- surface_before_particles %>%
  filter(Trial == 9) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_before9 <- Cwsurface_before_data$particle_data %>%
  filter(Trial == 9, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
starshade_surface_after9 <- surface_after_particles %>%
  filter(Trial == 9) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_after9 <- Cwsurface_after_data$particle_data %>%
  filter(Trial == 9, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

starshade_surface_before10 <- surface_before_particles %>%
  filter(Trial == 10) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_before10 <- Cwsurface_before_data$particle_data %>%
  filter(Trial == 10, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
starshade_surface_after10 <- surface_after_particles %>%
  filter(Trial == 10) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_after10 <- Cwsurface_after_data$particle_data %>%
  filter(Trial == 10, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

starshade_surface_before11 <- surface_before_particles %>%
  filter(Trial == 11) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_before11 <- Cwsurface_before_data$particle_data %>%
  filter(Trial == 11, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
starshade_surface_after11 <- surface_after_particles %>%
  filter(Trial == 11) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_after11 <- Cwsurface_after_data$particle_data %>%
  filter(Trial == 11, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

starshade_surface_before12 <- surface_before_particles %>%
  filter(Trial == 12) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_before12 <- Cwsurface_before_data$particle_data %>%
  filter(Trial == 12, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
starshade_surface_after12 <- surface_after_particles %>%
  filter(Trial == 12) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_after12 <- Cwsurface_after_data$particle_data %>%
  filter(Trial == 12, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

starshade_surface_before13 <- surface_before_particles %>%
  filter(Trial == 13) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_before13 <- Cwsurface_before_data$particle_data %>%
  filter(Trial == 13, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
starshade_surface_after13 <- surface_after_particles %>%
  filter(Trial == 13) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_after13 <- Cwsurface_after_data$particle_data %>%
  filter(Trial == 13, Area > 1) %>%
  select(Area, BX, BY, Width, Height)


starshade_surface_before14 <- surface_before_particles %>%
  filter(Trial == 14) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_before14 <- Cwsurface_before_data$particle_data %>%
  filter(Trial == 14, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
starshade_surface_after14 <- surface_after_particles %>%
  filter(Trial == 14) %>%
  select(Area, BX, BY, Width, Height)

calibration_surface_after14 <- Cwsurface_after_data$particle_data %>%
  filter(Trial == 14, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_before9 <- Witsurface_before_data$particle_data %>%
  filter(Trial == 9) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_before10 <- Witsurface_before_data$particle_data %>%
  filter(Trial == 10, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_before11 <- Witsurface_before_data$particle_data %>%
  filter(Trial == 11) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_before12 <- Witsurface_before_data$particle_data %>%
  filter(Trial == 12, Area > 1) %>%
  select(Area, BX, BY, Width, Height)
witness_surface_before13 <- Witsurface_before_data$particle_data %>%
  filter(Trial == 13, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_before14 <- Witsurface_before_data$particle_data %>%
  filter(Trial == 14, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Filter Trial 12 data from both surfaces, AFTER contamination
witness_surface_after9 <- Witsurface_after_data$particle_data %>%
  filter(Trial == 9) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_after10 <- Witsurface_after_data$particle_data %>%
  filter(Trial == 10, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_after11 <- Witsurface_after_data$particle_data %>%
  filter(Trial == 11) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_after12 <- Witsurface_after_data$particle_data %>%
  filter(Trial == 12, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_after13 <- Witsurface_after_data$particle_data %>%
  filter(Trial == 13, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

witness_surface_after14 <- Witsurface_after_data$particle_data %>%
  filter(Trial == 14, Area > 1) %>%
  select(Area, BX, BY, Width, Height)

# Calculate image dimensions for positioning
image_width <- 600  
image_height <- 450 

# Function to check if a particle intersects with a horizontal line and calculate overhang area
# This simulates how a particle would interact with an edge
particle_intersects_line <- function(particle, line_y) {
  # Calculate the top and bottom boundaries of the particle
  particle_top <- particle$BY + particle$Height
  particle_bottom <- particle$BY 
  
  # Check if the line passes through the particle
  if (line_y <= particle_top && line_y >= particle_bottom) {
    # Calculate proportion of area that would overhang
    # Distance from line to top of particle divided by total height
    proportion_above_line <- (particle_top - line_y) / particle$Height
    
    # Calculate the area that would overhang the edge (below the line)
    overhang_area <- particle$Area * (proportion_above_line)
    
    # Return intersection details
    return(list(
      intersects = TRUE,
      area = as.numeric(particle$Area),
      overhang_proportion = as.numeric(proportion_above_line),
      overhang_area = as.numeric(overhang_area),
      diameter = 2 * sqrt(particle$Area / pi),  # Equivalent circular diameter
      distance_from_line = min(line_y - particle_top, particle_bottom - line_y),  # How close to edge of particle
      relative_position = (line_y - particle_top) / particle$Height  # Relative position (0 = top, 1 = bottom)
    ))
  } else {
    return(list(intersects = FALSE))
  }
}

# Function to analyze intersections for a single line
analyze_line_intersections <- function(particles_data, line_positions = NULL) {
  # If no specific positions provided, use middle of image
  if (is.null(line_positions)) {
    line_positions <- image_height / 2
  }
  
  # Initialize results storage
  all_results <- list()
  
  # For each line position
  for (i in 1:length(line_positions)) {
    line_y <- line_positions[i]
    
    # Process each particle to check for intersection
    intersections <- map(1:nrow(particles_data), function(j) {
      particle_intersects_line(particles_data[j,], line_y)
    })
    
    # Filter to only intersecting particles
    intersecting_particles <- intersections[sapply(intersections, function(x) x$intersects)]
    
    # Calculate statistics for this line
    if (length(intersecting_particles) > 0) {
    all_results[[i]] <- list(
      line_position = line_y,
      num_intersections = length(intersecting_particles),
      intersecting_particles = intersecting_particles,
      total_area = sum(sapply(intersecting_particles, function(x) x$area)),
      overhang_area = sum(sapply(intersecting_particles, function(x) x$overhang_area)),
      size_data = tibble(
          area = sapply(intersecting_particles, function(x) x$area),
          diameter = sapply(intersecting_particles, function(x) x$diameter),
          overhang_prop = sapply(intersecting_particles, function(x) x$overhang_proportion)
        )
    )
    } else {
      all_results[[i]] <- list(
        line_position = line_y,
        num_intersections = 0,
        intersecting_particles = list(),
        total_area = 0,
        overhang_area = 0,
        size_data = tibble(area = numeric(0), diameter = numeric(0), overhang_prop = numeric(0))
      )
    }
  }
  
  return(all_results)
}

# Use the middle of the image for the edge simulation line
central_line_y <- image_height / 2

# Analyze both surfaces with the same single line - BEFORE contamination
starshade_before_results9 <- analyze_line_intersections(starshade_surface_before9, c(central_line_y))
witness_before_results9 <- analyze_line_intersections(witness_surface_before9, c(central_line_y))

# Analyze both surfaces with the same single line - AFTER contamination
starshade_after_results9 <- analyze_line_intersections(starshade_surface_after9, c(central_line_y))
witness_after_results9 <- analyze_line_intersections(witness_surface_after9, c(central_line_y))

# Analyze both surfaces with the same single line - BEFORE contamination
starshade_before_results10 <- analyze_line_intersections(starshade_surface_before10, c(central_line_y))
witness_before_results10 <- analyze_line_intersections(witness_surface_before10, c(central_line_y))

# Analyze both surfaces with the same single line - AFTER contamination
starshade_after_results10 <- analyze_line_intersections(starshade_surface_after10, c(central_line_y))
witness_after_results10 <- analyze_line_intersections(witness_surface_after10, c(central_line_y))

# Analyze both surfaces with the same single line - BEFORE contamination
starshade_before_results11 <- analyze_line_intersections(starshade_surface_before11, c(central_line_y))
witness_before_results11 <- analyze_line_intersections(witness_surface_before11, c(central_line_y))

# Analyze both surfaces with the same single line - AFTER contamination
starshade_after_results11 <- analyze_line_intersections(starshade_surface_after11, c(central_line_y))
witness_after_results11 <- analyze_line_intersections(witness_surface_after11, c(central_line_y))

# Analyze both surfaces with the same single line - BEFORE contamination
starshade_before_results12 <- analyze_line_intersections(starshade_surface_before12, c(central_line_y))
calibration_before_results12 <- analyze_line_intersections(calibration_surface_before12, c(central_line_y))
witness_before_results12 <- analyze_line_intersections(witness_surface_before12, c(central_line_y))

# Analyze both surfaces with the same single line - AFTER contamination
starshade_after_results12 <- analyze_line_intersections(starshade_surface_after12, c(central_line_y))
calibration_after_results12 <- analyze_line_intersections(calibration_surface_after12, c(central_line_y))
witness_after_results12 <- analyze_line_intersections(witness_surface_after12, c(central_line_y))

starshade_before_results13 <- analyze_line_intersections(starshade_surface_before13, c(central_line_y))
calibration_before_results13 <- analyze_line_intersections(calibration_surface_before13, c(central_line_y))
witness_before_results13 <- analyze_line_intersections(witness_surface_before13, c(central_line_y))

# Analyze both surfaces with the same single line - AFTER contamination
starshade_after_results13 <- analyze_line_intersections(starshade_surface_after13, c(central_line_y))
calibration_after_results13 <- analyze_line_intersections(calibration_surface_after13, c(central_line_y))
witness_after_results13 <- analyze_line_intersections(witness_surface_after13, c(central_line_y))


starshade_before_results14 <- analyze_line_intersections(starshade_surface_before14, c(central_line_y))
calibration_before_results14 <- analyze_line_intersections(calibration_surface_before14, c(central_line_y))
witness_before_results14 <- analyze_line_intersections(witness_surface_before14, c(central_line_y))

# Analyze both surfaces with the same single line - AFTER contamination
starshade_after_results14 <- analyze_line_intersections(starshade_surface_after14, c(central_line_y))
calibration_after_results14 <- analyze_line_intersections(calibration_surface_after14, c(central_line_y))
witness_after_results14 <- analyze_line_intersections(witness_surface_after14, c(central_line_y))

#Extract the results for the particles that intersect the line
starshade_sim_after9 <- if(length(starshade_after_results9[[1]]$intersecting_particles) > 0) {
  map_df(starshade_after_results9[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "9")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_before9 <- if(length(starshade_before_results9[[1]]$intersecting_particles) > 0) {
  map_df(starshade_before_results9[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "9")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}
starshade_sim_after10 <- if(length(starshade_after_results10[[1]]$intersecting_particles) > 0) {
  map_df(starshade_after_results10[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "10")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_before10 <- if(length(starshade_before_results10[[1]]$intersecting_particles) > 0) {
  map_df(starshade_before_results10[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "10")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_after11 <- if(length(starshade_after_results11[[1]]$intersecting_particles) > 0) {
  map_df(starshade_after_results11[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "11")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_before11 <- if(length(starshade_before_results11[[1]]$intersecting_particles) > 0) {
  map_df(starshade_before_results11[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "11")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_after12 <- if(length(starshade_after_results12[[1]]$intersecting_particles) > 0) {
  map_df(starshade_after_results12[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "12")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_before12 <- if(length(starshade_before_results12[[1]]$intersecting_particles) > 0) {
  map_df(starshade_before_results12[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "12")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}



calibration_sim_after12 <- if(length(calibration_after_results12[[1]]$intersecting_particles) > 0) {
  map_df(calibration_after_results12[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "12")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

calibration_sim_before12 <- if(length(calibration_before_results12[[1]]$intersecting_particles) > 0) {
  map_df(calibration_before_results12[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "12")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}



starshade_sim_after13 <- if(length(starshade_after_results13[[1]]$intersecting_particles) > 0) {
  map_df(starshade_after_results13[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "13")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_before13 <- if(length(starshade_before_results13[[1]]$intersecting_particles) > 0) {
  map_df(starshade_before_results13[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "13")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}



calibration_sim_after13 <- if(length(calibration_after_results13[[1]]$intersecting_particles) > 0) {
  map_df(calibration_after_results13[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "13")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

calibration_sim_before13 <- if(length(calibration_before_results13[[1]]$intersecting_particles) > 0) {
  map_df(calibration_before_results13[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "13")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}




starshade_sim_after14 <- if(length(starshade_after_results14[[1]]$intersecting_particles) > 0) {
  map_df(starshade_after_results14[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "14")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

starshade_sim_before14 <- if(length(starshade_before_results14[[1]]$intersecting_particles) > 0) {
  map_df(starshade_before_results14[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "14")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}



calibration_sim_after14 <- if(length(calibration_after_results14[[1]]$intersecting_particles) > 0) {
  map_df(calibration_after_results14[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "after",
           Trial = "14")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

calibration_sim_before14 <- if(length(calibration_before_results14[[1]]$intersecting_particles) > 0) {
  map_df(calibration_before_results14[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "starshade_surface",
           time = "before",
           Trial = "14")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_after9 <- if(length(witness_after_results9[[1]]$intersecting_particles) > 0) {
  map_df(witness_after_results9[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "after",
           Trial = "9")
} else {
  # Create an empty dataframe with the same structure
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_before9 <- if(length(witness_before_results9[[1]]$intersecting_particles) > 0) {
  map_df(witness_before_results9[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "before",
           Trial = "9")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_after10 <- if(length(witness_after_results10[[1]]$intersecting_particles) > 0) {
  map_df(witness_after_results10[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "after",
           Trial = "10")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_before10 <- if(length(witness_before_results10[[1]]$intersecting_particles) > 0) {
  map_df(witness_before_results10[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "before",
           Trial = "10")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_after11 <- if(length(witness_after_results11[[1]]$intersecting_particles) > 0) {
  map_df(witness_after_results11[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "after",
           Trial = "11")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_before11 <- if(length(witness_before_results11[[1]]$intersecting_particles) > 0) {
  map_df(witness_before_results11[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "before",
           Trial = "11")
} else {
  data.frame(
    intersect = character(0),
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_after12 <- if(length(witness_after_results12[[1]]$intersecting_particles) > 0) {
  map_df(witness_after_results12[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "after",
           Trial = "12")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_before12 <- if(length(witness_before_results12[[1]]$intersecting_particles) > 0) {
  map_df(witness_before_results12[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "before",
           Trial = "12")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}


witness_sim_after13 <- if(length(witness_after_results13[[1]]$intersecting_particles) > 0) {
  map_df(witness_after_results13[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "after",
           Trial = "13")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_before13 <- if(length(witness_before_results13[[1]]$intersecting_particles) > 0) {
  map_df(witness_before_results13[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "before",
           Trial = "13")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}



witness_sim_after14 <- if(length(witness_after_results14[[1]]$intersecting_particles) > 0) {
  map_df(witness_after_results14[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "after",
           Trial = "14")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

witness_sim_before14 <- if(length(witness_before_results14[[1]]$intersecting_particles) > 0) {
  map_df(witness_before_results14[[1]]$intersecting_particles, ~as.data.frame(t(.x))) %>% 
    mutate(area = as.numeric(area),
           overhang_proportion = as.numeric(overhang_proportion),
           overhang_area = as.numeric(overhang_area),
           diameter = as.numeric(diameter),
           distance_from_line = as.numeric(distance_from_line),
           relative_position = as.numeric(relative_position),
           source = "calibration_surface",
           time = "before",
           Trial = "14")
} else {
  data.frame(
    area = numeric(0),
    overhang_proportion = numeric(0),
    overhang_area = numeric(0),
    diameter = numeric(0),
    distance_from_line = numeric(0),
    relative_position = numeric(0),
    source = character(0),
    time = character(0),
    Trial = character(0)
  )
}

# Datasets to work from

s_bmodel_edge_before <- rbind(starshade_sim_before9, starshade_sim_before10, starshade_sim_before11, starshade_sim_before12, starshade_sim_before13, starshade_sim_before14)

s_bmodel_edge_after <- rbind(starshade_sim_after9, starshade_sim_after10, starshade_sim_after11, starshade_sim_after12, starshade_sim_after13, starshade_sim_after14)

w_bmodel_edge_before <- rbind(witness_sim_before9, witness_sim_before10, witness_sim_before11, witness_sim_before12, witness_sim_before13, witness_sim_before14)

w_bmodel_edge_after <- rbind(witness_sim_after9, witness_sim_after10, witness_sim_after11, witness_sim_after12, witness_sim_after13, witness_sim_after14)

c_bmodel_edge_before <- rbind(calibration_sim_before12,calibration_sim_before13,calibration_sim_before14)

c_bmodel_edge_after <- rbind(calibration_sim_after12,calibration_sim_after13,calibration_sim_after14)


# Calculate normalization factors for edge measurements
new_SSLSM_edge_factors<- surface_before_data$summary_data %>%
  group_by(Trial) %>%
  summarise(
    Total_Width = n() * 600 * 1e-6,  # Convert microns to meters
    .groups = "drop"
  )

# Calculate area-based counts for edge data using the same function as surface data
SSLSM_edge_counts_before <- s_bmodel_edge_before %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <-  0.1 / new_SSLSM_edge_factors$Total_Width[new_SSLSM_edge_factors$Trial == .y$Trial]
  get_area_counts(.x, area_thresholds, norm_factor)
  })

SSLSM_edge_counts_after <- s_bmodel_edge_after %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <-  0.1 / new_SSLSM_edge_factors$Total_Width[new_SSLSM_edge_factors$Trial == .y$Trial]
  get_area_counts(.x, area_thresholds, norm_factor)
  })

SSLSM_surface_count_diff <- SSLSM_edge_counts_after %>%
  full_join(SSLSM_edge_counts_before, 
            by = c("Trial", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Positive_Diff = pmax(Count_Diff, 0),
         Scatter_Diff = Scatter_Area_After - Scatter_Area_Before,
         Positive_Scatter = pmax(Scatter_Diff, 0)
         )

# Calculate cumulative counts (particles larger than each threshold)
SSLSM_cumulative_edge_counts <- SSLSM_surface_count_diff %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Positive_Diff),
         Cumulative_Scatter = rev(cumsum(rev(Positive_Scatter)))) %>%
  ungroup() %>%
  mutate(log_area = log10(Area),
         log_count = log10(Cumulative_Count),
         log_count = ifelse(log_count < 0, 0, log_count),
         log_scatter = log10(Cumulative_Scatter),
         log_scatter = ifelse(log_scatter < 0, 0, log_scatter)
         ) %>% 
  arrange(Trial, desc(Area)) 


SSLSM_edge_9 <- SSLSM_cumulative_edge_counts %>% 
  filter( Trial == 9)

SSLSM_edge_10 <- SSLSM_cumulative_edge_counts %>% 
  filter( Trial == 10)

SSLSM_edge_11 <- SSLSM_cumulative_edge_counts %>% 
  filter( Trial == 11)

SSLSM_edge_12 <- SSLSM_cumulative_edge_counts %>% 
  filter( Trial == 12)

SSLSM_edge_13 <- SSLSM_cumulative_edge_counts %>% 
  filter( Trial == 13)

SSLSM_edge_14 <- SSLSM_cumulative_edge_counts %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
SSLSM_edge_average <- bind_rows(SSLSM_edge_9, SSLSM_edge_10, SSLSM_edge_11, SSLSM_edge_12) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

SSLSM_edge_average_air <- bind_rows(SSLSM_edge_13, SSLSM_edge_14) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

# Calculate binned counts from cumulative data
SSLSM_edge_binned <- SSLSM_cumulative_edge_counts %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%  # Ensure data is sorted by descending area
  mutate(
    Count = c(Cumulative_Count[1], diff(Cumulative_Count)),  # First value is the total, then differences
    Scatter = c(Cumulative_Scatter[length(Cumulative_Scatter)], -diff(Cumulative_Scatter))
  ) %>%
  ungroup() %>% 
  mutate(log_count_bin = log10(Count),
          log_count_bin = ifelse(log_count_bin < 0, 0, log_count_bin),
         log_scatter_bin = log10(Scatter),
          log_scatter_bin = ifelse(log_scatter_bin < 0, 0, log_scatter_bin)
         )

SSLSM_edge_9_binned <- SSLSM_edge_binned %>% 
  filter( Trial == 9)

SSLSM_edge_10_binned <- SSLSM_edge_binned %>% 
  filter( Trial == 10)

SSLSM_edge_11_binned <- SSLSM_edge_binned %>% 
  filter( Trial == 11)

SSLSM_edge_12_binned <- SSLSM_edge_binned %>% 
  filter( Trial == 12)

SSLSM_edge_13_binned <- SSLSM_edge_binned %>% 
  filter( Trial == 13)

SSLSM_edge_14_binned <- SSLSM_edge_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
SSLSM_edge_average_binned <- bind_rows(SSLSM_edge_9_binned, SSLSM_edge_10_binned, SSLSM_edge_11_binned, SSLSM_edge_12_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )

SSLSM_edge_average_air_binned <- bind_rows(SSLSM_edge_13_binned, SSLSM_edge_14_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )

#Calibration Wafer Now

# Calculate normalization factors for edge measurements
new_CSLSM_edge_factors<- Cwsurface_before_data$summary_data %>%
  group_by(Trial) %>%
  summarise(
    Total_Width = n() * 600 * 1e-6,  # Convert microns to meters
    .groups = "drop"
  )

# Calculate area-based counts for edge data using the same function as surface data
CSLSM_edge_counts_before <- c_bmodel_edge_before %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <-  0.1 / new_CSLSM_edge_factors$Total_Width[new_CSLSM_edge_factors$Trial == .y$Trial]
  get_area_counts(.x, area_thresholds, norm_factor)
  })

CSLSM_edge_counts_after <- c_bmodel_edge_after %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <-  0.1 / new_CSLSM_edge_factors$Total_Width[new_CSLSM_edge_factors$Trial == .y$Trial]
  get_area_counts(.x, area_thresholds, norm_factor)
  })

CSLSM_surface_count_diff <- CSLSM_edge_counts_after %>%
  full_join(CSLSM_edge_counts_before, 
            by = c("Trial", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Positive_Diff = pmax(Count_Diff, 0),
         Scatter_Diff = Scatter_Area_After - Scatter_Area_Before,
         Positive_Scatter = pmax(Scatter_Diff, 0)
         )

# Calculate cumulative counts (particles larger than each threshold)
CSLSM_cumulative_edge_counts <- CSLSM_surface_count_diff %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Positive_Diff),
         Cumulative_Scatter = rev(cumsum(rev(Positive_Scatter)))) %>%
  ungroup() %>%
  mutate(log_area = log10(Area),
         log_count = log10(Cumulative_Count),
         log_count = ifelse(log_count < 0, 0, log_count),
         log_scatter = log10(Cumulative_Scatter),
         log_scatter = ifelse(log_scatter < 0, 0, log_scatter)
         ) %>% 
  arrange(Trial, desc(Area)) 


CSLSM_edge_9 <- CSLSM_cumulative_edge_counts %>% 
  filter( Trial == 9)

CSLSM_edge_10 <- CSLSM_cumulative_edge_counts %>% 
  filter( Trial == 10)

CSLSM_edge_11 <- CSLSM_cumulative_edge_counts %>% 
  filter( Trial == 11)

CSLSM_edge_12 <- CSLSM_cumulative_edge_counts %>% 
  filter( Trial == 12)

CSLSM_edge_13 <- CSLSM_cumulative_edge_counts %>% 
  filter( Trial == 13)

CSLSM_edge_14 <- CSLSM_cumulative_edge_counts %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
CSLSM_edge_average <- bind_rows(CSLSM_edge_9, CSLSM_edge_10, CSLSM_edge_11, CSLSM_edge_12) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

CSLSM_edge_average_air <- bind_rows(CSLSM_edge_13, CSLSM_edge_14) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

# Calculate binned counts from cumulative data
CSLSM_edge_binned <- CSLSM_cumulative_edge_counts %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%  # Ensure data is sorted by descending area
  mutate(
    Count = c(Cumulative_Count[1], diff(Cumulative_Count)),  # First value is the total, then differences
    Scatter = c(Cumulative_Scatter[length(Cumulative_Scatter)], -diff(Cumulative_Scatter))
  ) %>%
  ungroup() %>% 
  mutate(log_count_bin = log10(Count),
          log_count_bin = ifelse(log_count_bin < 0, 0, log_count_bin),
         log_scatter_bin = log10(Scatter),
          log_scatter_bin = ifelse(log_scatter_bin < 0, 0, log_scatter_bin)
         )

CSLSM_edge_9_binned <- CSLSM_edge_binned %>% 
  filter( Trial == 9)

CSLSM_edge_10_binned <- CSLSM_edge_binned %>% 
  filter( Trial == 10)

CSLSM_edge_11_binned <- CSLSM_edge_binned %>% 
  filter( Trial == 11)

CSLSM_edge_12_binned <- CSLSM_edge_binned %>% 
  filter( Trial == 12)

CSLSM_edge_13_binned <- CSLSM_edge_binned %>% 
  filter( Trial == 13)

CSLSM_edge_14_binned <- CSLSM_edge_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
CSLSM_edge_average_binned <- bind_rows(CSLSM_edge_9_binned, CSLSM_edge_10_binned, CSLSM_edge_11_binned, CSLSM_edge_12_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )

CSLSM_edge_average_air_binned <- bind_rows(CSLSM_edge_13_binned, CSLSM_edge_14_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )


## Witness Sample


# Calculate normalization factors for edge measurements
new_WSLSM_edge_factors<- Witsurface_before_data$summary_data %>%
  group_by(Trial) %>%
  summarise(
    Total_Width = n() * 600 * 1e-6,  # Convert microns to meters
    .groups = "drop"
  )

# Calculate area-based counts for edge data using the same function as surface data
WSLSM_edge_counts_before <- w_bmodel_edge_before %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <-  0.1 / new_WSLSM_edge_factors$Total_Width[new_WSLSM_edge_factors$Trial == .y$Trial]
  get_area_counts(.x, area_thresholds, norm_factor)
  })

WSLSM_edge_counts_after <- w_bmodel_edge_after %>%
  group_by(Trial) %>%
  group_modify(~ {
    norm_factor <-  0.1 / new_WSLSM_edge_factors$Total_Width[new_WSLSM_edge_factors$Trial == .y$Trial]
  get_area_counts(.x, area_thresholds, norm_factor)
  })

WSLSM_surface_count_diff <- WSLSM_edge_counts_after %>%
  full_join(WSLSM_edge_counts_before, 
            by = c("Trial", "Area"), 
            suffix = c("_After", "_Before")) %>%
  mutate(Count_Diff = Count_After - Count_Before,
         Positive_Diff = pmax(Count_Diff, 0),
         Scatter_Diff = Scatter_Area_After - Scatter_Area_Before,
         Positive_Scatter = pmax(Scatter_Diff, 0)
         )

# Calculate cumulative counts (particles larger than each threshold)
WSLSM_cumulative_edge_counts <- WSLSM_surface_count_diff %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%
  mutate(Cumulative_Count = cumsum(Positive_Diff),
         Cumulative_Scatter = rev(cumsum(rev(Positive_Scatter)))) %>%
  ungroup() %>%
  mutate(log_area = log10(Area),
         log_count = log10(Cumulative_Count),
         log_count = ifelse(log_count < 0, 0, log_count),
         log_scatter = log10(Cumulative_Scatter),
         log_scatter = ifelse(log_scatter < 0, 0, log_scatter)
         ) %>% 
  arrange(Trial, desc(Area)) 


WSLSM_edge_9 <- WSLSM_cumulative_edge_counts %>% 
  filter( Trial == 9)

WSLSM_edge_10 <- WSLSM_cumulative_edge_counts %>% 
  filter( Trial == 10)

WSLSM_edge_11 <- WSLSM_cumulative_edge_counts %>% 
  filter( Trial == 11)

WSLSM_edge_12 <- WSLSM_cumulative_edge_counts %>% 
  filter( Trial == 12)

WSLSM_edge_13 <- WSLSM_cumulative_edge_counts %>% 
  filter( Trial == 13)

WSLSM_edge_14 <- WSLSM_cumulative_edge_counts %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
WSLSM_edge_average <- bind_rows(WSLSM_edge_9, WSLSM_edge_10, WSLSM_edge_11, WSLSM_edge_12) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

WSLSM_edge_average_air <- bind_rows(WSLSM_edge_13, WSLSM_edge_14) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Cumulative_Count, na.rm = TRUE),
    Average_Scatter = mean(Cumulative_Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count = mean(log_count, na.rm = TRUE),
    log_scatter = mean(log_scatter, na.rm = TRUE),
    .groups = "drop"
  )

# Calculate binned counts from cumulative data
WSLSM_edge_binned <- WSLSM_cumulative_edge_counts %>%
  group_by(Trial) %>%
  arrange(desc(Area)) %>%  # Ensure data is sorted by descending area
  mutate(
    Count = c(Cumulative_Count[1], diff(Cumulative_Count)),  # First value is the total, then differences
    Scatter = c(Cumulative_Scatter[length(Cumulative_Scatter)], -diff(Cumulative_Scatter))
  ) %>%
  ungroup() %>% 
  mutate(log_count_bin = log10(Count),
          log_count_bin = ifelse(log_count_bin < 0, 0, log_count_bin),
         log_scatter_bin = log10(Scatter),
          log_scatter_bin = ifelse(log_scatter_bin < 0, 0, log_scatter_bin)
         )

WSLSM_edge_9_binned <- WSLSM_edge_binned %>% 
  filter( Trial == 9)

WSLSM_edge_10_binned <- WSLSM_edge_binned %>% 
  filter( Trial == 10)

WSLSM_edge_11_binned <- WSLSM_edge_binned %>% 
  filter( Trial == 11)

WSLSM_edge_12_binned <- WSLSM_edge_binned %>% 
  filter( Trial == 12)

WSLSM_edge_13_binned <- WSLSM_edge_binned %>% 
  filter( Trial == 13)

WSLSM_edge_14_binned <- WSLSM_edge_binned %>% 
  filter( Trial == 14)

# Calculate the average of trials 9 through 12
WSLSM_edge_average_binned <- bind_rows(WSLSM_edge_9_binned, WSLSM_edge_10_binned, WSLSM_edge_11_binned, WSLSM_edge_12_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )

WSLSM_edge_average_air_binned <- bind_rows(WSLSM_edge_13_binned, WSLSM_edge_14_binned) %>%
  group_by(Area) %>%
  summarize(
    Average_Count = mean(Count, na.rm = TRUE),
    Average_Scatter = mean(Scatter,na.rm = TRUE),
    log_area = mean(log_area, na.rm = TRUE),
    log_count_bin = mean(log_count_bin, na.rm = TRUE),
    log_scatter_bin = mean(log_scatter_bin, na.rm = TRUE),
    .groups = "drop"
  )
```

## 8. Error Stats

```{r}
# Function to calculate error statistics for any dataset with grouped counts
# This handles both normalized and raw data
calculate_error_stats <- function(data, group_vars = c("Trial", "Area"), 
                                  count_var = "Cumulative_Count", 
                                  norm_factor = NULL) {
  
  # Process the data with proper grouping
  result <- data %>%
    group_by(across(all_of(group_vars))) %>%
    summarize(
      Average_Count = mean(!!sym(count_var), na.rm = TRUE),
      StdDev = sd(!!sym(count_var), na.rm = TRUE),
      n = n(),
      # If n=1 (e.g., for model data), use Poisson statistics instead
      StdError = ifelse(n > 1, StdDev / sqrt(n - 1), sqrt(Average_Count)),
      # Apply normalization if provided
      .groups = "drop"
    )
  
  # Apply normalization if provided
  if (!is.null(norm_factor)) {
    result <- result %>%
      mutate(
        # Scale the error by the same normalization factor
        StdError = StdError * norm_factor
      )
  }
  
  # Calculate log statistics with proper error handling
  result <- result %>%
    mutate(
      # For log scale, calculate upper and lower bounds
      Upper_raw = Average_Count + StdError,
      Lower_raw = pmax(Average_Count - StdError, 1), # Prevent negative values
      # Transform to log scale
      log_area = log10(Area),
      log_count = log10(Average_Count),
      log_count = ifelse(log_count < 0, 0, log_count),
      Upper = log10(Upper_raw),
      Lower = log10(Lower_raw)
    )
  
  return(result)
}

# Calculate error statistics for each dataset type
# 1. Surface data - cumulative
surface_error_stats <- calculate_error_stats(
  cumulative_surface,
  group_vars = c("Trial", "Area"),
  count_var = "Cumulative_Count"
)

# 2. Surface data - binned
surface_binned_error_stats <- average_surface_binned %>%
  group_by(Trial, Area) %>%
  mutate(
    # For binned data, use Poisson statistics
    StdError = sqrt(Average_Count),
    Upper_raw = Average_Count + StdError,
    Lower_raw = pmax(Average_Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()

# 3. Edge data - cumulative
edge_error_stats <- calculate_error_stats(
  cumulative_edge, 
  group_vars = c("Trial", "Area"),
  count_var = "Cumulative_Count"
)

# 4. Edge data - binned
edge_binned_error_stats <- binned_edge %>%
  group_by(Trial, Area) %>%
  mutate(
    StdError = sqrt(Count),
    Upper_raw = Count + StdError,
    Lower_raw = pmax(Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()


# 5. Calibration edge data
calibration_edge_error_stats <- calculate_error_stats(
  cw_cumulative_edge,
  group_vars = c("Trial", "Area"),
  count_var = "Cumulative_Count"
)

# 6. Model data
# Since model data doesn't have sample variation, we'll use theoretical Poisson errors
model_edge_error_stats <- model_average_edge_cumulative%>%
  group_by(Trial, Area) %>%
  mutate(
    StdError = sqrt(Average_Count),
    Upper_raw = Average_Count + StdError,
    Lower_raw = pmax(Average_Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()

# 7. SLSM Starshade edge model
SSLSM_edge_error_stats <- rbind(
  SSLSM_edge_9, SSLSM_edge_10, SSLSM_edge_11, 
  SSLSM_edge_12, SSLSM_edge_13, SSLSM_edge_14
) %>%
  group_by(Trial, Area) %>%
  mutate(
    StdError = sqrt(Cumulative_Count),
    Upper_raw = Cumulative_Count + StdError,
    Lower_raw = pmax(Cumulative_Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()

# 8. SLSM Witness edge model
WSLSM_edge_error_stats <- rbind(
  WSLSM_edge_9, WSLSM_edge_10, WSLSM_edge_11, 
  WSLSM_edge_12, WSLSM_edge_13, WSLSM_edge_14
) %>%
  group_by(Trial, Area) %>%
  mutate(
    StdError = sqrt(Cumulative_Count),
    Upper_raw = Cumulative_Count + StdError,
    Lower_raw = pmax(Cumulative_Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()

# 9. Calibration wafer surface data
cw_surface_error_stats <- cw_average_surface_cumulative %>%
  group_by(Trial, Area) %>%
  mutate(
    StdError = sqrt(Average_Count),
    Upper_raw = Average_Count + StdError,
    Lower_raw = pmax(Average_Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()

# 10. Witness surface data
wit_surface_error_stats <- wit_average_surface_cumulative %>%
  group_by(Trial, Area) %>%
  mutate(
    StdError = sqrt(Average_Count),
    Upper_raw = Average_Count + StdError,
    Lower_raw = pmax(Average_Count - StdError, 1),
    Upper = log10(Upper_raw),
    Lower = log10(Lower_raw)
  ) %>%
  ungroup()

# Function to extract trial-specific error stats
get_trial_error_stats <- function(error_stats_df, trial_num) {
  error_stats_df %>% filter(Trial == trial_num)
}
```

## 8. Trial Anlysis Graphs

### 8.1 Trial 9

```{r trial_9 graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_9,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
      geom_line(data = wit_surface_9,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
            linetype = "dashed") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 9: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange/Solid: Starshade Surface, Green/Dashed: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
      geom_line(data = wit_surface_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
            linetype = "dashed") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 9: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange/Solid: Starshade Surface, Green: Witness Surface") +
  custom_theme


# Plot the cumulative edge distributions
ggplot() +
  geom_line(data = edge_9,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_9,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_9,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_9,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
          geom_line(data = WSLSM_edge_9,
              aes(x = log_area, y = log_count),
                  color = "#56B4E9", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 9: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions
ggplot() +
  geom_line(data = edge_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_9_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_9_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_9_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
          geom_line(data = WSLSM_edge_9_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#56B4E9", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 9: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

ggplot() +
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 9 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_surface %>% 
              filter(Trial == 9 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 9 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 9 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 9 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 9 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 9 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 9 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "1"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "2"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "3"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "4"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 9 & Sample == "5"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 9 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 9 & Sample == "16"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 9 & Sample == "17"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 9 & Sample == "18"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 9 & Sample == "19"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 9 & Sample == "20"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 9 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_binned_edge %>% 
              filter(Trial == 9 & Sample == "16"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 9 & Sample == "17"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 9 & Sample == "18"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 9 & Sample == "19"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 9 & Sample == "20"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 9 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


```

```{r, include=FALSE, echo = FALSE, eval=FALSE}
# Plot the cumulative distribution of Surface data with error bars
ggplot() +
  # Starshade Surface with error bars
  geom_line(data = surface_9,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(surface_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # Witness Surface with error bars
  geom_line(data = wit_surface_9,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(wit_surface_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 9: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Green: Witness Surface") +
  custom_theme

# Plot the binned distribution of surface data with error bars
ggplot() +
  # Starshade Surface binned with error bars
  geom_line(data = surface_9_binned,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
            linetype = "solid") +
  geom_errorbar(data = surface_9_binned %>% 
                  mutate(StdError = sqrt(Average_Count),
                         Upper = log10(Average_Count + StdError),
                         Lower = log10(pmax(Average_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # Witness Surface binned with error bars
  geom_line(data = wit_surface_9_binned,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
            linetype = "dashed") +
  geom_errorbar(data = wit_surface_9_binned %>% 
                  mutate(StdError = sqrt(Average_Count),
                         Upper = log10(Average_Count + StdError),
                         Lower = log10(pmax(Average_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 9: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Green: Witness Surface") +
  custom_theme

# Plot the cumulative edge distributions with error bars
ggplot() +
  # Starshade Observed Edge with error bars
  geom_line(data = edge_9,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(edge_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Calibration Edge with error bars
  geom_line(data = cw_edge_9,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(calibration_edge_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#0072B2", alpha = 0.2) +
  
  # Model Edge with error bars
  geom_line(data = model_edge_9,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(model_edge_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  # SLSM Starshade with error bars
  geom_line(data = SSLSM_edge_9,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_ribbon(data = get_trial_error_stats(SSLSM_edge_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # SLSM Witness with error bars
  geom_line(data = WSLSM_edge_9,
            aes(x = log_area, y = log_count),
            color = "#56B4E9", 
                  linetype = "longdash") +
  geom_ribbon(data = get_trial_error_stats(WSLSM_edge_error_stats, 9),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#56B4E9", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 9: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions with error bars
ggplot() +
  # Starshade Edge binned with error bars
  geom_line(data = edge_9_binned,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_errorbar(data = edge_9_binned %>% 
                  mutate(StdError = sqrt(Average_Count),
                         Upper = log10(Average_Count + StdError),
                         Lower = log10(pmax(Average_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Calibration Edge binned with error bars
  geom_line(data = cw_edge_9_binned,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cw_edge_9_binned %>% 
                  mutate(StdError = sqrt(Average_Count),
                         Upper = log10(Average_Count + StdError),
                         Lower = log10(pmax(Average_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  # Model Edge binned with error bars
  geom_line(data = model_edge_9_binned,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = model_edge_9_binned %>% 
                  mutate(StdError = sqrt(Average_Count),
                         Upper = log10(Average_Count + StdError),
                         Lower = log10(pmax(Average_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  # SLSM Starshade binned with error bars
  geom_line(data = SSLSM_edge_9_binned,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_errorbar(data = SSLSM_edge_9_binned %>% 
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # SLSM Witness binned with error bars
  geom_line(data = WSLSM_edge_9_binned,
            aes(x = log_area, y = log_count),
            color = "#56B4E9", 
                  linetype = "longdash") +
  geom_errorbar(data = WSLSM_edge_9_binned %>% 
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 9: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Sample comparison plot with error bars
ggplot() +
  # Loop through samples 1-5 and add lines with error bars for each
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_surface %>% 
                  filter(Trial == 9 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_surface %>% 
                  filter(Trial == 9 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_surface %>% 
                  filter(Trial == 9 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_surface %>% 
                  filter(Trial == 9 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 9 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_surface %>% 
                  filter(Trial == 9 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 9 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme
```

### 8.2 Trial 10

```{r trial_10 graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_10,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
      geom_line(data = wit_surface_10,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
            linetype = "dashed") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 10: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange/Solid: Starshade Surface, Green/Dashed: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_10_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
      geom_line(data = wit_surface_10_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
            linetype = "dashed") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 10: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange/Solid: Starshade Surface, Green: Witness Surface") +
  custom_theme


# Plot the cumulative edge distributions
ggplot() +
  geom_line(data = edge_10,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_10,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_10,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
          geom_line(data = WSLSM_edge_10,
              aes(x = log_area, y = log_count),
                  color = "#56B4E9", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 10: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions
ggplot() +
  geom_line(data = edge_10_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_10_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_10_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
          geom_line(data = WSLSM_edge_10_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#56B4E9", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 10: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

ggplot() +
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 10 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 10 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 10 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 10 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 10 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 10 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_surface %>% 
              filter(Trial == 10 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 10 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 10 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 10 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 10 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 10 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "6"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "7"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "8"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "9"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "10"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 10 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "6"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "7"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "8"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "9"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 10 & Sample == "10"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 10 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 10 & Sample == "21"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 10 & Sample == "22"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 10 & Sample == "23"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 10 & Sample == "24"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 10 & Sample == "25"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 10 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_binned_edge %>% 
              filter(Trial == 10 & Sample == "21"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 10 & Sample == "22"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 10 & Sample == "23"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 10 & Sample == "24"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 10 & Sample == "25"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 10 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


```

### 8.2 Trial 10 with Error Bars

```{r trial_10_graphs_with_errors, include=FALSE, echo = FALSE, eval=FALSE}
# Plot the cumulative distribution of Surface data with error bars
ggplot() +
  # Starshade Surface with error bars
  geom_line(data = surface_10,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(surface_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # Witness Surface with error bars
  geom_line(data = wit_surface_10,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(wit_surface_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 10: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Green: Witness Surface") +
  custom_theme

# Plot the binned distribution of surface data with error bars
ggplot() +
  # Starshade Surface binned with error bars
  geom_line(data = surface_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
            linetype = "solid") +
  geom_errorbar(data = surface_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # Witness Surface binned with error bars
  geom_line(data = wit_surface_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
            linetype = "dashed") +
  geom_errorbar(data = wit_surface_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 10: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Green: Witness Surface") +
  custom_theme

# Plot the cumulative edge distributions with error bars
ggplot() +
  # Starshade Observed Edge with error bars
  geom_line(data = edge_10,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(edge_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Calibration Edge with error bars
  geom_line(data = cw_edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(calibration_edge_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#0072B2", alpha = 0.2) +
  
  # Model Edge with error bars
  geom_line(data = model_edge_10,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(model_edge_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  # SLSM Starshade with error bars
  geom_line(data = s_bmodel_edge_10,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_ribbon(data = get_trial_error_stats(s_bmodel_edge_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # SLSM Witness with error bars
  geom_line(data = w_bmodel_edge_10,
            aes(x = log_area, y = log_count),
            color = "#56B4E9", 
                  linetype = "longdash") +
  geom_ribbon(data = get_trial_error_stats(w_bmodel_edge_error_stats, 10),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#56B4E9", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 10: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions with error bars
ggplot() +
  # Starshade Edge binned with error bars
  geom_line(data = edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_errorbar(data = edge_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Calibration Edge binned with error bars
  geom_line(data = cw_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cw_edge_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  # Model Edge binned with error bars
  geom_line(data = model_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = model_edge_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  # SLSM Starshade binned with error bars
  geom_line(data = s_bmodel_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_errorbar(data = s_bmodel_edge_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # SLSM Witness binned with error bars
  geom_line(data = w_bmodel_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#56B4E9", 
                  linetype = "longdash") +
  geom_errorbar(data = w_bmodel_edge_10_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 10: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Sample comparison plot with error bars
ggplot() +
  # Loop through samples 1-5 and add lines with error bars for each
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 10 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 10 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 10 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 10 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 10 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 10 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 10 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 10 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 10 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 10 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 10 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme
```

### 8.3 Trial 11

```{r trial_11 graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_11,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
      geom_line(data = wit_surface_11,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
            linetype = "dashed") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 11: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange/Solid: Starshade Surface, Green/Dashed: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_11_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
      geom_line(data = wit_surface_11_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
            linetype = "dashed") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 11: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange/Solid: Starshade Surface, Green: Witness Surface") +
  custom_theme


# Plot the cumulative edge distributions
ggplot() +
  geom_line(data = edge_11,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_11,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
          geom_line(data = WSLSM_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#56B4E9", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 11: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions
ggplot() +
  geom_line(data = edge_11_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
          geom_line(data = WSLSM_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#56B4E9", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 11: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

ggplot() +
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 11 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 11 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 11 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 11 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 11 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 11 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_surface %>% 
              filter(Trial == 11 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 11 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 11 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 11 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 11 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 11 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "11"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "12"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "13"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "14"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "15"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 11 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "11"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "12"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "13"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "14"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 11 & Sample == "15"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 11 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 11 & Sample == "26"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 11 & Sample == "27"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 11 & Sample == "28"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 11 & Sample == "29"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 11 & Sample == "30"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 11 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_binned_edge %>% 
              filter(Trial == 11 & Sample == "26"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 11 & Sample == "27"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 11 & Sample == "28"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 11 & Sample == "29"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 11 & Sample == "30"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log10(Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 11 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

```

```{r trial_11_graphs_with_errors, include=FALSE, echo = FALSE, eval=FALSE}
# Plot the cumulative distribution of Surface data with error bars
ggplot() +
  # Starshade Surface with error bars
  geom_line(data = surface_11,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(surface_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # Witness Surface with error bars
  geom_line(data = wit_surface_11,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(wit_surface_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 11: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Green: Witness Surface") +
  custom_theme

# Plot the binned distribution of surface data with error bars
ggplot() +
  # Starshade Surface binned with error bars
  geom_line(data = surface_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
            linetype = "solid") +
  geom_errorbar(data = surface_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # Witness Surface binned with error bars
  geom_line(data = wit_surface_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
            linetype = "dashed") +
  geom_errorbar(data = wit_surface_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 11: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Green: Witness Surface") +
  custom_theme

# Plot the cumulative edge distributions with error bars
ggplot() +
  # Starshade Observed Edge with error bars
  geom_line(data = edge_11,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(edge_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Calibration Edge with error bars
  geom_line(data = cw_edge_11,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(calibration_edge_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#0072B2", alpha = 0.2) +
  
  # Model Edge with error bars
  geom_line(data = model_edge_11,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(model_edge_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  # SLSM Starshade with error bars
  geom_line(data = s_bmodel_edge_11,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_ribbon(data = get_trial_error_stats(s_bmodel_edge_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # SLSM Witness with error bars
  geom_line(data = w_bmodel_edge_11,
            aes(x = log_area, y = log_count),
            color = "#56B4E9", 
                  linetype = "longdash") +
  geom_ribbon(data = get_trial_error_stats(w_bmodel_edge_error_stats, 11),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#56B4E9", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 11: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions with error bars
ggplot() +
  # Starshade Edge binned with error bars
  geom_line(data = edge_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_errorbar(data = edge_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Calibration Edge binned with error bars
  geom_line(data = cw_edge_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cw_edge_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  # Model Edge binned with error bars
  geom_line(data = model_edge_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = model_edge_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  # SLSM Starshade binned with error bars
  geom_line(data = s_bmodel_edge_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_errorbar(data = s_bmodel_edge_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # SLSM Witness binned with error bars
  geom_line(data = w_bmodel_edge_11_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#56B4E9", 
                  linetype = "longdash") +
  geom_errorbar(data = w_bmodel_edge_11_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 11: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model, Orange: SLSM Starshade, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Sample comparison plot with error bars
ggplot() +
  # Loop through samples 1-5 and add lines with error bars for each
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 11 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 11 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 11 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 11 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 11 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 11 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 11 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 11 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 11 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 11 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 11 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme
```

### 8.4 Trial 12

```{r trial_12 graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_12,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_12,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "dashed") +
      geom_line(data = wit_surface_12,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 12: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_12_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_12_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "dashed") +
        geom_line(data = wit_surface_12_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 12: Binned Particle Size Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme 


# Plot the cumulative edge distributions
ggplot() +
  geom_line(data = edge_12,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_12,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = CSLSM_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "longdash") +
        geom_line(data = WSLSM_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#56B4E9", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 12: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions
ggplot() +
  geom_line(data = edge_12_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
        geom_line(data = CSLSM_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "longdash") +
          geom_line(data = WSLSM_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#56B4E9", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 12: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

ggplot() +
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 12 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 12 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 12 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 12 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 12 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 12 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_surface %>% 
              filter(Trial == 12 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 12 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 12 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 12 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 12 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 12 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 12 & Sample == "16"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 12 & Sample == "17"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 12 & Sample == "18"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 12 & Sample == "19"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 12 & Sample == "20"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 12 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_edge %>% 
              filter(Trial == 12 & Sample == "16"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 12 & Sample == "17"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 12 & Sample == "18"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 12 & Sample == "19"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 12 & Sample == "20"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 12 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 12 & Sample == "31"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 12 & Sample == "32"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 12 & Sample == "33"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 12 & Sample == "34"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 12 & Sample == "35"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 12 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_binned_edge %>% 
              filter(Trial == 12 & Sample == "31"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 12 & Sample == "32"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 12 & Sample == "33"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 12 & Sample == "34"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 12 & Sample == "35"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 12 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

```

```{r trial_12_graphs_with_errors, include=FALSE, echo = FALSE, eval=FALSE}
# Plot the cumulative distribution of Surface data with error bars
ggplot() +
  # Starshade Surface with error bars
  geom_line(data = surface_12,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(surface_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # Calibration Surface with error bars
  geom_line(data = cw_surface_12,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(cw_surface_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Witness Surface with error bars
  geom_line(data = wit_surface_12,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(wit_surface_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 12: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme

# Plot the binned distribution of surface data with error bars
ggplot() +
  # Starshade Surface binned with error bars
  geom_line(data = surface_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
            linetype = "solid") +
  geom_errorbar(data = surface_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # Calibration Surface binned with error bars
  geom_line(data = cw_surface_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#CC79A7", 
            linetype = "dashed") +
  geom_errorbar(data = cw_surface_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Witness Surface binned with error bars
  geom_line(data = wit_surface_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = wit_surface_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 12: Binned Particle Size Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme

# Plot the cumulative edge distributions with error bars
ggplot() +
  # Starshade Observed Edge with error bars
  geom_line(data = edge_12,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(edge_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Calibration Edge with error bars
  geom_line(data = cw_edge_12,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(calibration_edge_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#0072B2", alpha = 0.2) +
  
  # Model Edge with error bars
  geom_line(data = model_edge_12,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(model_edge_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  # SLSM Starshade with error bars
  geom_line(data = s_bmodel_edge_12,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_ribbon(data = get_trial_error_stats(s_bmodel_edge_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # SLSM Calibration with error bars
  geom_line(data = c_bmodel_edge_12,
            aes(x = log_area, y = log_count),
            color = "#F0E442", 
                  linetype = "longdash") +
  geom_errorbar(data = c_bmodel_edge_12 %>% 
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#F0E442", alpha = 0.5) +
  
  # SLSM Witness with error bars
  geom_line(data = w_bmodel_edge_12,
            aes(x = log_area, y = log_count),
            color = "#56B4E9", 
                  linetype = "twodash") +
  geom_ribbon(data = get_trial_error_stats(w_bmodel_edge_error_stats, 12),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#56B4E9", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 12: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions with error bars
ggplot() +
  # Starshade Edge binned with error bars
  geom_line(data = edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_errorbar(data = edge_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Calibration Edge binned with error bars
  geom_line(data = cw_edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cw_edge_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  # Model Edge binned with error bars
  geom_line(data = model_edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = model_edge_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  # SLSM Starshade binned with error bars
  geom_line(data = s_bmodel_edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_errorbar(data = s_bmodel_edge_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # SLSM Calibration binned with error bars
  geom_line(data = c_bmodel_edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#F0E442", 
                  linetype = "longdash") +
  geom_errorbar(data = c_bmodel_edge_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#F0E442", alpha = 0.5) +
  
  # SLSM Witness binned with error bars
  geom_line(data = w_bmodel_edge_12_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#56B4E9", 
                  linetype = "twodash") +
  geom_errorbar(data = w_bmodel_edge_12_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 12: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Sample comparison plot with error bars
ggplot() +
  # Loop through samples 1-5 and add lines with error bars for each
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 12 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

# Calibration sample comparison plot with error bars
ggplot() +
  # Loop through calibration samples 1-5 and add lines with error bars for each
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 12 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 12 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Analysis 12 - Sample: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

# # Combined sample comparison with error bands
# ggplot() +
#   # Starshade Samples
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "1"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#56B4E9", 
#             linetype = "solid") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "1") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#56B4E9", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "2"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#0072B2", 
#             linetype = "dashed") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "2") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#0072B2", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "3"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#009E73") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "3") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#009E73", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "4"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#CC79A7") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "4") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#CC79A7", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "5"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#D55E00") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "5") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#D55E00", alpha = 0.1) +
#   
#   # Calibration Samples with dotted lines
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "1"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#56B4E9", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "1") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#56B4E9", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "2"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#0072B2", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "2") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#0072B2", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "3"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#009E73", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "3") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#009E73", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "4"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#CC79A7", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "4") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#CC79A7", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 12 & Sample == "5"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#D55E00", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 12 & Sample == "5") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#D55E00", alpha = 0.1) +
#   
#   # Witness Sample with dashed line
#   geom_line(data = witcumulative_surface_counts %>% 
#               filter(Trial == 12),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#56B4E9", linetype = "dashed") +
#   geom_ribbon(data = witcumulative_surface_counts %>% 
#                 filter(Trial == 12) %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#56B4E9", alpha = 0.1) +
#   
#   labs(
#     x = expression(log[10](Area)~"(square microns)"),
#     y = "log10(Particle Count)",
#     title = "All Surface Analysis 12 - Samples: Cumulative Particle Area Distribution",
#     subtitle = "Solid: Starshade Samples, Dotted: Calibration Samples, Dashed: Witness Sample\nColors: Sky Blue (1), Navy Blue (2), Green (3), Purple (4), Orange (5)") +
#   custom_theme

# Edge sample comparison with error bars
ggplot() +
  # Loop through samples 1-5 and add lines with error bars for each
  geom_line(data = cumulative_edge_counts1 %>% 
              filter(Trial == 12 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_edge_counts1 %>% 
                  filter(Trial == 12 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_edge_counts1 %>% 
              filter(Trial == 12 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_edge_counts1 %>% 
                  filter(Trial == 12 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_edge_counts1 %>% 
              filter(Trial == 12 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_edge_counts1 %>% 
                  filter(Trial == 12 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_edge_counts1 %>% 
              filter(Trial == 12 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_edge_counts1 %>% 
                  filter(Trial == 12 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_edge_counts1 %>% 
              filter(Trial == 12 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_edge_counts1 %>% 
                  filter(Trial == 12 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 12 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

# Calibration edge sample comparison with error bars
ggplot() +
  # Loop through samples and add lines with error bars for each
  geom_line(data = cumulative_calibration_counts %>% 
              filter(Trial == 12 & Sample == "31"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_calibration_counts %>% 
                  filter(Trial == 12 & Sample == "31") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_calibration_counts %>% 
              filter(Trial == 12 & Sample == "32"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_calibration_counts %>% 
                  filter(Trial == 12 & Sample == "32") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_calibration_counts %>% 
              filter(Trial == 12 & Sample == "33"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_calibration_counts %>% 
                  filter(Trial == 12 & Sample == "33") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_calibration_counts %>% 
              filter(Trial == 12 & Sample == "34"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_calibration_counts %>% 
                  filter(Trial == 12 & Sample == "34") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_calibration_counts %>% 
              filter(Trial == 12 & Sample == "35"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_calibration_counts %>% 
                  filter(Trial == 12 & Sample == "35") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 12 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 31, Navy Blue: Sample 32, Green: Sample 33, Purple: Sample 34, Orange: Sample 35") +
  custom_theme
```

### 8.5 Trial 13

```{r trial_13 graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_13,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_13,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "dashed") +
      geom_line(data = wit_surface_13,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 13: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_13_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_13_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "dashed") +
        geom_line(data = wit_surface_13_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 13: Binned Particle Size Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme 


# Plot the cumulative edge distributions
ggplot() +
  geom_line(data = edge_13,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_13,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = CSLSM_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "longdash") +
        geom_line(data = WSLSM_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#56B4E9", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 13: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions
ggplot() +
  geom_line(data = edge_13_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
        geom_line(data = CSLSM_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "longdash") +
          geom_line(data = WSLSM_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#56B4E9", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 13: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

ggplot() +
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 13 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 13 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 13 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 13 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 13 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 13 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_surface %>% 
              filter(Trial == 13 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 13 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 13 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 13 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 13 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 13 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 13 & Sample == "21"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 13 & Sample == "22"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 13 & Sample == "23"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 13 & Sample == "24"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 13 & Sample == "25"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 13 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_edge %>% 
              filter(Trial == 13 & Sample == "21"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 13 & Sample == "22"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 13 & Sample == "23"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 13 & Sample == "24"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 13 & Sample == "25"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 13 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 13 & Sample == "36"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 13 & Sample == "37"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 13 & Sample == "38"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 13 & Sample == "39"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 13 & Sample == "40"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 13 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_binned_edge %>% 
              filter(Trial == 13 & Sample == "36"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 13 & Sample == "37"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 13 & Sample == "38"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 13 & Sample == "39"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 13 & Sample == "40"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 13 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme
```

```{r trial_13_graphs_with_errors, include=FALSE, echo = FALSE, eval=FALSE}
# Plot the cumulative distribution of Surface data with error bars
ggplot() +
  # Starshade Surface with error bars
  geom_line(data = surface_13,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(surface_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # Calibration Surface with error bars
  geom_line(data = cw_surface_13,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(cw_surface_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Witness Surface with error bars
  geom_line(data = wit_surface_13,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(wit_surface_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 13: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme

# Plot the binned distribution of surface data with error bars
ggplot() +
  # Starshade Surface binned with error bars
  geom_line(data = surface_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
            linetype = "solid") +
  geom_errorbar(data = surface_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # Calibration Surface binned with error bars
  geom_line(data = cw_surface_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#CC79A7", 
            linetype = "dashed") +
  geom_errorbar(data = cw_surface_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Witness Surface binned with error bars
  geom_line(data = wit_surface_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = wit_surface_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 13: Binned Particle Size Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme

# Plot the cumulative edge distributions with error bars
ggplot() +
  # Starshade Observed Edge with error bars
  geom_line(data = edge_13,
            aes(x = log_area, y = log_count),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_ribbon(data = get_trial_error_stats(edge_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#CC79A7", alpha = 0.2) +
  
  # Calibration Edge with error bars
  geom_line(data = cw_edge_13,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_ribbon(data = get_trial_error_stats(calibration_edge_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#0072B2", alpha = 0.2) +
  
  # Model Edge with error bars
  geom_line(data = model_edge_13,
            aes(x = log_area, y = log_count),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_ribbon(data = get_trial_error_stats(model_edge_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#009E73", alpha = 0.2) +
  
  # SLSM Starshade with error bars
  geom_line(data = s_bmodel_edge_13,
            aes(x = log_area, y = log_count),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_ribbon(data = get_trial_error_stats(s_bmodel_edge_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#D55E00", alpha = 0.2) +
  
  # SLSM Calibration with error bars
  geom_line(data = c_bmodel_edge_13,
            aes(x = log_area, y = log_count),
            color = "#F0E442", 
                  linetype = "longdash") +
  geom_errorbar(data = c_bmodel_edge_13 %>% 
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#F0E442", alpha = 0.5) +
  
  # SLSM Witness with error bars
  geom_line(data = w_bmodel_edge_13,
            aes(x = log_area, y = log_count),
            color = "#56B4E9", 
                  linetype = "twodash") +
  geom_ribbon(data = get_trial_error_stats(w_bmodel_edge_error_stats, 13),
              aes(x = log_area, ymin = Lower, ymax = Upper),
              fill = "#56B4E9", alpha = 0.2) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 13: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions with error bars
ggplot() +
  # Starshade Edge binned with error bars
  geom_line(data = edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#CC79A7", 
            linetype = "solid") +
  geom_errorbar(data = edge_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  # Calibration Edge binned with error bars
  geom_line(data = cw_edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cw_edge_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  # Model Edge binned with error bars
  geom_line(data = model_edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = model_edge_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  # SLSM Starshade binned with error bars
  geom_line(data = s_bmodel_edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#D55E00", 
                  linetype = "dotdash") +
  geom_errorbar(data = s_bmodel_edge_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  # SLSM Calibration binned with error bars
  geom_line(data = c_bmodel_edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#F0E442", 
                  linetype = "longdash") +
  geom_errorbar(data = c_bmodel_edge_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#F0E442", alpha = 0.5) +
  
  # SLSM Witness binned with error bars
  geom_line(data = w_bmodel_edge_13_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#56B4E9", 
                  linetype = "twodash") +
  geom_errorbar(data = w_bmodel_edge_13_binned %>% 
                  mutate(StdError = sqrt(Count),
                         Upper = log10(Count + StdError),
                         Lower = log10(pmax(Count - StdError, 1))),
                aes(x = log_area, ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 13: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Observed, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Sample comparison plot with error bars
ggplot() +
  # Loop through samples 1-5 and add lines with error bars for each
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 13 - Samples: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

# Calibration sample comparison plot with error bars
ggplot() +
  # Loop through calibration samples 1-5 and add lines with error bars for each
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "1") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#56B4E9", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "2") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#0072B2", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "3") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#009E73", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "4") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#CC79A7", alpha = 0.5) +
  
  geom_line(data = cwcumulative_surface_counts %>% 
              filter(Trial == 13 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  geom_errorbar(data = cwcumulative_surface_counts %>% 
                  filter(Trial == 13 & Sample == "5") %>%
                  mutate(StdError = sqrt(Cumulative_Count),
                         Upper = log10(Cumulative_Count + StdError),
                         Lower = log10(pmax(Cumulative_Count - StdError, 1))),
                aes(x = log10(Area), ymin = Lower, ymax = Upper),
                width = 0.1, color = "#D55E00", alpha = 0.5) +
  
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Analysis 13 - Sample: Cumulative Particle Area Distribution",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

# # Combined sample comparison with error bands
# ggplot() +
#   # Starshade Samples
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "1"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#56B4E9", 
#             linetype = "solid") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "1") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#56B4E9", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "2"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#0072B2", 
#             linetype = "dashed") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "2") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#0072B2", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "3"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#009E73") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "3") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#009E73", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "4"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#CC79A7") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "4") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#CC79A7", alpha = 0.1) +
#   
#   geom_line(data = cumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "5"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#D55E00") +
#   geom_ribbon(data = cumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "5") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#D55E00", alpha = 0.1) +
#   
#   # Calibration Samples with dotted lines
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "1"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#56B4E9", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "1") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#56B4E9", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "2"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#0072B2", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "2") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#0072B2", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "3"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#009E73", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "3") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#009E73", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "4"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#CC79A7", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "4") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#CC79A7", alpha = 0.1) +
#   
#   geom_line(data = cwcumulative_surface_counts %>% 
#               filter(Trial == 13 & Sample == "5"),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#D55E00", linetype = "dotted") +
#   geom_ribbon(data = cwcumulative_surface_counts %>% 
#                 filter(Trial == 13 & Sample == "5") %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#D55E00", alpha = 0.1) +
#   
#   # Witness Sample with dashed line
#   geom_line(data = witcumulative_surface_counts %>% 
#               filter(Trial == 13),
#             aes(x = log10(Area), y = log10(Cumulative_Count)),
#             color = "#56B4E9", linetype = "dashed") +
#   geom_ribbon(data = witcumulative_surface_counts %>% 
#                 filter(Trial == 13) %>%
#                 mutate(StdError = sqrt(Cumulative_Count),
#                        Upper = log10(Cumulative_Count + StdError),
#                        Lower = log10(pmax(Cumulative_Count - StdError, 1))),
#               aes(x = log10(Area), ymin = Lower, ymax = Upper),
#               fill = "#56B4E9", alpha = 0.1) +
#   
#   labs(
#     x = expression(log[10](Area)~"(square microns)"),
#     y = "log10(Particle Count)",
#     title = "All Surface Analysis 13 - Samples: Cumulative Particle Area Distribution",
#     subtitle = "Solid: Starshade Samples, Dotted: Calibration Samples, Dashed: Witness Sample\nColors: Sky Blue (1), Navy Blue (2), Green (3), Purple (4), Orange (5)") +
#   custom_theme
```


### 8.6 Trial 14

```{r trial_14 graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_14,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_14,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "dashed") +
      geom_line(data = wit_surface_14,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 14: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_14_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_14_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "dashed") +
        geom_line(data = wit_surface_14_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis 14: Binned Particle Size Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme 


# Plot the cumulative edge distributions
ggplot() +
  geom_line(data = edge_14,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_14,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = CSLSM_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "longdash") +
        geom_line(data = WSLSM_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#56B4E9", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 14: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

# Plot the binned edge distributions
ggplot() +
  geom_line(data = edge_14_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "solid") +
  geom_line(data = cw_edge_14_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
        geom_line(data = CSLSM_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "longdash") +
          geom_line(data = WSLSM_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#56B4E9", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis 14: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
  ) +
  custom_theme

ggplot() +
  geom_line(data = cumulative_surface %>% 
              filter(Trial == 14 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 14 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 14 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 14 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_surface %>% 
              filter(Trial == 14 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 14 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_surface %>% 
              filter(Trial == 14 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 14 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 14 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 14 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_surface %>% 
              filter(Trial == 14 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis 14 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cumulative_edge %>% 
              filter(Trial == 14 & Sample == "26"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 14 & Sample == "27"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 14 & Sample == "28"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 14 & Sample == "29"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cumulative_edge %>% 
              filter(Trial == 14 & Sample == "30"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 14 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = binned_edge %>% 
              filter(Trial == 14 & Sample == "26"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 14 & Sample == "27"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 14 & Sample == "28"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 14 & Sample == "29"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = binned_edge %>% 
              filter(Trial == 14 & Sample == "30"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis 14 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 14 & Sample == "1"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 14 & Sample == "2"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 14 & Sample == "3"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 14 & Sample == "4"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_surface %>% 
              filter(Trial == 14 & Sample == "5"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Surface Analysis 14 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme

ggplot() +
  geom_line(data = cw_binned_surface %>% 
              filter(Trial == 14 & Sample == "1"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_surface %>% 
              filter(Trial == 14 & Sample == "2"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_surface %>% 
              filter(Trial == 14 & Sample == "3"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_surface %>% 
              filter(Trial == 14 & Sample == "4"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_surface %>% 
              filter(Trial == 14 & Sample == "5"),
            aes(x = log10(Area), y = log10(Positive_Count_Diff)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Surface Analysis 14 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 14 & Sample == "41"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 14 & Sample == "42"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 14 & Sample == "43"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 14 & Sample == "44"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_cumulative_edge %>% 
              filter(Trial == 14 & Sample == "45"),
            aes(x = log10(Area), y = log10(Cumulative_Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 14 - Samples : Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme


ggplot() +
  geom_line(data = cw_binned_edge %>% 
              filter(Trial == 14 & Sample == "41"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#56B4E9", 
            linetype = "solid") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 14 & Sample == "42"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#0072B2", 
            linetype = "dashed") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 14 & Sample == "43"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 14 & Sample == "44"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#CC79A7", 
                  linetype = "dotdash") +
    geom_line(data = cw_binned_edge %>% 
              filter(Trial == 14 & Sample == "45"),
            aes(x = log10(Area), y = log10(Count)),
            color = "#D55E00", 
                  linetype = "longdash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis 14 - Samples : Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Sky Blue: Sample 1, Navy Blue: Sample 2, Green: Sample 3, Purple: Sample 4, Orange: Sample 5") +
  custom_theme
```

# 9. Average Graphs


### 9.1 Average of Trials

```{r Average graphs}

# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_average,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_average,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "dashed") +
      geom_line(data = wit_surface_average,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis Average: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_average_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_average_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "dashed") +
        geom_line(data = wit_surface_average_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis Average: Binned Particle Size Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme 


# Plot the cumulative edge distributions
 ggplot() +
   geom_line(data = edge_average,
             aes(x = log_area, y = log_count),
                 color = "#CC79A7", 
            linetype = "solid") +
   geom_line(data = cw_edge_average,
             aes(x = log_area, y = log_count),
             color = "#0072B2", 
            linetype = "dashed") +
   geom_line(data = model_edge_average,
               aes(x = log_area, y = log_count),
                   color = "#009E73", 
                  linetype = "dotted") +
     geom_line(data = SSLSM_edge_average,
               aes(x = log_area, y = log_count),
                   color = "#D55E00", 
                  linetype = "dotdash") +
       geom_line(data = CSLSM_edge_average,
               aes(x = log_area, y = log_count),
                   color = "#F0E442", 
                  linetype = "longdash") +
         geom_line(data = WSLSM_edge_average,
               aes(x = log_area, y = log_count),
                   color = "#56B4E9", 
                  linetype = "twodash") +
   labs(
     x = expression(log[10](Area)~"(square microns)"),
     y = "log10(Particle Count)",
  title = "Edge Analysis Average: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
   ) +
   custom_theme

# Plot the binned edge distributions
 ggplot() +
   geom_line(data = edge_average_binned,
             aes(x = log_area, y = log_count_bin),
                 color = "#CC79A7", 
            linetype = "solid") +
   geom_line(data = cw_edge_average_binned,
             aes(x = log_area, y = log_count_bin),
             color = "#0072B2", 
            linetype = "dashed") +
  geom_line(data = model_edge_average_binned,
               aes(x = log_area, y = log_count_bin),
                   color = "#009E73", 
                  linetype = "dotted") +
     geom_line(data = SSLSM_edge_average_binned,
               aes(x = log_area, y = log_count_bin),
                   color = "#D55E00", 
                  linetype = "dotdash") +
         geom_line(data = CSLSM_edge_average_binned,
               aes(x = log_area, y = log_count_bin),
                   color = "#F0E442", 
                  linetype = "longdash") +
           geom_line(data = WSLSM_edge_average_binned,
               aes(x = log_area, y = log_count_bin),
                   color = "#56B4E9", 
                  linetype = "twodash") +
   labs(
     x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis Average: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
   ) +
  custom_theme

 
```





### 9.2 Average Air of Trials

```{r Average Air graphs}

# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_average_air,
            aes(x = log_area, y = log_count),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_average_air,
            aes(x = log_area, y = log_count),
                color = "#CC79A7", 
            linetype = "dashed") +
      geom_line(data = wit_surface_average_air,
            aes(x = log_area, y = log_count),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis average_air: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_average_air_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_average_air_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#CC79A7", 
            linetype = "dashed") +
        geom_line(data = wit_surface_average_air_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis average_air: Binned Particle Size Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme 


# Plot the cumulative edge distributions
 ggplot() +
   geom_line(data = edge_average_air,
             aes(x = log_area, y = log_count),
                 color = "#CC79A7", 
            linetype = "solid") +
   geom_line(data = cw_edge_average_air,
             aes(x = log_area, y = log_count),
             color = "#0072B2", 
            linetype = "dashed") +
   geom_line(data = model_edge_average_air,
               aes(x = log_area, y = log_count),
                   color = "#009E73", 
                  linetype = "dotted") +
     geom_line(data = SSLSM_edge_average_air,
               aes(x = log_area, y = log_count),
                   color = "#D55E00", 
                  linetype = "dotdash") +
       geom_line(data = CSLSM_edge_average_air,
               aes(x = log_area, y = log_count),
                   color = "#F0E442", 
                  linetype = "longdash") +
         geom_line(data = WSLSM_edge_average_air,
               aes(x = log_area, y = log_count),
                   color = "#56B4E9", 
                  linetype = "twodash") +
   labs(
     x = expression(log[10](Area)~"(square microns)"),
     y = "log10(Particle Count)",
  title = "Edge Analysis average_air: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
   ) +
   custom_theme

# Plot the binned edge distributions
 ggplot() +
   geom_line(data = edge_average_air_binned,
             aes(x = log_area, y = log_count_bin),
                 color = "#CC79A7", 
            linetype = "solid") +
   geom_line(data = cw_edge_average_air_binned,
             aes(x = log_area, y = log_count_bin),
             color = "#0072B2", 
            linetype = "dashed") +
  geom_line(data = model_edge_average_air_binned,
               aes(x = log_area, y = log_count_bin),
                   color = "#009E73", 
                  linetype = "dotted") +
     geom_line(data = SSLSM_edge_average_air_binned,
               aes(x = log_area, y = log_count_bin),
                   color = "#D55E00", 
                  linetype = "dotdash") +
         geom_line(data = CSLSM_edge_average_air_binned,
               aes(x = log_area, y = log_count_bin),
                   color = "#F0E442", 
                  linetype = "longdash") +
           geom_line(data = WSLSM_edge_average_air_binned,
               aes(x = log_area, y = log_count_bin),
                   color = "#56B4E9", 
                  linetype = "twodash") +
   labs(
     x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Edge Analysis average_air: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved, Green: Model,\n Orange: SLSM Starshade, Yellow: SLSM Calibration, Sky Blue: SLSM Witness"
   ) +
  custom_theme

 
 
```

### 9.3 Scatter Graphs

```{r scatter_graphs}

 # Scatter
 
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_average,
            aes(x = log_area, y = Average_Scatter),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_average,
            aes(x = log_area, y = Average_Scatter),
                color = "#CC79A7", 
            linetype = "dashed") +
      geom_line(data = wit_surface_average,
            aes(x = log_area, y = Average_Scatter),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis Average: Cumulative Particle Scatter Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_average_binned,
            aes(x = log_area, y = Average_Scatter),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_average_binned,
            aes(x = log_area, y = Average_Scatter),
                color = "#CC79A7", 
            linetype = "dashed") +
        geom_line(data = wit_surface_average_binned,
            aes(x = log_area, y = Average_Scatter),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis Average: Binned Particle Scatter Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme 


# Plot the cumulative edge distributions
 ggplot() +
   geom_line(data = edge_average,
             aes(x = log_area, y = Average_Scatter),
                 color = "#CC79A7", 
            linetype = "solid") +
   geom_line(data = cw_edge_average,
             aes(x = log_area, y = Average_Scatter),
             color = "#0072B2", 
            linetype = "dashed") +
     geom_line(data = SSLSM_edge_average,
               aes(x = log_area, y = Average_Scatter),
                   color = "#D55E00", 
                  linetype = "dotdash") +
       geom_line(data = CSLSM_edge_average,
               aes(x = log_area, y = Average_Scatter),
                   color = "#F0E442", 
                  linetype = "longdash") +
         geom_line(data = WSLSM_edge_average,
               aes(x = log_area, y = Average_Scatter),
                   color = "#56B4E9", 
                  linetype = "twodash") +
   labs(
     x = expression(log[10](Area)~"(square microns)"),
     y = "log10(Particle Count)",
  title = "Edge Analysis Average: Cumulative Particle Scatter Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved"
   ) +
   custom_theme

# Plot the binned edge distributions
 ggplot() +
   geom_line(data = edge_average_binned,
             aes(x = log_area, y = Average_Scatter),
                 color = "#CC79A7", 
            linetype = "solid") +
   geom_line(data = cw_edge_average_binned,
             aes(x = log_area, y = Average_Scatter),
             color = "#0072B2", 
            linetype = "dashed") +
   geom_line(data = SSLSM_edge_average_binned,
               aes(x = log_area, y = Average_Scatter),
                   color = "#D55E00", 
                  linetype = "dotdash") +
       geom_line(data = CSLSM_edge_average_binned,
               aes(x = log_area, y = Average_Scatter),
                   color = "#F0E442", 
                  linetype = "longdash") +
         geom_line(data = WSLSM_edge_average_binned,
               aes(x = log_area, y = Average_Scatter),
                   color = "#56B4E9", 
                  linetype = "twodash") +
   labs(
     x = expression(log[10](Area)~"(square microns)"),
    y = "Total Area",
    title = "Edge Analysis Average: Binned Particle Scatter Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved"
   ) +
  custom_theme

 
 

```


### 9.4 Scatter Air Graphs

```{r Scatter Air Graphs}
# Scatter
 
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_average_air,
            aes(x = log_area, y = Average_Scatter),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_average_air,
            aes(x = log_area, y = Average_Scatter),
                color = "#CC79A7", 
            linetype = "dashed") +
      geom_line(data = wit_surface_average_air,
            aes(x = log_area, y = Average_Scatter),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis average_air: Cumulative Particle Scatter Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme


# Plot the binned distribution of surface data
ggplot() +
  geom_line(data = surface_average_air_binned,
            aes(x = log_area, y = Average_Scatter),
                color = "#D55E00", 
            linetype = "solid") +
    geom_line(data = cw_surface_average_air_binned,
            aes(x = log_area, y = Average_Scatter),
                color = "#CC79A7", 
            linetype = "dashed") +
        geom_line(data = wit_surface_average_air_binned,
            aes(x = log_area, y = Average_Scatter),
                color = "#009E73", 
                  linetype = "dotted") +
  labs(
    x = expression(Area~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Surface Analysis average_air: Binned Particle Scatter Distribution over 0.1 square meters",
    subtitle = "Orange: Starshade Surface, Purple: Calibration Surface, Green: Witness Surface") +
  custom_theme 


# Plot the cumulative edge distributions
 ggplot() +
   geom_line(data = edge_average_air,
             aes(x = log_area, y = Average_Scatter),
                 color = "#CC79A7", 
            linetype = "solid") +
   geom_line(data = cw_edge_average_air,
             aes(x = log_area, y = Average_Scatter),
             color = "#0072B2", 
            linetype = "dashed") +
   geom_line(data = SSLSM_edge_average_air,
               aes(x = log_area, y = Average_Scatter),
                   color = "#D55E00", 
                  linetype = "dotdash") +
       geom_line(data = CSLSM_edge_average_air,
               aes(x = log_area, y = Average_Scatter),
                   color = "#F0E442", 
                  linetype = "longdash") +
         geom_line(data = WSLSM_edge_average_air,
               aes(x = log_area, y = Average_Scatter),
                   color = "#56B4E9", 
                  linetype = "twodash") +
   labs(
     x = expression(log[10](Area)~"(square microns)"),
     y = "log10(Particle Count)",
  title = "Edge Analysis average_air: Cumulative Particle Scatter Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved"
   ) +
   custom_theme

# Plot the binned edge distributions
 ggplot() +
   geom_line(data = edge_average_air_binned,
             aes(x = log_area, y = Average_Scatter),
                 color = "#CC79A7", 
            linetype = "solid") +
   geom_line(data = cw_edge_average_air_binned,
             aes(x = log_area, y = Average_Scatter),
             color = "#0072B2", 
            linetype = "dashed") +
      geom_line(data = SSLSM_edge_average_air_binned,
               aes(x = log_area, y = Average_Scatter),
                   color = "#D55E00", 
                  linetype = "dotdash") +
       geom_line(data = CSLSM_edge_average_air_binned,
               aes(x = log_area, y = Average_Scatter),
                   color = "#F0E442", 
                  linetype = "longdash") +
         geom_line(data = WSLSM_edge_average_air_binned,
               aes(x = log_area, y = Average_Scatter),
                   color = "#56B4E9", 
                  linetype = "twodash") +
   labs(
     x = expression(log[10](Area)~"(square microns)"),
    y = "Total Area",
    title = "Edge Analysis average_air: Binned Particle Scatter Distribution over 0.1 meter",
    subtitle = "Purple: Starshade Observed, Navy Blue: Calibration Obvserved"
   ) +
  custom_theme

 
 
```



# 10. Comparison Graphics

### 10.1 Graph Comparison Graphic Count

```{r comparison}
# 8.8 Comprehensive Trial Comparison

# Create a comprehensive comparison grid showing all trials and analysis types
library(tidyverse)
library(gridExtra)
library(grid)

# Define trials in the requested order
trial_order <- c(9, 10, 11, 12, 13, 14)

# Custom theme for consistent appearance with minimal margins
compact_theme <- theme_minimal() +
  theme(
    plot.title = element_blank(),  # Remove individual plot titles
    plot.margin = margin(2, 2, 2, 2, "pt"),  # Minimize plot margins
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    legend.position = "none",
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray95")
  )

# Create lists to store plots
surface_cumulative_plots <- list()
surface_binned_plots <- list()
edge_cumulative_plots <- list()
edge_binned_plots <- list()

# Function to create a fallback plot when data isn't available
create_fallback_plot <- function() {
  ggplot() + 
    annotate("text", x = 2, y = 2, label = "Data not available") +
    theme_minimal() +
    theme(plot.margin = margin(2, 2, 2, 2, "pt")) +
    labs(x = expression(log[10](Area)), y = "log10(Count)")
}

# Helper function to check for column names
get_column_name <- function(data, possible_names) {
  for (name in possible_names) {
    if (name %in% names(data)) {
      return(name)
    }
  }
  return(NULL)
}

# Generate plots for each trial with error handling
for (i in 1:length(trial_order)) {
  trial_num <- trial_order[i]
  
  # 1. Surface cumulative plots
  tryCatch({
    surface_data <- get(paste0("surface_", trial_num))
    witness_data <- get(paste0("wit_surface_", trial_num))
    
    # Check column names
    area_col <- get_column_name(surface_data, c("log_area", "Area"))
    count_col <- get_column_name(surface_data, c("log_count", "Count", "Average_Count"))
    
    wit_area_col <- get_column_name(witness_data, c("log_area", "Area"))
    wit_count_col <- get_column_name(witness_data, c("log_count", "Count", "Average_Count"))
    
    # Base plot for surface cumulative
    p_surf_cum <- ggplot()
    
    if (!is.null(area_col) && !is.null(count_col)) {
      p_surf_cum <- p_surf_cum + 
        geom_line(data = surface_data,
                  aes_string(x = area_col, y = count_col),
                  color = "#D55E00", 
                  linetype = "solid")
    }
    
    if (!is.null(wit_area_col) && !is.null(wit_count_col)) {
      p_surf_cum <- p_surf_cum + 
        geom_line(data = witness_data,
                  aes_string(x = wit_area_col, y = wit_count_col),
                  color = "#009E73", 
                  linetype = "dashed")
    }
    
    # Add calibration data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("cw_surface_", trial_num))) {
        cw_data <- get(paste0("cw_surface_", trial_num))
        cw_area_col <- get_column_name(cw_data, c("log_area", "Area"))
        cw_count_col <- get_column_name(cw_data, c("log_count", "Count", "Average_Count"))
        
        if (!is.null(cw_area_col) && !is.null(cw_count_col)) {
          p_surf_cum <- p_surf_cum +
            geom_line(data = cw_data,
                      aes_string(x = cw_area_col, y = cw_count_col),
                      color = "#CC79A7", 
                      linetype = "dotted")
        }
      }
    }
    
    # Finalize surface cumulative plot with minimal spacing
    p_surf_cum <- p_surf_cum +
      labs(
        x = expression(log[10](Area)),
        y = "log10(Count)"
      ) +
      compact_theme
    
    surface_cumulative_plots[[i]] <- p_surf_cum
  }, error = function(e) {
    surface_cumulative_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating surface cumulative plot for trial", trial_num, ":", e$message))
  })
  
  # 2. Surface binned plots
  tryCatch({
    surface_bin_data <- get(paste0("surface_", trial_num, "_binned"))
    witness_bin_data <- get(paste0("wit_surface_", trial_num, "_binned"))
    
    # Check column names
    bin_area_col <- get_column_name(surface_bin_data, c("log_area", "Area"))
    bin_count_col <- get_column_name(surface_bin_data, c("log_count_bin"))
    
    wit_bin_area_col <- get_column_name(witness_bin_data, c("log_area", "Area"))
    wit_bin_count_col <- get_column_name(witness_bin_data, c("log_count_bin"))
    
    # Base plot for surface binned
    p_surf_bin <- ggplot()
    
    if (!is.null(bin_area_col) && !is.null(bin_count_col)) {
      p_surf_bin <- p_surf_bin + 
        geom_line(data = surface_bin_data,
                  aes_string(x = bin_area_col, y = bin_count_col),
                  color = "#D55E00", 
                  linetype = "solid")
    }
    
    if (!is.null(wit_bin_area_col) && !is.null(wit_bin_count_col)) {
      p_surf_bin <- p_surf_bin + 
        geom_line(data = witness_bin_data,
                  aes_string(x = wit_bin_area_col, y = wit_bin_count_col),
                  color = "#009E73", 
                  linetype = "dashed")
    }
    
    # Add calibration data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("cw_surface_", trial_num, "_binned"))) {
        cw_bin_data <- get(paste0("cw_surface_", trial_num, "_binned"))
        cw_bin_area_col <- get_column_name(cw_bin_data, c("log_area", "Area"))
        cw_bin_count_col <- get_column_name(cw_bin_data, c("log_count_bin"))
        
        if (!is.null(cw_bin_area_col) && !is.null(cw_bin_count_col)) {
          p_surf_bin <- p_surf_bin +
            geom_line(data = cw_bin_data,
                      aes_string(x = cw_bin_area_col, y = cw_bin_count_col),
                      color = "#CC79A7", 
                      linetype = "dotted")
        }
      }
    }
    
    # Finalize surface binned plot
    p_surf_bin <- p_surf_bin +
      labs(
        x = expression(log[10](Area)),
        y = "log10(Count)"
      ) +
      compact_theme
    
    surface_binned_plots[[i]] <- p_surf_bin
  }, error = function(e) {
    surface_binned_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating surface binned plot for trial", trial_num, ":", e$message))
  })
  
  # 3. Edge cumulative plots 
  tryCatch({
    edge_data <- get(paste0("edge_", trial_num))
    cw_edge_data <- get(paste0("cw_edge_", trial_num))
    model_edge_data <- get(paste0("model_edge_", trial_num))
    SSLSM_edge_data <- get(paste0("SSLSM_edge_", trial_num))
    WSLSM_edge_data <- get(paste0("WSLSM_edge_", trial_num))
    
    # Check column names for each dataset
    edge_area_col <- get_column_name(edge_data, c("log_area", "Area"))
    edge_count_col <- get_column_name(edge_data, c("log_count", "Count", "Average_Count"))
    
    cw_edge_area_col <- get_column_name(cw_edge_data, c("log_area", "Area"))
    cw_edge_count_col <- get_column_name(cw_edge_data, c("log_count", "Count", "Average_Count"))
    
    model_edge_area_col <- get_column_name(model_edge_data, c("log_area", "Area"))
    model_edge_count_col <- get_column_name(model_edge_data, c("log_count", "Count", "Average_Count"))
    
    SSLSM_edge_area_col <- get_column_name(SSLSM_edge_data, c("log_area", "Area"))
    SSLSM_edge_count_col <- get_column_name(SSLSM_edge_data, c("log_count", "Count", "Average_Count", "Cumulative_Count"))
    
    WSLSM_edge_area_col <- get_column_name(WSLSM_edge_data, c("log_area", "Area"))
    WSLSM_edge_count_col <- get_column_name(WSLSM_edge_data, c("log_count", "Count", "Average_Count", "Cumulative_Count"))
    
    # Base plot for edge cumulative
    p_edge_cum <- ggplot()
    
    if (!is.null(edge_area_col) && !is.null(edge_count_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = edge_data,
                  aes_string(x = edge_area_col, y = edge_count_col),
                  color = "#CC79A7", 
                  linetype = "solid")
    }
    
    if (!is.null(cw_edge_area_col) && !is.null(cw_edge_count_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = cw_edge_data,
                  aes_string(x = cw_edge_area_col, y = cw_edge_count_col),
                  color = "#0072B2", 
                  linetype = "dashed")
    }
    
    if (!is.null(model_edge_area_col) && !is.null(model_edge_count_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = model_edge_data,
                  aes_string(x = model_edge_area_col, y = model_edge_count_col),
                  color = "#009E73", 
                  linetype = "dotted")
    }
    
    if (!is.null(SSLSM_edge_area_col) && !is.null(SSLSM_edge_count_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = SSLSM_edge_data,
                  aes_string(x = SSLSM_edge_area_col, y = SSLSM_edge_count_col),
                  color = "#D55E00", 
                  linetype = "dotdash")
    }
    
    if (!is.null(WSLSM_edge_area_col) && !is.null(WSLSM_edge_count_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = WSLSM_edge_data,
                  aes_string(x = WSLSM_edge_area_col, y = WSLSM_edge_count_col),
                  color = "#56B4E9", 
                  linetype = "longdash")
    }
    
    # Add calibration SLSM data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("CSLSM_edge_", trial_num))) {
        CSLSM_edge_data <- get(paste0("CSLSM_edge_", trial_num))
        CSLSM_edge_area_col <- get_column_name(CSLSM_edge_data, c("log_area", "Area"))
        CSLSM_edge_count_col <- get_column_name(CSLSM_edge_data, c("log_count", "Count", "Average_Count", "Cumulative_Count"))
        
        if (!is.null(CSLSM_edge_area_col) && !is.null(CSLSM_edge_count_col)) {
          p_edge_cum <- p_edge_cum +
            geom_line(data = CSLSM_edge_data,
                      aes_string(x = CSLSM_edge_area_col, y = CSLSM_edge_count_col),
                      color = "#F0E442", 
                      linetype = "twodash")
        }
      }
    }
    
    # Finalize edge cumulative plot
    p_edge_cum <- p_edge_cum +
      labs(
        x = expression(log[10](Area)),
        y = "log10(Count)"
      ) +
      compact_theme
    
    edge_cumulative_plots[[i]] <- p_edge_cum
  }, error = function(e) {
    edge_cumulative_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating edge cumulative plot for trial", trial_num, ":", e$message))
  })
  
  # 4. Edge binned plots
  tryCatch({
    edge_bin_data <- get(paste0("edge_", trial_num, "_binned"))
    cw_edge_bin_data <- get(paste0("cw_edge_", trial_num, "_binned"))
    model_edge_bin_data <- get(paste0("model_edge_", trial_num, "_binned"))
    SSLSM_edge_bin_data <- get(paste0("SSLSM_edge_", trial_num, "_binned"))
    WSLSM_edge_bin_data <- get(paste0("WSLSM_edge_", trial_num, "_binned"))
    
    # Check column names for each dataset
    edge_bin_area_col <- get_column_name(edge_bin_data, c("log_area", "Area"))
    edge_bin_count_col <- get_column_name(edge_bin_data, c("log_count_bin"))
    
    cw_edge_bin_area_col <- get_column_name(cw_edge_bin_data, c("log_area", "Area"))
    cw_edge_bin_count_col <- get_column_name(cw_edge_bin_data, c("log_count_bin"))
    
    model_edge_bin_area_col <- get_column_name(model_edge_bin_data, c("log_area", "Area"))
    model_edge_bin_count_col <- get_column_name(model_edge_bin_data, c("log_count_bin"))
    
    SSLSM_edge_bin_area_col <- get_column_name(SSLSM_edge_bin_data, c("log_area", "Area"))
    SSLSM_edge_bin_count_col <- get_column_name(SSLSM_edge_bin_data, c("log_count_bin"))
    
    WSLSM_edge_bin_area_col <- get_column_name(WSLSM_edge_bin_data, c("log_area", "Area"))
    WSLSM_edge_bin_count_col <- get_column_name(WSLSM_edge_bin_data, c("log_count_bin"))
    
    # Base plot for edge binned
    p_edge_bin <- ggplot()
    
    if (!is.null(edge_bin_area_col) && !is.null(edge_bin_count_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = edge_bin_data,
                  aes_string(x = edge_bin_area_col, y = edge_bin_count_col),
                  color = "#CC79A7", 
                  linetype = "solid")
    }
    
    if (!is.null(cw_edge_bin_area_col) && !is.null(cw_edge_bin_count_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = cw_edge_bin_data,
                  aes_string(x = cw_edge_bin_area_col, y = cw_edge_bin_count_col),
                  color = "#0072B2", 
                  linetype = "dashed")
    }
    
    if (!is.null(model_edge_bin_area_col) && !is.null(model_edge_bin_count_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = model_edge_bin_data,
                  aes_string(x = model_edge_bin_area_col, y = model_edge_bin_count_col),
                  color = "#009E73", 
                  linetype = "dotted")
    }
    
    if (!is.null(SSLSM_edge_bin_area_col) && !is.null(SSLSM_edge_bin_count_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = SSLSM_edge_bin_data,
                  aes_string(x = SSLSM_edge_bin_area_col, y = SSLSM_edge_bin_count_col),
                  color = "#D55E00", 
                  linetype = "dotdash")
    }
    
    if (!is.null(WSLSM_edge_bin_area_col) && !is.null(WSLSM_edge_bin_count_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = WSLSM_edge_bin_data,
                  aes_string(x = WSLSM_edge_bin_area_col, y = WSLSM_edge_bin_count_col),
                  color = "#56B4E9", 
                  linetype = "longdash")
    }
    
    # Add calibration SLSM data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("CSLSM_edge_", trial_num, "_binned"))) {
        CSLSM_edge_bin_data <- get(paste0("CSLSM_edge_", trial_num, "_binned"))
        CSLSM_edge_bin_area_col <- get_column_name(CSLSM_edge_bin_data, c("log_area", "Area"))
        CSLSM_edge_bin_count_col <- get_column_name(CSLSM_edge_bin_data, c("log_count_bin"))
        
        if (!is.null(CSLSM_edge_bin_area_col) && !is.null(CSLSM_edge_bin_count_col)) {
          p_edge_bin <- p_edge_bin +
            geom_line(data = CSLSM_edge_bin_data,
                      aes_string(x = CSLSM_edge_bin_area_col, y = CSLSM_edge_bin_count_col),
                      color = "#F0E442", 
                      linetype = "twodash")
        }
      }
    }
    
    # Finalize edge binned plot
    p_edge_bin <- p_edge_bin +
      labs(
        x = expression(log[10](Area)),
        y = "log10(Count)"
      ) +
      compact_theme
    
    edge_binned_plots[[i]] <- p_edge_bin
  }, error = function(e) {
    edge_binned_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating edge binned plot for trial", trial_num, ":", e$message))
  })
}

# Add the average plots and air average plots (from trials 13-14)
# Surface cumulative average
tryCatch({
  surface_avg_cum_plot <- ggplot()
  surface_avg_air_cum_plot <- ggplot()
  
  # Check column names for standard average
  s_avg_area_col <- get_column_name(surface_average, c("log_area", "Area"))
  s_avg_count_col <- get_column_name(surface_average, c("log_count", "Count", "Average_Count"))
  
  wit_avg_area_col <- get_column_name(wit_surface_average, c("log_area", "Area"))
  wit_avg_count_col <- get_column_name(wit_surface_average, c("log_count", "Count", "Average_Count"))
  
  cw_avg_area_col <- get_column_name(cw_surface_average, c("log_area", "Area"))
  cw_avg_count_col <- get_column_name(cw_surface_average, c("log_count", "Count", "Average_Count"))
  
  # Check column names for air average (trials 13-14)
  s_avg_air_area_col <- get_column_name(surface_average_air, c("log_area", "Area"))
  s_avg_air_count_col <- get_column_name(surface_average_air, c("log_count", "Count", "Average_Count"))
  
  wit_avg_air_area_col <- get_column_name(wit_surface_average_air, c("log_area", "Area"))
  wit_avg_air_count_col <- get_column_name(wit_surface_average_air, c("log_count", "Count", "Average_Count"))
  
  cw_avg_air_area_col <- get_column_name(cw_surface_average_air, c("log_area", "Area"))
  cw_avg_air_count_col <- get_column_name(cw_surface_average_air, c("log_count", "Count", "Average_Count"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(s_avg_area_col) && !is.null(s_avg_count_col)) {
    surface_avg_cum_plot <- surface_avg_cum_plot +
      geom_line(data = surface_average,
                aes_string(x = s_avg_area_col, y = s_avg_count_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_area_col) && !is.null(wit_avg_count_col)) {
    surface_avg_cum_plot <- surface_avg_cum_plot +
      geom_line(data = wit_surface_average,
                aes_string(x = wit_avg_area_col, y = wit_avg_count_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_area_col) && !is.null(cw_avg_count_col)) {
    surface_avg_cum_plot <- surface_avg_cum_plot +
      geom_line(data = cw_surface_average,
                aes_string(x = cw_avg_area_col, y = cw_avg_count_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(s_avg_air_area_col) && !is.null(s_avg_air_count_col)) {
    surface_avg_air_cum_plot <- surface_avg_air_cum_plot +
      geom_line(data = surface_average_air,
                aes_string(x = s_avg_air_area_col, y = s_avg_air_count_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_air_area_col) && !is.null(wit_avg_air_count_col)) {
    surface_avg_air_cum_plot <- surface_avg_air_cum_plot +
      geom_line(data = wit_surface_average_air,
                aes_string(x = wit_avg_air_area_col, y = wit_avg_air_count_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_air_area_col) && !is.null(cw_avg_air_count_col)) {
    surface_avg_air_cum_plot <- surface_avg_air_cum_plot +
      geom_line(data = cw_surface_average_air,
                aes_string(x = cw_avg_air_area_col, y = cw_avg_air_count_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  surface_avg_cum_plot <- surface_avg_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    compact_theme
  
  surface_avg_air_cum_plot <- surface_avg_air_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    compact_theme
  
  surface_cumulative_plots[[length(trial_order) + 1]] <- surface_avg_cum_plot
  surface_cumulative_plots[[length(trial_order) + 2]] <- surface_avg_air_cum_plot
}, error = function(e) {
  surface_cumulative_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  surface_cumulative_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating surface cumulative average plots:", e$message))
})

# Surface binned average
tryCatch({
  surface_avg_bin_plot <- ggplot()
  surface_avg_air_bin_plot <- ggplot()
  
  # Check column names for standard average
  s_avg_bin_area_col <- get_column_name(surface_average_binned, c("log_area", "Area"))
  s_avg_bin_count_col <- get_column_name(surface_average_binned, c("log_count_bin"))
  
  wit_avg_bin_area_col <- get_column_name(wit_surface_average_binned, c("log_area", "Area"))
  wit_avg_bin_count_col <- get_column_name(wit_surface_average_binned, c("log_count_bin"))
  
  cw_avg_bin_area_col <- get_column_name(cw_surface_average_binned, c("log_area", "Area"))
  cw_avg_bin_count_col <- get_column_name(cw_surface_average_binned, c("log_count_bin"))
  
  # Check column names for air average (trials 13-14)
  s_avg_air_bin_area_col <- get_column_name(surface_average_air_binned, c("log_area", "Area"))
  s_avg_air_bin_count_col <- get_column_name(surface_average_air_binned, c("log_count_bin"))
  
  wit_avg_air_bin_area_col <- get_column_name(wit_surface_average_air_binned, c("log_area", "Area"))
  wit_avg_air_bin_count_col <- get_column_name(wit_surface_average_air_binned, c("log_count_bin"))
  
  cw_avg_air_bin_area_col <- get_column_name(cw_surface_average_air_binned, c("log_area", "Area"))
  cw_avg_air_bin_count_col <- get_column_name(cw_surface_average_air_binned, c("log_count_bin"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(s_avg_bin_area_col) && !is.null(s_avg_bin_count_col)) {
    surface_avg_bin_plot <- surface_avg_bin_plot +
      geom_line(data = surface_average_binned,
                aes_string(x = s_avg_bin_area_col, y = s_avg_bin_count_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_bin_area_col) && !is.null(wit_avg_bin_count_col)) {
    surface_avg_bin_plot <- surface_avg_bin_plot +
      geom_line(data = wit_surface_average_binned,
                aes_string(x = wit_avg_bin_area_col, y = wit_avg_bin_count_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
 if (!is.null(cw_avg_bin_area_col) && !is.null(cw_avg_bin_count_col)) {
    surface_avg_bin_plot <- surface_avg_bin_plot +
      geom_line(data = cw_surface_average_binned,
                aes_string(x = cw_avg_bin_area_col, y = cw_avg_bin_count_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(s_avg_air_bin_area_col) && !is.null(s_avg_air_bin_count_col)) {
    surface_avg_air_bin_plot <- surface_avg_air_bin_plot +
      geom_line(data = surface_average_air_binned,
                aes_string(x = s_avg_air_bin_area_col, y = s_avg_air_bin_count_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_air_bin_area_col) && !is.null(wit_avg_air_bin_count_col)) {
    surface_avg_air_bin_plot <- surface_avg_air_bin_plot +
      geom_line(data = wit_surface_average_air_binned,
                aes_string(x = wit_avg_air_bin_area_col, y = wit_avg_air_bin_count_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_air_bin_area_col) && !is.null(cw_avg_air_bin_count_col)) {
    surface_avg_air_bin_plot <- surface_avg_air_bin_plot +
      geom_line(data = cw_surface_average_air_binned,
                aes_string(x = cw_avg_air_bin_area_col, y = cw_avg_air_bin_count_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  surface_avg_bin_plot <- surface_avg_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    compact_theme
  
  surface_avg_air_bin_plot <- surface_avg_air_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    compact_theme
  
  surface_binned_plots[[length(trial_order) + 1]] <- surface_avg_bin_plot
  surface_binned_plots[[length(trial_order) + 2]] <- surface_avg_air_bin_plot
}, error = function(e) {
  surface_binned_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  surface_binned_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating surface binned average plots:", e$message))
})

# Edge cumulative average
tryCatch({
  edge_avg_cum_plot <- ggplot()
  edge_avg_air_cum_plot <- ggplot()
  
  # Check column names for standard average
  e_avg_area_col <- get_column_name(edge_average, c("log_area", "Area"))
  e_avg_count_col <- get_column_name(edge_average, c("log_count", "Count", "Average_Count"))
  
  cw_e_avg_area_col <- get_column_name(cw_edge_average, c("log_area", "Area"))
  cw_e_avg_count_col <- get_column_name(cw_edge_average, c("log_count", "Count", "Average_Count"))
  
  m_e_avg_area_col <- get_column_name(model_edge_average, c("log_area", "Area"))
  m_e_avg_count_col <- get_column_name(model_edge_average, c("log_count", "Count", "Average_Count"))
  
  SSLSM_e_avg_area_col <- get_column_name(SSLSM_edge_average, c("log_area", "Area"))
  SSLSM_e_avg_count_col <- get_column_name(SSLSM_edge_average, c("log_count", "Count", "Average_Count"))
  
  WSLSM_e_avg_area_col <- get_column_name(WSLSM_edge_average, c("log_area", "Area"))
  WSLSM_e_avg_count_col <- get_column_name(WSLSM_edge_average, c("log_count", "Count", "Average_Count"))
  
  CSLSM_e_avg_area_col <- get_column_name(CSLSM_edge_average, c("log_area", "Area"))
  CSLSM_e_avg_count_col <- get_column_name(CSLSM_edge_average, c("log_count", "Count", "Average_Count"))
  
  # Check column names for air average (trials 13-14)
  e_avg_air_area_col <- get_column_name(edge_average_air, c("log_area", "Area"))
  e_avg_air_count_col <- get_column_name(edge_average_air, c("log_count", "Count", "Average_Count"))
  
  cw_e_avg_air_area_col <- get_column_name(cw_edge_average_air, c("log_area", "Area"))
  cw_e_avg_air_count_col <- get_column_name(cw_edge_average_air, c("log_count", "Count", "Average_Count"))
  
  m_e_avg_air_area_col <- get_column_name(model_edge_average_air, c("log_area", "Area"))
  m_e_avg_air_count_col <- get_column_name(model_edge_average_air, c("log_count", "Count", "Average_Count"))
  
  SSLSM_e_avg_air_area_col <- get_column_name(SSLSM_edge_average_air, c("log_area", "Area"))
  SSLSM_e_avg_air_count_col <- get_column_name(SSLSM_edge_average_air, c("log_count", "Count", "Average_Count"))
  
  WSLSM_e_avg_air_area_col <- get_column_name(WSLSM_edge_average_air, c("log_area", "Area"))
  WSLSM_e_avg_air_count_col <- get_column_name(WSLSM_edge_average_air, c("log_count", "Count", "Average_Count"))
  
  CSLSM_e_avg_air_area_col <- get_column_name(CSLSM_edge_average_air, c("log_area", "Area"))
  CSLSM_e_avg_air_count_col <- get_column_name(CSLSM_edge_average_air, c("log_count", "Count", "Average_Count"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(e_avg_area_col) && !is.null(e_avg_count_col)) {
    edge_avg_cum_plot <- edge_avg_cum_plot +
      geom_line(data = edge_average,
                aes_string(x = e_avg_area_col, y = e_avg_count_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_area_col) && !is.null(cw_e_avg_count_col)) {
    edge_avg_cum_plot <- edge_avg_cum_plot +
      geom_line(data = cw_edge_average,
                aes_string(x = cw_e_avg_area_col, y = cw_e_avg_count_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  if (!is.null(m_e_avg_area_col) && !is.null(m_e_avg_count_col)) {
    edge_avg_cum_plot <- edge_avg_cum_plot +
      geom_line(data = model_edge_average,
                aes_string(x = m_e_avg_area_col, y = m_e_avg_count_col),
                color = "#009E73", 
                linetype = "dotted")
  }
  
  if (!is.null(SSLSM_e_avg_area_col) && !is.null(SSLSM_e_avg_count_col)) {
    edge_avg_cum_plot <- edge_avg_cum_plot +
      geom_line(data = SSLSM_edge_average,
                aes_string(x = SSLSM_e_avg_area_col, y = SSLSM_e_avg_count_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_area_col) && !is.null(WSLSM_e_avg_count_col)) {
    edge_avg_cum_plot <- edge_avg_cum_plot +
      geom_line(data = WSLSM_edge_average,
                aes_string(x = WSLSM_e_avg_area_col, y = WSLSM_e_avg_count_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_area_col) && !is.null(CSLSM_e_avg_count_col)) {
    edge_avg_cum_plot <- edge_avg_cum_plot +
      geom_line(data = CSLSM_edge_average,
                aes_string(x = CSLSM_e_avg_area_col, y = CSLSM_e_avg_count_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(e_avg_air_area_col) && !is.null(e_avg_air_count_col)) {
    edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
      geom_line(data = edge_average_air,
                aes_string(x = e_avg_air_area_col, y = e_avg_air_count_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_air_area_col) && !is.null(cw_e_avg_air_count_col)) {
    edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
      geom_line(data = cw_edge_average_air,
                aes_string(x = cw_e_avg_air_area_col, y = cw_e_avg_air_count_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  if (!is.null(m_e_avg_air_area_col) && !is.null(m_e_avg_air_count_col)) {
    edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
      geom_line(data = model_edge_average_air,
                aes_string(x = m_e_avg_air_area_col, y = m_e_avg_air_count_col),
                color = "#009E73", 
                linetype = "dotted")
  }
  
  if (!is.null(SSLSM_e_avg_air_area_col) && !is.null(SSLSM_e_avg_air_count_col)) {
    edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
      geom_line(data = SSLSM_edge_average_air,
                aes_string(x = SSLSM_e_avg_air_area_col, y = SSLSM_e_avg_air_count_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_air_area_col) && !is.null(WSLSM_e_avg_air_count_col)) {
    edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
      geom_line(data = WSLSM_edge_average_air,
                aes_string(x = WSLSM_e_avg_air_area_col, y = WSLSM_e_avg_air_count_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_air_area_col) && !is.null(CSLSM_e_avg_air_count_col)) {
    edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
      geom_line(data = CSLSM_edge_average_air,
                aes_string(x = CSLSM_e_avg_air_area_col, y = CSLSM_e_avg_air_count_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  edge_avg_cum_plot <- edge_avg_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    compact_theme
  
  edge_avg_air_cum_plot <- edge_avg_air_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    compact_theme
  
  edge_cumulative_plots[[length(trial_order) + 1]] <- edge_avg_cum_plot
  edge_cumulative_plots[[length(trial_order) + 2]] <- edge_avg_air_cum_plot
}, error = function(e) {
  edge_cumulative_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  edge_cumulative_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating edge cumulative average plots:", e$message))
})

# Edge binned average
tryCatch({
  edge_avg_bin_plot <- ggplot()
  edge_avg_air_bin_plot <- ggplot()
  
  # Check column names for standard average
  e_avg_bin_area_col <- get_column_name(edge_average_binned, c("log_area", "Area"))
  e_avg_bin_count_col <- get_column_name(edge_average_binned, c("log_count_bin"))
  
  cw_e_avg_bin_area_col <- get_column_name(cw_edge_average_binned, c("log_area", "Area"))
  cw_e_avg_bin_count_col <- get_column_name(cw_edge_average_binned, c("log_count_bin"))
  
  m_e_avg_bin_area_col <- get_column_name(model_edge_average_binned, c("log_area", "Area"))
  m_e_avg_bin_count_col <- get_column_name(model_edge_average_binned, c("log_count_bin"))
  
  SSLSM_e_avg_bin_area_col <- get_column_name(SSLSM_edge_average_binned, c("log_area", "Area"))
  SSLSM_e_avg_bin_count_col <- get_column_name(SSLSM_edge_average_binned, c("log_count_bin"))
  
  WSLSM_e_avg_bin_area_col <- get_column_name(WSLSM_edge_average_binned, c("log_area", "Area"))
  WSLSM_e_avg_bin_count_col <- get_column_name(WSLSM_edge_average_binned, c("log_count_bin"))
  
  CSLSM_e_avg_bin_area_col <- get_column_name(CSLSM_edge_average_binned, c("log_area", "Area"))
  CSLSM_e_avg_bin_count_col <- get_column_name(CSLSM_edge_average_binned, c("log_count_bin"))
  
  # Check column names for air average (trials 13-14)
  e_avg_air_bin_area_col <- get_column_name(edge_average_air_binned, c("log_area", "Area"))
  e_avg_air_bin_count_col <- get_column_name(edge_average_air_binned, c("log_count_bin"))
  
  cw_e_avg_air_bin_area_col <- get_column_name(cw_edge_average_air_binned, c("log_area", "Area"))
  cw_e_avg_air_bin_count_col <- get_column_name(cw_edge_average_air_binned, c("log_count_bin"))
  
  m_e_avg_air_bin_area_col <- get_column_name(model_edge_average_air_binned, c("log_area", "Area"))
  m_e_avg_air_bin_count_col <- get_column_name(model_edge_average_air_binned, c("log_count_bin"))
  
  SSLSM_e_avg_air_bin_area_col <- get_column_name(SSLSM_edge_average_air_binned, c("log_area", "Area"))
  SSLSM_e_avg_air_bin_count_col <- get_column_name(SSLSM_edge_average_air_binned, c("log_count_bin"))
  
  WSLSM_e_avg_air_bin_area_col <- get_column_name(WSLSM_edge_average_air_binned, c("log_area", "Area"))
  WSLSM_e_avg_air_bin_count_col <- get_column_name(WSLSM_edge_average_air_binned, c("log_count_bin"))
  
  CSLSM_e_avg_air_bin_area_col <- get_column_name(CSLSM_edge_average_air_binned, c("log_area", "Area"))
  CSLSM_e_avg_air_bin_count_col <- get_column_name(CSLSM_edge_average_air_binned, c("log_count_bin"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(e_avg_bin_area_col) && !is.null(e_avg_bin_count_col)) {
    edge_avg_bin_plot <- edge_avg_bin_plot +
      geom_line(data = edge_average_binned,
                aes_string(x = e_avg_bin_area_col, y = e_avg_bin_count_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_bin_area_col) && !is.null(cw_e_avg_bin_count_col)) {
    edge_avg_bin_plot <- edge_avg_bin_plot +
      geom_line(data = cw_edge_average_binned,
                aes_string(x = cw_e_avg_bin_area_col, y = cw_e_avg_bin_count_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  if (!is.null(m_e_avg_bin_area_col) && !is.null(m_e_avg_bin_count_col)) {
    edge_avg_bin_plot <- edge_avg_bin_plot +
      geom_line(data = model_edge_average_binned,
                aes_string(x = m_e_avg_bin_area_col, y = m_e_avg_bin_count_col),
                color = "#009E73", 
                linetype = "dotted")
  }
  
  if (!is.null(SSLSM_e_avg_bin_area_col) && !is.null(SSLSM_e_avg_bin_count_col)) {
    edge_avg_bin_plot <- edge_avg_bin_plot +
      geom_line(data = SSLSM_edge_average_binned,
                aes_string(x = SSLSM_e_avg_bin_area_col, y = SSLSM_e_avg_bin_count_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_bin_area_col) && !is.null(WSLSM_e_avg_bin_count_col)) {
    edge_avg_bin_plot <- edge_avg_bin_plot +
      geom_line(data = WSLSM_edge_average_binned,
                aes_string(x = WSLSM_e_avg_bin_area_col, y = WSLSM_e_avg_bin_count_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_bin_area_col) && !is.null(CSLSM_e_avg_bin_count_col)) {
    edge_avg_bin_plot <- edge_avg_bin_plot +
      geom_line(data = CSLSM_edge_average_binned,
                aes_string(x = CSLSM_e_avg_bin_area_col, y = CSLSM_e_avg_bin_count_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(e_avg_air_bin_area_col) && !is.null(e_avg_air_bin_count_col)) {
    edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
      geom_line(data = edge_average_air_binned,
                aes_string(x = e_avg_air_bin_area_col, y = e_avg_air_bin_count_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_air_bin_area_col) && !is.null(cw_e_avg_air_bin_count_col)) {
    edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
      geom_line(data = cw_edge_average_air_binned,
                aes_string(x = cw_e_avg_air_bin_area_col, y = cw_e_avg_air_bin_count_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  if (!is.null(m_e_avg_air_bin_area_col) && !is.null(m_e_avg_air_bin_count_col)) {
    edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
      geom_line(data = model_edge_average_air_binned,
                aes_string(x = m_e_avg_air_bin_area_col, y = m_e_avg_air_bin_count_col),
                color = "#009E73", 
                linetype = "dotted")
  }
  
  if (!is.null(SSLSM_e_avg_air_bin_area_col) && !is.null(SSLSM_e_avg_air_bin_count_col)) {
    edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
      geom_line(data = SSLSM_edge_average_air_binned,
                aes_string(x = SSLSM_e_avg_air_bin_area_col, y = SSLSM_e_avg_air_bin_count_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_air_bin_area_col) && !is.null(WSLSM_e_avg_air_bin_count_col)) {
    edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
      geom_line(data = WSLSM_edge_average_air_binned,
                aes_string(x = WSLSM_e_avg_air_bin_area_col, y = WSLSM_e_avg_air_bin_count_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_air_bin_area_col) && !is.null(CSLSM_e_avg_air_bin_count_col)) {
    edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
      geom_line(data = CSLSM_edge_average_air_binned,
                aes_string(x = CSLSM_e_avg_air_bin_area_col, y = CSLSM_e_avg_air_bin_count_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  edge_avg_bin_plot <- edge_avg_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    compact_theme
  
  edge_avg_air_bin_plot <- edge_avg_air_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "log10(Count)"
    ) +
    compact_theme
  
  edge_binned_plots[[length(trial_order) + 1]] <- edge_avg_bin_plot
  edge_binned_plots[[length(trial_order) + 2]] <- edge_avg_air_bin_plot
}, error = function(e) {
  edge_binned_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  edge_binned_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating edge binned average plots:", e$message))
})

# Create standalone legend grobs for surface and edge plots
surface_legend <- grobTree(
  # Starshade
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#D55E00", lty = "solid", lwd = 4)),
  textGrob("Starshade", x = unit(0.5, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Witness
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#009E73", lty = "dashed", lwd = 4)),
  textGrob("Witness", x = unit(0.5, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Calibration
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#CC79A7", lty = "dotted", lwd = 4)),
  textGrob("Calibration", x = unit(0.5, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20))
)

# Edge legend (more complex with 6 items)
edge_legend <- grobTree(
  # First column
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#CC79A7", lty = "solid", lwd = 4)),
  textGrob("Starshade Observed", x = unit(0.3, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#0072B2", lty = "dashed", lwd = 4)),
  textGrob("Calibration Observed", x = unit(0.3, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#009E73", lty = "dotted", lwd = 4)),
  textGrob("Model", x = unit(0.3, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Second column
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#D55E00", lty = "dotdash", lwd = 4)),
  textGrob("SLSM Starshade", x = unit(0.8, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#56B4E9", lty = "longdash", lwd = 4)),
  textGrob("SLSM Witness", x = unit(0.8, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#F0E442", lty = "twodash", lwd = 4)),
  textGrob("SLSM Calibration", x = unit(0.8, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20))
)

# Create column and row labels with consistent formatting
col_labels <- c(
  lapply(trial_order, function(t) textGrob(paste("Trial", t), gp = gpar(fontsize = 22, fontface = "bold"))),
  list(
    textGrob("Average", gp = gpar(fontsize = 22, fontface = "bold")),
    textGrob("Air Average", gp = gpar(fontsize = 22, fontface = "bold"))
  )
)

row_labels <- list(
  textGrob("Surface\nCumulative", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Surface\nBinned", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Edge\nCumulative", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Edge\nBinned", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90)
)

# Assemble the complete grid layout
complete_grid <- grid.arrange(
  # Main title 
  textGrob("Comprehensive Particle Distribution Analysis Across Trials", 
           gp = gpar(fontsize = 36, fontface = "bold"), y = 0.7),
  
  # Main grid
  grid.arrange(
    # Column labels
    arrangeGrob(
      nullGrob(), 
      col_labels[[1]], col_labels[[2]], col_labels[[3]], col_labels[[4]], 
      col_labels[[5]], col_labels[[6]], col_labels[[7]], col_labels[[8]],
      ncol = 9, widths = c(0.25, 1, 1, 1, 1, 1, 1, 1, 1),
      heights = unit(0.2, "cm")
    ),
    
    # Main plot grid with row labels
    arrangeGrob(
      # Surface Cumulative row
      row_labels[[1]],
      surface_cumulative_plots[[1]], surface_cumulative_plots[[2]], 
      surface_cumulative_plots[[3]], surface_cumulative_plots[[4]], 
      surface_cumulative_plots[[5]], surface_cumulative_plots[[6]], 
      surface_cumulative_plots[[7]], surface_cumulative_plots[[8]],
      
      # Surface Binned row
      row_labels[[2]],
      surface_binned_plots[[1]], surface_binned_plots[[2]], 
      surface_binned_plots[[3]], surface_binned_plots[[4]], 
      surface_binned_plots[[5]], surface_binned_plots[[6]], 
      surface_binned_plots[[7]], surface_binned_plots[[8]],
      
      # Edge Cumulative row
      row_labels[[3]],
      edge_cumulative_plots[[1]], edge_cumulative_plots[[2]], 
      edge_cumulative_plots[[3]], edge_cumulative_plots[[4]], 
      edge_cumulative_plots[[5]], edge_cumulative_plots[[6]], 
      edge_cumulative_plots[[7]], edge_cumulative_plots[[8]],
      
      # Edge Binned row
      row_labels[[4]],
      edge_binned_plots[[1]], edge_binned_plots[[2]], 
      edge_binned_plots[[3]], edge_binned_plots[[4]], 
      edge_binned_plots[[5]], edge_binned_plots[[6]], 
      edge_binned_plots[[7]], edge_binned_plots[[8]],
      
      ncol = 9, widths = c(0.25, 1, 1, 1, 1, 1, 1, 1, 1)
    ),
    
    # Legend section
    arrangeGrob(
      textGrob("Surface Plot Legend:", gp = gpar(fontsize = 22, fontface = "bold")), 
      surface_legend,
      textGrob("Edge Plot Legend:", gp = gpar(fontsize = 22, fontface = "bold")), 
      edge_legend,
      ncol = 4, widths = c(0.4, 1.3, 0.4, 1.3)
    ),
    
    # Layout adjustment
    nrow = 3,
    heights = c(0.1, 4, 0.5)
  ),
  
  # Overall layout parameters
  heights = c(0.05, 0.95)
)

# Display the complete grid
print(complete_grid)

# Save to high-resolution image
ggsave("particle_distribution_comparison1.png", complete_grid, width = 40, height = 20, dpi = 300)
```

### 10.2 Graph Comparison Graphic Scatter
```{r}
# Create a comprehensive comparison grid showing all trials and analysis types for scatter data
library(tidyverse)
library(gridExtra)
library(grid)

# Define trials in the requested order
trial_order <- c(9, 10, 11, 12, 13, 14)

# Custom theme for consistent appearance with minimal margins
compact_theme <- theme_minimal() +
  theme(
    plot.title = element_blank(),  # Remove individual plot titles
    plot.margin = margin(2, 2, 2, 2, "pt"),  # Minimize plot margins
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    legend.position = "none",
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray95")
  )

# Create lists to store plots
surface_scatter_cumulative_plots <- list()
surface_scatter_binned_plots <- list()
edge_scatter_cumulative_plots <- list()
edge_scatter_binned_plots <- list()

# Function to create a fallback plot when data isn't available
create_fallback_plot <- function() {
  ggplot() + 
    annotate("text", x = 2, y = 2, label = "Data not available") +
    theme_minimal() +
    theme(plot.margin = margin(2, 2, 2, 2, "pt")) +
    labs(x = expression(log[10](Area)), y = "Scatter Area")
}

# Helper function to check for column names
get_column_name <- function(data, possible_names) {
  for (name in possible_names) {
    if (name %in% names(data)) {
      return(name)
    }
  }
  return(NULL)
}

# Generate plots for each trial with error handling
for (i in 1:length(trial_order)) {
  trial_num <- trial_order[i]
  
  # 1. Surface cumulative scatter plots
  tryCatch({
    surface_data <- get(paste0("surface_", trial_num))
    witness_data <- get(paste0("wit_surface_", trial_num))
    
    # Check column names
    area_col <- get_column_name(surface_data, c("log_area", "Area"))
    scatter_col <- get_column_name(surface_data, c("Average_Scatter"))
    
    wit_area_col <- get_column_name(witness_data, c("log_area", "Area"))
    wit_scatter_col <- get_column_name(witness_data, c("Average_Scatter"))
    
    # Base plot for surface cumulative
    p_surf_cum <- ggplot()
    
    if (!is.null(area_col) && !is.null(scatter_col)) {
      p_surf_cum <- p_surf_cum + 
        geom_line(data = surface_data,
                  aes_string(x = area_col, y = scatter_col),
                  color = "#D55E00", 
                  linetype = "solid")
    }
    
    if (!is.null(wit_area_col) && !is.null(wit_scatter_col)) {
      p_surf_cum <- p_surf_cum + 
        geom_line(data = witness_data,
                  aes_string(x = wit_area_col, y = wit_scatter_col),
                  color = "#009E73", 
                  linetype = "dashed")
    }
    
    # Add calibration data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("cw_surface_", trial_num))) {
        cw_data <- get(paste0("cw_surface_", trial_num))
        cw_area_col <- get_column_name(cw_data, c("log_area", "Area"))
        cw_scatter_col <- get_column_name(cw_data, c("Average_Scatter"))
        
        if (!is.null(cw_area_col) && !is.null(cw_scatter_col)) {
          p_surf_cum <- p_surf_cum +
            geom_line(data = cw_data,
                      aes_string(x = cw_area_col, y = cw_scatter_col),
                      color = "#CC79A7", 
                      linetype = "dotted")
        }
      }
    }
    
    # Finalize surface cumulative plot with minimal spacing
    p_surf_cum <- p_surf_cum +
      labs(
        x = expression(log[10](Area)),
        y = "Scatter Area"
      ) +
      compact_theme
    
    surface_scatter_cumulative_plots[[i]] <- p_surf_cum
  }, error = function(e) {
    surface_scatter_cumulative_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating surface cumulative scatter plot for trial", trial_num, ":", e$message))
  })
  
  # 2. Surface binned scatter plots
  tryCatch({
    surface_bin_data <- get(paste0("surface_", trial_num, "_binned"))
    witness_bin_data <- get(paste0("wit_surface_", trial_num, "_binned"))
    
    # Check column names
    bin_area_col <- get_column_name(surface_bin_data, c("log_area", "Area"))
    bin_scatter_col <- get_column_name(surface_bin_data, c("Average_Scatter"))
    
    wit_bin_area_col <- get_column_name(witness_bin_data, c("log_area", "Area"))
    wit_bin_scatter_col <- get_column_name(witness_bin_data, c("Average_Scatter"))
    
    # Base plot for surface binned
    p_surf_bin <- ggplot()
    
    if (!is.null(bin_area_col) && !is.null(bin_scatter_col)) {
      p_surf_bin <- p_surf_bin + 
        geom_line(data = surface_bin_data,
                  aes_string(x = bin_area_col, y = bin_scatter_col),
                  color = "#D55E00", 
                  linetype = "solid")
    }
    
    if (!is.null(wit_bin_area_col) && !is.null(wit_bin_scatter_col)) {
      p_surf_bin <- p_surf_bin + 
        geom_line(data = witness_bin_data,
                  aes_string(x = wit_bin_area_col, y = wit_bin_scatter_col),
                  color = "#009E73", 
                  linetype = "dashed")
    }
    
    # Add calibration data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("cw_surface_", trial_num, "_binned"))) {
        cw_bin_data <- get(paste0("cw_surface_", trial_num, "_binned"))
        cw_bin_area_col <- get_column_name(cw_bin_data, c("log_area", "Area"))
        cw_bin_scatter_col <- get_column_name(cw_bin_data, c("Average_Scatter"))
        
        if (!is.null(cw_bin_area_col) && !is.null(cw_bin_scatter_col)) {
          p_surf_bin <- p_surf_bin +
            geom_line(data = cw_bin_data,
                      aes_string(x = cw_bin_area_col, y = cw_bin_scatter_col),
                      color = "#CC79A7", 
                      linetype = "dotted")
        }
      }
    }
    
    # Finalize surface binned plot
    p_surf_bin <- p_surf_bin +
      labs(
        x = expression(log[10](Area)),
        y = "Scatter Area"
      ) +
      compact_theme
    
    surface_scatter_binned_plots[[i]] <- p_surf_bin
  }, error = function(e) {
    surface_scatter_binned_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating surface binned scatter plot for trial", trial_num, ":", e$message))
  })
  
  # 3. Edge cumulative scatter plots 
  tryCatch({
    edge_data <- get(paste0("edge_", trial_num))
    cw_edge_data <- get(paste0("cw_edge_", trial_num))
    SSLSM_edge_data <- get(paste0("SSLSM_edge_", trial_num))
    WSLSM_edge_data <- get(paste0("WSLSM_edge_", trial_num))
    
    # Check column names for each dataset
    edge_area_col <- get_column_name(edge_data, c("log_area", "Area"))
    edge_scatter_col <- get_column_name(edge_data, c("Average_Scatter"))
    
    cw_edge_area_col <- get_column_name(cw_edge_data, c("log_area", "Area"))
    cw_edge_scatter_col <- get_column_name(cw_edge_data, c("Average_Scatter"))
    
    SSLSM_edge_area_col <- get_column_name(SSLSM_edge_data, c("log_area", "Area"))
    SSLSM_edge_scatter_col <- get_column_name(SSLSM_edge_data, c("Cumulative_Scatter"))
    
    WSLSM_edge_area_col <- get_column_name(WSLSM_edge_data, c("log_area", "Area"))
    WSLSM_edge_scatter_col <- get_column_name(WSLSM_edge_data, c("Cumulative_Scatter"))
    
    # Base plot for edge cumulative
    p_edge_cum <- ggplot()
    
    if (!is.null(edge_area_col) && !is.null(edge_scatter_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = edge_data,
                  aes_string(x = edge_area_col, y = edge_scatter_col),
                  color = "#CC79A7", 
                  linetype = "solid")
    }
    
    if (!is.null(cw_edge_area_col) && !is.null(cw_edge_scatter_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = cw_edge_data,
                  aes_string(x = cw_edge_area_col, y = cw_edge_scatter_col),
                  color = "#0072B2", 
                  linetype = "dashed")
    }
    
    if (!is.null(SSLSM_edge_area_col) && !is.null(SSLSM_edge_scatter_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = SSLSM_edge_data,
                  aes_string(x = SSLSM_edge_area_col, y = SSLSM_edge_scatter_col),
                  color = "#D55E00", 
                  linetype = "dotdash")
    }
    
    if (!is.null(WSLSM_edge_area_col) && !is.null(WSLSM_edge_scatter_col)) {
      p_edge_cum <- p_edge_cum + 
        geom_line(data = WSLSM_edge_data,
                  aes_string(x = WSLSM_edge_area_col, y = WSLSM_edge_scatter_col),
                  color = "#56B4E9", 
                  linetype = "longdash")
    }
    
    # Add calibration SLSM data for trials 12-14
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("CSLSM_edge_", trial_num))) {
        CSLSM_edge_data <- get(paste0("CSLSM_edge_", trial_num))
        CSLSM_edge_area_col <- get_column_name(CSLSM_edge_data, c("log_area", "Area"))
        CSLSM_edge_scatter_col <- get_column_name(CSLSM_edge_data, c("Cumulative_Scatter"))
        
        if (!is.null(CSLSM_edge_area_col) && !is.null(CSLSM_edge_scatter_col)) {
          p_edge_cum <- p_edge_cum +
            geom_line(data = CSLSM_edge_data,
                      aes_string(x = CSLSM_edge_area_col, y = CSLSM_edge_scatter_col),
                      color = "#F0E442", 
                      linetype = "twodash")
        }
      }
    }
    
    # Finalize edge cumulative plot
    p_edge_cum <- p_edge_cum +
      labs(
        x = expression(log[10](Area)),
        y = "Scatter Area"
      ) +
      compact_theme
    
    edge_scatter_cumulative_plots[[i]] <- p_edge_cum
  }, error = function(e) {
    edge_scatter_cumulative_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating edge cumulative scatter plot for trial", trial_num, ":", e$message))
  })
  
  # 4. Edge binned scatter plots
  tryCatch({
    edge_bin_data <- get(paste0("edge_", trial_num, "_binned"))
    cw_edge_bin_data <- get(paste0("cw_edge_", trial_num, "_binned"))
    
    # NEW: Add SSLSM and WSLSM binned data for all trials
    SSLSM_edge_bin_data <- get(paste0("SSLSM_edge_", trial_num, "_binned"))
    WSLSM_edge_bin_data <- get(paste0("WSLSM_edge_", trial_num, "_binned"))
    
    # Check column names for each dataset
    edge_bin_area_col <- get_column_name(edge_bin_data, c("log_area", "Area"))
    edge_bin_scatter_col <- get_column_name(edge_bin_data, c("Average_Scatter"))
    
    cw_edge_bin_area_col <- get_column_name(cw_edge_bin_data, c("log_area", "Area"))
    cw_edge_bin_scatter_col <- get_column_name(cw_edge_bin_data, c("Average_Scatter"))
    
    # NEW: Check column names for SSLSM and WSLSM binned data
    SSLSM_edge_bin_area_col <- get_column_name(SSLSM_edge_bin_data, c("log_area", "Area"))
    SSLSM_edge_bin_scatter_col <- get_column_name(SSLSM_edge_bin_data, c("Scatter"))
    
    WSLSM_edge_bin_area_col <- get_column_name(WSLSM_edge_bin_data, c("log_area", "Area"))
    WSLSM_edge_bin_scatter_col <- get_column_name(WSLSM_edge_bin_data, c("Scatter"))
    
    # Base plot for edge binned
    p_edge_bin <- ggplot()
    
    if (!is.null(edge_bin_area_col) && !is.null(edge_bin_scatter_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = edge_bin_data,
                  aes_string(x = edge_bin_area_col, y = edge_bin_scatter_col),
                  color = "#CC79A7", 
                  linetype = "solid")
    }
    
    if (!is.null(cw_edge_bin_area_col) && !is.null(cw_edge_bin_scatter_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = cw_edge_bin_data,
                  aes_string(x = cw_edge_bin_area_col, y = cw_edge_bin_scatter_col),
                  color = "#0072B2", 
                  linetype = "dashed")
    }
    
    # NEW: Add SSLSM and WSLSM lines to binned plots
    if (!is.null(SSLSM_edge_bin_area_col) && !is.null(SSLSM_edge_bin_scatter_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = SSLSM_edge_bin_data,
                  aes_string(x = SSLSM_edge_bin_area_col, y = SSLSM_edge_bin_scatter_col),
                  color = "#D55E00", 
                  linetype = "dotdash")
    }
    
    if (!is.null(WSLSM_edge_bin_area_col) && !is.null(WSLSM_edge_bin_scatter_col)) {
      p_edge_bin <- p_edge_bin + 
        geom_line(data = WSLSM_edge_bin_data,
                  aes_string(x = WSLSM_edge_bin_area_col, y = WSLSM_edge_bin_scatter_col),
                  color = "#56B4E9", 
                  linetype = "longdash")
    }
    
    # NEW: Add calibration SLSM data for trials 12-14 binned plots
    if(trial_num %in% c(12, 13, 14)) {
      if(exists(paste0("CSLSM_edge_", trial_num, "_binned"))) {
        CSLSM_edge_bin_data <- get(paste0("CSLSM_edge_", trial_num, "_binned"))
        CSLSM_edge_bin_area_col <- get_column_name(CSLSM_edge_bin_data, c("log_area", "Area"))
        CSLSM_edge_bin_scatter_col <- get_column_name(CSLSM_edge_bin_data, c("Scatter"))
        
        if (!is.null(CSLSM_edge_bin_area_col) && !is.null(CSLSM_edge_bin_scatter_col)) {
          p_edge_bin <- p_edge_bin +
            geom_line(data = CSLSM_edge_bin_data,
                      aes_string(x = CSLSM_edge_bin_area_col, y = CSLSM_edge_bin_scatter_col),
                      color = "#F0E442", 
                      linetype = "twodash")
        }
      }
    }
    
    # Finalize edge binned plot
    p_edge_bin <- p_edge_bin +
      labs(
        x = expression(log[10](Area)),
        y = "Scatter Area"
      ) +
      compact_theme
    
    edge_scatter_binned_plots[[i]] <- p_edge_bin
  }, error = function(e) {
    edge_scatter_binned_plots[[i]] <<- create_fallback_plot()
    message(paste("Error creating edge binned scatter plot for trial", trial_num, ":", e$message))
  })
}

# Add the average plots and air average plots
# Surface cumulative scatter average
tryCatch({
  surface_avg_scatter_cum_plot <- ggplot()
  surface_avg_air_scatter_cum_plot <- ggplot()
  
  # Check column names for standard average
  s_avg_area_col <- get_column_name(surface_average, c("log_area", "Area"))
  s_avg_scatter_col <- get_column_name(surface_average, c("Average_Scatter"))
  
  wit_avg_area_col <- get_column_name(wit_surface_average, c("log_area", "Area"))
  wit_avg_scatter_col <- get_column_name(wit_surface_average, c("Average_Scatter"))
  
  cw_avg_area_col <- get_column_name(cw_surface_average, c("log_area", "Area"))
  cw_avg_scatter_col <- get_column_name(cw_surface_average, c("Average_Scatter"))
  
  # Check column names for air average (trials 13-14)
  s_avg_air_area_col <- get_column_name(surface_average_air, c("log_area", "Area"))
  s_avg_air_scatter_col <- get_column_name(surface_average_air, c("Average_Scatter"))
  
  wit_avg_air_area_col <- get_column_name(wit_surface_average_air, c("log_area", "Area"))
  wit_avg_air_scatter_col <- get_column_name(wit_surface_average_air, c("Average_Scatter"))
  
  cw_avg_air_area_col <- get_column_name(cw_surface_average_air, c("log_area", "Area"))
  cw_avg_air_scatter_col <- get_column_name(cw_surface_average_air, c("Average_Scatter"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(s_avg_area_col) && !is.null(s_avg_scatter_col)) {
    surface_avg_scatter_cum_plot <- surface_avg_scatter_cum_plot +
      geom_line(data = surface_average,
                aes_string(x = s_avg_area_col, y = s_avg_scatter_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_area_col) && !is.null(wit_avg_scatter_col)) {
    surface_avg_scatter_cum_plot <- surface_avg_scatter_cum_plot +
      geom_line(data = wit_surface_average,
                aes_string(x = wit_avg_area_col, y = wit_avg_scatter_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_area_col) && !is.null(cw_avg_scatter_col)) {
    surface_avg_scatter_cum_plot <- surface_avg_scatter_cum_plot +
      geom_line(data = cw_surface_average,
                aes_string(x = cw_avg_area_col, y = cw_avg_scatter_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(s_avg_air_area_col) && !is.null(s_avg_air_scatter_col)) {
    surface_avg_air_scatter_cum_plot <- surface_avg_air_scatter_cum_plot +
      geom_line(data = surface_average_air,
                aes_string(x = s_avg_air_area_col, y = s_avg_air_scatter_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_air_area_col) && !is.null(wit_avg_air_scatter_col)) {
    surface_avg_air_scatter_cum_plot <- surface_avg_air_scatter_cum_plot +
      geom_line(data = wit_surface_average_air,
                aes_string(x = wit_avg_air_area_col, y = wit_avg_air_scatter_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_air_area_col) && !is.null(cw_avg_air_scatter_col)) {
    surface_avg_air_scatter_cum_plot <- surface_avg_air_scatter_cum_plot +
      geom_line(data = cw_surface_average_air,
                aes_string(x = cw_avg_air_area_col, y = cw_avg_air_scatter_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  surface_avg_scatter_cum_plot <- surface_avg_scatter_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  surface_avg_air_scatter_cum_plot <- surface_avg_air_scatter_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  surface_scatter_cumulative_plots[[length(trial_order) + 1]] <- surface_avg_scatter_cum_plot
  surface_scatter_cumulative_plots[[length(trial_order) + 2]] <- surface_avg_air_scatter_cum_plot
}, error = function(e) {
  surface_scatter_cumulative_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  surface_scatter_cumulative_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating surface cumulative scatter average plots:", e$message))
})

# Surface binned scatter average
tryCatch({
  surface_avg_scatter_bin_plot <- ggplot()
  surface_avg_air_scatter_bin_plot <- ggplot()
  
  # Check column names for standard average
  s_avg_bin_area_col <- get_column_name(surface_average_binned, c("log_area", "Area"))
  s_avg_bin_scatter_col <- get_column_name(surface_average_binned, c("Average_Scatter"))
  
  wit_avg_bin_area_col <- get_column_name(wit_surface_average_binned, c("log_area", "Area"))
  wit_avg_bin_scatter_col <- get_column_name(wit_surface_average_binned, c("Average_Scatter"))
  
  cw_avg_bin_area_col <- get_column_name(cw_surface_average_binned, c("log_area", "Area"))
  cw_avg_bin_scatter_col <- get_column_name(cw_surface_average_binned, c("Average_Scatter"))
  
  # Check column names for air average (trials 13-14)
  s_avg_air_bin_area_col <- get_column_name(surface_average_air_binned, c("log_area", "Area"))
  s_avg_air_bin_scatter_col <- get_column_name(surface_average_air_binned, c("Average_Scatter"))
  
  wit_avg_air_bin_area_col <- get_column_name(wit_surface_average_air_binned, c("log_area", "Area"))
  wit_avg_air_bin_scatter_col <- get_column_name(wit_surface_average_air_binned, c("Average_Scatter"))
  
  cw_avg_air_bin_area_col <- get_column_name(cw_surface_average_air_binned, c("log_area", "Area"))
  cw_avg_air_bin_scatter_col <- get_column_name(cw_surface_average_air_binned, c("Average_Scatter"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(s_avg_bin_area_col) && !is.null(s_avg_bin_scatter_col)) {
    surface_avg_scatter_bin_plot <- surface_avg_scatter_bin_plot +
      geom_line(data = surface_average_binned,
                aes_string(x = s_avg_bin_area_col, y = s_avg_bin_scatter_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_bin_area_col) && !is.null(wit_avg_bin_scatter_col)) {
    surface_avg_scatter_bin_plot <- surface_avg_scatter_bin_plot +
      geom_line(data = wit_surface_average_binned,
                aes_string(x = wit_avg_bin_area_col, y = wit_avg_bin_scatter_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_bin_area_col) && !is.null(cw_avg_bin_scatter_col)) {
    surface_avg_scatter_bin_plot <- surface_avg_scatter_bin_plot +
      geom_line(data = cw_surface_average_binned,
                aes_string(x = cw_avg_bin_area_col, y = cw_avg_bin_scatter_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(s_avg_air_bin_area_col) && !is.null(s_avg_air_bin_scatter_col)) {
    surface_avg_air_scatter_bin_plot <- surface_avg_air_scatter_bin_plot +
      geom_line(data = surface_average_air_binned,
                aes_string(x = s_avg_air_bin_area_col, y = s_avg_air_bin_scatter_col),
                color = "#D55E00", 
                linetype = "solid")
  }
  
  if (!is.null(wit_avg_air_bin_area_col) && !is.null(wit_avg_air_bin_scatter_col)) {
    surface_avg_air_scatter_bin_plot <- surface_avg_air_scatter_bin_plot +
      geom_line(data = wit_surface_average_air_binned,
                aes_string(x = wit_avg_air_bin_area_col, y = wit_avg_air_bin_scatter_col),
                color = "#009E73", 
                linetype = "dashed")
  }
  
  if (!is.null(cw_avg_air_bin_area_col) && !is.null(cw_avg_air_bin_scatter_col)) {
    surface_avg_air_scatter_bin_plot <- surface_avg_air_scatter_bin_plot +
      geom_line(data = cw_surface_average_air_binned,
                aes_string(x = cw_avg_air_bin_area_col, y = cw_avg_air_bin_scatter_col),
                color = "#CC79A7", 
                linetype = "dotted")
  }
  
  surface_avg_scatter_bin_plot <- surface_avg_scatter_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  surface_avg_air_scatter_bin_plot <- surface_avg_air_scatter_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  surface_scatter_binned_plots[[length(trial_order) + 1]] <- surface_avg_scatter_bin_plot
  surface_scatter_binned_plots[[length(trial_order) + 2]] <- surface_avg_air_scatter_bin_plot
}, error = function(e) {
  surface_scatter_binned_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  surface_scatter_binned_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating surface binned scatter average plots:", e$message))
})

# Edge cumulative scatter average
tryCatch({
  edge_avg_scatter_cum_plot <- ggplot()
  edge_avg_air_scatter_cum_plot <- ggplot()
  
  # Check column names for standard average
  e_avg_area_col <- get_column_name(edge_average, c("log_area", "Area"))
  e_avg_scatter_col <- get_column_name(edge_average, c("Average_Scatter"))
  
  cw_e_avg_area_col <- get_column_name(cw_edge_average, c("log_area", "Area"))
  cw_e_avg_scatter_col <- get_column_name(cw_edge_average, c("Average_Scatter"))
  
  SSLSM_e_avg_area_col <- get_column_name(SSLSM_edge_average, c("log_area", "Area"))
  SSLSM_e_avg_scatter_col <- get_column_name(SSLSM_edge_average, c("Average_Scatter"))
  
  WSLSM_e_avg_area_col <- get_column_name(WSLSM_edge_average, c("log_area", "Area"))
  WSLSM_e_avg_scatter_col <- get_column_name(WSLSM_edge_average, c("Average_Scatter"))
  
  CSLSM_e_avg_area_col <- get_column_name(CSLSM_edge_average, c("log_area", "Area"))
  CSLSM_e_avg_scatter_col <- get_column_name(CSLSM_edge_average, c("Average_Scatter"))
  
 # Check column names for air average (trials 13-14)
  e_avg_air_area_col <- get_column_name(edge_average_air, c("log_area", "Area"))
  e_avg_air_scatter_col <- get_column_name(edge_average_air, c("Average_Scatter"))
  
  cw_e_avg_air_area_col <- get_column_name(cw_edge_average_air, c("log_area", "Area"))
  cw_e_avg_air_scatter_col <- get_column_name(cw_edge_average_air, c("Average_Scatter"))
  
  SSLSM_e_avg_air_area_col <- get_column_name(SSLSM_edge_average_air, c("log_area", "Area"))
  SSLSM_e_avg_air_scatter_col <- get_column_name(SSLSM_edge_average_air, c("Average_Scatter"))
  
  WSLSM_e_avg_air_area_col <- get_column_name(WSLSM_edge_average_air, c("log_area", "Area"))
  WSLSM_e_avg_air_scatter_col <- get_column_name(WSLSM_edge_average_air, c("Average_Scatter"))
  
  CSLSM_e_avg_air_area_col <- get_column_name(CSLSM_edge_average_air, c("log_area", "Area"))
  CSLSM_e_avg_air_scatter_col <- get_column_name(CSLSM_edge_average_air, c("Average_Scatter"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(e_avg_area_col) && !is.null(e_avg_scatter_col)) {
    edge_avg_scatter_cum_plot <- edge_avg_scatter_cum_plot +
      geom_line(data = edge_average,
                aes_string(x = e_avg_area_col, y = e_avg_scatter_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_area_col) && !is.null(cw_e_avg_scatter_col)) {
    edge_avg_scatter_cum_plot <- edge_avg_scatter_cum_plot +
      geom_line(data = cw_edge_average,
                aes_string(x = cw_e_avg_area_col, y = cw_e_avg_scatter_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  if (!is.null(SSLSM_e_avg_area_col) && !is.null(SSLSM_e_avg_scatter_col)) {
    edge_avg_scatter_cum_plot <- edge_avg_scatter_cum_plot +
      geom_line(data = SSLSM_edge_average,
                aes_string(x = SSLSM_e_avg_area_col, y = SSLSM_e_avg_scatter_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_area_col) && !is.null(WSLSM_e_avg_scatter_col)) {
    edge_avg_scatter_cum_plot <- edge_avg_scatter_cum_plot +
      geom_line(data = WSLSM_edge_average,
                aes_string(x = WSLSM_e_avg_area_col, y = WSLSM_e_avg_scatter_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_area_col) && !is.null(CSLSM_e_avg_scatter_col)) {
    edge_avg_scatter_cum_plot <- edge_avg_scatter_cum_plot +
      geom_line(data = CSLSM_edge_average,
                aes_string(x = CSLSM_e_avg_area_col, y = CSLSM_e_avg_scatter_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(e_avg_air_area_col) && !is.null(e_avg_air_scatter_col)) {
    edge_avg_air_scatter_cum_plot <- edge_avg_air_scatter_cum_plot +
      geom_line(data = edge_average_air,
                aes_string(x = e_avg_air_area_col, y = e_avg_air_scatter_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_air_area_col) && !is.null(cw_e_avg_air_scatter_col)) {
    edge_avg_air_scatter_cum_plot <- edge_avg_air_scatter_cum_plot +
      geom_line(data = cw_edge_average_air,
                aes_string(x = cw_e_avg_air_area_col, y = cw_e_avg_air_scatter_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  if (!is.null(SSLSM_e_avg_air_area_col) && !is.null(SSLSM_e_avg_air_scatter_col)) {
    edge_avg_air_scatter_cum_plot <- edge_avg_air_scatter_cum_plot +
      geom_line(data = SSLSM_edge_average_air,
                aes_string(x = SSLSM_e_avg_air_area_col, y = SSLSM_e_avg_air_scatter_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_air_area_col) && !is.null(WSLSM_e_avg_air_scatter_col)) {
    edge_avg_air_scatter_cum_plot <- edge_avg_air_scatter_cum_plot +
      geom_line(data = WSLSM_edge_average_air,
                aes_string(x = WSLSM_e_avg_air_area_col, y = WSLSM_e_avg_air_scatter_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_air_area_col) && !is.null(CSLSM_e_avg_air_scatter_col)) {
    edge_avg_air_scatter_cum_plot <- edge_avg_air_scatter_cum_plot +
      geom_line(data = CSLSM_edge_average_air,
                aes_string(x = CSLSM_e_avg_air_area_col, y = CSLSM_e_avg_air_scatter_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  edge_avg_scatter_cum_plot <- edge_avg_scatter_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  edge_avg_air_scatter_cum_plot <- edge_avg_air_scatter_cum_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  edge_scatter_cumulative_plots[[length(trial_order) + 1]] <- edge_avg_scatter_cum_plot
  edge_scatter_cumulative_plots[[length(trial_order) + 2]] <- edge_avg_air_scatter_cum_plot
}, error = function(e) {
  edge_scatter_cumulative_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  edge_scatter_cumulative_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating edge cumulative scatter average plots:", e$message))
})

# Edge binned scatter average
tryCatch({
  edge_avg_scatter_bin_plot <- ggplot()
  edge_avg_air_scatter_bin_plot <- ggplot()
  
  # Check column names for standard average
  e_avg_bin_area_col <- get_column_name(edge_average_binned, c("log_area", "Area"))
  e_avg_bin_scatter_col <- get_column_name(edge_average_binned, c("Average_Scatter"))
  
  cw_e_avg_bin_area_col <- get_column_name(cw_edge_average_binned, c("log_area", "Area"))
  cw_e_avg_bin_scatter_col <- get_column_name(cw_edge_average_binned, c("Average_Scatter"))
  
  # NEW: Add SSLSM, WSLSM, and CSLSM for binned average plots
  SSLSM_e_avg_bin_area_col <- get_column_name(SSLSM_edge_average_binned, c("log_area", "Area"))
  SSLSM_e_avg_bin_scatter_col <- get_column_name(SSLSM_edge_average_binned, c("Average_Scatter"))
  
  WSLSM_e_avg_bin_area_col <- get_column_name(WSLSM_edge_average_binned, c("log_area", "Area"))
  WSLSM_e_avg_bin_scatter_col <- get_column_name(WSLSM_edge_average_binned, c("Average_Scatter"))
  
  CSLSM_e_avg_bin_area_col <- get_column_name(CSLSM_edge_average_binned, c("log_area", "Area"))
  CSLSM_e_avg_bin_scatter_col <- get_column_name(CSLSM_edge_average_binned, c("Average_Scatter"))
  
  # Check column names for air average (trials 13-14)
  e_avg_air_bin_area_col <- get_column_name(edge_average_air_binned, c("log_area", "Area"))
  e_avg_air_bin_scatter_col <- get_column_name(edge_average_air_binned, c("Average_Scatter"))
  
  cw_e_avg_air_bin_area_col <- get_column_name(cw_edge_average_air_binned, c("log_area", "Area"))
  cw_e_avg_air_bin_scatter_col <- get_column_name(cw_edge_average_air_binned, c("Average_Scatter"))
  
  # NEW: Add SSLSM, WSLSM, and CSLSM for air binned average plots
  SSLSM_e_avg_air_bin_area_col <- get_column_name(SSLSM_edge_average_air_binned, c("log_area", "Area"))
  SSLSM_e_avg_air_bin_scatter_col <- get_column_name(SSLSM_edge_average_air_binned, c("Average_Scatter"))
  
  WSLSM_e_avg_air_bin_area_col <- get_column_name(WSLSM_edge_average_air_binned, c("log_area", "Area"))
  WSLSM_e_avg_air_bin_scatter_col <- get_column_name(WSLSM_edge_average_air_binned, c("Average_Scatter"))
  
  CSLSM_e_avg_air_bin_area_col <- get_column_name(CSLSM_edge_average_air_binned, c("log_area", "Area"))
  CSLSM_e_avg_air_bin_scatter_col <- get_column_name(CSLSM_edge_average_air_binned, c("Average_Scatter"))
  
  # Plot for standard average (trials 9-12)
  if (!is.null(e_avg_bin_area_col) && !is.null(e_avg_bin_scatter_col)) {
    edge_avg_scatter_bin_plot <- edge_avg_scatter_bin_plot +
      geom_line(data = edge_average_binned,
                aes_string(x = e_avg_bin_area_col, y = e_avg_bin_scatter_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_bin_area_col) && !is.null(cw_e_avg_bin_scatter_col)) {
    edge_avg_scatter_bin_plot <- edge_avg_scatter_bin_plot +
      geom_line(data = cw_edge_average_binned,
                aes_string(x = cw_e_avg_bin_area_col, y = cw_e_avg_bin_scatter_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  # NEW: Add SSLSM, WSLSM, and CSLSM to standard average binned plot
  if (!is.null(SSLSM_e_avg_bin_area_col) && !is.null(SSLSM_e_avg_bin_scatter_col)) {
    edge_avg_scatter_bin_plot <- edge_avg_scatter_bin_plot +
      geom_line(data = SSLSM_edge_average_binned,
                aes_string(x = SSLSM_e_avg_bin_area_col, y = SSLSM_e_avg_bin_scatter_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_bin_area_col) && !is.null(WSLSM_e_avg_bin_scatter_col)) {
    edge_avg_scatter_bin_plot <- edge_avg_scatter_bin_plot +
      geom_line(data = WSLSM_edge_average_binned,
                aes_string(x = WSLSM_e_avg_bin_area_col, y = WSLSM_e_avg_bin_scatter_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_bin_area_col) && !is.null(CSLSM_e_avg_bin_scatter_col)) {
    edge_avg_scatter_bin_plot <- edge_avg_scatter_bin_plot +
      geom_line(data = CSLSM_edge_average_binned,
                aes_string(x = CSLSM_e_avg_bin_area_col, y = CSLSM_e_avg_bin_scatter_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  # Plot for air average (trials 13-14)
  if (!is.null(e_avg_air_bin_area_col) && !is.null(e_avg_air_bin_scatter_col)) {
    edge_avg_air_scatter_bin_plot <- edge_avg_air_scatter_bin_plot +
      geom_line(data = edge_average_air_binned,
                aes_string(x = e_avg_air_bin_area_col, y = e_avg_air_bin_scatter_col),
                color = "#CC79A7", 
                linetype = "solid")
  }
  
  if (!is.null(cw_e_avg_air_bin_area_col) && !is.null(cw_e_avg_air_bin_scatter_col)) {
    edge_avg_air_scatter_bin_plot <- edge_avg_air_scatter_bin_plot +
      geom_line(data = cw_edge_average_air_binned,
                aes_string(x = cw_e_avg_air_bin_area_col, y = cw_e_avg_air_bin_scatter_col),
                color = "#0072B2", 
                linetype = "dashed")
  }
  
  # NEW: Add SSLSM, WSLSM, and CSLSM to air average binned plot
  if (!is.null(SSLSM_e_avg_air_bin_area_col) && !is.null(SSLSM_e_avg_air_bin_scatter_col)) {
    edge_avg_air_scatter_bin_plot <- edge_avg_air_scatter_bin_plot +
      geom_line(data = SSLSM_edge_average_air_binned,
                aes_string(x = SSLSM_e_avg_air_bin_area_col, y = SSLSM_e_avg_air_bin_scatter_col),
                color = "#D55E00", 
                linetype = "dotdash")
  }
  
  if (!is.null(WSLSM_e_avg_air_bin_area_col) && !is.null(WSLSM_e_avg_air_bin_scatter_col)) {
    edge_avg_air_scatter_bin_plot <- edge_avg_air_scatter_bin_plot +
      geom_line(data = WSLSM_edge_average_air_binned,
                aes_string(x = WSLSM_e_avg_air_bin_area_col, y = WSLSM_e_avg_air_bin_scatter_col),
                color = "#56B4E9", 
                linetype = "longdash")
  }
  
  if (!is.null(CSLSM_e_avg_air_bin_area_col) && !is.null(CSLSM_e_avg_air_bin_scatter_col)) {
    edge_avg_air_scatter_bin_plot <- edge_avg_air_scatter_bin_plot +
      geom_line(data = CSLSM_edge_average_air_binned,
                aes_string(x = CSLSM_e_avg_air_bin_area_col, y = CSLSM_e_avg_air_bin_scatter_col),
                color = "#F0E442", 
                linetype = "twodash")
  }
  
  edge_avg_scatter_bin_plot <- edge_avg_scatter_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  edge_avg_air_scatter_bin_plot <- edge_avg_air_scatter_bin_plot +
    labs(
      x = expression(log[10](Area)),
      y = "Scatter Area"
    ) +
    compact_theme
  
  edge_scatter_binned_plots[[length(trial_order) + 1]] <- edge_avg_scatter_bin_plot
  edge_scatter_binned_plots[[length(trial_order) + 2]] <- edge_avg_air_scatter_bin_plot
}, error = function(e) {
  edge_scatter_binned_plots[[length(trial_order) + 1]] <- create_fallback_plot()
  edge_scatter_binned_plots[[length(trial_order) + 2]] <- create_fallback_plot()
  message(paste("Error creating edge binned scatter average plots:", e$message))
})

# Create standalone legend grobs for surface and edge plots
surface_legend <- grobTree(
  # Starshade
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#D55E00", lty = "solid", lwd = 4)),
  textGrob("Starshade", x = unit(0.5, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Witness
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#009E73", lty = "dashed", lwd = 4)),
  textGrob("Witness", x = unit(0.5, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Calibration
  linesGrob(x = unit(c(0.1, 0.4), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#CC79A7", lty = "dotted", lwd = 4)),
  textGrob("Calibration", x = unit(0.5, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20))
)

# Edge legend (more complex with 6 items)
edge_legend <- grobTree(
  # First column
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#CC79A7", lty = "solid", lwd = 4)),
  textGrob("Starshade Observed", x = unit(0.3, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.05, 0.25), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#0072B2", lty = "dashed", lwd = 4)),
  textGrob("Calibration Observed", x = unit(0.3, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  # Second column
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.8, "npc"), 
            gp = gpar(col = "#D55E00", lty = "dotdash", lwd = 4)),
  textGrob("SLSM Starshade", x = unit(0.8, "npc"), y = unit(0.8, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.5, "npc"), 
            gp = gpar(col = "#56B4E9", lty = "longdash", lwd = 4)),
  textGrob("SLSM Witness", x = unit(0.8, "npc"), y = unit(0.5, "npc"), 
           just = "left", gp = gpar(fontsize = 20)),
  
  linesGrob(x = unit(c(0.55, 0.75), "npc"), y = unit(0.2, "npc"), 
            gp = gpar(col = "#F0E442", lty = "twodash", lwd = 4)),
  textGrob("SLSM Calibration", x = unit(0.8, "npc"), y = unit(0.2, "npc"), 
           just = "left", gp = gpar(fontsize = 20))
)

# Create column and row labels with consistent formatting
col_labels <- c(
  lapply(trial_order, function(t) textGrob(paste("Trial", t), gp = gpar(fontsize = 22, fontface = "bold"))),
  list(
    textGrob("Average", gp = gpar(fontsize = 22, fontface = "bold")),
    textGrob("Air Average", gp = gpar(fontsize = 22, fontface = "bold"))
  )
)

row_labels <- list(
  textGrob("Surface\nCumulative\nScatter", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Surface\nBinned\nScatter", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Edge\nCumulative\nScatter", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90),
  textGrob("Edge\nBinned\nScatter", gp = gpar(fontsize = 22, fontface = "bold"), rot = 90)
)

# Assemble the complete grid layout
scatter_grid <- grid.arrange(
  # Main title 
  textGrob("Comprehensive Particle Scatter Distribution Analysis Across Trials", 
           gp = gpar(fontsize = 36, fontface = "bold"), y = 0.7),
  
  # Main grid
  grid.arrange(
    # Column labels
    arrangeGrob(
      nullGrob(), 
      col_labels[[1]], col_labels[[2]], col_labels[[3]], col_labels[[4]], 
      col_labels[[5]], col_labels[[6]], col_labels[[7]], col_labels[[8]],
      ncol = 9, widths = c(0.25, 1, 1, 1, 1, 1, 1, 1, 1),
      heights = unit(0.2, "cm")
    ),
    
    # Main plot grid with row labels
    arrangeGrob(
      # Surface Cumulative row
      row_labels[[1]],
      surface_scatter_cumulative_plots[[1]], surface_scatter_cumulative_plots[[2]], 
      surface_scatter_cumulative_plots[[3]], surface_scatter_cumulative_plots[[4]], 
      surface_scatter_cumulative_plots[[5]], surface_scatter_cumulative_plots[[6]], 
      surface_scatter_cumulative_plots[[7]], surface_scatter_cumulative_plots[[8]],
      
      # Surface Binned row
      row_labels[[2]],
      surface_scatter_binned_plots[[1]], surface_scatter_binned_plots[[2]], 
      surface_scatter_binned_plots[[3]], surface_scatter_binned_plots[[4]], 
      surface_scatter_binned_plots[[5]], surface_scatter_binned_plots[[6]], 
      surface_scatter_binned_plots[[7]], surface_scatter_binned_plots[[8]],
      
      # Edge Cumulative row
      row_labels[[3]],
      edge_scatter_cumulative_plots[[1]], edge_scatter_cumulative_plots[[2]], 
      edge_scatter_cumulative_plots[[3]], edge_scatter_cumulative_plots[[4]], 
      edge_scatter_cumulative_plots[[5]], edge_scatter_cumulative_plots[[6]], 
      edge_scatter_cumulative_plots[[7]], edge_scatter_cumulative_plots[[8]],
      
      # Edge Binned row
      row_labels[[4]],
      edge_scatter_binned_plots[[1]], edge_scatter_binned_plots[[2]], 
      edge_scatter_binned_plots[[3]], edge_scatter_binned_plots[[4]], 
      edge_scatter_binned_plots[[5]], edge_scatter_binned_plots[[6]], 
      edge_scatter_binned_plots[[7]], edge_scatter_binned_plots[[8]],
      
      ncol = 9, widths = c(0.25, 1, 1, 1, 1, 1, 1, 1, 1)
    ),
    
    # Legend section
    arrangeGrob(
      textGrob("Surface Plot Legend:", gp = gpar(fontsize = 22, fontface = "bold")), 
      surface_legend,
      textGrob("Edge Plot Legend:", gp = gpar(fontsize = 22, fontface = "bold")), 
      edge_legend,
      ncol = 4, widths = c(0.4, 1.3, 0.4, 1.3)
    ),
    
    # Layout adjustment
    nrow = 3,
    heights = c(0.1, 4, 0.5)
  ),
  
  # Overall layout parameters
  heights = c(0.05, 0.95)
)

# Display the complete grid
print(scatter_grid)

# Save to high-resolution image
ggsave("particle_scatter_distribution_comparison.png", scatter_grid, width = 40, height = 20, dpi = 300)
```


## 11. Combined Analysis and Comparison

<!-- This section combines and compares all analyses to validate the edge contamination model -->

### 11.1 Cumulative Comparison

```{r combined_cumulative graphs}
# Plot the cumulative distribution of Surface data
ggplot() +
  geom_line(data = surface_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = surface_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = surface_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = surface_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = surface_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = surface_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

# Plot the cumulative distribution of witness data
ggplot() +
  geom_line(data = wit_surface_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = wit_surface_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = wit_surface_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = wit_surface_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = wit_surface_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = wit_surface_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Witness Surface Analysis: Cumulative Particle Area Distribution over 0.1 square meters",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

# Plot the cumulative starshade edge distributions
ggplot() +
  geom_line(data = edge_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = edge_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = edge_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

# Plot the cumulative calibration edge distributions
ggplot() +
  geom_line(data = cw_edge_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = cw_edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = cw_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = cw_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = cw_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

# Plot the cumulative model edge distributions
ggplot() +
  geom_line(data = model_edge_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = model_edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = model_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = model_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = model_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Model Edge Analysis: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

# Plot the cumulative starshade edge distributions
ggplot() +
  geom_line(data = SSLSM_edge_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = SSLSM_edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = SSLSM_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = SSLSM_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = SSLSM_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "SLSM Starshade Edge Analysis: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

# Plot the cumulative witness edge distributions
ggplot() +
    geom_line(data = CSLSM_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = CSLSM_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
  geom_line(data = CSLSM_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "SLSM Witness Edge Analysis: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme


# Plot the cumulative witness edge distributions
ggplot() +
  geom_line(data = WSLSM_edge_9,
            aes(x = log_area, y = log_count),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = WSLSM_edge_10,
            aes(x = log_area, y = log_count),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = WSLSM_edge_11,
              aes(x = log_area, y = log_count),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = WSLSM_edge_12,
              aes(x = log_area, y = log_count),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = WSLSM_edge_13,
              aes(x = log_area, y = log_count),
                  color = "#CC79A7", 
                  linetype = "longdash") +
  geom_line(data = WSLSM_edge_14,
              aes(x = log_area, y = log_count),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "SLSM Witness Edge Analysis: Cumulative Particle Area Distribution over 0.1 meter",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

```

### 11.2 Binned Comparison

```{r combined_binned graphs}
# Plot the Binned distribution of Surface data
ggplot() +
  geom_line(data = surface_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = surface_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = surface_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = surface_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = surface_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = surface_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Surface Analysis: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

# Plot the Binned distribution of witness data
ggplot() +
  geom_line(data = wit_surface_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = wit_surface_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = wit_surface_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = wit_surface_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = wit_surface_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = wit_surface_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Witness Surface Analysis: Binned Particle Area Distribution over 0.1 square meters",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

# Plot the Binned starshade edge distributions
ggplot() +
  geom_line(data = edge_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade Edge Analysis: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

# Plot the Binned calibration edge distributions
ggplot() +
  geom_line(data = cw_edge_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = cw_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = cw_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = cw_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = cw_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = cw_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration Edge Analysis: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

# Plot the Binned model edge distributions
ggplot() +
  geom_line(data = model_edge_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = model_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = model_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = model_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = model_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = model_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Model Edge Analysis: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

# Plot the Binned starshade edge distributions
ggplot() +
  geom_line(data = SSLSM_edge_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = SSLSM_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = SSLSM_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = SSLSM_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = SSLSM_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
        geom_line(data = SSLSM_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "SLSM Starshade Edge Analysis: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

# Plot the Binned witness edge distributions
ggplot() +
    geom_line(data = CSLSM_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = CSLSM_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
  geom_line(data = CSLSM_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "SLSM Witness Edge Analysis: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme


# Plot the Binned witness edge distributions
ggplot() +
  geom_line(data = WSLSM_edge_9_binned,
            aes(x = log_area, y = log_count_bin),
                color = "#56B4E9", 
            linetype = "solid") +
  geom_line(data = WSLSM_edge_10_binned,
            aes(x = log_area, y = log_count_bin),
            color = "#0072B2", 
            linetype = "dashed") +  
  geom_line(data = WSLSM_edge_11_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#009E73", 
                  linetype = "dotted") +
    geom_line(data = WSLSM_edge_12_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#D55E00", 
                  linetype = "dotdash") +
      geom_line(data = WSLSM_edge_13_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#CC79A7", 
                  linetype = "longdash") +
  geom_line(data = WSLSM_edge_14_binned,
              aes(x = log_area, y = log_count_bin),
                  color = "#F0E442", 
                  linetype = "twodash") +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "SLSM Witness Edge Analysis: Binned Particle Area Distribution over 0.1 meter",
    subtitle = "Blue: Trial 9, Navy Blue: Trial 10, Green: Trial 11, Orange: Trial 12, Purple: Trial 13, Yellow: Trial 14"
  ) +
  custom_theme

```

## 12. Multiple Line analysis

```{r Multiple_line_analysis}
# This section simulates drawing a line across surfaces and analyzes how particles intersect with it
# Expanded to cover trials 9, 12, 13, 14 and all three surfaces: starshade, calibration, and witness

# Define trials to analyze
trials_to_analyze <- c(9, 12, 13, 14)

# Calculate image dimensions for positioning
image_width <- 600  
image_height <- 450 

# Define line positions for edge simulation
lines <- c(10, 50, 100, 130, 185, 225, 290, 320, 350, 380)

# Function to check if a particle intersects with a horizontal line and calculate overhang area
particle_intersects_line <- function(particle, line_y) {
  # Check for missing values in required fields
  if (is.na(particle$BY) || is.na(particle$Height) || is.na(particle$Area) || 
      particle$Height <= 0 || particle$Area <= 0) {
    return(list(intersects = FALSE))
  }
  
  # Calculate the top and bottom boundaries of the particle
  particle_top <- particle$BY + particle$Height
  particle_bottom <- particle$BY 
  
  # Check for missing values in calculated positions
  if (is.na(particle_top) || is.na(particle_bottom)) {
    return(list(intersects = FALSE))
  }
  
  # Check if the line passes through the particle
  if (line_y <= particle_top && line_y >= particle_bottom) {
    # Calculate proportion of area that would overhang
    proportion_above_line <- (particle_top - line_y) / particle$Height
    
    # Calculate the area that would overhang the edge (below the line)
    overhang_area <- particle$Area * (proportion_above_line)
    
    # Additional safety checks
    if (is.na(proportion_above_line) || is.na(overhang_area)) {
      return(list(intersects = FALSE))
    }
    
    # Return intersection details
    return(list(
      intersects = TRUE,
      area = as.numeric(particle$Area),
      overhang_proportion = as.numeric(proportion_above_line),
      overhang_area = as.numeric(overhang_area),
      diameter = 2 * sqrt(particle$Area / pi),
      distance_from_line = min(abs(line_y - particle_top), abs(particle_bottom - line_y)),
      relative_position = (line_y - particle_bottom) / particle$Height
    ))
  } else {
    return(list(intersects = FALSE))
  }
}

# Function to analyze intersections for a single line
analyze_line_intersections <- function(particles_data, line_positions = NULL) {
  if (is.null(line_positions)) {
    line_positions <- image_height / 2
  }
  
  # Check if particles_data is empty or has no rows
  if (is.null(particles_data) || nrow(particles_data) == 0) {
    # Return empty results for all line positions
    all_results <- list()
    for (i in 1:length(line_positions)) {
      all_results[[i]] <- list(
        line_position = line_positions[i],
        num_intersections = 0,
        intersecting_particles = list(),
        total_area = 0,
        overhang_area = 0,
        size_data = tibble(area = numeric(0), diameter = numeric(0), overhang_prop = numeric(0))
      )
    }
    return(all_results)
  }
  
  all_results <- list()
  
  for (i in 1:length(line_positions)) {
    line_y <- line_positions[i]
    
    # Use tryCatch to handle any remaining errors in individual particle processing
    intersections <- tryCatch({
      map(1:nrow(particles_data), function(j) {
        particle_intersects_line(particles_data[j,], line_y)
      })
    }, error = function(e) {
      cat("Error processing particles for line", i, ":", e$message, "\n")
      return(list())
    })
    
    # Filter to only intersecting particles, with additional safety check
    intersecting_particles <- tryCatch({
      intersections[sapply(intersections, function(x) {
        !is.null(x) && is.list(x) && !is.null(x$intersects) && x$intersects == TRUE
      })]
    }, error = function(e) {
      cat("Error filtering intersections for line", i, ":", e$message, "\n")
      return(list())
    })
    
    if (length(intersecting_particles) > 0) {
      all_results[[i]] <- list(
        line_position = line_y,
        num_intersections = length(intersecting_particles),
        intersecting_particles = intersecting_particles,
        total_area = sum(sapply(intersecting_particles, function(x) x$area), na.rm = TRUE),
        overhang_area = sum(sapply(intersecting_particles, function(x) x$overhang_area), na.rm = TRUE),
        size_data = tibble(
          area = sapply(intersecting_particles, function(x) x$area),
          diameter = sapply(intersecting_particles, function(x) x$diameter),
          overhang_prop = sapply(intersecting_particles, function(x) x$overhang_proportion)
        )
      )
    } else {
      all_results[[i]] <- list(
        line_position = line_y,
        num_intersections = 0,
        intersecting_particles = list(),
        total_area = 0,
        overhang_area = 0,
        size_data = tibble(area = numeric(0), diameter = numeric(0), overhang_prop = numeric(0))
      )
    }
  }
  
  return(all_results)
}

# Function to process results to dataframe
process_results_to_df <- function(results_list, source_name, time_label, trial_number) {
  # Initialize empty list to store all dataframes
  result_dfs <- list()
  
  for (i in seq_along(results_list)) {
    result <- results_list[[i]]
    
    if (length(result$intersecting_particles) > 0) {
      # Process each intersecting particle individually to avoid data type conflicts
      particle_dfs <- list()
      
      for (j in seq_along(result$intersecting_particles)) {
        particle <- result$intersecting_particles[[j]]
        
        # Create a single-row dataframe for this particle
        particle_df <- data.frame(
          intersects = TRUE,  # Always TRUE for intersecting particles
          area = as.numeric(particle$area),
          overhang_proportion = as.numeric(particle$overhang_proportion),
          overhang_area = as.numeric(particle$overhang_area),
          diameter = as.numeric(particle$diameter),
          distance_from_line = as.numeric(particle$distance_from_line),
          relative_position = as.numeric(particle$relative_position),
          source = source_name,
          time = time_label,
          Trial = trial_number,
          line_index = i,
          stringsAsFactors = FALSE
        )
        
        particle_dfs[[j]] <- particle_df
      }
      
      # Combine all particles for this line
      if (length(particle_dfs) > 0) {
        result_dfs[[i]] <- bind_rows(particle_dfs)
      }
    }
    # If no intersecting particles, we don't add anything to result_dfs for this line
  }
  
  # Combine all results, return empty dataframe if no results
  if (length(result_dfs) > 0) {
    return(bind_rows(result_dfs))
  } else {
    # Return empty dataframe with correct structure
    return(data.frame(
      intersects = logical(0),
      area = numeric(0),
      overhang_proportion = numeric(0),
      overhang_area = numeric(0),
      diameter = numeric(0),
      distance_from_line = numeric(0),
      relative_position = numeric(0),
      source = character(0),
      time = character(0),
      Trial = character(0),
      line_index = numeric(0),
      stringsAsFactors = FALSE
    ))
  }
}

# Initialize storage for all results
all_starshade_sim_before <- list()
all_starshade_sim_after <- list()
all_calibration_sim_before <- list()
all_calibration_sim_after <- list()
all_witness_sim_before <- list()
all_witness_sim_after <- list()

# Process each trial
for (trial in trials_to_analyze) {
  cat("Processing Trial", trial, "\n")
  
  # STARSHADE SURFACE
  # Filter data for current trial and remove rows with missing critical data
  starshade_surface_before <- surface_before_particles %>%
    filter(Trial == trial) %>%
    select(Area, BX, BY, Width, Height) %>%
    filter(!is.na(Area), !is.na(BX), !is.na(BY), !is.na(Width), !is.na(Height),
           Area > 0, Width > 0, Height > 0)
  
  starshade_surface_after <- surface_after_particles %>%
    filter(Trial == trial) %>%
    select(Area, BX, BY, Width, Height) %>%
    filter(!is.na(Area), !is.na(BX), !is.na(BY), !is.na(Width), !is.na(Height),
           Area > 0, Width > 0, Height > 0)
  
  cat("  Starshade before:", nrow(starshade_surface_before), "particles\n")
  cat("  Starshade after:", nrow(starshade_surface_after), "particles\n")
  
  # Analyze intersections
  starshade_before_results <- analyze_line_intersections(starshade_surface_before, lines)
  starshade_after_results <- analyze_line_intersections(starshade_surface_after, lines)
  
  # Process to dataframes
  all_starshade_sim_before[[as.character(trial)]] <- process_results_to_df(
    starshade_before_results, "starshade_surface", "before", as.character(trial)
  )
  
  all_starshade_sim_after[[as.character(trial)]] <- process_results_to_df(
    starshade_after_results, "starshade_surface", "after", as.character(trial)
  )
  
  # CALIBRATION SURFACE
  # Filter data for current trial and remove rows with missing critical data
  calibration_surface_before <- Cwsurface_before_data$particle_data %>%
    filter(Trial == trial, Area > 1) %>%
    select(Area, BX, BY, Width, Height) %>%
    filter(!is.na(Area), !is.na(BX), !is.na(BY), !is.na(Width), !is.na(Height),
           Area > 0, Width > 0, Height > 0)
  
  calibration_surface_after <- Cwsurface_after_data$particle_data %>%
    filter(Trial == trial, Area > 1) %>%
    select(Area, BX, BY, Width, Height) %>%
    filter(!is.na(Area), !is.na(BX), !is.na(BY), !is.na(Width), !is.na(Height),
           Area > 0, Width > 0, Height > 0)
  
  cat("  Calibration before:", nrow(calibration_surface_before), "particles\n")
  cat("  Calibration after:", nrow(calibration_surface_after), "particles\n")
  
  # Analyze intersections
  calibration_before_results <- analyze_line_intersections(calibration_surface_before, lines)
  calibration_after_results <- analyze_line_intersections(calibration_surface_after, lines)
  
  # Process to dataframes
  all_calibration_sim_before[[as.character(trial)]] <- process_results_to_df(
    calibration_before_results, "calibration_surface", "before", as.character(trial)
  )
  
  all_calibration_sim_after[[as.character(trial)]] <- process_results_to_df(
    calibration_after_results, "calibration_surface", "after", as.character(trial)
  )
  
  # WITNESS SURFACE
  # Filter data for current trial and remove rows with missing critical data
  witness_surface_before <- wit_surface_before_particles %>%
    filter(Trial == trial, Area > 1) %>%
    select(Area, BX, BY, Width, Height) %>%
    filter(!is.na(Area), !is.na(BX), !is.na(BY), !is.na(Width), !is.na(Height),
           Area > 0, Width > 0, Height > 0)
  
  witness_surface_after <- wit_surface_after_particles %>%
    filter(Trial == trial, Area > 1) %>%
    select(Area, BX, BY, Width, Height) %>%
    filter(!is.na(Area), !is.na(BX), !is.na(BY), !is.na(Width), !is.na(Height),
           Area > 0, Width > 0, Height > 0)
  
  cat("  Witness before:", nrow(witness_surface_before), "particles\n")
  cat("  Witness after:", nrow(witness_surface_after), "particles\n")
  
  # Analyze intersections
  witness_before_results <- analyze_line_intersections(witness_surface_before, lines)
  witness_after_results <- analyze_line_intersections(witness_surface_after, lines)
  
  # Process to dataframes
  all_witness_sim_before[[as.character(trial)]] <- process_results_to_df(
    witness_before_results, "witness_surface", "before", as.character(trial)
  )
  
  all_witness_sim_after[[as.character(trial)]] <- process_results_to_df(
    witness_after_results, "witness_surface", "after", as.character(trial)
  )
}

# Combine all results
s_bmodel_edge_before <- bind_rows(all_starshade_sim_before)
s_bmodel_edge_after <- bind_rows(all_starshade_sim_after)
c_bmodel_edge_before <- bind_rows(all_calibration_sim_before)
c_bmodel_edge_after <- bind_rows(all_calibration_sim_after)
w_bmodel_edge_before <- bind_rows(all_witness_sim_before)
w_bmodel_edge_after <- bind_rows(all_witness_sim_after)

# Function to get area counts
get_area_counts <- function(data, area_thresholds, normalization_factor) {
  counts <- numeric(length(area_thresholds))
  
  for(i in 1:(length(area_thresholds) - 1)) {
    counts[i] <- sum(data$overhang_area >= area_thresholds[i] & 
                    data$overhang_area < area_thresholds[i + 1]) * normalization_factor
  }
  
  counts[length(area_thresholds)] <- sum(data$overhang_area >= area_thresholds[length(area_thresholds)]) * normalization_factor
  
  tibble(
    Area = area_thresholds,
    Count = counts
  )
}

# Function to process edge data for a surface type
process_edge_data <- function(edge_before, edge_after, normalization_data, surface_name) {
  # Calculate normalization factors
  edge_factors <- normalization_data %>%
    group_by(Trial) %>%
    summarise(
      Total_Width = n() * 600 * 1e-6,  # Convert microns to meters
      .groups = "drop"
    )
  
  # Calculate area-based counts for before data
  edge_counts_before <- edge_before %>%
    group_by(Trial, line_index) %>%
    group_modify(~ {
      norm_factor <- 0.1 / edge_factors$Total_Width[edge_factors$Trial == .y$Trial]
      counts <- get_area_counts(.x, area_thresholds, norm_factor)
      tibble(
        Area = area_thresholds,
        Count = counts$Count
      )
    })
  
  # Calculate area-based counts for after data
  edge_counts_after <- edge_after %>%
    group_by(Trial, line_index) %>%
    group_modify(~ {
      norm_factor <- 0.1 / edge_factors$Total_Width[edge_factors$Trial == .y$Trial]
      counts <- get_area_counts(.x, area_thresholds, norm_factor)
      tibble(
        Area = area_thresholds,
        Count = counts$Count
      )
    })
  
  # Calculate differences
  surface_count_diff <- edge_counts_after %>%
    full_join(edge_counts_before, 
              by = c("Trial", "Area", "line_index"), 
              suffix = c("_After", "_Before")) %>%
    mutate(
      Count_After = replace_na(Count_After, 0),
      Count_Before = replace_na(Count_Before, 0),
      Count_Diff = Count_After - Count_Before,
      Positive_Diff = pmax(Count_Diff, 0)
    )
  
  # Calculate cumulative counts
  cumulative_edge_counts <- surface_count_diff %>%
    group_by(Trial, line_index) %>%
    arrange(desc(Area)) %>%
    mutate(Cumulative_Count = cumsum(Positive_Diff)) %>%
    ungroup() %>%
    mutate(
      log_area = log10(Area),
      log_count = log10(Cumulative_Count),
      log_count = ifelse(is.infinite(log_count) | log_count < 0, 0, log_count)
    ) %>% 
    arrange(Trial, line_index, desc(Area))
  
  # Calculate binned counts from cumulative data
  edge_binned <- cumulative_edge_counts %>%
    group_by(Trial, line_index) %>%
    arrange(desc(Area)) %>%
    mutate(
      Count = c(Cumulative_Count[1], -diff(Cumulative_Count))  # Use negative diff for reverse cumsum
    ) %>%
    ungroup() %>% 
    mutate(
      log_count_bin = log10(Count),
      log_count_bin = ifelse(is.infinite(log_count_bin) | log_count_bin < 0, 0, log_count_bin)
    )
  
  return(list(
    cumulative = cumulative_edge_counts,
    binned = edge_binned
  ))
}

# Process all surface types
cat("Processing starshade edge data...\n")
starshade_edge_results <- process_edge_data(
  s_bmodel_edge_before, s_bmodel_edge_after, 
  surface_before_data$summary_data, "starshade"
)

cat("Processing calibration edge data...\n")
calibration_edge_results <- process_edge_data(
  c_bmodel_edge_before, c_bmodel_edge_after, 
  Cwsurface_before_data$summary_data, "calibration"
)

cat("Processing witness edge data...\n")
witness_edge_results <- process_edge_data(
  w_bmodel_edge_before, w_bmodel_edge_after, 
  Witsurface_before_data$summary_data, "witness"
)

# Extract results for easier access
s_bmodel_edge_mult <- starshade_edge_results$cumulative
s_bmodel_edge_mult_binned <- starshade_edge_results$binned

c_bmodel_edge_mult <- calibration_edge_results$cumulative
c_bmodel_edge_mult_binned <- calibration_edge_results$binned

w_bmodel_edge_mult <- witness_edge_results$cumulative
w_bmodel_edge_mult_binned <- witness_edge_results$binned

# Create summary plots for each trial and surface type
for (trial in trials_to_analyze) {
  cat("Creating plots for Trial", trial, "\n")
  
  # STARSHADE PLOTS
  # Cumulative plot
  p1 <- ggplot() +
    geom_line(data = s_bmodel_edge_mult %>% filter(Trial == trial),
              aes(x = log_area, y = log_count,
                  color = factor(line_index), 
                  group = line_index)) +
    labs(
      x = expression(log[10](Area)~"(square microns)"),
      y = "log10(Particle Count)",
      title = paste("Trial", trial, "Starshade: Cumulative Particle Area Distribution over 0.1 meter"),
      color = "Line Index"
    ) +
    custom_theme
  
  print(p1)
  
  # Binned plot
  p2 <- ggplot() +
    geom_line(data = s_bmodel_edge_mult_binned %>% filter(Trial == trial),
              aes(x = log_area, y = log_count_bin,
                  color = factor(line_index), 
                  group = line_index)) +
    labs(
      x = expression(log[10](Area)~"(square microns)"),
      y = "log10(Particle Count)",
      title = paste("Trial", trial, "Starshade: Binned Particle Area Distribution over 0.1 meter"),
      color = "Line Index"
    ) +
    custom_theme
  
  print(p2)
  
  # CALIBRATION PLOTS
  # Cumulative plot
  p3 <- ggplot() +
    geom_line(data = c_bmodel_edge_mult %>% filter(Trial == trial),
              aes(x = log_area, y = log_count,
                  color = factor(line_index), 
                  group = line_index)) +
    labs(
      x = expression(log[10](Area)~"(square microns)"),
      y = "log10(Particle Count)",
      title = paste("Trial", trial, "Calibration: Cumulative Particle Area Distribution over 0.1 meter"),
      color = "Line Index"
    ) +
    custom_theme
  
  print(p3)
  
  # Binned plot
  p4 <- ggplot() +
    geom_line(data = c_bmodel_edge_mult_binned %>% filter(Trial == trial),
              aes(x = log_area, y = log_count_bin,
                  color = factor(line_index), 
                  group = line_index)) +
    labs(
      x = expression(log[10](Area)~"(square microns)"),
      y = "log10(Particle Count)",
      title = paste("Trial", trial, "Calibration: Binned Particle Area Distribution over 0.1 meter"),
      color = "Line Index"
    ) +
    custom_theme
  
  print(p4)
  
  # WITNESS PLOTS
  # Cumulative plot
  p5 <- ggplot() +
    geom_line(data = w_bmodel_edge_mult %>% filter(Trial == trial),
              aes(x = log_area, y = log_count,
                  color = factor(line_index), 
                  group = line_index)) +
    labs(
      x = expression(log[10](Area)~"(square microns)"),
      y = "log10(Particle Count)",
      title = paste("Trial", trial, "Witness: Cumulative Particle Area Distribution over 0.1 meter"),
      color = "Line Index"
    ) +
    custom_theme
  
  print(p5)
  
  # Binned plot
  p6 <- ggplot() +
    geom_line(data = w_bmodel_edge_mult_binned %>% filter(Trial == trial),
              aes(x = log_area, y = log_count_bin,
                  color = factor(line_index), 
                  group = line_index)) +
    labs(
      x = expression(log[10](Area)~"(square microns)"),
      y = "log10(Particle Count)",
      title = paste("Trial", trial, "Witness: Binned Particle Area Distribution over 0.1 meter"),
      color = "Line Index"
    ) +
    custom_theme
  
  print(p6)
}

# Create comparison plots across all trials for each surface type
# Starshade comparison
ggplot() +
  geom_line(data = s_bmodel_edge_mult,
            aes(x = log_area, y = log_count,
                color = factor(Trial), 
                linetype = factor(line_index),
                group = interaction(Trial, line_index))) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Starshade: Cumulative Edge Analysis Comparison Across Trials",
    color = "Trial",
    linetype = "Line Index"
  ) +
  custom_theme

# Calibration comparison
ggplot() +
  geom_line(data = c_bmodel_edge_mult,
            aes(x = log_area, y = log_count,
                color = factor(Trial), 
                linetype = factor(line_index),
                group = interaction(Trial, line_index))) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Calibration: Cumulative Edge Analysis Comparison Across Trials",
    color = "Trial",
    linetype = "Line Index"
  ) +
  custom_theme

# Witness comparison
ggplot() +
  geom_line(data = w_bmodel_edge_mult,
            aes(x = log_area, y = log_count,
                color = factor(Trial), 
                linetype = factor(line_index),
                group = interaction(Trial, line_index))) +
  labs(
    x = expression(log[10](Area)~"(square microns)"),
    y = "log10(Particle Count)",
    title = "Witness: Cumulative Edge Analysis Comparison Across Trials",
    color = "Trial",
    linetype = "Line Index"
  ) +
  custom_theme

cat("Edge analysis complete for all trials and surfaces!\n")
```

<!-- Next steps include comparison to paper sections, Witness Analysis, Cropped Surface Analysis -->

## 13. Paper Comparisons

<!-- This section creates figures that can be directly compared with those in the research paper -->

```{r comparison graphs, include=FALSE, echo = FALSE, eval=FALSE}
# Calculate surface binned fit parameters for comparison with literature
surface_binned_fit <- overall_average_surface_binned %>%
  summarise(
    slope = coef(lm(log_count ~ log_area))[2],
    intercept = coef(lm(log_count ~ log_area))[1],
    .groups = "drop"
  ) %>%
  mutate(PCL = 10^(sqrt(-intercept/slope)))
#logN = -0.926(log2 (x) - log2 (PCL)) - IEST standard formula for reference

# Normalize calibration data for comparison
# Converts to proportion of particles rather than absolute counts
calibration_normalized <- overall_average_calibration_binned %>% 
  mutate(
    Total_Count = sum(10^log_count, na.rm = TRUE),
    Normalized_Count = 10^log_count / Total_Count) 
  
# Normalize edge data similarly
edge_normalized <- overall_average_binned %>%
  mutate(
    Total_Count = sum(10^log_count, na.rm = TRUE),
    Normalized_Count = 10^log_count / Total_Count )

# Calculate the ratio between normalized distributions
# This helps identify the "adhesion factor" described in the paper
normalized_ratio <- calibration_normalized %>% 
  full_join(edge_normalized, by = c("Area", "log_area")) %>% 
  mutate(observed_over_calibration = Normalized_Count.y/Normalized_Count.x,
         Ratio = 1/(2*(sqrt(10^(log_area)/pi)))) %>% 
  select(Area,log_area,observed_over_calibration,Ratio)

# Updated plot theme with improved readability for publication-quality figures
plot_theme <- theme_minimal() +
  theme(
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray95"),
    text = element_text(size = 11),
    legend.position = "top",
    legend.text = element_text(size = 10),
    legend.title = element_blank(),
    plot.title = element_text(size = 12, hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5)
  )

# Figure 15(a) - Total Measured Surface Particulate Distribution
# Recreates Fig. 15 from the paper with updated data
p1 <- ggplot() +
  geom_line(data = overall_average_surface_binned,
            aes(x = 10^log_area, y = 10^log_count, color = "Measured on Surface")) +
  geom_abline(
    data = surface_binned_fit,
    aes(slope = slope, intercept = intercept, linetype = "IEST Fit"),
    color = "black"
  ) +
  scale_x_log10(
    limits = c(10, 1e5),
    breaks = 10^(1:5),
    labels = scales::scientific_format(digits = 1)
  ) +
  scale_y_log10(
    limits = c(1, 1e6),
    breaks = 10^(0:6)
  ) +
  scale_color_manual(values = c("Measured on Surface" = "#0072BD")) +
  scale_linetype_manual(values = c("IEST Fit" = "dashed")) +
  labs(
    x = expression("Overhanging Particle Area ("*mu*m^2*")"),
    y = "# Surface Particles",
    title = "Total Measured Surface Particulate Distribution"
  ) +
  plot_theme +
  annotate(
    "text",
    x = 100,
    y = 1e5,
    label = sprintf("IEST Fit: PCL %d, slope %.2f",
                   round(surface_binned_fit$PCL),
                   surface_binned_fit$slope),
    hjust = 0
  )

# Figure 15(b) - Total Measured Edge Particulate Distribution
# Shows actual vs predicted particle counts and the adhesion factor effect
p2 <- ggplot() +
  geom_line(data = overall_average_binned,
            aes(x = log_area, y = log_count, color = "Measured on Edge")) +
  geom_line(data = overall_average_model_binned,
            aes(x = log_area, y = log_count, color = "Predicted from Surface")) +
  geom_line(data = overall_average_model_binned,
            aes(x = log_area, 
                y = (log_count)/(2*(sqrt((log_area)/pi))),
                color = "Predicted with Adhesion Factor"),
            linetype = "dotted") +
  
  scale_color_manual(
    values = c(
      "Measured on Edge" = "#0072BD",
      "Predicted from Surface" = "#D95319",
      "Predicted with Adhesion Factor" = "#7E2F8E"
    )
  ) +
  labs(
    x = expression("Overhanging Particle Area ("*mu*m^2*")"),
    y = "# Edge Particles",
    title = "Total Measured Edge Particulate Distribution"
  ) +
  plot_theme

# Figure 16(a) - Normalized Edge Particulate Distributions
# Shows proportional distribution of particles by size
p3 <- ggplot() +
  geom_line(data = calibration_normalized,
            aes(x = 10^log_area, y = Normalized_Count, color = "Calibration Mask")) +
  geom_line(data = edge_normalized,
            aes(x = 10^log_area, y = Normalized_Count, color = "Etched Samples")) +
  scale_x_log10(
    limits = c(10, 1e4),
    breaks = c(10, 100, 1000, 10000),
    labels = scales::scientific_format(digits = 1)
  ) +
  scale_y_log10(
    limits = c(1e-4, 1),
    breaks = 10^seq(-4, 0, by = 1)
  ) +
  scale_color_manual(
    values = c(
      "Calibration Mask" = "#D95319",
      "Etched Samples" = "#0072BD"
    )
  ) +
  labs(
    x = expression("Particle Area ("*mu*m^2*")"),
    y = "Proportion of Particulates",
    title = "Normalized Edge Particulate Distributions"
  ) +
  plot_theme

# Figure 16(b) - Missing Edge Particulate Ratio
# Shows ratio of etched samples to calibration samples
# The inverse diameter effect is key to the paper's findings
p4 <- ggplot() +
  geom_line(data = normalized_ratio,
            aes(x = 10^log_area, y = observed_over_calibration, color = "Ratio")) +
  geom_line(data = normalized_ratio,
            aes(x = 10^log_area, y = Ratio, color = "1/diam. Fitted Curve"),
            linetype = "dashed") +
  scale_x_log10(
    limits = c(10, 1e4),
    breaks = c(10, 100, 1000, 10000)
  ) +
  scale_y_continuous(
    limits = c(0, 2),
    breaks = seq(0, 2, 0.5)
  ) +
  scale_color_manual(
    values = c(
      "Ratio" = "#0072BD",
      "1/diam. Fitted Curve" = "#D95319"
    )
  ) +
  labs(
    x = expression("Particle Area ("*mu*m^2*")"),
    y = "Edge Particulate Ratio\nEtched/Calibration",
    title = "Missing Edge Particulate Ratio"
  ) +
  plot_theme

# Display each plot separately
p1
p2
p3
p4
```

```{r combined comparison, include=FALSE, echo = FALSE, eval = FALSE}
# Functions to create combined figures for comparison with paper figures

# Create image grid from PNG file
create_image_grob <- function(img_path) {
  img <- readPNG(img_path)
  rasterGrob(img, interpolate = TRUE)
}

# Create text grid for labels
create_label <- function(text) {
  textGrob(text, gp = gpar(fontsize = 12, fontface = "bold"))
}

# Compare Figure 15 - Side by side comparison with original paper figure
grid.arrange(
  create_image_grob("/Users/brandontitensor/Desktop/College/Research/Dust_Contamination/starshade_dust_particle/data_analysis/Figure_15.png"),
  arrangeGrob(p1, p2, ncol = 2),
  ncol = 1,
  heights = c(1, 1),
  top = textGrob("Figure 15: Etched Samples Comparison", 
                 gp = gpar(fontsize = 14, fontface = "bold"))
)

# Function to compare reference and generated plots
compare_plots <- function(reference_img, generated_plot, title) {
  grid.arrange(
    reference_img, generated_plot,
    ncol = 2,
    top = textGrob(title, gp = gpar(fontsize = 14, fontface = "bold")),
    widths = c(1, 1)
  )
}

# Compare Figure 16 - Side by side with original paper figure
grid.arrange(
  create_image_grob("/Users/brandontitensor/Desktop/College/Research/Dust_Contamination/starshade_dust_particle/data_analysis/Figure_16.png"),
  arrangeGrob(p3, p4, ncol = 2),
  ncol = 1,
  heights = c(1, 1),
  top = textGrob("Figure 16: Comparative Analysis Comparison", 
                 gp = gpar(fontsize = 14, fontface = "bold"))
)
```
